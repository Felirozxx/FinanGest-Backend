<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1200, initial-scale=0.5">
    <meta name="google-site-verification" content="p22U-tFPWoJMGepUFZs-SlX6QiqwRku1M92GOexz5bQ" />
    <title>FinanGest - Gestão Financeira Profissional | Controle de Clientes</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="FinanGest é o sistema profissional de gestão financeira para controle de clientes, pagamentos, cobranças e despesas. Gerencie seu negócio de forma simples e eficiente.">
    <meta name="keywords" content="gestão financeira, controle de clientes, sistema de cobranças, controle de pagamentos, finanças, gestão de negócios, app financeiro, FinanGest">
    <meta name="author" content="FinanGest Software">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://venerable-moonbeam-96c059.netlify.app/finangest.html">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://venerable-moonbeam-96c059.netlify.app/finangest.html">
    <meta property="og:title" content="FinanGest - Gestão Financeira Profissional">
    <meta property="og:description" content="Sistema profissional de gestão financeira para controle de clientes, pagamentos e despesas.">
    <meta property="og:image" content="https://venerable-moonbeam-96c059.netlify.app/og-image.svg">
    <meta property="og:site_name" content="FinanGest">
    <meta property="og:locale" content="pt_BR">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="FinanGest - Gestão Financeira Profissional">
    <meta name="twitter:description" content="Sistema profissional de gestão financeira para controle de clientes, pagamentos e despesas.">
    <meta name="twitter:image" content="https://venerable-moonbeam-96c059.netlify.app/og-image.svg">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#00d4ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FinanGest">
    <meta name="application-name" content="FinanGest">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#00d4ff">
    
    <!-- Favicon & Icons -->
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/apple-touch-icon.svg">
    <link rel="icon" type="image/svg+xml" href="/icon-192.svg">
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Schema.org JSON-LD for SEO -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "FinanGest",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web, Android, iOS",
      "description": "Sistema profissional de gestão financeira para controle de clientes, pagamentos, cobranças e despesas.",
      "url": "https://venerable-moonbeam-96c059.netlify.app/finangest.html",
      "author": {
        "@type": "Organization",
        "name": "FinanGest Software"
      },
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "BRL"
      },
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.8",
        "ratingCount": "150"
      }
    }
    </script>
    
    <!-- Stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Flatpickr para calendarios personalizados -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/pt.js"></script>
    
    <style>
        /* Ocultar flechas del input number */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #111827;
            --bg-card: #1a1f2e;
            --bg-hover: #1e2538;
            --accent-cyan: #00d4ff;
            --accent-green: #2ecc71;
            --accent-yellow: #e6a700;
            --accent-red: #ff4757;
            --accent-purple: #a855f7;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border-color: #2d3548;
        }
        * { box-sizing: border-box; }
        html, body {
            overscroll-behavior-y: contain;
        }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            opacity: 0;
            transition: opacity 0.15s ease-in-out;
        }
        body.loaded {
            opacity: 1;
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            margin: 0;
        }
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 260px; height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: transform 0.3s;
        }
        .sidebar.hidden { transform: translateX(-100%); }
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan); }
        .logo span { color: var(--text-secondary); font-weight: 400; font-size: 0.9rem; }
        .nav-menu { padding: 20px 0; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 25px;
            color: var(--text-secondary); text-decoration: none;
            transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--bg-hover); color: var(--accent-cyan);
            border-left-color: var(--accent-cyan);
        }
        .nav-item i { width: 24px; margin-right: 12px; }
        .main-content {
            margin-left: 260px; padding: 30px;
            min-height: 100vh; transition: margin 0.3s;
            background: var(--bg-primary);
            position: relative;
        }
        .main-content .row { display: flex; flex-wrap: wrap; }
        .main-content .col-md-4, .main-content .col-md-8, .main-content .col-md-3 { 
            position: relative; 
            min-height: 1px;
        }
        .main-content.expanded { margin-left: 0; }
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-title { font-size: 1.5rem; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-cyan); display: flex;
            align-items: center; justify-content: center; font-weight: 600;
        }
        /* Toast de notificación */
        .toast-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #00d4ff, #00b894);
            color: #000;
            padding: 16px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1.1rem;
            box-shadow: 0 8px 32px rgba(0, 212, 255, 0.5);
            z-index: 9999999;
            opacity: 0;
            display: none;
            align-items: center;
            gap: 12px;
            transition: opacity 0.4s ease;
        }
        .toast-notification.show {
            opacity: 1;
        }
        .toast-notification i {
            font-size: 1.4rem;
        }
        .card-dark {
            background: var(--bg-card); border-radius: 16px;
            border: 1px solid var(--border-color); padding: 24px;
        }
        .stat-card {
            background: var(--bg-card); border-radius: 16px;
            padding: 20px; border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
            min-width: 180px;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 4px; height: 100%; background: var(--accent-cyan);
        }
        .stat-card.green::before { background: var(--accent-green); }
        .stat-card.yellow::before { background: var(--accent-yellow); }
        .stat-card.red::before { background: var(--accent-red); }
        .stat-card.purple::before { background: var(--accent-purple); }
        .stat-card.orange::before { background: #ff8c00; }
        .stat-value { font-size: 1.6rem; font-weight: 700; margin-bottom: 5px; white-space: nowrap; }
        .stat-label { color: var(--text-secondary); font-size: 0.85rem; }
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
            border: none; padding: 12px 28px; border-radius: 8px;
            color: #000; font-weight: 600; transition: all 0.3s;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,255,0.3);
            color: #000;
        }
        .btn-success-custom {
            background: linear-gradient(135deg, var(--accent-green), #00cc6a);
            border: none; padding: 10px 20px; border-radius: 8px;
            color: #000; font-weight: 600;
        }
        .table-dark-custom { background: transparent; color: var(--text-primary); }
        .table-dark-custom th {
            background: var(--bg-hover); border-color: var(--border-color);
            color: var(--text-secondary); font-weight: 500; padding: 14px;
        }
        .table-dark-custom td {
            border-color: var(--border-color); padding: 14px;
            vertical-align: middle;
        }
        .table-dark-custom tbody tr:hover { background: var(--bg-hover); }
        .badge-status {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
        }
        .badge-active { background: rgba(0,255,136,0.15); color: var(--accent-green); }
        .badge-finished { background: rgba(0,212,255,0.15); color: var(--accent-cyan); }
        .badge-late { background: rgba(255,71,87,0.15); color: var(--accent-red); }
        .form-control-dark {
            background: var(--bg-hover) !important; border: 1px solid var(--border-color);
            color: var(--text-primary) !important; padding: 12px 16px; border-radius: 8px;
        }
        .form-control-dark:focus {
            background: var(--bg-hover) !important; border-color: var(--accent-cyan);
            color: var(--text-primary) !important; box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
        }
        .form-control-dark::placeholder { color: var(--text-secondary); }
        
        /* Hacer que los inputs de fecha sean clickeables en toda su área */
        input[type="date"] {
            cursor: pointer;
            position: relative;
            color-scheme: dark;
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            filter: invert(1);
        }
        
        /* Tema oscuro para el calendario del navegador */
        :root {
            color-scheme: dark light;
        }
        
        [data-theme="dark"] input[type="date"],
        [data-theme="dark"] input[type="datetime-local"] {
            color-scheme: dark;
        }
        
        [data-theme="light"] input[type="date"],
        [data-theme="light"] input[type="datetime-local"] {
            color-scheme: light;
        }
        
        .section { display: none; }
        .section.active { display: block; }
        .progress-custom {
            height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;
        }
        .progress-custom .bar {
            height: 100%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
            border-radius: 4px; transition: width 0.5s;
        }
        .chart-container { position: relative; height: 300px; }
        .chart-range-btn {
            padding: 4px 10px !important;
            font-size: 0.75rem !important;
            border-color: #3d3d5c !important;
            color: #8892b0 !important;
            background: transparent !important;
        }
        .chart-range-btn:hover {
            background: rgba(0,212,255,0.1) !important;
            border-color: #00d4ff !important;
            color: #00d4ff !important;
        }
        .chart-range-btn.active {
            background: #00d4ff !important;
            border-color: #00d4ff !important;
            color: #000 !important;
            font-weight: 600 !important;
        }
        .modal-dark .modal-content {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .modal-dark .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-hover); border-radius: 16px 16px 0 0;
        }
        .modal-dark .modal-footer { border-top: 1px solid var(--border-color); }
        .modal-dark .btn-close { filter: invert(1); }
        /* Auth Screen */
        .auth-container {
            min-height: 100vh; display: flex; align-items: center;
            justify-content: center; background: var(--bg-primary);
        }
        .auth-card {
            background: var(--bg-card); border-radius: 20px;
            border: 1px solid var(--border-color); width: 100%;
            max-width: 420px; overflow: hidden;
        }
        .auth-header {
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-secondary));
            padding: 40px; text-align: center;
        }
        .auth-header .logo { font-size: 2.2rem; }
        .auth-body { padding: 40px; }
        .auth-tabs {
            display: flex; margin-bottom: 30px;
            background: var(--bg-hover); border-radius: 10px; padding: 5px;
        }
        .auth-tab {
            flex: 1; padding: 12px; text-align: center; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; color: var(--text-secondary);
        }
        .auth-tab.active {
            background: var(--accent-cyan); color: #000; font-weight: 600;
        }
        .verification-input {
            display: flex; gap: 10px; justify-content: center; margin: 20px 0;
        }
        .verification-input input {
            width: 50px; height: 60px; text-align: center; font-size: 1.5rem;
            background: var(--bg-hover); border: 2px solid var(--border-color);
            border-radius: 10px; color: var(--text-primary);
        }
        .verification-input input:focus {
            border-color: var(--accent-cyan); outline: none;
        }
        .client-card {
            background: var(--bg-card); border-radius: 12px;
            border: 1px solid var(--border-color); padding: 20px;
            margin-bottom: 15px; transition: all 0.3s;
        }
        .client-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 4px 20px rgba(0,212,255,0.1);
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            #authScreen { flex-direction: column !important; min-height: 100vh; }
            #authScreen > div:first-child { 
                flex: none !important; 
                min-height: auto !important;
                padding: 30px 25px !important;
            }
            #brandingSide { 
                display: flex !important; 
                flex: 1 !important;
                padding: 40px 25px !important;
                min-height: auto !important;
            }
            #brandingSide h1 { font-size: 2.5rem !important; }
            #brandingSide p { font-size: 0.9rem !important; letter-spacing: 3px !important; margin-bottom: 30px !important; }
            #brandingSide button { padding: 14px 40px !important; font-size: 1rem !important; margin-bottom: 30px !important; }
            #brandingSide > div > div:last-child { padding: 25px !important; }
            #brandingSide > div > div:first-child { margin-bottom: 25px !important; }
            #brandingSide > div > div:first-child > div { width: 100px !important; height: 100px !important; }
            #brandingSide > div > div:first-child > div > i { font-size: 3rem !important; }
        }
        /* Animaciones para login */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0,212,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(0,212,255,0.6); }
        }
        .auth-icon-float {
            animation: float 3s ease-in-out infinite;
        }
        .auth-card {
            animation: pulse-glow 4s ease-in-out infinite;
        }
        .feature-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 0; color: var(--text-secondary);
        }
        .feature-item i {
            color: var(--accent-cyan); width: 20px;
        }
        /* Tema Claro */
        body.light-theme {
            --bg-primary: #f2f4f6;
            --bg-secondary: #f2f4f6;
            --bg-card: #f2f4f6;
            --bg-hover: #e0e3e7;
            --text-primary: #1a1a2e;
            --text-secondary: #5a6270;
            --border-color: #d1d9e6;
        }
        body.light-theme .sidebar {
            background: #f2f4f6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        body.light-theme .table-dark-custom th {
            background: #e0e3e7;
        }
        body.light-theme .form-control-dark {
            background: #eaecef;
            border-color: #d1d9e6;
            color: #1a1a2e;
        }
        body.light-theme .form-control-dark:focus {
            background: #f2f4f6;
        }
        body.light-theme .modal-dark .modal-content {
            background: #f2f4f6;
        }
        body.light-theme .modal-dark .modal-header {
            background: #eaecef;
        }
        body.light-theme #chartNavContainer {
            background: linear-gradient(180deg, #e8ebef 0%, #dde1e6 100%) !important;
            border-color: #c5ccd6 !important;
        }
        body.light-theme #miniChartWrapper {
            background: #d0d5dc !important;
        }
        body.light-theme #rangeSelector {
            background: rgba(0, 180, 220, 0.15) !important;
        }
        body.light-theme #rangeOverlayLeft,
        body.light-theme #rangeOverlayRight {
            background: rgba(255,255,255,0.6) !important;
        }
        /* Mapa */
        #mapContainer {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
        }
        .leaflet-popup-tip {
            background: var(--bg-card);
        }
        body.light-theme .leaflet-popup-content-wrapper {
            background: #f2f4f6;
            color: #1a1a2e;
        }
        body.light-theme .leaflet-popup-tip {
            background: #f2f4f6;
        }
        /* Estilos del selector de carteras */
        .cartera-selector button:hover {
            border-color: var(--accent-cyan) !important;
            background: var(--bg-card) !important;
        }
        #carteraDropdown::-webkit-scrollbar {
            width: 6px;
        }
        #carteraDropdown::-webkit-scrollbar-track {
            background: var(--bg-hover);
        }
        #carteraDropdown::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }
        .cartera-color-btn:hover {
            transform: scale(1.1);
        }
        
        /* Flatpickr - Tema oscuro personalizado */
        .flatpickr-calendar {
            background: var(--bg-secondary, #1a1f2e) !important;
            border: 1px solid var(--border-color, #2d3748) !important;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4) !important;
            border-radius: 12px !important;
        }
        .flatpickr-months {
            background: var(--bg-secondary, #1a1f2e) !important;
            border-bottom: 1px solid var(--border-color, #2d3748) !important;
        }
        .flatpickr-month {
            color: var(--text-primary, #e2e8f0) !important;
        }
        .flatpickr-current-month .flatpickr-monthDropdown-months {
            background: var(--bg-tertiary, #0f1419) !important;
            color: var(--text-primary, #e2e8f0) !important;
        }
        .flatpickr-current-month input.cur-year {
            color: var(--text-primary, #e2e8f0) !important;
        }
        .flatpickr-weekdays {
            background: var(--bg-secondary, #1a1f2e) !important;
        }
        .flatpickr-weekday {
            color: var(--text-secondary, #94a3b8) !important;
        }
        .flatpickr-days {
            background: var(--bg-secondary, #1a1f2e) !important;
        }
        .flatpickr-day {
            color: var(--text-primary, #e2e8f0) !important;
            border: none !important;
        }
        .flatpickr-day:hover:not(.flatpickr-disabled) {
            background: var(--primary, #00d4ff) !important;
            color: #000 !important;
        }
        .flatpickr-day.today {
            border: 2px solid var(--primary, #00d4ff) !important;
            background: transparent !important;
        }
        .flatpickr-day.selected {
            background: var(--primary, #00d4ff) !important;
            color: #000 !important;
            font-weight: bold !important;
        }
        .flatpickr-day.flatpickr-disabled {
            color: #4a5568 !important;
            background: transparent !important;
            cursor: not-allowed !important;
            opacity: 0.3 !important;
        }
        .flatpickr-day.prevMonthDay,
        .flatpickr-day.nextMonthDay {
            color: #4a5568 !important;
            opacity: 0.5 !important;
        }
        .flatpickr-prev-month:hover svg,
        .flatpickr-next-month:hover svg {
            fill: var(--primary, #00d4ff) !important;
        }
        .flatpickr-prev-month svg,
        .flatpickr-next-month svg {
            fill: var(--text-secondary, #94a3b8) !important;
        }
    </style>
</head>
<body>
    <!-- Auth Screen - Diseño Profesional Mejorado -->
    <div id="authScreen" style="display: flex !important; min-height: 100vh; margin: 0; padding: 0; flex-direction: row !important;">
        <!-- Lado Izquierdo - Formulario -->
        <div style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 50px 40px; background: linear-gradient(180deg, #080b10 0%, #0d1117 100%);">
            <div style="width: 100%; max-width: 400px;">
                <!-- Logo -->
                <div style="display: flex; align-items: center; gap: 14px; margin-bottom: 30px;">
                    <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #00d4ff, #0099cc); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,212,255,0.3);">
                        <i class="fas fa-chart-line" style="color: #fff; font-size: 1.4rem;"></i>
                    </div>
                    <span style="font-size: 1.7rem; font-weight: 700; color: #fff;">FinanGest</span>
                </div>
                
                <!-- Selector de Idioma en Login -->
                <div style="display: flex; gap: 10px; margin-bottom: 30px;">
                    <button id="authLangEs" onclick="cambiarIdiomaAuth('es')" style="flex: 1; padding: 10px; background: #161b22; border: 2px solid #30363d; border-radius: 8px; color: #9ca3af; font-size: 0.9rem; cursor: pointer; transition: all 0.3s;">
                        🇪🇸 Español
                    </button>
                    <button id="authLangPt" onclick="cambiarIdiomaAuth('pt')" style="flex: 1; padding: 10px; background: #00d4ff; border: 2px solid #00d4ff; border-radius: 8px; color: #000; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; font-weight: 600;">
                        🇧🇷 Português
                    </button>
                </div>
                
                <h1 id="authTitulo" style="font-size: 2.4rem; font-weight: 700; margin-bottom: 12px; color: #fff;">Bem-vindo!</h1>
                <p id="authSubtitulo" style="color: #6b7280; margin-bottom: 40px; font-size: 1.05rem;">Digite suas credenciais para acessar o sistema</p>
                
                <!-- Login Form -->
                <div id="loginForm">
                    <div style="margin-bottom: 24px;">
                        <label id="labelEmail" style="display: block; color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px; font-weight: 500;">Email ou Usuário</label>
                        <input type="email" id="loginEmail" placeholder="seu@email.com" autocomplete="off"
                            style="width: 100%; padding: 16px 20px; background: #161b22; border: 2px solid #30363d; border-radius: 12px; color: #fff; font-size: 1rem; transition: all 0.3s; outline: none; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#00d4ff'; this.style.boxShadow='0 0 0 4px rgba(0,212,255,0.15)'"
                            onblur="this.style.borderColor='#30363d'; this.style.boxShadow='none'">
                    </div>
                    <div style="margin-bottom: 32px;">
                        <label id="labelSenha" style="display: block; color: #9ca3af; font-size: 0.9rem; margin-bottom: 10px; font-weight: 500;">Senha</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" autocomplete="new-password"
                            style="width: 100%; padding: 16px 20px; background: #161b22; border: 2px solid #30363d; border-radius: 12px; color: #fff; font-size: 1rem; transition: all 0.3s; outline: none; box-sizing: border-box;"
                            onfocus="this.style.borderColor='#00d4ff'; this.style.boxShadow='0 0 0 4px rgba(0,212,255,0.15)'"
                            onblur="this.style.borderColor='#30363d'; this.style.boxShadow='none'">
                    </div>
                    <button id="btnLogin" onclick="handleLogin()" 
                        style="width: 100%; padding: 16px; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); border: none; border-radius: 12px; color: #000; font-size: 1.05rem; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 20px rgba(0,212,255,0.35);"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 30px rgba(0,212,255,0.45)'"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(0,212,255,0.35)'">
                        Entrar
                    </button>
                    <div style="text-align: center; margin-top: 28px; display: flex; justify-content: center; gap: 20px;">
                        <a id="linkOlvidoSenha" href="#" onclick="showForgotPassword(); return false;" style="color: #00d4ff; text-decoration: none; font-size: 0.9rem;">
                            Esqueceu sua senha?
                        </a>
                        <span style="color: #4b5563;">|</span>
                        <a id="linkCambiarUsuario" href="#" onclick="showForgotPassword(); return false;" style="color: #00d4ff; text-decoration: none; font-size: 0.9rem;">
                            Recuperar conta com Gmail de recuperação
                        </a>
                    </div>
                    <div style="text-align: center; margin-top: 16px;">
                        <span id="spanNoCuenta" style="color: #6b7280; font-size: 0.95rem;">Não tem conta? </span>
                        <a id="linkRegistrarse" href="#" onclick="showAuthTab('register'); return false;" style="color: #00d4ff; text-decoration: none; font-weight: 600;">Cadastre-se</a>
                    </div>
                </div>
                
                <!-- Renewal Payment Form (for expired subscriptions) -->
                <div id="renewalPaymentForm" style="display: none;">
                    <h2 style="font-size: 1.5rem; margin-bottom: 10px; color: #ff6b6b;">Assinatura Vencida</h2>
                    <p style="color: var(--text-secondary); margin-bottom: 25px;">Renove sua assinatura para continuar</p>
                    <div style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">Plano Mensal</p>
                        <h2 style="color: var(--accent-green); font-size: 2.5rem; margin: 0;">R$ 79,50</h2>
                    </div>
                    <div id="renewalPixContainer" style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                        <div id="renewalPixLoading">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i>
                            <p class="text-secondary">Gerando código PIX...</p>
                        </div>
                        <div id="renewalPixQrCode" style="display: none;">
                            <img id="renewalPixQrImage" src="" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 180px;">
                            <div style="margin-top: 15px;">
                                <input type="text" id="renewalPixCopyPaste" readonly style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--accent-cyan); padding: 8px; border-radius: 5px; font-size: 0.7rem; width: 100%;">
                                <button onclick="copyRenewalPixCode()" style="margin-top: 10px; background: var(--accent-cyan); border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; color: #000;">
                                    <i class="fas fa-copy me-1"></i>Copiar
                                </button>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success-custom w-100" onclick="verificarPagoRenovacion()" id="btnVerificarPagoRenovacion" style="padding: 14px;">
                        Já paguei - Verificar
                    </button>
                    <div class="text-center mt-3">
                        <button class="btn w-100" onclick="solicitarAccesoAdminRenovacion()" style="padding: 12px; background: var(--accent-purple); color: #fff; border: none; border-radius: 8px;">
                            <i class="fas fa-gift me-2"></i>Obtener acceso gratis
                        </button>
                    </div>
                    <div class="text-center mt-3">
                        <a href="#" onclick="volverAlLogin()" style="color: var(--text-secondary); text-decoration: none;">
                            <i class="fas fa-arrow-left me-1"></i>Voltar ao Login
                        </a>
                    </div>
                </div>
                
                <!-- Forgot Password Form -->
                <div id="forgotPasswordForm" style="display: none;">
                    <div id="forgotStep1">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Recuperar Senha</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">Digite seu email principal ou de recuperação</p>
                        <div class="mb-4">
                            <label class="form-label text-secondary">Email principal ou de recuperação</label>
                            <input type="email" class="form-control form-control-dark" id="forgotEmail" placeholder="seu@email.com" style="padding: 14px 16px;">
                        </div>
                        <button class="btn btn-primary-custom w-100" onclick="sendResetCode()" id="btnSendResetCode" style="padding: 14px;">
                            Enviar Código
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="backToLogin()" style="color: var(--text-secondary); text-decoration: none;">
                                <i class="fas fa-arrow-left me-1"></i>Voltar ao Login
                            </a>
                        </div>
                    </div>
                    <div id="forgotStep2" style="display: none;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Verifique seu Código</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">Enviamos um código para <span id="forgotEmailSent" style="color: var(--accent-cyan);"></span></p>
                        <div id="recoveryEmailNotice" style="display: none; background: rgba(168, 85, 247, 0.15); border: 1px solid var(--accent-purple); border-radius: 8px; padding: 12px; margin-bottom: 15px;">
                            <p style="color: var(--accent-purple); margin: 0; font-size: 0.9rem;">
                                <i class="fas fa-info-circle me-2"></i>
                                <span id="recoveryEmailNoticeText">Você está usando seu email de recuperação. Este se tornará seu novo email principal.</span>
                            </p>
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Código</label>
                            <input type="text" class="form-control form-control-dark text-center" id="resetCode" placeholder="000000" maxlength="6" style="font-size: 1.5rem; letter-spacing: 8px; padding: 14px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Nova Senha</label>
                            <input type="password" class="form-control form-control-dark" id="newPassword" placeholder="Mínimo 6 caracteres" style="padding: 14px 16px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Confirmar Senha</label>
                            <input type="password" class="form-control form-control-dark" id="confirmPassword" placeholder="Repetir senha" style="padding: 14px 16px;">
                        </div>
                        <div id="newRecoveryEmailContainer" style="display: none;" class="mb-4">
                            <label class="form-label" style="color: var(--accent-purple);">
                                <i class="fas fa-envelope-open me-1"></i>
                                <span data-lang-es="Nuevo Email de Recuperación (obligatorio)">Novo Email de Recuperação (obrigatório)</span>
                            </label>
                            <input type="email" class="form-control form-control-dark" id="newRecoveryEmail" placeholder="outro@email.com" style="padding: 14px 16px; border-color: var(--accent-purple);">
                            <small style="color: var(--text-secondary);" data-lang-es="Este será tu nuevo email de respaldo">Este será seu novo email de backup</small>
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="resetPassword()" id="btnResetPassword" style="padding: 14px;">
                            Alterar Senha
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="backToLogin()" style="color: var(--text-secondary); text-decoration: none;">
                                <i class="fas fa-arrow-left me-1"></i><span data-lang-es="Volver al Login">Voltar ao Login</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Change Username Form -->
                <div id="changeUsernameForm" style="display: none;">
                    <div id="usernameStep1">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Alterar Usuário</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">Digite seu email para verificar sua conta</p>
                        <div class="mb-4">
                            <label class="form-label text-secondary">Email</label>
                            <input type="email" class="form-control form-control-dark" id="changeUserEmail" placeholder="seu@email.com" style="padding: 14px 16px;">
                        </div>
                        <button class="btn btn-primary-custom w-100" onclick="sendUsernameCode()" id="btnSendUsernameCode" style="padding: 14px;">
                            Enviar Código
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" onclick="backToLogin()" style="color: var(--text-secondary); text-decoration: none;">
                                <i class="fas fa-arrow-left me-1"></i>Voltar ao Login
                            </a>
                        </div>
                    </div>
                    <div id="usernameStep2" style="display: none;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Novo Usuário</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">Código enviado para <span id="usernameEmailSent" style="color: var(--accent-cyan);"></span></p>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Código de Verificação</label>
                            <input type="text" class="form-control form-control-dark text-center" id="usernameCode" placeholder="000000" maxlength="6" style="font-size: 1.5rem; letter-spacing: 8px; padding: 14px;">
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-secondary">Novo Nome de Usuário</label>
                            <input type="text" class="form-control form-control-dark" id="newUsername" placeholder="novo_usuario" style="padding: 14px 16px;">
                            <small class="text-secondary">Sem espaços, apenas letras, números e hífens</small>
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="changeUsername()" id="btnChangeUsername" style="padding: 14px;">
                            <i class="fas fa-user-edit me-2"></i>Alterar Usuário
                        </button>
                    </div>
                </div>
                
                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <div id="registerStep1">
                        <h2 id="regTitulo" style="font-size: 1.5rem; margin-bottom: 10px;">Criar Conta</h2>
                        <p id="regSubtitulo" style="color: var(--text-secondary); margin-bottom: 25px;">Complete seus dados para se cadastrar</p>
                        <div class="mb-3">
                            <label id="labelNombre" class="form-label text-secondary">Nome Completo</label>
                            <input type="text" class="form-control form-control-dark" id="regNombre" placeholder="Seu nome" style="padding: 14px 16px;">
                        </div>
                        <div class="mb-3">
                            <label id="labelUsuario" class="form-label text-secondary">Usuário</label>
                            <input type="text" class="form-control form-control-dark" id="regUsername" placeholder="usuario123" autocomplete="off" style="padding: 14px 16px;">
                        </div>
                        <div class="mb-3">
                            <label id="labelRegEmail" class="form-label text-secondary">Email</label>
                            <input type="email" class="form-control form-control-dark" id="regEmail" placeholder="seu@gmail.com" style="padding: 14px 16px;">
                        </div>
                        <div class="mb-3">
                            <label id="labelRecoveryEmail" class="form-label text-secondary">Email de Recuperação <span style="color: var(--accent-red); font-size: 0.8rem;">*</span></label>
                            <input type="email" class="form-control form-control-dark" id="regRecoveryEmail" placeholder="outro@email.com (familiar, amigo)" style="padding: 14px 16px;" required>
                            <small id="recoveryEmailHelp" style="color: var(--text-secondary); font-size: 0.75rem;">Obrigatório - Usado para recuperar sua conta se perder acesso ao email principal</small>
                        </div>
                        <div class="mb-3">
                            <label id="labelRegSenha" class="form-label text-secondary">Senha</label>
                            <input type="password" class="form-control form-control-dark" id="regPassword" placeholder="Mínimo 6 caracteres" style="padding: 14px 16px;">
                        </div>
                        <div class="mb-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="acceptTerms" style="cursor: pointer;">
                                <label class="form-check-label text-secondary" for="acceptTerms" style="font-size: 0.85rem; cursor: pointer;">
                                    <span id="spanAceptoTerminos">Aceito os</span> <a href='/politicas#terminos' style='color: var(--accent-cyan);' target='_blank'><span id="linkTerminos">Termos</span></a> e <a href='/politicas' style='color: var(--accent-cyan);' target='_blank'><span id="linkPrivacidad">Privacidade</span></a>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary-custom w-100" onclick="sendVerificationCode()" id="btnSendCode" style="padding: 14px;">
                            Enviar Código
                        </button>
                        <div class="text-center mt-3">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">Já tem conta? </span>
                            <a href="#" onclick="showAuthTab('login')" style="color: var(--accent-cyan); text-decoration: none;">Entrar</a>
                        </div>
                    </div>
                    <div id="registerStep2" style="display: none;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px;">Verifique seu Email</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 25px;">Código enviado para <span id="emailSent" style="color: var(--accent-cyan);"></span></p>
                        <div class="mb-4">
                            <label class="form-label text-secondary">Código de Verificação</label>
                            <input type="text" class="form-control form-control-dark text-center" id="verificationCode" placeholder="000000" maxlength="6" style="font-size: 1.5rem; letter-spacing: 8px; padding: 14px;">
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="verifyCode()" style="padding: 14px;">
                            Verificar e Criar Conta
                        </button>
                        <div class="text-center mt-3">
                            <button class="btn btn-outline-secondary w-100 mb-2" onclick="voltarParaRegistro()" style="padding: 10px;">
                                <i class="fas fa-arrow-left me-2"></i>Voltar
                            </button>
                            <span style="color: var(--text-secondary);">Não recebeu o código? </span>
                            <a href="#" id="resendLink" onclick="resendCode(); return false;" style="color: var(--accent-cyan); text-decoration: underline; cursor: pointer;">Reenviar</a>
                            <p id="resendStatus" style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 8px; display: none;"></p>
                        </div>
                    </div>
                    <!-- Paso 3: Pago PIX -->
                    <div id="registerStep3" style="display: none;">
                        <h2 style="font-size: 1.5rem; margin-bottom: 10px; color: var(--accent-green);">Conta Criada!</h2>
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Último passo: Selecione suas carteiras</p>
                        
                        <!-- Selector de carteras -->
                        <div style="background: var(--bg-hover); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                            <label style="color: var(--text-secondary); font-size: 0.9rem; display: block; margin-bottom: 10px;">
                                <i class="fas fa-wallet me-2"></i>Quantas carteiras você precisa?
                            </label>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <button onclick="ajustarCarteras(-1)" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-cyan); background: transparent; color: var(--accent-cyan); font-size: 1.2rem; cursor: pointer;">-</button>
                                <input type="number" id="regCantidadCarteras" value="1" min="1" readonly style="width: 60px; text-align: center; font-size: 1.5rem; font-weight: bold; background: transparent; border: none; color: var(--accent-cyan);">
                                <button onclick="ajustarCarteras(1)" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-cyan); background: transparent; color: var(--accent-cyan); font-size: 1.2rem; cursor: pointer;">+</button>
                            </div>
                            <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 10px;">
                                Cada carteira = R$ 51,41/mês
                            </small>
                        </div>
                        
                        <!-- Total a pagar -->
                        <div style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">Total Mensal</p>
                            <h2 id="regTotalPagar" style="color: var(--accent-green); font-size: 2.5rem; margin: 0;">R$ 51,41</h2>
                            <small id="regDetalleCarteras" style="color: var(--text-secondary);">1 carteira × R$ 51,41</small>
                        </div>
                        
                        <div id="pixQrContainer" style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <div id="pixLoading">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i>
                                <p class="text-secondary">Gerando código PIX...</p>
                            </div>
                            <div id="pixQrCode" style="display: none;">
                                <img id="pixQrImage" src="" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 180px;">
                                <div style="margin-top: 15px;">
                                    <input type="text" id="pixCopyPaste" readonly style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--accent-cyan); padding: 8px; border-radius: 5px; font-size: 0.7rem; width: 100%;">
                                    <button onclick="copyPixCode()" style="margin-top: 10px; background: var(--accent-cyan); border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; color: #000;">
                                        <i class="fas fa-copy me-1"></i>Copiar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="verificarPago()" id="btnVerificarPago" style="padding: 14px;">
                            Já paguei - Verificar
                        </button>
                        <div class="text-center mt-3">
                            <button class="btn w-100" onclick="solicitarAccesoAdmin()" style="padding: 12px; background: var(--accent-purple); color: #fff; border: none; border-radius: 8px;">
                                <i class="fas fa-gift me-2"></i>Obtener acceso gratis
                            </button>
                        </div>
                        <div class="text-center mt-3">
                            <a href="#" onclick="volverAlRegistro(); return false;" style="color: var(--text-secondary); text-decoration: none;">
                                <i class="fas fa-arrow-left me-1"></i>Voltar ao Cadastro
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Lado Derecho - Branding Profesional -->
        <div id="brandingSide" style="flex: 1.1; background: linear-gradient(145deg, #0c1929 0%, #0a1628 40%, #061220 100%); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 60px; position: relative; overflow: hidden;">
            <!-- Efectos de fondo -->
            <div style="position: absolute; top: 5%; right: 5%; width: 500px; height: 500px; background: radial-gradient(circle, rgba(0,212,255,0.08) 0%, transparent 60%); pointer-events: none;"></div>
            <div style="position: absolute; bottom: 5%; left: 5%; width: 400px; height: 400px; background: radial-gradient(circle, rgba(0,212,255,0.04) 0%, transparent 60%); pointer-events: none;"></div>
            
            <!-- Contenido -->
            <div style="text-align: center; z-index: 1; max-width: 480px;">
                <!-- Icono con animación -->
                <div style="margin-bottom: 45px;">
                    <div style="width: 150px; height: 150px; background: linear-gradient(135deg, rgba(0,212,255,0.15), rgba(0,212,255,0.03)); border-radius: 40px; display: flex; align-items: center; justify-content: center; margin: 0 auto; border: 2px solid rgba(0,212,255,0.2); box-shadow: 0 25px 80px rgba(0,212,255,0.2); animation: floatIcon 4s ease-in-out infinite;">
                        <i class="fas fa-chart-line" style="font-size: 4.5rem; color: #00d4ff; filter: drop-shadow(0 0 25px rgba(0,212,255,0.6));"></i>
                    </div>
                </div>
                
                <!-- Título -->
                <h1 style="font-size: 4rem; font-weight: 800; color: #fff; margin-bottom: 15px; letter-spacing: -1px;">FinanGest</h1>
                <p id="brandingSistema" style="font-size: 1.15rem; color: #00d4ff; letter-spacing: 5px; text-transform: uppercase; margin-bottom: 55px; font-weight: 500;">Sistema Financeiro</p>
                
                <!-- Botón Instalar -->
                <button id="installBtn" onclick="installApp()" 
                    style="padding: 18px 55px; background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%); border: none; border-radius: 50px; color: #000; font-size: 1.15rem; font-weight: 700; cursor: pointer; box-shadow: 0 10px 40px rgba(0,212,255,0.4); transition: all 0.3s; margin-bottom: 60px;"
                    onmouseover="this.style.transform='translateY(-4px) scale(1.02)'; this.style.boxShadow='0 15px 50px rgba(0,212,255,0.5)'"
                    onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 10px 40px rgba(0,212,255,0.4)'">
                    <i class="fas fa-download" style="margin-right: 12px;"></i>Instalar Aplicativo
                </button>
                
                <!-- Features Card -->
                <div style="background: rgba(13,25,41,0.6); border-radius: 24px; padding: 35px 40px; border: 1px solid rgba(0,212,255,0.1); backdrop-filter: blur(10px);">
                    <div style="display: flex; align-items: center; gap: 18px; margin-bottom: 25px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, rgba(0,212,255,0.2), rgba(0,212,255,0.05)); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-users" style="color: #00d4ff; font-size: 1.2rem;"></i>
                        </div>
                        <div style="text-align: left;">
                            <p id="brandingControl" style="color: #fff; font-weight: 600; margin: 0 0 4px 0; font-size: 1.05rem;">Controle de Clientes</p>
                            <p id="brandingControlDesc" style="color: #6b7280; font-size: 0.9rem; margin: 0;">Gerencie todos os seus clientes facilmente</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 18px; margin-bottom: 25px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, rgba(46,204,113,0.2), rgba(46,204,113,0.05)); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-money-bill-wave" style="color: #2ecc71; font-size: 1.2rem;"></i>
                        </div>
                        <div style="text-align: left;">
                            <p id="brandingSeguimiento" style="color: #fff; font-weight: 600; margin: 0 0 4px 0; font-size: 1.05rem;">Acompanhamento de Pagamentos</p>
                            <p id="brandingSeguimientoDesc" style="color: #6b7280; font-size: 0.9rem; margin: 0;">Cobranças automáticas e alertas</p>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 18px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, rgba(168,85,247,0.2), rgba(168,85,247,0.05)); border-radius: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                            <i class="fas fa-chart-bar" style="color: #a855f7; font-size: 1.2rem;"></i>
                        </div>
                        <div style="text-align: left;">
                            <p id="brandingReportes" style="color: #fff; font-weight: 600; margin: 0 0 4px 0; font-size: 1.05rem;">Relatórios em Tempo Real</p>
                            <p id="brandingReportesDesc" style="color: #6b7280; font-size: 0.9rem; margin: 0;">Estatísticas e gráficos detalhados</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <style>
        @keyframes floatIcon { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-12px); } }
        #authScreen input::placeholder { color: #4b5563 !important; }
    </style>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    
    <!-- Toast de notificación -->
    <div id="toastNotification" class="toast-notification">
        <i class="fas fa-check-circle"></i>
        <span id="toastMessage">Mensaje</span>
    </div>
    
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">FinanGest<br><span>Software</span></div>
                <button onclick="sincronizarDatos()" style="background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; margin-left: 10px; transition: all 0.2s;" title="Sincronizar datos" onmouseover="this.style.color='var(--primary)'; this.style.transform='rotate(180deg)'" onmouseout="this.style.color='var(--text-secondary)'; this.style.transform='rotate(0deg)'">
                    <i class="fas fa-sync-alt" style="font-size: 1.1rem;"></i>
                </button>
            </div>
            <!-- Reloj del Servidor UTC -->
            <div style="padding: 8px 20px; text-align: center; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                <div style="color: var(--text-secondary); font-size: 0.7rem; font-family: monospace; display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <i class="fas fa-clock" style="font-size: 0.75rem;"></i>
                    <span id="serverTimeUTC">--:--:--</span>
                    <span style="opacity: 0.6;">UTC</span>
                </div>
            </div>
            <div class="nav-menu" id="navMenu">
                <!-- Se llena dinámicamente -->
            </div>
            <div style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
                <div class="nav-item" onclick="logout()" style="border-radius: 8px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <i class="fas fa-sign-out-alt"></i><span data-translate="cerrarSesion">Cerrar Sesión</span>
                </div>
            </div>
        </nav>
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="topbar">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-link d-md-none" onclick="toggleSidebar()" style="color: var(--text-primary);">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="user-info">
                    <!-- Selector de Cartera -->
                    <div class="cartera-selector" style="position: relative; margin-right: 15px;">
                        <button id="carteraBtn" onclick="toggleCarteraDropdown()" style="background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 14px; color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: all 0.3s;">
                            <i class="fas fa-wallet" style="color: var(--accent-cyan);"></i>
                            <span id="carteraActualNombre">Cartera Principal</span>
                            <i class="fas fa-chevron-down" style="font-size: 0.7rem; color: var(--text-secondary);"></i>
                        </button>
                        <div id="carteraDropdown" style="display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 10px; min-width: 220px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); z-index: 1000; overflow: hidden;">
                            <div style="padding: 12px 15px; border-bottom: 1px solid var(--border-color); background: var(--bg-hover);">
                                <span style="color: var(--text-secondary); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">Mis Carteras</span>
                            </div>
                            <div id="carterasList" style="max-height: 200px; overflow-y: auto;">
                                <!-- Las carteras se cargan dinámicamente -->
                            </div>
                            <div style="padding: 10px; border-top: 1px solid var(--border-color);">
                                <button onclick="mostrarModalNuevaCartera()" style="width: 100%; background: transparent; border: 1px dashed var(--accent-cyan); border-radius: 6px; padding: 8px; color: var(--accent-cyan); cursor: pointer; font-size: 0.85rem; transition: all 0.3s; margin-bottom: 8px;">
                                    <i class="fas fa-plus me-2"></i>Nueva Cartera
                                </button>
                                <button onclick="mostrarGestionSuscripciones()" style="width: 100%; background: transparent; border: 1px solid var(--accent-purple); border-radius: 6px; padding: 8px; color: var(--accent-purple); cursor: pointer; font-size: 0.85rem; transition: all 0.3s;">
                                    <i class="fas fa-credit-card me-2"></i>Gestionar Suscripciones
                                </button>
                            </div>
                        </div>
                    </div>
                    <span id="userName" class="d-none d-md-block"></span>
                    <div class="user-avatar" id="userAvatar">U</div>
                </div>
            </div>
            <!-- Spinner de carga del contenido -->
            <div id="contentLoader" style="display: none; position: absolute; top: 70px; left: 0; right: 0; bottom: 0; background: var(--bg-primary); z-index: 100; justify-content: center; align-items: center; flex-direction: column;">
                <div style="width: 50px; height: 50px; border: 4px solid var(--bg-hover); border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;"></div>
                <p style="margin-top: 15px; color: var(--text-secondary); font-size: 0.95rem;">Cargando...</p>
            </div>
            
            <!-- Sección de Bienvenida (sin carteras) -->
            <div id="sinCarteraInicio" class="section">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; text-align: center; padding: 40px 20px;">
                    <div style="width: 150px; height: 150px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 40px; box-shadow: 0 20px 60px rgba(0,212,255,0.3);">
                        <i class="fas fa-wallet fa-4x" style="color: #fff;"></i>
                    </div>
                    <h1 style="color: var(--text-primary); font-size: 2.5rem; margin-bottom: 15px;">¡Bienvenido a FinanGest!</h1>
                    <p style="color: var(--text-secondary); font-size: 1.2rem; max-width: 500px; margin-bottom: 40px; line-height: 1.6;">
                        Para comenzar a gestionar tus clientes, cobros y gastos, primero necesitas crear tu primera cartera.
                    </p>
                    <button onclick="mostrarModalNuevaCartera()" class="btn btn-lg" style="background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); color: #fff; font-size: 1.2rem; padding: 18px 50px; border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0,212,255,0.4); transition: all 0.3s;">
                        <i class="fas fa-plus-circle me-3"></i>Crear Mi Primera Cartera
                    </button>
                    <div style="margin-top: 50px; padding: 30px; background: var(--bg-card); border-radius: 15px; max-width: 600px; border: 1px solid var(--border-color);">
                        <h5 style="color: var(--accent-cyan); margin-bottom: 20px;"><i class="fas fa-info-circle me-2"></i>¿Qué es una cartera?</h5>
                        <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                            Una cartera te permite organizar tus clientes y préstamos. Puedes tener múltiples carteras para separar diferentes negocios, zonas o tipos de clientes.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Sección Cartera Bloqueada (tiene carteras pero ninguna desbloqueada) -->
            <div id="carteraBloqueada" class="section">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 70vh; text-align: center; padding: 40px 20px;">
                    <div style="width: 150px; height: 150px; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 40px; box-shadow: 0 20px 60px rgba(0,212,255,0.3);">
                        <i class="fas fa-lock fa-4x" style="color: #fff;"></i>
                    </div>
                    <h1 style="color: var(--text-primary); font-size: 2.5rem; margin-bottom: 15px;">Selecciona una Cartera</h1>
                    <p style="color: var(--text-secondary); font-size: 1.2rem; max-width: 500px; margin-bottom: 40px; line-height: 1.6;">
                        Tus carteras están protegidas con contraseña. Haz click en el botón de arriba para seleccionar una cartera e ingresar tu contraseña.
                    </p>
                    <div style="margin-top: 20px; padding: 30px; background: var(--bg-card); border-radius: 15px; max-width: 600px; border: 1px solid var(--border-color);">
                        <h5 style="color: var(--accent-cyan); margin-bottom: 20px;"><i class="fas fa-shield-alt me-2"></i>Seguridad</h5>
                        <p style="color: var(--text-secondary); margin: 0; line-height: 1.6;">
                            Cada cartera tiene su propia contraseña para proteger tus datos. Si olvidaste tu contraseña, puedes recuperarla desde el menú de la cartera.
                        </p>
                    </div>
                </div>
            </div>
            
            <!-- Historial de Carteras Section -->
            <div id="historialCarteras" class="section">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <button id="btnVolverHistorialCarteras" onclick="showSection('carteraBloqueada')" style="display: none; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; color: var(--text-primary); cursor: pointer;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2" style="color: var(--accent-cyan);"></i>Historial de Carteras</h5>
                </div>
                
                <!-- Carteras Eliminadas -->
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-wallet me-2" style="color: var(--accent-red);"></i>Carteras Eliminadas</h6>
                    <div class="mb-3">
                        <input type="text" id="buscarCarteraEliminadaHist" class="form-control form-control-dark" placeholder="🔍 Buscar cartera..." oninput="filtrarCarterasEliminadasHist()">
                    </div>
                    <div id="carterasEliminadasHist"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            
            <!-- Dashboard Section -->
            <div id="dashboard" class="section">
                <!-- Filtro de fecha para stats -->
                <div class="d-flex align-items-center gap-3 mb-3 flex-wrap">
                    <input type="date" id="dashboardFecha" class="form-control form-control-dark" style="width: 160px;" onchange="filtrarDashboardPorFecha()">
                    <button class="btn btn-sm" style="background: var(--accent-green); color: #000; font-weight: 600;" onclick="mostrarSoloHoy()">
                        <i class="fas fa-calendar-day me-1"></i><span data-translate="hoy">Hoy</span>
                    </button>
                    <span id="dashboardFechaLabel" class="text-secondary" style="font-size: 0.85rem;"></span>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-2 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="statClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i><span data-translate="clientesActivos">Clientes Activos</span></div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="statPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i><span data-translate="totalPrestado">Total Prestado</span></div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="statCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i><span data-translate="totalCobrado">Total Cobrado</span></div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="stat-card orange">
                            <div class="stat-value" id="statPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i><span data-translate="pendiente">Pendiente</span></div>
                        </div>
                    </div>
                    <div class="col-md-2 col-6">
                        <div class="stat-card purple">
                            <div class="stat-value" id="statGastos">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-receipt me-2" style="color: #ff8c00;"></i><span data-translate="gastos">Gastos</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Contraseña de Caja -->
                <div class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-purple);">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div style="width: 40px; height: 40px; background: var(--accent-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                <i class="fas fa-wallet" style="color: #fff;"></i>
                            </div>
                            <div>
                                <strong>🔐 <span data-translate="contraseniaCaja">Contraseña de Caja</span></strong>
                                <p class="text-secondary mb-0" style="font-size: 0.85rem;"><span data-translate="protegeIngresoCaja">Protege el ingreso de dinero a la caja con una contraseña</span></p>
                            </div>
                        </div>
                        <button class="btn" style="background: var(--accent-purple); color: #fff;" onclick="configurarPasswordCaja()">
                            <i class="fas fa-key me-2"></i><span data-translate="configurar">Configurar</span>
                        </button>
                    </div>
                </div>
                
                <!-- Caja Inicial, Caja Actual y Caja Total -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark caja-card" style="border: 2px solid var(--accent-purple);">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-2" style="color: var(--accent-purple);"><i class="fas fa-history me-2"></i>Caja Inicial</h6>
                                    <div class="stat-value" id="cajaInicialValue" style="font-size: 1.5rem; color: var(--accent-purple);">R$ 0.00</div>
                                    <small class="text-secondary" id="cajaInicialSource">Total del día anterior</small>
                                </div>
                                <i class="fas fa-piggy-bank" style="font-size: 2.5rem; color: var(--accent-purple); opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark caja-card" style="border: 2px solid var(--accent-cyan);">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-2" style="color: var(--accent-cyan);"><i class="fas fa-wallet me-2"></i>Caja Actual</h6>
                                    <div class="stat-value" id="cajaActualValue" style="font-size: 1.5rem; color: var(--accent-cyan);">R$ 0.00</div>
                                    <small class="text-secondary mb-2" style="display: block;">+ Cobros - Préstamos - Gastos</small>
                                    <div class="d-flex align-items-center gap-2">
                                        <span style="font-size: 0.8rem; color: var(--text-secondary);">R$</span>
                                        <input type="number" id="cajaActualInput" class="form-control form-control-dark" 
                                            style="width: 100px; font-size: 0.85rem; font-weight: 700; background: var(--bg-hover); border: 1px solid var(--accent-cyan); border-radius: 4px; color: var(--accent-cyan); text-align: right; padding: 6px 8px;"
                                            placeholder="0" step="1">
                                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000; font-weight: 600;" onclick="agregarDineroCaja()">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <i class="fas fa-wallet" style="font-size: 2.5rem; color: var(--accent-cyan); opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark caja-card" style="border: 2px solid var(--accent-green);">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <h6 class="mb-2" style="color: var(--accent-green);"><i class="fas fa-coins me-2"></i>Caja Total</h6>
                                    <div class="stat-value" id="cajaTotalValue" style="font-size: 1.5rem; color: var(--accent-green);">R$ 0.00</div>
                                    <small class="text-secondary">Actual + Pendiente = Inicial de mañana</small>
                                </div>
                                <i class="fas fa-coins" style="font-size: 2.5rem; color: var(--accent-green); opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card-dark h-100">
                            <h5 class="mb-4"><i class="fas fa-user-plus me-2" style="color: var(--accent-green);"></i><span data-translate="clientesHoy">Clientes de Hoy</span></h5>
                            <div id="cobrosHoyPreview" style="max-height: 250px; overflow-y: auto; padding-right: 10px;"><!-- Se llena dinámicamente --></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card-dark h-100">
                            <h5 class="mb-4"><i class="fas fa-exclamation-triangle me-2" style="color: var(--accent-yellow);"></i><span data-translate="clientesAtrasados">Clientes Atrasados</span></h5>
                            <div id="clientesAtrasadosPreview" style="max-height: 400px; overflow-y: auto;">
                                <p class="text-secondary text-center" data-translate="cargando">Cargando...</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card-dark h-100">
                            <h5 class="mb-4"><i class="fas fa-trophy me-2" style="color: var(--accent-green);"></i><span data-translate="mejoresClientes">Mejores Clientes</span></h5>
                            <div id="mejoresClientesPreview" style="max-height: 200px; overflow-y: auto; padding-right: 10px;">
                                <p class="text-secondary text-center" data-translate="cargando">Cargando...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Segunda fila del dashboard -->
                <div class="row g-4 mt-2">
                    <div class="col-lg-4">
                        <div class="card-dark h-100">
                            <h5 class="mb-4"><i class="fas fa-calendar-week me-2" style="color: var(--accent-cyan);"></i><span data-translate="resumenSemana">Resumen de la Semana</span></h5>
                            <div id="resumenSemanaPreview">
                                <div class="d-flex justify-content-between mb-3 pb-2" style="border-bottom: 1px solid var(--border-color);">
                                    <span class="text-secondary" data-translate="nuevosClientes">Nuevos clientes</span>
                                    <span id="semanaNuevosClientes" style="color: var(--accent-cyan); font-weight: bold;">0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 pb-2" style="border-bottom: 1px solid var(--border-color);">
                                    <span class="text-secondary" data-translate="prestamosRealizados">Préstamos realizados</span>
                                    <span id="semanaPrestamos" style="color: var(--accent-green); font-weight: bold;">R$ 0</span>
                                </div>
                                <div class="d-flex justify-content-between mb-3 pb-2" style="border-bottom: 1px solid var(--border-color);">
                                    <span class="text-secondary" data-translate="cobrosRecibidos">Cobros recibidos</span>
                                    <span id="semanaCobros" style="color: var(--accent-yellow); font-weight: bold;">R$ 0</span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span class="text-secondary" data-translate="gananciaEstimada">Ganancia estimada</span>
                                    <span id="semanaGanancia" style="color: var(--accent-purple); font-weight: bold;">R$ 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tercera fila - Actividad reciente -->
                <div class="row g-4 mt-2">
                    <div class="col-12">
                        <div class="card-dark">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5 class="mb-0"><i class="fas fa-history me-2" style="color: var(--accent-purple);"></i><span data-translate="actividadReciente">Actividad Reciente</span></h5>
                                <div style="width: 200px;">
                                    <input type="text" class="form-control form-control-dark form-control-sm" id="buscarActividad" placeholder="Buscar cliente..." oninput="renderActividadReciente()">
                                </div>
                            </div>
                            <div id="actividadReciente" style="min-height: 300px; max-height: 400px; overflow-y: auto; padding-right: 10px;">
                                <p class="text-secondary text-center" data-translate="cargando">Cargando actividad...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Clientes Section -->
            <div id="clientes" class="section">
                <!-- Mensaje cuando no hay cartera seleccionada -->
                <div id="sinCarteraMsg" style="display: none;">
                    <div class="text-center py-5">
                        <div style="width: 120px; height: 120px; background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(138,43,226,0.1)); border-radius: 50%; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color);">
                            <i class="fas fa-folder-open fa-3x" style="color: var(--accent-cyan);"></i>
                        </div>
                        <h4 style="color: #fff; margin-bottom: 15px;">No tienes carteras</h4>
                        <p style="color: var(--text-secondary); margin-bottom: 25px; max-width: 400px; margin-left: auto; margin-right: auto;">
                            Crea tu primera cartera para comenzar a registrar clientes, cobros y gastos.
                        </p>
                        <button class="btn btn-primary-custom btn-lg" onclick="abrirModalNuevaCartera()">
                            <i class="fas fa-plus me-2"></i>Crear Primera Cartera
                        </button>
                    </div>
                </div>
                
                <!-- Contenido normal de clientes (se oculta si no hay cartera) -->
                <div id="clientesContent">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-users me-2" style="color: var(--accent-cyan);"></i><span data-translate="gestionClientes">Gestión de Clientes</span></h5>
                    <button class="btn btn-primary-custom" onclick="openNewClientModal()">
                        <i class="fas fa-plus me-2"></i><span data-translate="nuevoCliente">Nuevo Cliente</span>
                    </button>
                </div>
                
                <!-- Sistema de Llave de Edición -->
                <!-- Mensaje cuando el admin bloqueó la llave -->
                <div id="editAdminBlocked" class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-red); display: none;">
                    <div class="d-flex align-items-center">
                        <div style="width: 50px; height: 50px; background: var(--accent-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 20px rgba(255,82,82,0.6);">
                            <i class="fas fa-ban" style="color: #fff; font-size: 1.3rem;"></i>
                        </div>
                        <div>
                            <strong style="color: var(--accent-red);">🚫 Llave Bloqueada por Administrador</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;">El administrador ha bloqueado tu llave de edición. Contacta al admin para desbloquearla.</p>
                        </div>
                    </div>
                </div>
                
                <div id="editLockSystem" class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-red); display: none;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <div id="editLockIcon" style="width: 50px; height: 50px; background: var(--accent-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; box-shadow: 0 0 20px rgba(255,82,82,0.6);">
                                <i id="editLockIconI" class="fas fa-lock" style="color: #fff; font-size: 1.3rem;"></i>
                            </div>
                            <div>
                                <strong id="editLockTitle" style="color: var(--accent-red);">🔒 Edición Bloqueada</strong>
                                <p id="editLockDesc" class="text-secondary mb-0" style="font-size: 0.85rem;">Ingresa tu contraseña para editar clientes</p>
                            </div>
                        </div>
                        <div id="editUnlockForm" class="d-flex align-items-center gap-2">
                            <input type="password" id="editUnlockPassword" class="form-control form-control-dark" placeholder="Contraseña" style="width: 150px;">
                            <button id="editToggleBtn" class="btn" style="background: var(--accent-red); color: #fff;" onclick="toggleEditLockBtn()">
                                <i id="editToggleBtnIcon" class="fas fa-lock"></i>
                            </button>
                        </div>
                        <button class="btn btn-sm" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="mostrarConfigEditPassword()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Crear Contraseña de Edición (Primera vez) -->
                <div id="editCreatePassword" class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-yellow); display: none;">
                    <div class="d-flex align-items-center mb-3">
                        <div style="width: 40px; height: 40px; background: var(--accent-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="fas fa-key" style="color: #000;"></i>
                        </div>
                        <div>
                            <strong>🔐 Crear Contraseña de Edición</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;">Protege la edición de clientes con una contraseña</p>
                        </div>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-5">
                            <label class="form-label text-secondary" style="font-size: 0.85rem;">Nueva contraseña</label>
                            <input type="password" id="newEditPass" class="form-control form-control-dark" placeholder="Mínimo 4 caracteres">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label text-secondary" style="font-size: 0.85rem;">Confirmar contraseña</label>
                            <input type="password" id="confirmEditPass" class="form-control form-control-dark" placeholder="Repetir contraseña">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label" style="visibility: hidden;">.</label>
                            <button class="btn btn-success-custom w-100" onclick="crearEditPassword()">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Configurar Contraseña de Edición -->
                <div id="editConfigModal" class="card-dark p-3 mb-4" style="border: 1px solid var(--border-color); display: none;">
                    <div class="mb-3">
                        <strong><i class="fas fa-cog me-2"></i>Configurar Contraseña de Edición</strong>
                    </div>
                    <div id="editPasswordSection"></div>
                </div>
                
                <!-- Filtros de clientes -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i><span data-translate="tipoCliente">Tipo de Cliente</span></label>
                            <select class="form-control form-control-dark" id="clientesFiltroTipo" onchange="renderClientes()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="nuevo" data-translate-opt="tipoNuevo">🆕 Novo</option>
                                <option value="bueno" data-translate-opt="tipoBueno">✅ Bom Cliente</option>
                                <option value="regular" data-translate-opt="tipoRegular">⚠️ Regular</option>
                                <option value="malo" data-translate-opt="tipoMalo">❌ Mau Pagador</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i><span data-translate="estado">Estado</span></label>
                            <select class="form-control form-control-dark" id="clientesFiltroEstado" onchange="renderClientes()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="ativo" data-translate="activos">Activos</option>
                                <option value="finalizado" data-translate="finalizados">Finalizados</option>
                                <option value="atrasado" data-translate="atrasados">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-search me-2"></i><span data-translate="buscar">Buscar</span></label>
                            <input type="text" class="form-control form-control-dark" id="clientesBuscar" data-translate-placeholder="nombreTelefono" placeholder="Nombre o teléfono..." oninput="renderClientes()">
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo -->
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('nuevo')">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="clientesNuevos">0</div>
                            <small class="text-secondary">🆕 <span data-translate="nuevos">Nuevos</span></small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('bueno')">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="clientesBuenos">0</div>
                            <small class="text-secondary">✅ <span data-translate="buenos">Buenos</span></small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('regular')">
                            <div style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: bold;" id="clientesRegulares">0</div>
                            <small class="text-secondary">⚠️ <span data-translate="regulares">Regulares</span></small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('malo')">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="clientesMalos">0</div>
                            <small class="text-secondary">❌ <span data-translate="malaPaga">Mala Paga</span></small>
                        </div>
                    </div>
                </div>
                
                <div class="card-dark">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th data-translate="cliente">Cliente</th>
                                    <th data-translate="tipo">Tipo</th>
                                    <th data-translate="telefono">Teléfono</th>
                                    <th data-translate="prestado">Prestado</th>
                                    <th data-translate="cobrado">Cobrado</th>
                                    <th data-translate="restante">Restante</th>
                                    <th data-translate="parcelas">Parcelas</th>
                                    <th data-translate="atrasos">Atrasos</th>
                                    <th data-translate="estado">Estado</th>
                                    <th data-translate="acciones">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientesTable"><!-- Se llena dinámicamente --></tbody>
                        </table>
                    </div>
                </div>
                </div><!-- Fin clientesContent -->
            </div>
            <!-- Estadísticas Section -->
            <div id="estadisticas" class="section">
                <h5 class="mb-4"><i class="fas fa-chart-bar me-2" style="color: var(--accent-purple);"></i><span data-translate="misEstadisticas">Mis Estadísticas</span></h5>
                
                <!-- Filtros de fecha -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-eye me-2"></i><span data-translate="verPor">Ver por</span></label>
                            <select class="form-control form-control-dark" id="estVista" onchange="renderEstadisticas()">
                                <option value="dia" data-translate="diaEspecifico">Día específico</option>
                                <option value="semana" data-translate="estaSemana">Esta semana</option>
                                <option value="mes" selected data-translate="esteMes">Este mes</option>
                                <option value="anio" data-translate="esteAnio">Este año</option>
                                <option value="todo" data-translate="todoTiempo">Todo el tiempo</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i><span data-translate="fecha">Fecha</span></label>
                            <input type="date" class="form-control form-control-dark" id="estFecha" onchange="renderEstadisticas()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i><span data-translate="mes">Mes</span></label>
                            <select class="form-control form-control-dark" id="estMes" onchange="renderEstadisticas()">
                                <option value="0" data-translate="enero">Enero</option><option value="1" data-translate="febrero">Febrero</option><option value="2" data-translate="marzo">Marzo</option>
                                <option value="3" data-translate="abril">Abril</option><option value="4" data-translate="mayo">Mayo</option><option value="5" data-translate="junio">Junio</option>
                                <option value="6" data-translate="julio">Julio</option><option value="7" data-translate="agosto">Agosto</option><option value="8" data-translate="septiembre">Septiembre</option>
                                <option value="9" data-translate="octubre">Octubre</option><option value="10" data-translate="noviembre">Noviembre</option><option value="11" data-translate="diciembre">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i><span data-translate="anio">Año</span></label>
                            <select class="form-control form-control-dark" id="estAnio" onchange="renderEstadisticas()"></select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen principal -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="estClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i><span data-translate="clientes">Clientes</span></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="estPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i><span data-translate="prestado">Prestado</span></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="estCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i><span data-translate="cobrado">Cobrado</span></div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red">
                            <div class="stat-value" id="estPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i><span data-translate="pendiente">Pendiente</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Más estadísticas -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2" style="color: var(--accent-green);"></i><span data-translate="pagosRecibidos">Pagos Recibidos</span></h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estPagosCount">0</div>
                                    <small class="text-secondary" data-translate="cantidad">Cantidad</small>
                                </div>
                                <div class="col-6">
                                    <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estPagosTotal">R$ 0</div>
                                    <small class="text-secondary" data-translate="total">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-wallet me-2" style="color: var(--accent-red);"></i><span data-translate="gastos">Gastos</span></h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estGastosCount">0</div>
                                    <small class="text-secondary" data-translate="cantidad">Cantidad</small>
                                </div>
                                <div class="col-6">
                                    <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estGastosTotal">R$ 0</div>
                                    <small class="text-secondary" data-translate="total">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-balance-scale me-2" style="color: var(--accent-cyan);"></i><span data-translate="balance">Balance</span></h6>
                            <div class="text-center">
                                <div style="font-size: 2rem; font-weight: bold;" id="estBalance">R$ 0</div>
                                <small class="text-secondary" data-translate="cobradoMenosGastos">Cobrado - Gastos</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Por tipo de cliente -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i><span data-translate="porTipoCliente">Por Tipo de Cliente</span></h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="estNuevos">0</div>
                            <small class="text-secondary">🆕 <span data-translate="nuevos">Nuevos</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="estBuenos">0</div>
                            <small class="text-secondary">✅ <span data-translate="buenos">Buenos</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="estRegulares">0</div>
                            <small class="text-secondary">⚠️ <span data-translate="regulares">Regulares</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="estMalos">0</div>
                            <small class="text-secondary">❌ <span data-translate="malaPaga">Mala Paga</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Por estado -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-tasks me-2" style="color: var(--accent-cyan);"></i><span data-translate="porEstado">Por Estado</span></h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estActivos">0</div>
                            <small class="text-secondary" data-translate="activos">Activos</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="estFinalizados">0</div>
                            <small class="text-secondary" data-translate="finalizados">Finalizados</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estAtrasados">0</div>
                            <small class="text-secondary" data-translate="atrasados">Atrasados</small>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de actividad reciente -->
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i><span data-translate="actividadPeriodo">Actividad del Período</span></h6>
                    <div id="estActividad" style="max-height: 300px; overflow-y: auto; padding-right: 10px;">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
            <!-- Cobros Section -->
            <div id="cobros" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-calendar-day me-2" style="color: var(--accent-yellow);"></i><span data-translate="cobros">Cobros del Día</span></h5>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary-custom btn-sm" onclick="setFechaHoy()">
                            <i class="fas fa-calendar-check me-1"></i><span data-translate="hoy">Hoy</span>
                        </button>
                        <input type="date" class="form-control form-control-dark" id="fechaCobros" style="width: auto;" onchange="renderCobros()">
                    </div>
                </div>
                <!-- Buscador de cobros -->
                <div class="card-dark mb-4">
                    <div class="row g-3 align-items-end">
                        <div class="col-md-8">
                            <label class="form-label"><i class="fas fa-search me-2"></i><span data-translate="buscarCliente">Buscar Cliente</span></label>
                            <input type="text" class="form-control form-control-dark" id="cobrosBuscar" data-translate-placeholder="nombreTelefono" placeholder="Nombre o teléfono..." oninput="renderCobros()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label"><i class="fas fa-filter me-2"></i><span data-translate="estado">Estado</span></label>
                            <select class="form-control form-control-dark" id="cobrosFiltroEstado" onchange="renderCobros()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="pendiente" data-translate="pendientes">Pendientes</option>
                                <option value="pagado" data-translate="pagadosHoy">Pagados Hoy</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="cobrosResumen" class="row g-3 mb-4">
                    <!-- Resumen de cobros -->
                </div>
                <div class="card-dark">
                    <div id="cobrosLista"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Gastos Section -->
            <div id="gastos" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-wallet me-2" style="color: #ff8c00;"></i><span data-translate="gastosPersonales">Gastos Personales</span></h5>
                    <button class="btn btn-primary-custom" onclick="openGastoModal()">
                        <i class="fas fa-plus me-2"></i><span data-translate="nuevoGasto">Nuevo Gasto</span>
                    </button>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card orange">
                            <div class="stat-value" id="gastoHoy">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-day me-2"></i><span data-translate="gastosHoy">Gastos de Hoy</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card orange">
                            <div class="stat-value" id="gastoSemana">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-week me-2"></i><span data-translate="estaSemana">Esta Semana</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card orange">
                            <div class="stat-value" id="gastoMes">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-alt me-2"></i><span data-translate="esteMes">Este Mes</span></div>
                        </div>
                    </div>
                </div>
                <div class="card-dark mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-filter me-2"></i><span data-translate="filtrarFecha">Filtrar por fecha</span></h6>
                        <div class="d-flex gap-2">
                            <input type="date" class="form-control form-control-dark" id="gastoFechaFiltro" style="width: auto;" onchange="renderGastos()">
                            <button class="btn btn-sm btn-primary-custom" onclick="setGastoHoy()" data-translate="hoy">Hoy</button>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <div id="gastosLista"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Microseguros Section -->
            <div id="microseguros" class="section">
                <h5 class="mb-4"><i class="fas fa-shield-alt me-2" style="color: var(--accent-purple);"></i><span data-translate="microseguros">Microseguros</span></h5>
                
                <!-- Estadísticas -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="microseguroHoy">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-day me-2"></i><span data-translate="hoy">Hoy</span></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="microseguroSemana">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-week me-2"></i><span data-translate="ultimos7dias">Últimos 7 días</span></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="microseguroMes">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-alt me-2"></i><span data-translate="esteMes">Este Mes</span></div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="microseguroAnio">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar me-2"></i><span data-translate="esteAnio">Este Año</span></div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtro por fecha y búsqueda -->
                <div class="card-dark mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div class="d-flex gap-2 align-items-center">
                            <i class="fas fa-search text-secondary"></i>
                            <input type="text" class="form-control form-control-dark" id="microseguroBusqueda" data-translate-placeholder="buscarNombreTelefono" placeholder="Buscar por nombre o teléfono..." style="width: 200px;" oninput="renderMicroseguros()">
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="date" class="form-control form-control-dark" id="microseguroFechaInicio" style="width: auto;" onchange="renderMicroseguros()">
                            <span class="text-secondary">a</span>
                            <input type="date" class="form-control form-control-dark" id="microseguroFechaFin" style="width: auto;" onchange="renderMicroseguros()">
                            <button class="btn btn-sm btn-primary-custom" onclick="setMicroseguroHoy()" data-translate="hoy">Hoy</button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="resetMicroseguroFiltro()"><i class="fas fa-undo"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de microseguros -->
                <div class="card-dark">
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th data-translate="cliente">Cliente</th>
                                    <th data-translate="fecha">Fecha</th>
                                    <th data-translate="microseguro">Microseguro</th>
                                    <th data-translate="montoPrestamo">Monto Préstamo</th>
                                </tr>
                            </thead>
                            <tbody id="microsegurosLista">
                                <tr><td colspan="4" class="text-center text-secondary" data-translate="cargando">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Historial Section (Trabajadores) -->
            <div id="historial" class="section">
                <h5 class="mb-4"><i class="fas fa-history me-2" style="color: var(--accent-purple);"></i><span data-translate="miHistorialCompleto">Mi Historial Completo</span></h5>
                
                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i><span data-translate="anio">Año</span></label>
                            <select class="form-control form-control-dark" id="historialAnio" onchange="renderHistorial()">
                                <!-- Se llena dinámicamente -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i><span data-translate="mes">Mês</span></label>
                            <select class="form-control form-control-dark" id="historialMes" onchange="renderHistorial()">
                                <option value="" data-translate="todosMeses">Todos os meses</option>
                                <option value="0" data-translate-opt="enero">Janeiro</option>
                                <option value="1" data-translate-opt="febrero">Fevereiro</option>
                                <option value="2" data-translate-opt="marzo">Março</option>
                                <option value="3" data-translate-opt="abril">Abril</option>
                                <option value="4" data-translate-opt="mayo">Maio</option>
                                <option value="5" data-translate-opt="junio">Junho</option>
                                <option value="6" data-translate-opt="julio">Julho</option>
                                <option value="7" data-translate-opt="agosto">Agosto</option>
                                <option value="8" data-translate-opt="septiembre">Setembro</option>
                                <option value="9" data-translate-opt="octubre">Outubro</option>
                                <option value="10" data-translate-opt="noviembre">Novembro</option>
                                <option value="11" data-translate-opt="diciembre">Dezembro</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-day me-2"></i><span data-translate="diaEspecifico">Dia específico</span></label>
                            <input type="date" class="form-control form-control-dark" id="historialDia" onchange="renderHistorial()">
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i><span data-translate="estado">Estado</span></label>
                            <select class="form-control form-control-dark" id="historialEstado" onchange="renderHistorial()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="ativo" data-translate="activos">Activos</option>
                                <option value="finalizado" data-translate="finalizados">Finalizados</option>
                                <option value="atrasado" data-translate="atrasados">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i><span data-translate="tipoCliente">Tipo de Cliente</span></label>
                            <select class="form-control form-control-dark" id="historialTipo" onchange="renderHistorial()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="nuevo" data-translate-opt="tipoNuevo">🆕 Novo</option>
                                <option value="bueno" data-translate-opt="tipoBueno">✅ Bom Cliente</option>
                                <option value="regular" data-translate-opt="tipoRegular">⚠️ Regular</option>
                                <option value="malo" data-translate-opt="tipoMalo">❌ Mau Pagador</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo de cliente -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i><span data-translate="porTipoCliente">Por Tipo de Cliente</span></h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="histNuevos">0</div>
                            <small class="text-secondary">🆕 <span data-translate="nuevos">Novos</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="histBuenos">0</div>
                            <small class="text-secondary">✅ <span data-translate="buenos">Bons</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="histRegulares">0</div>
                            <small class="text-secondary">⚠️ <span data-translate="regulares">Regulares</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="histMalos">0</div>
                            <small class="text-secondary">❌ <span data-translate="malaPaga">Mau Pagador</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="histTotalClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i>Total Clientes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="histTotalPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i>Total Prestado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="histTotalCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i>Total Cobrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red">
                            <div class="stat-value" id="histTotalPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i>Pendiente</div>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por estado -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2" style="color: var(--accent-cyan);"></i><span data-translate="resumenPorEstado">Resumen por Estado</span></h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="histActivos">0</div>
                            <small class="text-secondary" data-translate="activos">Activos</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="histFinalizados">0</div>
                            <small class="text-secondary" data-translate="finalizados">Finalizados</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="histAtrasados">0</div>
                            <small class="text-secondary" data-translate="atrasados">Atrasados</small>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de clientes -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i><span data-translate="registroClientes">Registro de Clientes</span></h6>
                        <button class="btn btn-sm btn-primary-custom" onclick="limpiarFiltrosHistorial()">
                            <i class="fas fa-redo me-1"></i><span data-translate="limpiarFiltros">Limpiar Filtros</span>
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th data-translate="fecha">Fecha</th>
                                    <th data-translate="cliente">Cliente</th>
                                    <th data-translate="tipo">Tipo</th>
                                    <th data-translate="telefono">Teléfono</th>
                                    <th data-translate="prestado">Prestado</th>
                                    <th data-translate="cobrado">Cobrado</th>
                                    <th data-translate="pendiente">Pendiente</th>
                                    <th data-translate="estado">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="historialTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Historial de pagos recibidos -->
                <div class="card-dark mt-4">
                    <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2" style="color: var(--accent-green);"></i><span data-translate="ultimosPagos">Últimos Pagos Recibidos</span></h6>
                    <div id="historialPagos"><!-- Se llena dinámicamente --></div>
                </div>
                
                <!-- Clientes Eliminados -->
                <div class="card-dark mt-4">
                    <h6 class="mb-3"><i class="fas fa-trash-alt me-2" style="color: var(--accent-red);"></i><span data-translate="clientesEliminados">Clientes Eliminados</span></h6>
                    <!-- Buscador -->
                    <div class="mb-3">
                        <input type="text" id="buscarEliminado" class="form-control form-control-dark" placeholder="🔍 Buscar por nombre..." oninput="filtrarClientesEliminados()">
                    </div>
                    <div id="clientesEliminados"><!-- Se llena dinámicamente --></div>
                </div>
                
                <!-- Carteras Eliminadas -->
                <div class="card-dark mt-4">
                    <h6 class="mb-3"><i class="fas fa-wallet me-2" style="color: var(--accent-red);"></i>Carteras Eliminadas</h6>
                    <div class="mb-3">
                        <input type="text" id="buscarCarteraEliminada" class="form-control form-control-dark" placeholder="🔍 Buscar cartera..." oninput="filtrarCarterasEliminadas()">
                    </div>
                    <div id="carterasEliminadas"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Mis Backups Section (Trabajadores) -->
            <div id="misBackups" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-database me-2" style="color: var(--accent-cyan);"></i><span data-translate="misBackups">Mis Backups</span></h5>
                    <button class="btn btn-success-custom" onclick="crearMiBackup()" id="btnCrearBackup">
                        <i class="fas fa-plus me-2"></i><span data-translate="crearBackupAhora">Crear Backup Ahora</span>
                    </button>
                </div>
                
                <!-- Crear Contraseña (Primera vez - sin contraseña) -->
                <div id="backupCreatePassword" class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-yellow); display: none;">
                    <div class="d-flex align-items-center mb-3">
                        <div style="width: 40px; height: 40px; background: var(--accent-yellow); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="fas fa-key" style="color: #000;"></i>
                        </div>
                        <div>
                            <strong>🔐 Crear Contraseña de Backups</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;">
                                Protege tus backups con una contraseña exclusiva
                            </p>
                        </div>
                    </div>
                    <div class="row g-2 align-items-end">
                        <div class="col-md-5">
                            <label class="form-label text-secondary" style="font-size: 0.85rem;">Nueva contraseña</label>
                            <input type="password" id="newBackupPass" class="form-control form-control-dark" placeholder="Mínimo 4 caracteres">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label text-secondary" style="font-size: 0.85rem;">Confirmar contraseña</label>
                            <input type="password" id="confirmBackupPass" class="form-control form-control-dark" placeholder="Repetir contraseña">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-success-custom w-100" onclick="crearBackupPassword()">
                                <i class="fas fa-save"></i>
                            </button>
                        </div>
                    </div>
                    <small class="text-secondary mt-2 d-block">Esta contraseña será requerida para usar backups</small>
                </div>
                
                <!-- Sistema de Llave (con contraseña creada) -->
                <div id="backupLockSystem" class="card-dark p-3 mb-4" style="display: none;">
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-3">
                        <div class="d-flex align-items-center">
                            <div id="backupLockIcon" style="width: 60px; height: 60px; background: var(--accent-red); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; transition: all 0.3s; box-shadow: 0 0 15px rgba(255,82,82,0.5);">
                                <i id="backupLockIconI" class="fas fa-lock" style="color: #fff; font-size: 1.5rem;"></i>
                            </div>
                            <div>
                                <strong id="backupLockTitle" style="font-size: 1.1rem;">🔒 Backups Bloqueados</strong>
                                <p class="text-secondary mb-0" style="font-size: 0.85rem;" id="backupLockDesc">
                                    Ingresa tu contraseña para desbloquear
                                </p>
                            </div>
                        </div>
                        <!-- Campo contraseña + botón único -->
                        <div id="backupUnlockForm" class="d-flex align-items-center gap-2">
                            <input type="password" id="backupUnlockPassword" class="form-control form-control-dark" placeholder="Contraseña" style="width: 150px;">
                            <button id="backupToggleBtn" class="btn" style="background: var(--accent-green); color: #fff;" onclick="toggleBackupLockBtn()">
                                <i id="backupToggleBtnIcon" class="fas fa-unlock"></i>
                            </button>
                        </div>
                        <!-- Botón configurar -->
                        <button class="btn btn-sm" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="mostrarConfigBackupPassword()">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Modal Configurar Contraseña -->
                <div id="backupConfigModal" class="card-dark p-3 mb-4" style="border: 2px solid var(--accent-cyan); display: none;">
                    <div class="d-flex align-items-center mb-3">
                        <strong><i class="fas fa-cog me-2"></i>Configurar Contraseña</strong>
                    </div>
                    <div id="backupPasswordSection">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
                
                <div class="card-dark p-3 mb-4">
                    <div class="d-flex align-items-center">
                        <div style="width: 40px; height: 40px; background: var(--accent-green); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                            <i class="fas fa-shield-alt" style="color: #fff;"></i>
                        </div>
                        <div>
                            <strong data-translate="sistemaBackupsAuto">Sistema de Backups Automáticos</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;" data-translate="backupsDescripcion">
                                Tus datos se guardan automáticamente cada hora. Se mantienen los últimos 7 días de backups.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-dark p-3">
                    <h6 class="mb-3"><i class="fas fa-clock-rotate-left me-2" style="color: var(--accent-cyan);"></i><span data-translate="backupsDisponibles">Backups Disponibles</span></h6>
                    <div id="misBackupsList"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Mi Configuración Section (Trabajadores) -->
            <div id="miConfig" class="section">
                <div class="d-flex align-items-center gap-3 mb-4">
                    <button id="btnVolverCartera" onclick="showSection('carteraBloqueada')" style="display: none; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 8px; padding: 8px 12px; color: var(--text-primary); cursor: pointer;">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h5 class="mb-0"><i class="fas fa-cog me-2" style="color: var(--accent-cyan);"></i><span data-translate="miConfiguracion">Mi Configuración</span></h5>
                </div>
                
                <!-- Apariencia -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-palette me-2" style="color: var(--accent-purple);"></i><span data-translate="apariencia">Apariencia</span></h6>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-sm" id="btnTemaOscuro" style="background: var(--accent-cyan); color: #000;" onclick="setTheme('dark')">
                            <i class="fas fa-moon me-1"></i><span data-translate="oscuro">Oscuro</span>
                        </button>
                        <button class="btn btn-sm" id="btnTemaClaro" style="background: var(--bg-hover); color: var(--text-primary);" onclick="setTheme('light')">
                            <i class="fas fa-sun me-1"></i><span data-translate="claro">Claro</span>
                        </button>
                    </div>
                </div>
                
                <!-- Idioma -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-language me-2" style="color: var(--accent-cyan);"></i><span data-translate="idioma">Idioma</span> / Língua</h6>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-sm" id="btnLangEs" style="background: var(--accent-cyan); color: #000;" onclick="cambiarIdioma('es')">
                            🇪🇸 Español
                        </button>
                        <button class="btn btn-sm" id="btnLangPt" style="background: var(--bg-hover); color: var(--text-primary);" onclick="cambiarIdioma('pt')">
                            🇧🇷 Português
                        </button>
                    </div>
                </div>
                
                <!-- Notificaciones -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-bell me-2" style="color: var(--accent-green);"></i><span data-translate="notificaciones">Notificaciones</span></h6>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="notifCobros" checked onchange="guardarPreferencias()">
                        <label class="form-check-label text-secondary" for="notifCobros" data-translate="recordatorioCobros">Recordatorio de cobros del día</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="notifVencimientos" checked onchange="guardarPreferencias()">
                        <label class="form-check-label text-secondary" for="notifVencimientos" data-translate="alertasVencimientos">Alertas de vencimientos</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="notifSonido" checked onchange="guardarPreferencias()">
                        <label class="form-check-label text-secondary" for="notifSonido" data-translate="sonidosNotificacion">Sonidos de notificación</label>
                    </div>
                </div>
                
                <!-- Sesiones Activas -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-desktop me-2" style="color: var(--accent-red);"></i><span data-translate="sesionesActivas">Sesiones Activas</span></h6>
                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="cerrarTodasSesiones()">
                            <i class="fas fa-sign-out-alt me-1"></i><span data-translate="cerrarTodas">Cerrar Todas</span>
                        </button>
                    </div>
                    <div id="listaSesiones">
                        <div class="text-center py-3">
                            <i class="fas fa-spinner fa-spin"></i> <span data-translate="cargandoSesiones">Cargando sesiones...</span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Mapa Section -->
            <div id="mapa" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-map-marked-alt me-2" style="color: var(--accent-purple);"></i><span data-translate="mapaClientes">Mapa de Clientes</span></h5>
                    <button class="btn btn-primary-custom" onclick="obtenerMiUbicacion()">
                        <i class="fas fa-crosshairs me-2"></i><span data-translate="miUbicacion">Mi Ubicación</span>
                    </button>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card purple">
                            <div class="stat-value" id="clientesConUbicacion">0</div>
                            <div class="stat-label"><i class="fas fa-map-pin me-2"></i><span data-translate="conUbicacion">Con ubicación</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-value" id="clientesSinUbicacion">0</div>
                            <div class="stat-label"><i class="fas fa-question-circle me-2"></i><span data-translate="sinUbicacion">Sin ubicación</span></div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card green" id="miUbicacionCard" style="display: none;">
                            <div class="stat-value"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-label" data-translate="ubicacionActiva">Ubicación activa</div>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <div id="mapContainer"></div>
                </div>
                <div class="card-dark mt-3">
                    <h6 class="mb-3"><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i><span data-translate="clientesConUbicacionTitulo">Clientes con ubicación</span></h6>
                    <div id="listaClientesMapa"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Admin: Usuarios Section -->
            <div id="adminUsuarios" class="section">
                <h5 class="mb-4"><i class="fas fa-users-cog me-2" style="color: var(--accent-yellow);"></i><span data-translate="usuariosRegistrados">Usuarios Registrados</span></h5>
                <div class="row g-4 mb-4">
                    <div class="col-md-2">
                        <div class="stat-card purple">
                            <div class="stat-value" id="adminTotalUsers">0</div>
                            <div class="stat-label" data-translate="totalUsuarios">Total Usuarios</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card green">
                            <div class="stat-value" id="adminOnline">0</div>
                            <div class="stat-label">Conectados</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value" id="adminOffline" style="color: #6c757d;">0</div>
                            <div class="stat-label">Offline</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card red">
                            <div class="stat-value" id="adminPendientes">0</div>
                            <div class="stat-label">Pendientes</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card">
                            <div class="stat-value" id="adminTotalClients">0</div>
                            <div class="stat-label">Clientes</div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="adminTotalPrestado">R$ 0</div>
                            <div class="stat-label">Prestado</div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de Pendientes (usuarios que verificaron pero no pagaron) -->
                <div id="pendientesNuevosSection" class="card-dark mb-4" style="border-left: 4px solid var(--accent-purple); display: none;">
                    <h6 class="mb-3" style="color: var(--accent-purple);">
                        <i class="fas fa-user-clock me-2"></i>Usuarios Esperando Activación
                        <span class="badge" style="background: var(--accent-purple); color: #fff; margin-left: 10px;" id="pendientesNuevosBadge">0</span>
                    </h6>
                    <p class="text-secondary mb-3" style="font-size: 0.85rem;">
                        Estos usuarios verificaron su email y están esperando pago o activación manual.
                    </p>
                    <div id="pendientesNuevosList"><!-- Se llena dinámicamente --></div>
                </div>
                
                <!-- Sección de Pendientes (usuarios con paid:false - sistema antiguo) -->
                <div id="pendientesSection" class="card-dark mb-4" style="border-left: 4px solid #ff6b35; display: none;">
                    <h6 class="mb-3" style="color: #ff6b35;">
                        <i class="fas fa-exclamation-circle me-2"></i>Usuarios Pendientes de Pago (Sistema Antiguo)
                        <span class="badge" style="background: #ff6b35; color: #fff; margin-left: 10px;" id="pendientesBadge">0</span>
                    </h6>
                    <p class="text-secondary mb-3" style="font-size: 0.85rem;">
                        Estos usuarios se registraron con el sistema anterior y no han pagado.
                    </p>
                    <div id="pendientesList"><!-- Se llena dinámicamente --></div>
                </div>
                
                <div id="usuariosList"><!-- Se llena dinámicamente --></div>
            </div>
            <!-- Admin: Backups Section -->
            <div id="adminBackups" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-database me-2" style="color: var(--accent-green);"></i>Backups del Sistema</h5>
                    <button id="btnCrearBackup" class="btn btn-success-custom" onclick="crearBackupManual()">
                        <i class="fas fa-plus me-2"></i>Crear Backup Ahora
                    </button>
                </div>
                <div class="card-dark mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-shield-alt fa-2x" style="color: var(--accent-green);"></i>
                        <div>
                            <strong>Sistema de Backups Automáticos</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;">
                                Los datos se guardan automáticamente cada hora. Se mantienen los últimos 7 días de backups.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-history me-2"></i>Backups Disponibles</h6>
                    <div id="backupsList"><!-- Se llena dinámicamente --></div>
                </div>
            </div>
            <!-- Admin: Configuración -->
            <div id="adminConfig" class="section">
                <h5 class="mb-4"><i class="fas fa-cog me-2" style="color: var(--accent-cyan);"></i>Configuración del Sistema</h5>
                
                <!-- Configuración General -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-sliders-h me-2" style="color: var(--accent-cyan);"></i>Configuración General</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Nombre de la Empresa</label>
                            <input type="text" class="form-control form-control-dark" id="cfgNombreEmpresa" value="FinanGest" onchange="guardarConfigAdmin()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Moneda</label>
                            <select class="form-control form-control-dark" id="cfgMoneda" onchange="guardarConfigAdmin()">
                                <option value="R$" selected>R$ (Real Brasileño)</option>
                                <option value="$">$ (Dólar)</option>
                                <option value="€">€ (Euro)</option>
                                <option value="COP">COP (Peso Colombiano)</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Precio Suscripción por Cartera</label>
                            <input type="number" class="form-control form-control-dark" id="cfgPrecioSuscripcion" value="51.41" step="0.01" onchange="guardarConfigAdmin()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Días de Prueba Gratis</label>
                            <input type="number" class="form-control form-control-dark" id="cfgDiasPrueba" value="0" onchange="guardarConfigAdmin()">
                        </div>
                    </div>
                </div>
                
                <!-- Configuración de Backups -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-database me-2" style="color: var(--accent-green);"></i>Backups Automáticos</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Frecuencia</label>
                            <select class="form-control form-control-dark" id="cfgBackupFreq" onchange="guardarConfigAdmin()">
                                <option value="1">Cada hora</option>
                                <option value="6">Cada 6 horas</option>
                                <option value="12">Cada 12 horas</option>
                                <option value="24">Diario</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Retención (días)</label>
                            <input type="number" class="form-control form-control-dark" id="cfgBackupRetencion" value="7" onchange="guardarConfigAdmin()">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Máx. Backups</label>
                            <input type="number" class="form-control form-control-dark" id="cfgBackupMax" value="50" onchange="guardarConfigAdmin()">
                        </div>
                    </div>
                </div>
                
                <!-- Configuración de Notificaciones -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-bell me-2" style="color: var(--accent-yellow);"></i>Notificaciones por Email</h6>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="cfgEmailNuevoUsuario" checked onchange="guardarConfigAdmin()">
                        <label class="form-check-label text-secondary" for="cfgEmailNuevoUsuario">Notificar nuevo registro de usuario</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="cfgEmailPago" checked onchange="guardarConfigAdmin()">
                        <label class="form-check-label text-secondary" for="cfgEmailPago">Notificar pagos recibidos</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="cfgEmailBackup" onchange="guardarConfigAdmin()">
                        <label class="form-check-label text-secondary" for="cfgEmailBackup">Notificar backups completados</label>
                    </div>
                </div>
                
                <!-- Información del Sistema -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-info-circle me-2" style="color: var(--accent-purple);"></i>Información del Sistema</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <small class="text-secondary">Versión</small>
                                <div style="font-size: 1.2rem; font-weight: 600;">v2.5.0</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <small class="text-secondary">Última Actualización</small>
                                <div style="font-size: 1.2rem; font-weight: 600;">Enero 2026</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <small class="text-secondary">Estado</small>
                                <div style="font-size: 1.2rem; font-weight: 600; color: var(--accent-green);"><i class="fas fa-check-circle me-1"></i>Operativo</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Uso del Sistema (Recursos) -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-chart-pie me-2" style="color: var(--accent-cyan);"></i>Uso de Recursos del Sistema</h6>
                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000;" onclick="cargarEstadisticasSistema()">
                            <i class="fas fa-sync-alt me-1"></i>Actualizar
                        </button>
                    </div>
                    
                    <div id="systemStatsContainer">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i>
                            <p class="text-secondary">Cargando estadísticas...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Admin: Seguridad -->
            <div id="adminSeguridad" class="section">
                <h5 class="mb-4"><i class="fas fa-shield-alt me-2" style="color: var(--accent-red);"></i>Centro de Seguridad</h5>
                
                <!-- Estado de Seguridad -->
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card green">
                            <div class="stat-value" id="segUsuariosActivos">0</div>
                            <div class="stat-label"><i class="fas fa-user-check me-1"></i>Usuarios Activos</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card red">
                            <div class="stat-value" id="segUsuariosBloqueados">0</div>
                            <div class="stat-label"><i class="fas fa-user-lock me-1"></i>Bloqueados</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="segSesionesHoy">0</div>
                            <div class="stat-label"><i class="fas fa-sign-in-alt me-1"></i>Sesiones Hoy</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="segIntentosLogin">0</div>
                            <div class="stat-label"><i class="fas fa-exclamation-triangle me-1"></i>Intentos Fallidos</div>
                        </div>
                    </div>
                </div>
                
                <!-- Políticas de Seguridad -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-lock me-2" style="color: var(--accent-cyan);"></i>Políticas de Contraseña</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Longitud Mínima</label>
                            <select class="form-control form-control-dark" id="segPassMinLength" onchange="guardarConfigSeguridad()">
                                <option value="6" selected>6 caracteres</option>
                                <option value="8">8 caracteres</option>
                                <option value="10">10 caracteres</option>
                                <option value="12">12 caracteres</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Expiración</label>
                            <select class="form-control form-control-dark" id="segPassExpira" onchange="guardarConfigSeguridad()">
                                <option value="0" selected>Nunca</option>
                                <option value="30">30 días</option>
                                <option value="60">60 días</option>
                                <option value="90">90 días</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-secondary">Intentos Máximos</label>
                            <select class="form-control form-control-dark" id="segMaxIntentos" onchange="guardarConfigSeguridad()">
                                <option value="3">3 intentos</option>
                                <option value="5" selected>5 intentos</option>
                                <option value="10">10 intentos</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="segRequiereMayuscula" onchange="guardarConfigSeguridad()">
                            <label class="form-check-label text-secondary" for="segRequiereMayuscula">Requerir mayúscula</label>
                        </div>
                        <div class="form-check form-switch mb-2">
                            <input class="form-check-input" type="checkbox" id="segRequiereNumero" onchange="guardarConfigSeguridad()">
                            <label class="form-check-label text-secondary" for="segRequiereNumero">Requerir número</label>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="segRequiereEspecial" onchange="guardarConfigSeguridad()">
                            <label class="form-check-label text-secondary" for="segRequiereEspecial">Requerir carácter especial (!@#$%)</label>
                        </div>
                    </div>
                </div>
                
                <!-- Control de Sesiones -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-clock me-2" style="color: var(--accent-yellow);"></i>Control de Sesiones</h6>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Tiempo de Inactividad (minutos)</label>
                            <select class="form-control form-control-dark" id="segTimeoutSesion" onchange="guardarConfigSeguridad()">
                                <option value="0">Sin límite</option>
                                <option value="15">15 minutos</option>
                                <option value="30" selected>30 minutos</option>
                                <option value="60">1 hora</option>
                                <option value="120">2 horas</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-secondary">Sesiones Simultáneas</label>
                            <select class="form-control form-control-dark" id="segSesionesMax" onchange="guardarConfigSeguridad()">
                                <option value="1">1 dispositivo</option>
                                <option value="3" selected>3 dispositivos</option>
                                <option value="5">5 dispositivos</option>
                                <option value="0">Sin límite</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Acciones de Seguridad -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-tools me-2" style="color: var(--accent-red);"></i>Acciones de Emergencia</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <button class="btn w-100" style="background: var(--accent-yellow); color: #000;" onclick="cerrarTodasSesionesAdmin()">
                                <i class="fas fa-sign-out-alt me-2"></i>Cerrar Todas las Sesiones
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn w-100" style="background: var(--accent-red); color: #fff;" onclick="bloquearTodosUsuarios()">
                                <i class="fas fa-user-lock me-2"></i>Bloquear Todos los Usuarios
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button class="btn w-100" style="background: var(--accent-green); color: #000;" onclick="desbloquearTodosUsuarios()">
                                <i class="fas fa-user-check me-2"></i>Desbloquear Todos
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Registro de Actividad -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-list-alt me-2" style="color: var(--accent-purple);"></i>Registro de Actividad</h6>
                        <button class="btn btn-sm btn-primary-custom" onclick="cargarLogSeguridad()">
                            <i class="fas fa-sync-alt me-1"></i>Actualizar
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                        <table class="table table-dark-custom table-sm">
                            <thead>
                                <tr>
                                    <th>Fecha/Hora</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                    <th>IP</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="logSeguridadTable">
                                <tr><td colspan="5" class="text-center text-secondary">Cargando...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Admin: Calendario de Clientes -->
            <div id="adminCalendario" class="section">
                <h5 class="mb-4"><i class="fas fa-calendar-alt me-2" style="color: var(--accent-purple);"></i>Calendario de Clientes</h5>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-user-tie me-2"></i>Filtrar por Trabajador</label>
                            <select class="form-control form-control-dark" id="calendarioTrabajador" onchange="renderCalendarioClientes()">
                                <option value="" data-translate="todos">Todos</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i><span data-translate="seleccionarFecha">Selecionar Data</span></label>
                            <input type="date" class="form-control form-control-dark" id="calendarioFecha" onchange="renderCalendarioClientes()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i>Ver</label>
                            <select class="form-control form-control-dark" id="calendarioVista" onchange="renderCalendarioClientes()">
                                <option value="todos" selected>Todos</option>
                                <option value="dia">Este día</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes">Este mes</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.8rem; font-weight: bold;" id="calTotalClientes">0</div>
                            <small class="text-secondary">Clientes</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.8rem; font-weight: bold;" id="calTotalPrestado">R$ 0</div>
                            <small class="text-secondary">Prestado</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-yellow); font-size: 1.8rem; font-weight: bold;" id="calTotalCobrado">R$ 0</div>
                            <small class="text-secondary">Cobrado</small>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-list me-2"></i>Clientes Registrados</h6>
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Fecha Registro</th>
                                    <th>Cliente</th>
                                    <th>Trabajador</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="calendarioClientesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Admin: Historial de Trabajador -->
            <div id="adminHistorial" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-history me-2" style="color: var(--accent-purple);"></i>Historial de: <span id="adminHistNombre">Trabajador</span></h5>
                    <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Año</label>
                            <select class="form-control form-control-dark" id="adminHistAnio" onchange="renderAdminHistorialTrabajador()"></select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Mes</label>
                            <select class="form-control form-control-dark" id="adminHistMes" onchange="renderAdminHistorialTrabajador()">
                                <option value="">Todos</option>
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Día</label>
                            <input type="date" class="form-control form-control-dark" id="adminHistDia" onchange="renderAdminHistorialTrabajador()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Estado</label>
                            <select class="form-control form-control-dark" id="adminHistEstado" onchange="renderAdminHistorialTrabajador()">
                                <option value="">Todos</option>
                                <option value="ativo">Activos</option>
                                <option value="finalizado">Finalizados</option>
                                <option value="atrasado">Atrasados</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i>Tipo de Cliente</label>
                            <select class="form-control form-control-dark" id="adminHistTipo" onchange="renderAdminHistorialTrabajador()">
                                <option value="" data-translate="todos">Todos</option>
                                <option value="nuevo" data-translate-opt="tipoNuevo">🆕 Novo</option>
                                <option value="bueno" data-translate-opt="tipoBueno">✅ Bom Cliente</option>
                                <option value="regular" data-translate-opt="tipoRegular">⚠️ Regular</option>
                                <option value="malo" data-translate-opt="tipoMalo">❌ Mau Pagador</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i><span data-translate="porTipoCliente">Por Tipo de Cliente</span></h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="adminHistNuevos">0</div>
                            <small class="text-secondary">🆕 <span data-translate="nuevos">Novos</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="adminHistBuenos">0</div>
                            <small class="text-secondary">✅ <span data-translate="buenos">Bons</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="adminHistRegulares">0</div>
                            <small class="text-secondary">⚠️ <span data-translate="regulares">Regulares</span></small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="adminHistMalos">0</div>
                            <small class="text-secondary">❌ <span data-translate="malaPaga">Mau Pagador</span></small>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card"><div class="stat-value" id="adminHistTotal">0</div><div class="stat-label">Clientes</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green"><div class="stat-value" id="adminHistPrestado">R$ 0</div><div class="stat-label">Prestado</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow"><div class="stat-value" id="adminHistCobrado">R$ 0</div><div class="stat-label">Cobrado</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red"><div class="stat-value" id="adminHistPendiente">R$ 0</div><div class="stat-label">Pendiente</div></div>
                    </div>
                </div>
                
                <!-- Tabla -->
                <div class="card-dark">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover" style="cursor: pointer;">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Teléfono</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Pendiente</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="adminHistTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Admin: Backups de Trabajador -->
            <div id="adminBackupsTrabajador" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-database me-2" style="color: var(--accent-yellow);"></i>Backups: <span id="backupTrabajadorNombre">Trabajador</span></h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success-custom" onclick="crearBackupTrabajador()">
                            <i class="fas fa-plus me-2"></i>Crear Backup Ahora
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </button>
                    </div>
                </div>
                
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="btClientes">0</div>
                            <small class="text-secondary">Clientes</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="btPrestado">R$ 0</div>
                            <small class="text-secondary">Prestado</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="btGastos">R$ 0</div>
                            <small class="text-secondary">Gastos</small>
                        </div>
                    </div>
                </div>
                
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-history me-2" style="color: var(--accent-yellow);"></i>Backups Disponibles</h6>
                        <button id="btnToggleBackupBlock" class="btn btn-sm" onclick="toggleBackupBlock()" title="Bloquear/Desbloquear uso de backups para este usuario">
                            <i class="fas fa-lock-open"></i> Desbloqueado
                        </button>
                    </div>
                    <div id="backupsTrabajadorList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
            </div>
            
            <!-- Admin: Carteras del Trabajador (Nueva Sección Intermedia) -->
            <div id="adminCarterasTrabajador" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-folder me-2" style="color: var(--accent-cyan);"></i>Carteras de: <span id="carterasTrabajadorNombre">Trabajador</span></h5>
                    <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Usuarios
                    </button>
                </div>
                
                <!-- Info del trabajador -->
                <div class="card-dark mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Email</p>
                            <p id="carterasTrabajadorEmail" style="color: var(--accent-cyan);">-</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Total Carteras</p>
                            <p id="carterasTrabajadorTotal" style="color: var(--accent-green); font-weight: bold; font-size: 1.3rem;">0</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Estado</p>
                            <p id="carterasTrabajadorEstado">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de carteras -->
                <div id="carterasTrabajadorLista"></div>
            </div>
            
            <!-- Admin: Ver Todo de Trabajador -->
            <div id="adminVerTodo" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-eye me-2" style="color: var(--accent-purple);"></i>Control Total: <span id="verTodoNombre">Trabajador</span></h5>
                    <button class="btn btn-secondary" onclick="volverACarteras()">
                        <i class="fas fa-arrow-left me-2"></i>Volver a Carteras
                    </button>
                </div>
                
                <!-- Info del trabajador -->
                <div class="card-dark mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Email</p>
                            <p id="verTodoEmail" style="color: var(--accent-cyan);">-</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Fecha de Registro</p>
                            <p id="verTodoFechaReg">-</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Estado</p>
                            <p id="verTodoEstado">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen general -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2 col-4">
                        <div class="stat-card"><div class="stat-value" id="vtTotalClientes">0</div><div class="stat-label">Clientes</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card green"><div class="stat-value" id="vtPrestado">R$ 0</div><div class="stat-label">Prestado</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card yellow"><div class="stat-value" id="vtCobrado">R$ 0</div><div class="stat-label">Cobrado</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card red"><div class="stat-value" id="vtPendiente">R$ 0</div><div class="stat-label">Pendiente</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card purple"><div class="stat-value" id="vtGastos">R$ 0</div><div class="stat-label">Gastos</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card"><div class="stat-value" id="vtPagosRecibidos">0</div><div class="stat-label">Pagos</div></div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="card-dark mb-4">
                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <button class="btn btn-primary-custom" onclick="mostrarTabVerTodo('clientes')" id="vtTabClientes">
                            <i class="fas fa-users me-1"></i>Clientes
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('carteras')" id="vtTabCarteras">
                            <i class="fas fa-folder me-1"></i>Carteras
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('gastos')" id="vtTabGastos">
                            <i class="fas fa-wallet me-1"></i>Gastos
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('pagos')" id="vtTabPagos">
                            <i class="fas fa-money-bill me-1"></i>Pagos Recibidos
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('actividad')" id="vtTabActividad">
                            <i class="fas fa-clock me-1"></i>Actividad
                        </button>
                        <div class="ms-auto" style="min-width: 250px;">
                            <div class="input-group">
                                <span class="input-group-text" style="background: var(--bg-hover); border-color: var(--border-color); color: var(--accent-cyan);">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control form-control-dark" id="vtBuscador" placeholder="Buscar por nombre..." oninput="filtrarVerTodo()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de tabs -->
                <div id="vtContenido">
                    <!-- Se llena dinámicamente -->
                </div>
            </div>
            <!-- Admin: Todos los Clientes -->
            <div id="adminClientes" class="section">
                <h5 class="mb-4"><i class="fas fa-database me-2" style="color: var(--accent-cyan);"></i>Todos los Clientes</h5>
                <div class="card-dark">
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Usuario</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Restante</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="adminClientesTable"><!-- Se llena dinámicamente --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Modal Nuevo Cliente -->
    <div class="modal fade modal-dark" id="clienteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Cliente</label>
                            <input type="text" class="form-control form-control-dark" id="clienteNombre">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Teléfono</label>
                            <input type="tel" class="form-control form-control-dark" id="clienteTelefono">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>Ubicación / Dirección</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-dark" id="clienteUbicacion" placeholder="Dirección del cliente">
                                <button class="btn btn-primary-custom" type="button" onclick="obtenerUbicacionCliente()" title="Usar ubicación actual">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                            <input type="hidden" id="clienteLat">
                            <input type="hidden" id="clienteLng">
                            <small id="coordsInfo" class="text-secondary" style="display: none;">
                                <i class="fas fa-check-circle text-success"></i> Coordenadas guardadas
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-star me-1"></i><span data-translate="tipoCliente">Tipo de Cliente</span></label>
                            <select class="form-control form-control-dark" id="clienteTipo">
                                <option value="nuevo" data-translate-opt="tipoNuevo">🆕 Novo</option>
                                <option value="bueno" data-translate-opt="tipoBueno">✅ Bom Cliente</option>
                                <option value="regular" data-translate-opt="tipoRegular">⚠️ Regular</option>
                                <option value="malo" data-translate-opt="tipoMalo">❌ Mau Pagador</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-store me-1"></i><span data-translate="tipoNegocio">Tipo de Negócio</span></label>
                            <select class="form-control form-control-dark" id="clienteNegocio" onchange="toggleOtroNegocio()">
                                <option value="" data-translate-opt="seleccionar">-- Selecionar --</option>
                                <option value="tienda" data-translate-opt="negTienda">🏪 Loja</option>
                                <option value="restaurante" data-translate-opt="negRestaurante">🍽️ Restaurante</option>
                                <option value="taxista" data-translate-opt="negTaxista">🚕 Taxista</option>
                                <option value="vendedor" data-translate-opt="negVendedor">🛒 Vendedor Ambulante</option>
                                <option value="peluqueria" data-translate-opt="negPeluqueria">💇 Salão/Barbearia</option>
                                <option value="taller" data-translate-opt="negTaller">🔧 Oficina Mecânica</option>
                                <option value="farmacia" data-translate-opt="negFarmacia">💊 Farmácia</option>
                                <option value="panaderia" data-translate-opt="negPanaderia">🥖 Padaria</option>
                                <option value="carniceria" data-translate-opt="negCarniceria">🥩 Açougue</option>
                                <option value="ferreteria" data-translate-opt="negFerreteria">🔨 Ferragem</option>
                                <option value="ropa" data-translate-opt="negRopa">👕 Loja de Roupas</option>
                                <option value="celulares" data-translate-opt="negCelulares">📱 Celulares/Tecnologia</option>
                                <option value="otro" data-translate-opt="negOtro">📦 Outro</option>
                            </select>
                            <input type="text" class="form-control form-control-dark mt-2" id="clienteNegocioOtro" placeholder="Escribe el tipo de negocio..." style="display: none;">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-building me-1"></i><span data-translate="nombreNegocio">Nome do Negócio (opcional)</span></label>
                            <input type="text" class="form-control form-control-dark" id="clienteNombreNegocio" data-translate-placeholder="ejTienda" placeholder="Ex: Loja do José">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-sticky-note me-1"></i>Notas sobre el cliente (opcional)</label>
                        <textarea class="form-control form-control-dark" id="clienteNotas" rows="2" placeholder="Información adicional..."></textarea>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <div class="row">
                        <div class="col-md-3 col-6 mb-3">
                            <label class="form-label">Valor Prestado (R$)</label>
                            <input type="number" class="form-control form-control-dark" id="clienteMonto" oninput="calcularTotal()">
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <label class="form-label">Parcelas</label>
                            <input type="number" class="form-control form-control-dark" id="clienteParcelas" oninput="calcularTotal()">
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <label class="form-label">Comisión %</label>
                            <select class="form-control form-control-dark" id="clienteComision" onchange="calcularTotal()">
                                <option value="10">10%</option>
                                <option value="20" selected>20%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                        <div class="col-md-3 col-6 mb-3">
                            <label class="form-label"><i class="fas fa-shield-alt me-1"></i>Microseguro (R$)</label>
                            <input type="number" class="form-control form-control-dark" id="clienteMicroseguro" placeholder="0" oninput="calcularTotal()" step="0.01">
                        </div>
                    </div>
                    <div class="card-dark" style="background: var(--bg-hover);">
                        <div class="row text-center">
                            <div class="col-3">
                                <small class="text-secondary">Comisión (<span id="comisionLabel">20</span>%)</small>
                                <div id="calcComision" style="color: var(--accent-yellow);">R$ 0</div>
                            </div>
                            <div class="col-3">
                                <small class="text-secondary">Microseguro</small>
                                <div id="calcMicroseguro" style="color: var(--accent-purple);">R$ 0</div>
                            </div>
                            <div class="col-3">
                                <small class="text-secondary">Total a Pagar</small>
                                <div id="calcTotal" style="color: var(--accent-green);">R$ 0</div>
                            </div>
                            <div class="col-3">
                                <small class="text-secondary">Por Parcela</small>
                                <div id="calcParcela" style="color: var(--accent-cyan);">R$ 0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" id="btnCrearCliente" onclick="crearCliente()">Crear Cliente</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Pago -->
    <div class="modal fade modal-dark" id="pagoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-money-bill-wave me-2"></i>Registrar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pagoClienteInfo" class="card-dark mb-3" style="background: var(--bg-hover);"></div>
                    
                    <div class="mb-3">
                        <label class="form-label">¿Cuántas parcelas quiere pagar?</label>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-outline-secondary" onclick="cambiarCantidadParcelas(-1)" style="width: 45px;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" class="form-control form-control-dark text-center" id="pagoCantidadParcelas" value="1" min="1" style="width: 80px; font-size: 1.3rem; font-weight: bold;" onchange="actualizarValorPago()">
                            <button type="button" class="btn btn-outline-secondary" onclick="cambiarCantidadParcelas(1)" style="width: 45px;">
                                <i class="fas fa-plus"></i>
                            </button>
                            <span id="pagoParcelasRestantes" class="text-secondary ms-2" style="font-size: 0.9rem;"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Valor del Pago (R$)</label>
                        <input type="number" class="form-control form-control-dark" id="pagoValor" style="font-size: 1.2rem; font-weight: bold;">
                        <small id="pagoValorInfo" class="text-secondary"></small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control form-control-dark" id="pagoFecha">
                    </div>
                    
                    <button type="button" class="btn w-100 mb-2" style="background: var(--accent-purple); color: #fff;" onclick="pagarTodo()">
                        <i class="fas fa-check-double me-2"></i>Pagar Todo (Saldar Deuda)
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="confirmarPago()">Confirmar Pago</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Gasto -->
    <div class="modal fade modal-dark" id="gastoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-wallet me-2"></i>Nuevo Gasto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Descripción del Gasto</label>
                        <input type="text" class="form-control form-control-dark" id="gastoDescripcion" placeholder="Ej: Pago de luz, Almuerzo...">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control form-control-dark" id="gastoValor" placeholder="0.00" step="0.01">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control form-control-dark" id="gastoFecha">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Categoría</label>
                        <input type="text" class="form-control form-control-dark" id="gastoCategoria" placeholder="Ej: Comida, Transporte, Servicios...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="guardarGasto()">
                        <i class="fas fa-save me-2"></i>Guardar Gasto
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Contraseña Cartera - Ingresar -->
    <div class="modal fade modal-dark" id="carteraPasswordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-lock me-2" style="color: var(--accent-cyan);"></i>Cartera Protegida</h5>
                </div>
                <div class="modal-body">
                    <p class="text-secondary mb-3">Ingresa la contraseña para acceder a <strong id="carteraPasswordNombre"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-dark" id="carteraPasswordInput" placeholder="Ingresa la contraseña" onkeypress="if(event.key==='Enter')verificarCarteraPassword()">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('carteraPasswordInput', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-center">
                        <a href="#" onclick="olvidoCarteraPassword()" style="color: var(--accent-cyan); font-size: 0.85rem;">¿Olvidaste la contraseña?</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="verificarCarteraPassword()">
                        <i class="fas fa-unlock me-2"></i>Ingresar
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Contraseña Cartera - Crear Nueva -->
    <div class="modal fade modal-dark" id="carteraCrearPasswordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-shield-alt me-2" style="color: var(--accent-green);"></i>Proteger Cartera</h5>
                </div>
                <div class="modal-body">
                    <p class="text-secondary mb-3">Crea una contraseña para proteger <strong id="carteraCrearPasswordNombre"></strong></p>
                    <div class="mb-3">
                        <label class="form-label">Nueva Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-dark" id="carteraNuevaPassword" placeholder="Mínimo 4 caracteres">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('carteraNuevaPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirmar Contraseña</label>
                        <div class="input-group">
                            <input type="password" class="form-control form-control-dark" id="carteraConfirmarPassword" placeholder="Repite la contraseña">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('carteraConfirmarPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="alert" style="background: rgba(0,212,255,0.15); border: 1px solid var(--accent-cyan); font-size: 0.85rem; color: #fff;">
                        <i class="fas fa-info-circle me-2" style="color: var(--accent-cyan);"></i>Si olvidas la contraseña, podrás recuperarla con tu email principal.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="crearCarteraPassword()">
                        <i class="fas fa-save me-2"></i>Crear Contraseña
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Recuperar Contraseña Cartera -->
    <div class="modal fade modal-dark" id="carteraRecuperarPasswordModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-envelope me-2" style="color: var(--accent-yellow);"></i>Recuperar Contraseña</h5>
                </div>
                <div class="modal-body">
                    <!-- Paso 1: Enviar código -->
                    <div id="carteraRecuperarPaso1">
                        <p class="text-secondary mb-3">Se enviará un código de recuperación a tu email registrado.</p>
                        <p class="mb-3"><strong>Cartera:</strong> <span id="carteraRecuperarNombre"></span></p>
                        <button type="button" class="btn btn-primary-custom w-100" onclick="enviarCodigoRecuperacionCartera()">
                            <i class="fas fa-paper-plane me-2"></i>Enviar Código
                        </button>
                    </div>
                    <!-- Paso 2: Ingresar código y nueva contraseña -->
                    <div id="carteraRecuperarPaso2" style="display: none;">
                        <p class="text-secondary mb-3">Ingresa el código enviado a tu email y la nueva contraseña.</p>
                        <div class="mb-3">
                            <label class="form-label">Código de Recuperación</label>
                            <input type="text" class="form-control form-control-dark" id="carteraCodigoRecuperacion" placeholder="Código de 6 dígitos" maxlength="6">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nueva Contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control form-control-dark" id="carteraNuevaPasswordRecuperar" placeholder="Mínimo 4 caracteres">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('carteraNuevaPasswordRecuperar', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Confirmar Nueva Contraseña</label>
                            <div class="input-group">
                                <input type="password" class="form-control form-control-dark" id="carteraConfirmarPasswordRecuperar" placeholder="Repite la contraseña">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('carteraConfirmarPasswordRecuperar', this)">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelarRecuperacionCartera()">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" id="btnConfirmarRecuperacionCartera" style="display: none;" onclick="confirmarRecuperacionCartera()">
                        <i class="fas fa-check me-2"></i>Cambiar Contraseña
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Eliminar Cartera (con contraseña) -->
    <div class="modal fade modal-dark" id="eliminarCarteraModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header" style="border-bottom-color: var(--accent-red);">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2" style="color: var(--accent-red);"></i>Eliminar Cartera</h5>
                </div>
                <div class="modal-body">
                    <div class="alert" style="background: rgba(255,82,82,0.15); border: 1px solid var(--accent-red); color: #fff;">
                        <i class="fas fa-warning me-2" style="color: var(--accent-red);"></i>
                        <strong>¡Atención!</strong> Esta acción moverá la cartera a "Carteras Eliminadas".
                    </div>
                    <p class="text-secondary mb-3">Cartera a eliminar: <strong id="eliminarCarteraNombre" style="color: var(--accent-red);"></strong></p>
                    <p class="text-secondary mb-3">Ingresa la contraseña de la cartera para confirmar:</p>
                    <div class="mb-3">
                        <div class="input-group">
                            <input type="password" class="form-control form-control-dark" id="eliminarCarteraPassword" placeholder="Contraseña de la cartera">
                            <button class="btn btn-outline-secondary" type="button" onclick="toggleCarteraPasswordVisibility('eliminarCarteraPassword', this)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-secondary">Escribe "ELIMINAR" para confirmar:</label>
                        <input type="text" class="form-control form-control-dark" id="eliminarCarteraConfirmacion" placeholder="ELIMINAR">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn" style="background: var(--accent-red); color: #fff;" onclick="confirmarEliminarCartera()">
                        <i class="fas fa-trash me-2"></i>Eliminar Cartera
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Nueva Cartera -->
    <div class="modal fade modal-dark" id="carteraModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-wallet me-2" style="color: var(--accent-cyan);"></i><span id="carteraModalTitle">Nueva Cartera</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Nombre de la Cartera</label>
                        <input type="text" class="form-control form-control-dark" id="carteraNombre" placeholder="Ej: Préstamos Personales, Negocio 2...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Descripción (opcional)</label>
                        <textarea class="form-control form-control-dark" id="carteraDescripcion" rows="2" placeholder="Descripción breve de esta cartera..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Color</label>
                        <div class="d-flex gap-2 flex-wrap" id="carteraColores">
                            <button type="button" class="cartera-color-btn active" data-color="#00d4ff" style="width: 35px; height: 35px; border-radius: 8px; background: #00d4ff; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#00d4ff')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#2ecc71" style="width: 35px; height: 35px; border-radius: 8px; background: #2ecc71; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#2ecc71')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#e6a700" style="width: 35px; height: 35px; border-radius: 8px; background: #e6a700; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#e6a700')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#ff4757" style="width: 35px; height: 35px; border-radius: 8px; background: #ff4757; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#ff4757')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#a855f7" style="width: 35px; height: 35px; border-radius: 8px; background: #a855f7; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#a855f7')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#ff6b9d" style="width: 35px; height: 35px; border-radius: 8px; background: #ff6b9d; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#ff6b9d')"></button>
                            <button type="button" class="cartera-color-btn" data-color="#17a2b8" style="width: 35px; height: 35px; border-radius: 8px; background: #17a2b8; border: 3px solid transparent; cursor: pointer;" onclick="seleccionarColorCartera(this, '#17a2b8')"></button>
                        </div>
                        <input type="hidden" id="carteraColorSeleccionado" value="#00d4ff">
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between">
                    <button type="button" class="btn" style="background: var(--accent-red); color: #fff; display: none;" id="btnEliminarCarteraModal" onclick="mostrarEliminarCartera()">
                        <i class="fas fa-trash me-2"></i>Eliminar
                    </button>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary-custom" id="btnGuardarCartera" onclick="guardarCartera()">
                            <i class="fas fa-save me-2"></i>Guardar Cartera
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Gestionar Carteras -->
    <div class="modal fade modal-dark" id="gestionarCarterasModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-cog me-2" style="color: var(--accent-cyan);"></i>Gestionar Carteras</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="listaCarterasGestion">
                        <!-- Se llena dinámicamente -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK para notificaciones push -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script>
        // Configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAfq8kCrmGxLNpWaxxGHq2VzKLIN3Jq_t4",
            authDomain: "finangest-8b9f5.firebaseapp.com",
            projectId: "finangest-8b9f5",
            storageBucket: "finangest-8b9f5.firebasestorage.app",
            messagingSenderId: "826547494608",
            appId: "1:826547494608:web:ead7a874d1e410229f88d5"
        };
        
        // Inicializar Firebase
        let firebaseApp = null;
        let firebaseMessaging = null;
        
        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            firebaseMessaging = firebase.messaging();
            console.log('✅ Firebase inicializado correctamente');
        } catch (e) {
            console.error('Error inicializando Firebase:', e);
        }
        
        // Función para suscribirse a notificaciones push
        async function subscribeToPushNotifications() {
            if (!firebaseMessaging) {
                console.log('Firebase Messaging no disponible');
                return null;
            }
            
            try {
                // Registrar service worker
                const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
                console.log('Service Worker registrado:', registration);
                
                // Solicitar permiso
                const permission = await Notification.requestPermission();
                if (permission !== 'granted') {
                    console.log('Permiso de notificaciones denegado');
                    return null;
                }
                
                // Obtener token
                const token = await firebaseMessaging.getToken({
                    vapidKey: 'BPAjHwR3iAaRYdjsvyCJfVVt2ISn8HAs8WYeXagjv8i8JLCkaMUkTxsxPm2-jShkvk5nFDFA64fTYxy2kac5WnU',
                    serviceWorkerRegistration: registration
                });
                
                console.log('Token de notificaciones:', token);
                return token;
            } catch (e) {
                console.error('Error obteniendo token push:', e);
                return null;
            }
        }
        
        // Guardar token en el servidor
        async function savePushToken(token) {
            if (!token || !currentUser) return;
            
            try {
                await fetch(API_URL + '/api/push-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        token: token,
                        deviceInfo: {
                            userAgent: navigator.userAgent,
                            platform: navigator.platform,
                            language: navigator.language
                        }
                    })
                });
                console.log('Token guardado en servidor');
            } catch (e) {
                console.error('Error guardando token:', e);
            }
        }
        
        // Manejar mensajes en primer plano
        if (firebaseMessaging) {
            firebaseMessaging.onMessage((payload) => {
                console.log('Notificación recibida en primer plano:', payload);
                
                // Mostrar toast en la app
                if (payload.notification) {
                    showToast(payload.notification.body || 'Nueva notificación', 5000);
                    
                    // También mostrar notificación del sistema
                    if (Notification.permission === 'granted') {
                        new Notification(payload.notification.title || 'FinanGest', {
                            body: payload.notification.body,
                            icon: '/icon-192.svg'
                        });
                    }
                }
            });
        }
    </script>
    
    <script>
        // API URL - Backend desplegado en Vercel
        const API_URL = 'https://finangest-backend.vercel.app';
        let currentUser = null;
        let clientes = [];
        let gastos = [];
        let allUsers = [];
        let mainChart = null;
        let lastEditKeyStatus = null; // Para detectar cambios en la llave
        
        // Variables del sistema de backup lock (declaradas aquí para evitar problemas de scope)
        let backupUnlocked = false;
        let userHasBackupPassword = false;
        let backupLockInitialized = false;
        
        // Variables del sistema de edición lock
        let editUnlocked = false;
        let userHasEditPassword = false;
        let editLockInitialized = false;
        
        // Variables del sistema de carteras
        let carteras = [];
        let carteraActual = null; // null = todas las carteras, o el ID de la cartera seleccionada
        let editandoCarteraId = null;
        
        // Variable para caja inicial por cartera
        let cajasIniciales = {}; // { carteraId: valor }
        
        // ========== SISTEMA DE TIEMPO (WorldTimeAPI) ==========
        // Zona horaria del usuario (se obtiene del perfil o del navegador)
        let userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Sao_Paulo';
        let serverTimeOffset = 0; // Diferencia entre hora del servidor y hora local
        let serverTimeInitialized = false;
        
        // Obtener hora del servidor (WorldTimeAPI)
        async function getServerTime() {
            try {
                const res = await fetch(API_URL + '/api/server-time?timezone=' + encodeURIComponent(userTimezone));
                const data = await res.json();
                if (data.success) {
                    const serverDate = new Date(data.datetime);
                    serverTimeOffset = serverDate.getTime() - Date.now();
                    serverTimeInitialized = true;
                    return serverDate;
                }
            } catch (e) {
                console.error('Error obteniendo hora del servidor:', e);
            }
            return new Date();
        }
        
        // Obtener fecha actual corregida (usa el offset del servidor)
        function getCurrentDate() {
            if (!serverTimeInitialized) {
                // Si no se ha inicializado, usar fecha local con ajuste de timezone
                try {
                    const formatter = new Intl.DateTimeFormat('en-CA', {
                        timeZone: userTimezone,
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    const parts = formatter.formatToParts(new Date());
                    const getPart = (type) => parts.find(p => p.type === type)?.value || '00';
                    return new Date(`${getPart('year')}-${getPart('month')}-${getPart('day')}T${getPart('hour')}:${getPart('minute')}:${getPart('second')}`);
                } catch (e) {
                    return new Date();
                }
            }
            return new Date(Date.now() + serverTimeOffset);
        }
        
        // Obtener fecha en formato YYYY-MM-DD (USAR ESTA EN TODO EL SISTEMA)
        function getCurrentDateString() {
            const d = getCurrentDate();
            return d.getFullYear() + '-' + 
                   String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(d.getDate()).padStart(2, '0');
        }
        
        // Obtener fecha de hoy a medianoche (para comparaciones)
        function getTodayMidnight() {
            const d = getCurrentDate();
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        // Obtener inicio de la semana (lunes)
        function getWeekStart() {
            const d = getCurrentDate();
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            d.setDate(diff);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        // Obtener inicio del mes
        function getMonthStart() {
            const d = getCurrentDate();
            d.setDate(1);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        // Inicializar tiempo del servidor al cargar
        async function initServerTime() {
            if (currentUser && currentUser.timezone) {
                userTimezone = currentUser.timezone;
            }
            await getServerTime();
            console.log('Timezone:', userTimezone, '| Server offset:', serverTimeOffset, 'ms | Initialized:', serverTimeInitialized);
        }
        
        // ========== SISTEMA DE PROTECCIÓN GLOBAL ==========
        // Función para ejecutar código de forma segura
        function safeExecute(fn, fallback = null, context = 'función') {
            try {
                return fn();
            } catch (e) {
                console.error(`Error en ${context}:`, e);
                return fallback;
            }
        }
        
        // Verificar que los arrays estén inicializados
        function ensureArrays() {
            if (!Array.isArray(clientes)) clientes = [];
            if (!Array.isArray(gastos)) gastos = [];
            if (!Array.isArray(carteras)) carteras = [];
            if (!Array.isArray(allUsers)) allUsers = [];
        }
        
        // Función para mostrar mensaje de éxito (SIEMPRE FUNCIONA)
        function mostrarMensajeExito(mensaje) {
            // Crear div flotante
            const div = document.createElement('div');
            div.innerHTML = mensaje;
            div.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: linear-gradient(135deg, #00d4ff, #00b894);
                color: #000;
                padding: 15px 30px;
                border-radius: 10px;
                font-weight: bold;
                font-size: 16px;
                z-index: 99999999;
                box-shadow: 0 5px 20px rgba(0,0,0,0.3);
                animation: fadeInOut 3s forwards;
            `;
            
            // Agregar animación CSS
            if (!document.getElementById('mensajeExitoStyle')) {
                const style = document.createElement('style');
                style.id = 'mensajeExitoStyle';
                style.textContent = `
                    @keyframes fadeInOut {
                        0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                        15% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        85% { opacity: 1; transform: translateX(-50%) translateY(0); }
                        100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
                    }
                `;
                document.head.appendChild(style);
            }
            
            document.body.appendChild(div);
            
            // Remover después de 3 segundos
            setTimeout(() => div.remove(), 3000);
        }
        
        // Mostrar toast de notificación (aparece y desaparece solo)
        function showToast(message, duration = 3000, type = 'success') {
            // Crear toast si no existe
            let toast = document.getElementById('toastNotification');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toastNotification';
                toast.className = 'toast-notification';
                toast.innerHTML = '<i class="fas fa-check-circle"></i><span id="toastMessage"></span>';
                document.body.appendChild(toast);
            }
            
            const toastMsg = document.getElementById('toastMessage') || toast.querySelector('span');
            const toastIcon = toast.querySelector('i');
            
            toastMsg.textContent = message;
            
            // Cambiar color según tipo
            if (type === 'error') {
                toast.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                if (toastIcon) toastIcon.className = 'fas fa-times-circle';
            } else if (type === 'warning') {
                toast.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                if (toastIcon) toastIcon.className = 'fas fa-exclamation-circle';
            } else {
                toast.style.background = 'linear-gradient(135deg, #00d4ff, #00b894)';
                if (toastIcon) toastIcon.className = 'fas fa-check-circle';
            }
            
            // Forzar reflow y mostrar
            toast.style.display = 'flex';
            toast.offsetHeight; // Force reflow
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.style.display = 'none';
                }, 400);
            }, duration);
        }
        
        // Modal de alerta personalizado (reemplaza alert nativo)
        function showCustomAlert(message, callback = null) {
            // Crear modal si no existe
            let modal = document.getElementById('customAlertModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'customAlertModal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99998; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--bg-card, #1a1a2e); border-radius: 16px; padding: 24px; max-width: 400px; width: 90%; border: 1px solid var(--border-color, #2d2d44); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                            <div id="customAlertMessage" style="color: var(--text-primary, #fff); font-size: 1rem; line-height: 1.6; white-space: pre-line; margin-bottom: 20px;"></div>
                            <button id="customAlertOk" style="width: 100%; padding: 12px; background: linear-gradient(135deg, var(--accent-cyan, #00d4ff), #0099cc); border: none; border-radius: 8px; color: #000; font-weight: 600; cursor: pointer;">OK</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                
                document.getElementById('customAlertOk').addEventListener('click', () => {
                    modal.style.display = 'none';
                    if (window.customAlertCallback) {
                        window.customAlertCallback();
                        window.customAlertCallback = null;
                    }
                });
            }
            
            document.getElementById('customAlertMessage').textContent = message;
            window.customAlertCallback = callback;
            modal.style.display = 'block';
        }
        
        // Sobrescribir alert nativo
        window.originalAlert = window.alert;
        window.alert = function(message) {
            showCustomAlert(message);
        };
        
        // Verificar elemento DOM antes de modificar
        function safeSetText(elementId, text) {
            try {
                const el = document.getElementById(elementId);
                if (el) el.textContent = text;
            } catch (e) {
                console.error(`Error setting text for ${elementId}:`, e);
            }
        }
        
        function safeSetHTML(elementId, html) {
            try {
                const el = document.getElementById(elementId);
                if (el) el.innerHTML = html;
            } catch (e) {
                console.error(`Error setting HTML for ${elementId}:`, e);
            }
        }
        // ========== FIN SISTEMA DE PROTECCIÓN ==========
        
        // ========== SISTEMA DE OPTIMIZACIÓN ==========
        // Debounce para evitar múltiples renders
        const debounceTimers = {};
        function debounce(fn, delay, key) {
            if (debounceTimers[key]) clearTimeout(debounceTimers[key]);
            debounceTimers[key] = setTimeout(fn, delay);
        }
        
        function updateStatsDebounced() {
            debounce(() => { try { updateStats(); } catch(e) {} }, 100, 'stats');
        }
        function renderClientesDebounced() {
            debounce(() => { try { renderClientes(); } catch(e) {} }, 50, 'clientes');
        }
        function renderCobrosDebounced() {
            debounce(() => { try { renderCobros(); } catch(e) {} }, 50, 'cobros');
        }
        function renderGastosDebounced() {
            debounce(() => { try { renderGastos(); } catch(e) {} }, 50, 'gastos');
        }
        function refreshAllDebounced() {
            updateStatsDebounced();
            renderClientesDebounced();
            renderCobrosDebounced();
            // Actualizar gráfico de resumen
            debounce(() => { try { if (typeof renderChart === 'function') renderChart(); } catch(e) {} }, 150, 'chart');
        }
        // ========== FIN OPTIMIZACIÓN ==========
        
        // Sistema de idiomas
        let currentLang = localStorage.getItem('finangest_lang') || 'pt';
        const translations = {
            es: {
                // Navegación
                dashboard: 'Dashboard',
                clientes: 'Clientes',
                estadisticas: 'Estadísticas',
                cobros: 'Cobros del Día',
                gastos: 'Gastos',
                mapa: 'Mapa',
                historial: 'Mi Historial',
                backups: 'Backups',
                configuracion: 'Configuración',
                microseguros: 'Microseguros',
                usuarios: 'Usuarios',
                calendario: 'Calendario',
                seguridad: 'Seguridad',
                // Dashboard stats
                clientesActivos: 'Clientes Activos',
                gestionClientes: 'Gestión de Clientes',
                totalPrestado: 'Total Prestado',
                totalCobrado: 'Total Cobrado',
                pendiente: 'Pendiente',
                resumen: 'Resumen',
                clientesHoy: 'Clientes de Hoy',
                clientesAtrasados: 'Clientes Atrasados',
                sinClientesAtrasados: 'Sin clientes atrasados',
                mejoresClientes: 'Mejores Clientes',
                resumenSemana: 'Resumen de la Semana',
                nuevosClientes: 'Nuevos clientes',
                prestamosRealizados: 'Préstamos realizados',
                cobrosRecibidos: 'Cobros recibidos',
                gananciaEstimada: 'Ganancia estimada',
                actividadReciente: 'Actividad Reciente',
                pagoRecibido: 'Pago recibido',
                clienteCreado: 'Cliente creado',
                prestamoRenovado: 'Préstamo renovado',
                // Botones
                nuevoCliente: 'Nuevo Cliente',
                guardar: 'Guardar',
                cancelar: 'Cancelar',
                eliminar: 'Eliminar',
                editar: 'Editar',
                buscar: 'Buscar',
                buscarCliente: 'Buscar cliente...',
                todos: 'Todos',
                hoy: 'Hoy',
                estaSemana: 'Esta Semana',
                esteMes: 'Este Mes',
                esteAnio: 'Este Año',
                ultimos7dias: 'Últimos 7 días',
                buscarNombre: 'Buscar por nombre...',
                montoPrestamo: 'Monto Préstamo',
                todosTiempos: 'Todos los tiempos',
                nuevoGasto: 'Nuevo Gasto',
                miUbicacion: 'Mi Ubicación',
                cerrarTodas: 'Cerrar Todas',
                guardarCambios: 'Guardar Cambios',
                registrarPago: 'Registrar Pago',
                renovar: 'Renovar',
                verMapa: 'Ver en Mapa',
                llamar: 'Llamar',
                whatsapp: 'WhatsApp',
                // Campos
                nombre: 'Nombre',
                telefono: 'Teléfono',
                tipo: 'Tipo',
                parcelas: 'Parcelas',
                atrasos: 'Atrasos',
                montoPrestado: 'Monto Prestado',
                totalAPagar: 'Total a Pagar',
                dineroCobrado: 'Dinero Cobrado',
                parcelasAPagar: 'Parcelas a Pagar',
                parcelasPagas: 'Parcelas Pagas',
                comision: 'Comisión',
                microseguro: 'Microseguro',
                ubicacion: 'Ubicación',
                notas: 'Notas',
                tipoCliente: 'Tipo de Cliente',
                tipoNegocio: 'Tipo de Negocio',
                fecha: 'Fecha',
                fechaInicio: 'Fecha Inicio',
                fechaFin: 'Fecha Fin',
                valor: 'Valor',
                cliente: 'Cliente',
                estado: 'Estado',
                acciones: 'Acciones',
                descripcion: 'Descripción',
                categoria: 'Categoría',
                monto: 'Monto',
                // Estados
                nuevo: 'Nuevo',
                bueno: 'Buen Cliente',
                regular: 'Regular',
                malo: 'Mala Paga',
                activo: 'Activo',
                pagado: 'Pagado',
                pendientes: 'Pendientes',
                pagadosHoy: 'Pagados Hoy',
                // Cobros
                cobradoEsteDia: 'Cobrado este día',
                pagosRegistrados: 'Pagos registrados',
                clientesPendientes: 'Clientes pendientes',
                pagosDel: 'Pagos del',
                pagoRealizado: 'Pago realizado',
                aLas: 'a las',
                sinTelefono: 'Sin teléfono',
                pendientesCobro: 'Pendientes de cobro',
                parcela: 'Parcela',
                // Secciones
                gastosPersonales: 'Gastos Personales',
                gastosHoy: 'Gastos de Hoy',
                sinGastosFecha: 'No hay gastos para esta fecha',
                totalDia: 'Total del día',
                filtrarFecha: 'Filtrar por fecha',
                conUbicacion: 'Con ubicación',
                sinUbicacion: 'Sin ubicación',
                ubicacionActiva: 'Ubicación activa',
                backupsDisponibles: 'Backups Disponibles',
                misBackups: 'Mis Backups',
                crearBackupAhora: 'Crear Backup Ahora',
                sistemaBackupsAuto: 'Sistema de Backups Automáticos',
                backupsDescripcion: 'Tus datos se guardan automáticamente cada hora. Se mantienen los últimos 7 días de backups.',
                sesionesActivas: 'Sesiones Activas',
                zonaPeligro: 'Zona de Peligro',
                zonaPeligroDesc: 'Estas acciones son irreversibles. Tus carteras pagadas se mantendrán.',
                eliminarTodosDatos: 'Eliminar todos mis datos',
                notificaciones: 'Notificaciones',
                recordatorioCobros: 'Recordatorio de cobros del día',
                alertasVencimientos: 'Alertas de vencimientos',
                sonidosNotificacion: 'Sonidos de notificación',
                apariencia: 'Apariencia',
                miConfiguracion: 'Mi Configuración',
                oscuro: 'Oscuro',
                claro: 'Claro',
                idioma: 'Idioma',
                // Historial
                historialPrestamos: 'Historial de Préstamos',
                miHistorialCompleto: 'Mi Historial Completo',
                anio: 'Año',
                mes: 'Mes',
                todosMeses: 'Todos los meses',
                diaEspecifico: 'Día específico',
                // Meses
                enero: 'Enero', febrero: 'Febrero', marzo: 'Marzo', abril: 'Abril',
                mayo: 'Mayo', junio: 'Junio', julio: 'Julio', agosto: 'Agosto',
                septiembre: 'Septiembre', octubre: 'Octubre', noviembre: 'Noviembre', diciembre: 'Diciembre',
                // Estadísticas
                misEstadisticas: 'Mis Estadísticas',
                verPor: 'Ver por',
                todoTiempo: 'Todo el tiempo',
                pagosRecibidos: 'Pagos Recibidos',
                porEstado: 'Por Estado',
                actividadPeriodo: 'Actividad del Período',
                nuevos: 'Nuevos',
                buenos: 'Buenos',
                regulares: 'Regulares',
                malaPaga: 'Mala Paga',
                buscarCliente: 'Buscar Cliente',
                nombreTelefono: 'Nombre o teléfono...',
                activos: 'Activos',
                finalizados: 'Finalizados',
                atrasados: 'Atrasados',
                porTipoCliente: 'Por Tipo de Cliente',
                resumenPorEstado: 'Resumen por Estado',
                registroClientes: 'Registro de Clientes',
                limpiarFiltros: 'Limpiar Filtros',
                ultimosPagos: 'Últimos Pagos Recibidos',
                clientesEliminados: 'Clientes Eliminados',
                sinFecha: 'Sin fecha',
                noPagosRegistrados: 'No hay pagos registrados',
                noClientesEliminados: 'No hay clientes eliminados',
                todosAnios: 'Todos los años',
                totalClientes: 'Total Clientes',
                prestado: 'Prestado',
                cobrado: 'Cobrado',
                restante: 'Restante',
                // Estadísticas
                rendimiento: 'Rendimiento',
                balance: 'Balance',
                cobradoMenosGastos: 'Cobrado - Gastos',
                cantidad: 'Cantidad',
                total: 'Total',
                // Mapa
                mapaClientes: 'Mapa de Clientes',
                clientesConUbicacionTitulo: 'Clientes con ubicación',
                cargandoSesiones: 'Cargando sesiones...',
                usuariosRegistrados: 'Usuarios Registrados',
                totalUsuarios: 'Total Usuarios',
                // Mensajes
                errorConexion: 'Error de conexión',
                confirmarEliminar: '¿Estás seguro de eliminar?',
                cargando: 'Cargando...',
                sinResultados: 'Sin resultados',
                cerrarSesion: 'Cerrar Sesión',
                watermarkSubtitle: 'Gestión Financiera Profesional',
                watermarkQuote: '"El éxito financiero comienza con una buena gestión"',
                // Modales
                editarCliente: 'Editar Cliente',
                nuevoClienteModal: 'Nuevo Cliente',
                detallesCliente: 'Detalles del Cliente',
                registrarPagoModal: 'Registrar Pago',
                renovarPrestamo: 'Renovar Préstamo',
                // Parcelas
                parcelas: 'parcelas',
                de: 'de',
                // Tipos de cliente (para selects)
                tipoNuevo: '🆕 Nuevo',
                tipoBueno: '✅ Buen Cliente',
                tipoRegular: '⚠️ Regular',
                tipoMalo: '❌ Mala Paga',
                todosAnios: 'Todos los años',
                todosMeses: 'Todos los meses',
                // Tipos de negocio
                seleccionar: '-- Seleccionar --',
                negTienda: '🏪 Tienda',
                negRestaurante: '🍽️ Restaurante',
                negTaxista: '🚕 Taxista',
                negVendedor: '🛒 Vendedor Ambulante',
                negPeluqueria: '💇 Peluquería/Barbería',
                negTaller: '🔧 Taller Mecánico',
                negFarmacia: '💊 Farmacia',
                negPanaderia: '🥖 Panadería',
                negCarniceria: '🥩 Carnicería',
                negFerreteria: '🔨 Ferretería',
                negRopa: '👕 Tienda de Ropa',
                negCelulares: '📱 Celulares/Tecnología',
                negOtro: '📦 Otro',
                seleccionarFecha: 'Seleccionar Fecha',
                nombreNegocio: 'Nombre del Negocio (opcional)',
                ejTienda: 'Ej: Tienda Don José',
                // Navegador del gráfico
                navArrastra: '⟵ Arrastra para navegar ⟶',
                navUsaApp: '📊 Usa la app por más días para navegar',
                // Sistema cerrado nocturno
                sistemaCerrado: '🌙 Sistema Cerrado',
                sistemaCerradoMsg: 'El sistema está cerrado de 12:00 AM a 6:00 AM',
                abreEn: 'Abre en',
                horas: 'horas',
                minutos: 'minutos',
                soloLectura: 'Solo puedes ver información, no crear ni modificar datos',
                mostrandoHoy: 'Mostrando: Hoy',
                // Contraseña de Caja
                contraseniaCaja: 'Contraseña de Caja',
                protegeIngresoCaja: 'Protege el ingreso de dinero a la caja con una contraseña',
                configurar: 'Configurar',
                configurarContraseniaCaja: 'Configurar Contraseña de Caja',
                ingresaContraseniaCaja: 'Ingresa la contraseña de caja:',
                operacionCancelada: 'Operación cancelada',
                contraseniaIncorrecta: 'Contraseña incorrecta',
                contraseniaCajaActualizada: 'Contraseña de caja actualizada',
                contraseniaCajaEliminada: 'Contraseña de caja eliminada',
                contraseniaCajaConfigurada: 'Contraseña de caja configurada'
            },
            pt: {
                // Navegação
                dashboard: 'Painel',
                clientes: 'Clientes',
                estadisticas: 'Estatísticas',
                cobros: 'Cobranças do Dia',
                gastos: 'Despesas',
                mapa: 'Mapa',
                historial: 'Meu Histórico',
                backups: 'Backups',
                configuracion: 'Configuração',
                microseguros: 'Microsseguros',
                usuarios: 'Usuários',
                calendario: 'Calendário',
                seguridad: 'Segurança',
                // Dashboard stats
                clientesActivos: 'Clientes Ativos',
                gestionClientes: 'Gestão de Clientes',
                totalPrestado: 'Total Emprestado',
                totalCobrado: 'Total Recebido',
                pendiente: 'Pendente',
                resumen: 'Resumo',
                clientesHoy: 'Clientes de Hoje',
                clientesAtrasados: 'Clientes Atrasados',
                sinClientesAtrasados: 'Sem clientes atrasados',
                mejoresClientes: 'Melhores Clientes',
                resumenSemana: 'Resumo da Semana',
                nuevosClientes: 'Novos clientes',
                prestamosRealizados: 'Empréstimos realizados',
                cobrosRecibidos: 'Cobranças recebidas',
                gananciaEstimada: 'Lucro estimado',
                actividadReciente: 'Atividade Recente',
                pagoRecibido: 'Pagamento recebido',
                clienteCreado: 'Cliente criado',
                prestamoRenovado: 'Empréstimo renovado',
                // Botões
                nuevoCliente: 'Novo Cliente',
                guardar: 'Salvar',
                cancelar: 'Cancelar',
                eliminar: 'Excluir',
                editar: 'Editar',
                buscar: 'Buscar',
                buscarCliente: 'Buscar cliente...',
                todos: 'Todos',
                hoy: 'Hoje',
                estaSemana: 'Esta Semana',
                esteMes: 'Este Mês',
                esteAnio: 'Este Ano',
                ultimos7dias: 'Últimos 7 dias',
                buscarNombre: 'Buscar por nome...',
                montoPrestamo: 'Valor do Empréstimo',
                todosTiempos: 'Todo o período',
                nuevoGasto: 'Nova Despesa',
                miUbicacion: 'Minha Localização',
                cerrarTodas: 'Fechar Todas',
                guardarCambios: 'Salvar Alterações',
                registrarPago: 'Registrar Pagamento',
                renovar: 'Renovar',
                verMapa: 'Ver no Mapa',
                llamar: 'Ligar',
                whatsapp: 'WhatsApp',
                // Campos
                nombre: 'Nome',
                telefono: 'Telefone',
                tipo: 'Tipo',
                parcelas: 'Parcelas',
                atrasos: 'Atrasos',
                montoPrestado: 'Valor Emprestado',
                totalAPagar: 'Total a Pagar',
                dineroCobrado: 'Valor Recebido',
                parcelasAPagar: 'Parcelas a Pagar',
                parcelasPagas: 'Parcelas Pagas',
                comision: 'Comissão',
                microseguro: 'Microsseguro',
                ubicacion: 'Localização',
                notas: 'Notas',
                tipoCliente: 'Tipo de Cliente',
                tipoNegocio: 'Tipo de Negócio',
                fecha: 'Data',
                fechaInicio: 'Data Início',
                fechaFin: 'Data Fim',
                valor: 'Valor',
                cliente: 'Cliente',
                estado: 'Estado',
                acciones: 'Ações',
                descripcion: 'Descrição',
                categoria: 'Categoria',
                monto: 'Valor',
                // Estados
                nuevo: 'Novo',
                bueno: 'Bom Cliente',
                regular: 'Regular',
                malo: 'Mau Pagador',
                activo: 'Ativo',
                pagado: 'Pago',
                pendientes: 'Pendentes',
                pagadosHoy: 'Pagos Hoje',
                // Cobranças
                cobradoEsteDia: 'Cobrado neste dia',
                pagosRegistrados: 'Pagamentos registrados',
                clientesPendientes: 'Clientes pendentes',
                pagosDel: 'Pagamentos de',
                pagoRealizado: 'Pagamento realizado',
                aLas: 'às',
                sinTelefono: 'Sem telefone',
                pendientesCobro: 'Pendentes de cobrança',
                parcela: 'Parcela',
                // Seções
                gastosPersonales: 'Despesas Pessoais',
                gastosHoy: 'Despesas de Hoje',
                sinGastosFecha: 'Não há despesas para esta data',
                totalDia: 'Total do dia',
                filtrarFecha: 'Filtrar por data',
                conUbicacion: 'Com localização',
                sinUbicacion: 'Sem localização',
                ubicacionActiva: 'Localização ativa',
                backupsDisponibles: 'Backups Disponíveis',
                misBackups: 'Meus Backups',
                crearBackupAhora: 'Criar Backup Agora',
                sistemaBackupsAuto: 'Sistema de Backups Automáticos',
                backupsDescripcion: 'Seus dados são salvos automaticamente a cada hora. Os últimos 7 dias de backups são mantidos.',
                sesionesActivas: 'Sessões Ativas',
                zonaPeligro: 'Zona de Perigo',
                zonaPeligroDesc: 'Estas ações são irreversíveis. Suas carteiras pagas serão mantidas.',
                eliminarTodosDatos: 'Eliminar todos os meus dados',
                notificaciones: 'Notificações',
                recordatorioCobros: 'Lembrete de cobranças do dia',
                alertasVencimientos: 'Alertas de vencimentos',
                sonidosNotificacion: 'Sons de notificação',
                apariencia: 'Aparência',
                miConfiguracion: 'Minha Configuração',
                oscuro: 'Escuro',
                claro: 'Claro',
                idioma: 'Idioma',
                // Histórico
                historialPrestamos: 'Histórico de Empréstimos',
                miHistorialCompleto: 'Meu Histórico Completo',
                anio: 'Ano',
                mes: 'Mês',
                todosMeses: 'Todos os meses',
                diaEspecifico: 'Dia específico',
                // Meses
                enero: 'Janeiro', febrero: 'Fevereiro', marzo: 'Março', abril: 'Abril',
                mayo: 'Maio', junio: 'Junho', julio: 'Julho', agosto: 'Agosto',
                septiembre: 'Setembro', octubre: 'Outubro', noviembre: 'Novembro', diciembre: 'Dezembro',
                // Estatísticas
                misEstadisticas: 'Minhas Estatísticas',
                verPor: 'Ver por',
                todoTiempo: 'Todo o período',
                pagosRecibidos: 'Pagamentos Recebidos',
                porEstado: 'Por Estado',
                actividadPeriodo: 'Atividade do Período',
                nuevos: 'Novos',
                buenos: 'Bons',
                regulares: 'Regulares',
                malaPaga: 'Mau Pagador',
                buscarCliente: 'Buscar Cliente',
                nombreTelefono: 'Nome ou telefone...',
                activos: 'Ativos',
                finalizados: 'Finalizados',
                atrasados: 'Atrasados',
                porTipoCliente: 'Por Tipo de Cliente',
                resumenPorEstado: 'Resumo por Estado',
                registroClientes: 'Registro de Clientes',
                limpiarFiltros: 'Limpar Filtros',
                ultimosPagos: 'Últimos Pagamentos Recebidos',
                clientesEliminados: 'Clientes Excluídos',
                sinFecha: 'Sem data',
                noPagosRegistrados: 'Não há pagamentos registrados',
                noClientesEliminados: 'Não há clientes excluídos',
                todosAnios: 'Todos os anos',
                totalClientes: 'Total Clientes',
                prestado: 'Emprestado',
                cobrado: 'Recebido',
                restante: 'Restante',
                // Estatísticas
                rendimiento: 'Desempenho',
                balance: 'Balanço',
                cobradoMenosGastos: 'Recebido - Despesas',
                cantidad: 'Quantidade',
                total: 'Total',
                // Mapa
                mapaClientes: 'Mapa de Clientes',
                clientesConUbicacionTitulo: 'Clientes com localização',
                cargandoSesiones: 'Carregando sessões...',
                usuariosRegistrados: 'Usuários Registrados',
                totalUsuarios: 'Total Usuários',
                // Mensagens
                errorConexion: 'Erro de conexão',
                confirmarEliminar: 'Tem certeza que deseja excluir?',
                cargando: 'Carregando...',
                sinResultados: 'Sem resultados',
                cerrarSesion: 'Encerrar Sessão',
                watermarkSubtitle: 'Gestão Financeira Profissional',
                watermarkQuote: '"O sucesso financeiro começa com uma boa gestão"',
                // Modais
                editarCliente: 'Editar Cliente',
                nuevoClienteModal: 'Novo Cliente',
                detallesCliente: 'Detalhes do Cliente',
                registrarPagoModal: 'Registrar Pagamento',
                renovarPrestamo: 'Renovar Empréstimo',
                // Parcelas
                parcelas: 'parcelas',
                de: 'de',
                // Tipos de cliente (para selects)
                tipoNuevo: '🆕 Novo',
                tipoBueno: '✅ Bom Cliente',
                tipoRegular: '⚠️ Regular',
                tipoMalo: '❌ Mau Pagador',
                // Tipos de negócio
                seleccionar: '-- Selecionar --',
                negTienda: '🏪 Loja',
                negRestaurante: '🍽️ Restaurante',
                negTaxista: '🚕 Taxista',
                negVendedor: '🛒 Vendedor Ambulante',
                negPeluqueria: '💇 Salão/Barbearia',
                negTaller: '🔧 Oficina Mecânica',
                negFarmacia: '💊 Farmácia',
                negPanaderia: '🥖 Padaria',
                negCarniceria: '🥩 Açougue',
                negFerreteria: '🔨 Ferragem',
                negRopa: '👕 Loja de Roupas',
                negCelulares: '📱 Celulares/Tecnologia',
                negOtro: '📦 Outro',
                seleccionarFecha: 'Selecionar Data',
                nombreNegocio: 'Nome do Negócio (opcional)',
                ejTienda: 'Ex: Loja do José',
                // Navegador do gráfico
                navArrastra: '⟵ Arraste para navegar ⟶',
                navUsaApp: '📊 Use o app por mais dias para navegar',
                // Sistema fechado noturno
                sistemaCerrado: '🌙 Sistema Fechado',
                sistemaCerradoMsg: 'O sistema está fechado das 00:00 às 06:00',
                abreEn: 'Abre em',
                horas: 'horas',
                minutos: 'minutos',
                soloLectura: 'Você só pode ver informações, não criar ou modificar dados',
                mostrandoHoy: 'Mostrando: Hoje',
                // Senha do Caixa
                contraseniaCaja: 'Senha do Caixa',
                protegeIngresoCaja: 'Proteja a entrada de dinheiro no caixa com uma senha',
                configurar: 'Configurar',
                configurarContraseniaCaja: 'Configurar Senha do Caixa',
                ingresaContraseniaCaja: 'Digite a senha do caixa:',
                operacionCancelada: 'Operação cancelada',
                contraseniaIncorrecta: 'Senha incorreta',
                contraseniaCajaActualizada: 'Senha do caixa atualizada',
                contraseniaCajaEliminada: 'Senha do caixa removida',
                contraseniaCajaConfigurada: 'Senha do caixa configurada'
            }
        };
        
        function t(key) {
            return translations[currentLang][key] || translations['es'][key] || key;
        }
        
        function cambiarIdioma(lang) {
            currentLang = lang;
            localStorage.setItem('finangest_lang', lang);
            // Actualizar botones de idioma
            const btnEs = document.getElementById('btnLangEs');
            const btnPt = document.getElementById('btnLangPt');
            if (btnEs && btnPt) {
                if (lang === 'es') {
                    btnEs.style.background = 'var(--accent-cyan)';
                    btnEs.style.color = '#000';
                    btnPt.style.background = 'var(--bg-hover)';
                    btnPt.style.color = 'var(--text-primary)';
                } else {
                    btnPt.style.background = 'var(--accent-cyan)';
                    btnPt.style.color = '#000';
                    btnEs.style.background = 'var(--bg-hover)';
                    btnEs.style.color = 'var(--text-primary)';
                }
            }
            // Actualizar elementos con data-translate
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                const translated = t(key);
                if (translated && translated !== key) {
                    el.textContent = translated;
                }
            });
            // Actualizar placeholders
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.getAttribute('data-translate-placeholder');
                el.placeholder = t(key);
            });
            // Actualizar opciones de select con data-translate-opt
            document.querySelectorAll('[data-translate-opt]').forEach(el => {
                const key = el.getAttribute('data-translate-opt');
                const translated = t(key);
                if (translated && translated !== key) {
                    el.textContent = translated;
                }
            });
            // Recargar secciones dinámicas
            if (typeof renderClientes === 'function') renderClientes();
            if (typeof updateStats === 'function') updateStats();
            if (typeof renderCobros === 'function') renderCobros();
            if (typeof renderGastos === 'function') renderGastos();
            if (typeof renderMicroseguros === 'function') renderMicroseguros();
            if (typeof renderHistorial === 'function') renderHistorial();
            console.log('Idioma cambiado a:', lang);
        }
        
        // Función para cambiar idioma en pantalla de Auth (login/registro)
        function cambiarIdiomaAuth(lang) {
            currentLang = lang;
            localStorage.setItem('finangest_lang', lang);
            
            // Actualizar botones de idioma en auth
            const btnEs = document.getElementById('authLangEs');
            const btnPt = document.getElementById('authLangPt');
            if (btnEs && btnPt) {
                if (lang === 'es') {
                    btnEs.style.background = '#00d4ff';
                    btnEs.style.borderColor = '#00d4ff';
                    btnEs.style.color = '#000';
                    btnEs.style.fontWeight = '600';
                    btnPt.style.background = '#161b22';
                    btnPt.style.borderColor = '#30363d';
                    btnPt.style.color = '#9ca3af';
                    btnPt.style.fontWeight = 'normal';
                } else {
                    btnPt.style.background = '#00d4ff';
                    btnPt.style.borderColor = '#00d4ff';
                    btnPt.style.color = '#000';
                    btnPt.style.fontWeight = '600';
                    btnEs.style.background = '#161b22';
                    btnEs.style.borderColor = '#30363d';
                    btnEs.style.color = '#9ca3af';
                    btnEs.style.fontWeight = 'normal';
                }
            }
            
            // Textos de Auth
            const authTexts = {
                es: {
                    titulo: '¡Bienvenido!',
                    subtitulo: 'Ingresa tus credenciales para acceder al sistema',
                    labelEmail: 'Email o Usuario',
                    labelSenha: 'Contraseña',
                    btnLogin: 'Iniciar Sesión',
                    olvidoSenha: '¿Olvidaste tu contraseña?',
                    cambiarUsuario: 'Recuperar cuenta con Gmail de recuperación',
                    noCuenta: '¿No tienes cuenta? ',
                    registrarse: 'Regístrate',
                    // Registro
                    crearCuenta: 'Crear Cuenta',
                    completaDatos: 'Completa tus datos para registrarte',
                    nombreCompleto: 'Nombre Completo',
                    usuario: 'Usuario',
                    contrasena: 'Contraseña',
                    aceptoTerminos: 'Acepto los',
                    terminos: 'Términos',
                    privacidad: 'Privacidad',
                    enviarCodigo: 'Enviar Código',
                    yaTieneCuenta: '¿Ya tienes cuenta? ',
                    ingresar: 'Ingresar',
                    // Branding
                    sistemaFinanciero: 'Sistema Financiero',
                    instalarApp: 'Instalar Aplicación',
                    controlClientes: 'Control de Clientes',
                    gestionaClientes: 'Gestiona todos tus clientes fácilmente',
                    seguimientoPagos: 'Seguimiento de Pagos',
                    cobrosAutomaticos: 'Cobros automáticos y alertas',
                    reportesTiempoReal: 'Reportes en Tiempo Real',
                    estadisticasGraficos: 'Estadísticas y gráficos detallados',
                    // Recuperar
                    recuperarSenha: 'Recuperar Contraseña',
                    ingresaEmail: 'Ingresa tu email principal o de recuperación',
                    volverLogin: 'Volver al Login'
                },
                pt: {
                    titulo: 'Bem-vindo!',
                    subtitulo: 'Digite suas credenciais para acessar o sistema',
                    labelEmail: 'Email ou Usuário',
                    labelSenha: 'Senha',
                    btnLogin: 'Entrar',
                    olvidoSenha: 'Esqueceu sua senha?',
                    cambiarUsuario: 'Recuperar conta com Gmail de recuperação',
                    noCuenta: 'Não tem conta? ',
                    registrarse: 'Cadastre-se',
                    // Registro
                    crearCuenta: 'Criar Conta',
                    completaDatos: 'Complete seus dados para se cadastrar',
                    nombreCompleto: 'Nome Completo',
                    usuario: 'Usuário',
                    contrasena: 'Senha',
                    aceptoTerminos: 'Aceito os',
                    terminos: 'Termos',
                    privacidad: 'Privacidade',
                    enviarCodigo: 'Enviar Código',
                    yaTieneCuenta: 'Já tem conta? ',
                    ingresar: 'Entrar',
                    // Branding
                    sistemaFinanciero: 'Sistema Financeiro',
                    instalarApp: 'Instalar Aplicativo',
                    controlClientes: 'Controle de Clientes',
                    gestionaClientes: 'Gerencie todos os seus clientes facilmente',
                    seguimientoPagos: 'Acompanhamento de Pagamentos',
                    cobrosAutomaticos: 'Cobranças automáticas e alertas',
                    reportesTiempoReal: 'Relatórios em Tempo Real',
                    estadisticasGraficos: 'Estatísticas e gráficos detalhados',
                    // Recuperar
                    recuperarSenha: 'Recuperar Senha',
                    ingresaEmail: 'Digite seu email principal ou de recuperação',
                    volverLogin: 'Voltar ao Login'
                }
            };
            
            const txt = authTexts[lang];
            
            // Actualizar textos del login
            const el = (id) => document.getElementById(id);
            if (el('authTitulo')) el('authTitulo').textContent = txt.titulo;
            if (el('authSubtitulo')) el('authSubtitulo').textContent = txt.subtitulo;
            if (el('labelEmail')) el('labelEmail').textContent = txt.labelEmail;
            if (el('labelSenha')) el('labelSenha').textContent = txt.labelSenha;
            if (el('btnLogin')) el('btnLogin').textContent = txt.btnLogin;
            if (el('linkOlvidoSenha')) el('linkOlvidoSenha').textContent = txt.olvidoSenha;
            if (el('linkCambiarUsuario')) el('linkCambiarUsuario').textContent = txt.cambiarUsuario;
            if (el('spanNoCuenta')) el('spanNoCuenta').textContent = txt.noCuenta;
            if (el('linkRegistrarse')) el('linkRegistrarse').textContent = txt.registrarse;
            
            // Actualizar textos del branding
            if (el('brandingSistema')) el('brandingSistema').textContent = txt.sistemaFinanciero;
            if (el('installBtn')) el('installBtn').innerHTML = '<i class="fas fa-download" style="margin-right: 12px;"></i>' + txt.instalarApp;
            if (el('brandingControl')) el('brandingControl').textContent = txt.controlClientes;
            if (el('brandingControlDesc')) el('brandingControlDesc').textContent = txt.gestionaClientes;
            if (el('brandingSeguimiento')) el('brandingSeguimiento').textContent = txt.seguimientoPagos;
            if (el('brandingSeguimientoDesc')) el('brandingSeguimientoDesc').textContent = txt.cobrosAutomaticos;
            if (el('brandingReportes')) el('brandingReportes').textContent = txt.reportesTiempoReal;
            if (el('brandingReportesDesc')) el('brandingReportesDesc').textContent = txt.estadisticasGraficos;
            
            // Actualizar textos del registro
            if (el('regTitulo')) el('regTitulo').textContent = txt.crearCuenta;
            if (el('regSubtitulo')) el('regSubtitulo').textContent = txt.completaDatos;
            if (el('labelNombre')) el('labelNombre').textContent = txt.nombreCompleto;
            if (el('labelUsuario')) el('labelUsuario').textContent = txt.usuario;
            if (el('labelRegEmail')) el('labelRegEmail').textContent = 'Email';
            if (el('labelRecoveryEmail')) el('labelRecoveryEmail').innerHTML = (lang === 'es' ? 'Email de Recuperación' : 'Email de Recuperação') + ' <span style="color: var(--accent-red); font-size: 0.8rem;">*</span>';
            if (el('recoveryEmailHelp')) el('recoveryEmailHelp').textContent = lang === 'es' ? 'Obligatorio - Usado para recuperar tu cuenta si pierdes acceso al email principal' : 'Obrigatório - Usado para recuperar sua conta se perder acesso ao email principal';
            if (el('labelRegSenha')) el('labelRegSenha').textContent = txt.contrasena;
            if (el('spanAceptoTerminos')) el('spanAceptoTerminos').textContent = txt.aceptoTerminos;
            if (el('linkTerminos')) el('linkTerminos').textContent = txt.terminos;
            if (el('linkPrivacidad')) el('linkPrivacidad').textContent = txt.privacidad;
            if (el('spanYaCuenta')) el('spanYaCuenta').textContent = txt.yaTieneCuenta;
            if (el('linkIngresar')) el('linkIngresar').textContent = txt.ingresar;
            
            console.log('Idioma Auth cambiado a:', lang);
        }
        
        // Inicializar idioma en Auth al cargar
        function initIdiomaAuth() {
            const lang = localStorage.getItem('finangest_lang') || 'es'; // ESPAÑOL POR DEFECTO
            cambiarIdiomaAuth(lang);
        }
        
        // Inicializar idioma al cargar
        function initIdioma() {
            const lang = localStorage.getItem('finangest_lang') || 'es';
            currentLang = lang;
            // Actualizar botones de idioma
            const btnEs = document.getElementById('btnLangEs');
            const btnPt = document.getElementById('btnLangPt');
            if (btnEs && btnPt) {
                if (lang === 'es') {
                    btnEs.style.background = 'var(--accent-cyan)';
                    btnEs.style.color = '#000';
                    btnPt.style.background = 'var(--bg-hover)';
                    btnPt.style.color = 'var(--text-primary)';
                } else {
                    btnPt.style.background = 'var(--accent-cyan)';
                    btnPt.style.color = '#000';
                    btnEs.style.background = 'var(--bg-hover)';
                    btnEs.style.color = 'var(--text-primary)';
                }
            }
            // Aplicar traducciones después de un pequeño delay para asegurar que el DOM esté listo
            setTimeout(() => {
                document.querySelectorAll('[data-translate]').forEach(el => {
                    const key = el.getAttribute('data-translate');
                    const translated = t(key);
                    if (translated && translated !== key) {
                        el.textContent = translated;
                    }
                });
            }, 500);
        }

        // Función para verificar si el usuario tiene llave de edición
        async function checkEditKey() {
            if (!currentUser || currentUser.role === 'admin' || currentUser.isAdmin) return true;
            
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                const myUser = users.find(u => u.id === currentUser.id || u._id === currentUser.id);
                
                if (myUser) {
                    // Detectar cambio de estado de la llave
                    if (lastEditKeyStatus !== null && lastEditKeyStatus !== myUser.editKeyEnabled) {
                        if (myUser.editKeyEnabled) {
                            alert('🔑 O administrador ATIVOU sua chave de edição!\n\nAgora você pode editar empréstimos e informações de clientes.');
                        } else {
                            alert('🔒 O administrador DESATIVOU sua chave de edição.\n\nVocê não pode mais editar empréstimos nem informações de clientes.');
                        }
                    }
                    lastEditKeyStatus = myUser.editKeyEnabled;
                    return myUser.editKeyEnabled === true;
                }
            } catch (e) {
                console.log('Error verificando llave:', e);
            }
            return false;
        }

        // Verificar llave periódicamente (cada 30 segundos) y actualizar UI
        setInterval(async () => {
            if (currentUser && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                const oldStatus = userHasEditKey;
                await updateEditKeyStatus();
                // Si cambió el estado, re-renderizar clientes
                if (oldStatus !== userHasEditKey) {
                    renderClientes();
                }
                await checkEditKey();
            }
        }, 30000);

        // Auth Functions
        function showAuthTab(tab, evt) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            if (evt && evt.target) {
                evt.target.classList.add('active');
            } else {
                // Activar el tab correcto manualmente
                document.querySelectorAll('.auth-tab').forEach((t, i) => {
                    if ((tab === 'login' && i === 0) || (tab === 'register' && i === 1)) {
                        t.classList.add('active');
                    }
                });
            }
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            const renewalPaymentForm = document.getElementById('renewalPaymentForm');
            const supportSection = document.getElementById('supportSection');
            const registerStep1 = document.getElementById('registerStep1');
            const registerStep2 = document.getElementById('registerStep2');
            
            if (loginForm) loginForm.style.display = tab === 'login' ? 'block' : 'none';
            if (registerForm) registerForm.style.display = tab === 'register' ? 'block' : 'none';
            if (forgotPasswordForm) forgotPasswordForm.style.display = 'none';
            if (renewalPaymentForm) renewalPaymentForm.style.display = 'none';
            if (supportSection) supportSection.style.display = 'block';
            if (registerStep1) registerStep1.style.display = 'block';
            if (registerStep2) registerStep2.style.display = 'none';
        }

        // Helper function para evitar errores de null
        function setDisplay(id, display) {
            const el = document.getElementById(id);
            if (el) el.style.display = display;
        }
        
        // Forgot Password Functions
        function showForgotPassword() {
            setDisplay('loginForm', 'none');
            setDisplay('registerForm', 'none');
            setDisplay('forgotPasswordForm', 'block');
            setDisplay('forgotStep1', 'block');
            setDisplay('forgotStep2', 'none');
            setDisplay('supportSection', 'none');
            setDisplay('recoveryEmailNotice', 'none');
            setDisplay('newRecoveryEmailContainer', 'none');
        }

        function backToLogin() {
            const forgotForm = document.getElementById('forgotPasswordForm');
            const renewalForm = document.getElementById('renewalPaymentForm');
            const loginForm = document.getElementById('loginForm');
            const supportSection = document.getElementById('supportSection');
            
            if (forgotForm) forgotForm.style.display = 'none';
            if (renewalForm) renewalForm.style.display = 'none';
            if (loginForm) loginForm.style.display = 'block';
            if (supportSection) supportSection.style.display = 'block';
            
            document.querySelectorAll('.auth-tab').forEach((t, i) => {
                t.classList.toggle('active', i === 0);
            });
        }

        async function sendResetCode() {
            const email = document.getElementById('forgotEmail').value;
            if (!email) return alert('Digite seu email');
            const btn = document.getElementById('btnSendResetCode');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            try {
                const res = await fetch(API_URL + '/api/forgot-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                if (data.success) {
                    setDisplay('forgotStep1', 'none');
                    setDisplay('forgotStep2', 'block');
                    document.getElementById('forgotEmailSent').textContent = data.sentTo || email;
                    
                    // Si usó email de recuperación, mostrar aviso y campo para nuevo email
                    if (data.usedRecoveryEmail) {
                        const emailIngresado = document.getElementById('forgotEmail').value;
                        const noticeText = currentLang === 'es' ?
                            `Tu nuevo email principal será: ${emailIngresado}. Ahora debes ingresar un nuevo email de recuperación.` :
                            `Seu novo email principal será: ${emailIngresado}. Agora você deve inserir um novo email de recuperação.`;
                        const noticeEl = document.getElementById('recoveryEmailNoticeText');
                        if (noticeEl) noticeEl.textContent = noticeText;
                        setDisplay('recoveryEmailNotice', 'block');
                        setDisplay('newRecoveryEmailContainer', 'block');
                        window.usedRecoveryEmailForReset = true;
                    } else {
                        setDisplay('recoveryEmailNotice', 'none');
                        setDisplay('newRecoveryEmailContainer', 'none');
                        window.usedRecoveryEmailForReset = false;
                    }
                } else {
                    alert(data.error || 'Error al enviar código');
                }
            } catch (e) {
                alert('Error de conexión');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Código';
        }

        async function resendResetCode() {
            await sendResetCode();
        }

        async function resetPassword() {
            const email = document.getElementById('forgotEmail').value;
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const newRecoveryEmail = document.getElementById('newRecoveryEmail')?.value || '';
            
            if (!code || code.length !== 6) return alert('Digite o código de 6 dígitos');
            if (!newPassword || newPassword.length < 6) return alert('A senha deve ter pelo menos 6 caracteres');
            if (newPassword !== confirmPassword) return alert('As senhas não coincidem');
            
            // Si usó email de recuperación, DEBE proporcionar un nuevo email de recuperación
            if (window.usedRecoveryEmailForReset && !newRecoveryEmail) {
                return alert(currentLang === 'es' ? 
                    'Debes proporcionar un nuevo email de recuperación' : 
                    'Você deve fornecer um novo email de recuperação');
            }
            
            // Validar que el nuevo email de recuperación sea diferente al email usado
            if (newRecoveryEmail && newRecoveryEmail.toLowerCase() === email.toLowerCase()) {
                return alert(currentLang === 'es' ? 
                    'El email de recuperación debe ser diferente al email principal' : 
                    'O email de recuperação deve ser diferente do email principal');
            }
            
            const btn = document.getElementById('btnResetPassword');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Cambiando...';
            try {
                const res = await fetch(API_URL + '/api/reset-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, newPassword, newRecoveryEmail: newRecoveryEmail || undefined })
                });
                const data = await res.json();
                if (data.success) {
                    // Mensaje diferente si hubo rotación de email
                    if (data.emailRotated) {
                        const msg = currentLang === 'es' ? 
                            `✅ ¡CUENTA RECUPERADA!\n\n📧 Tu NUEVO email principal es:\n${data.newEmail}\n\n⚠️ IMPORTANTE: Usa este email para iniciar sesión a partir de ahora.` :
                            `✅ CONTA RECUPERADA!\n\n📧 Seu NOVO email principal é:\n${data.newEmail}\n\n⚠️ IMPORTANTE: Use este email para fazer login a partir de agora.`;
                        alert(msg);
                    } else {
                        alert(currentLang === 'es' ? 
                            'Contraseña cambiada con éxito. Ahora puedes iniciar sesión.' :
                            'Senha alterada com sucesso! Agora você pode fazer login.');
                    }
                    
                    // Limpiar campos primero
                    try {
                        const forgotEmail = document.getElementById('forgotEmail');
                        const resetCode = document.getElementById('resetCode');
                        const newPass = document.getElementById('newPassword');
                        const confirmPass = document.getElementById('confirmPassword');
                        const newRecEmail = document.getElementById('newRecoveryEmail');
                        
                        if (forgotEmail) forgotEmail.value = '';
                        if (resetCode) resetCode.value = '';
                        if (newPass) newPass.value = '';
                        if (confirmPass) confirmPass.value = '';
                        if (newRecEmail) newRecEmail.value = '';
                    } catch(cleanErr) {}
                    
                    window.usedRecoveryEmailForReset = false;
                    
                    // Volver al login
                    try {
                        backToLogin();
                    } catch(navErr) {
                        // Si falla backToLogin, recargar la página
                        window.location.reload();
                    }
                } else {
                    alert(data.error || 'Error al cambiar contraseña');
                }
            } catch (e) {
                alert('Error de conexión: ' + e.message);
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-check me-2"></i>Cambiar Contraseña';
        }

        // Función para detectar información del dispositivo
        function getDeviceInfo() {
            const ua = navigator.userAgent;
            let deviceName = 'Dispositivo';
            let deviceType = 'desktop';
            let os = 'Sistema';
            let browser = 'Navegador';
            
            // Detectar OS
            if (/Windows/i.test(ua)) os = 'Windows';
            else if (/Mac/i.test(ua)) os = 'macOS';
            else if (/Linux/i.test(ua)) os = 'Linux';
            else if (/Android/i.test(ua)) os = 'Android';
            else if (/iPhone|iPad|iPod/i.test(ua)) os = 'iOS';
            
            // Detectar tipo de dispositivo y nombre
            if (/iPhone/i.test(ua)) { deviceType = 'mobile'; deviceName = 'iPhone'; }
            else if (/iPad/i.test(ua)) { deviceType = 'tablet'; deviceName = 'iPad'; }
            else if (/Motorola|Moto/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Motorola'; }
            else if (/Samsung/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Samsung'; }
            else if (/Xiaomi|Redmi|POCO/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Xiaomi'; }
            else if (/Huawei/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Huawei'; }
            else if (/OPPO/i.test(ua)) { deviceType = 'mobile'; deviceName = 'OPPO'; }
            else if (/Vivo/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Vivo'; }
            else if (/OnePlus/i.test(ua)) { deviceType = 'mobile'; deviceName = 'OnePlus'; }
            else if (/LG/i.test(ua)) { deviceType = 'mobile'; deviceName = 'LG'; }
            else if (/Android/i.test(ua)) { deviceType = 'mobile'; deviceName = 'Android'; }
            else if (/Windows/i.test(ua)) { deviceType = 'desktop'; deviceName = 'Windows PC'; }
            else if (/Mac/i.test(ua)) { deviceType = 'desktop'; deviceName = 'Mac'; }
            
            // Detectar navegador
            if (/Chrome/i.test(ua) && !/Edge|Edg/i.test(ua)) browser = 'Chrome';
            else if (/Firefox/i.test(ua)) browser = 'Firefox';
            else if (/Safari/i.test(ua) && !/Chrome/i.test(ua)) browser = 'Safari';
            else if (/Edge|Edg/i.test(ua)) browser = 'Edge';
            else if (/Opera|OPR/i.test(ua)) browser = 'Opera';
            
            return { deviceName, deviceType, os, browser };
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Preencha todos os campos');
            
            // Mostrar estado de carga inmediatamente
            const btn = document.getElementById('btnLogin');
            const btnTextoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + (currentLang === 'pt' ? 'Entrando...' : 'Ingresando...');
            btn.disabled = true;
            btn.style.opacity = '0.7';
            
            try {
                const deviceInfo = getDeviceInfo();
                const res = await fetch(API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password, deviceInfo })
                });
                
                // Verificar si la respuesta es JSON
                const contentType = res.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('Respuesta no es JSON:', await res.text());
                    btn.innerHTML = btnTextoOriginal;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    return alert('Erro do servidor. Tente novamente.');
                }
                
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    
                    // Inicializar timezone del usuario
                    if (currentUser.timezone) {
                        userTimezone = currentUser.timezone;
                    }
                    // Sincronizar hora del servidor
                    await initServerTime();
                    
                    // Guardar sessionId
                    if (data.sessionId) {
                        sessionStorage.setItem('finangest_session', data.sessionId);
                    }
                    sessionStorage.setItem('finangest_user', JSON.stringify(currentUser));
                    
                    // Backup automático al iniciar sesión
                    const userId = currentUser.id || currentUser._id;
                    if (currentUser.isAdmin || currentUser.role === 'admin') {
                        // Admin: backup del sistema completo
                        fetch(API_URL + '/api/admin/backup', { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ auto: true })
                        }).catch(err => console.error('Error backup sistema:', err));
                    } else if (userId) {
                        // Trabajador: backup de sus datos
                        fetch(API_URL + '/api/admin/backup-trabajador/' + userId, { 
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ auto: true })
                        }).catch(err => console.error('Error backup auto:', err));
                    }
                    
                    showMainApp();
                } else if (data.needsPayment) {
                    // Usuario necesita pagar - mostrar modal de suscripción
                    pendingUser = { id: data.userId, nombre: data.nombre, email: data.email };
                    pendingUserNeedsPayment = true;
                    
                    if (data.expired) {
                        mostrarModalSuscripcion(
                            'Suscripción Vencida',
                            'Tu período de suscripción ha terminado. Han pasado 30 días desde tu último pago. Renueva ahora para continuar usando FinanGest.',
                            true // Es renovación
                        );
                    } else {
                        mostrarModalSuscripcion(
                            'Pago Pendiente',
                            'Tu cuenta está pendiente de activación. Completa el pago para acceder a todas las funciones de FinanGest.',
                            true // Es renovación
                        );
                    }
                } else {
                    // Error normal (contraseña incorrecta, usuario no encontrado, etc.)
                    btn.innerHTML = btnTextoOriginal;
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    mostrarModalSuscripcion('Error', data.error || 'Error al iniciar sesión', false);
                }
            } catch (e) {
                btn.innerHTML = btnTextoOriginal;
                btn.disabled = false;
                btn.style.opacity = '1';
                mostrarModalSuscripcion('Error de Conexión', 'No se pudo conectar con el servidor. Verifica tu conexión a internet e intenta de nuevo.', false);
            }
        }
        
        function mostrarModalSuscripcion(titulo, mensaje, esRenovacion = false) {
            document.getElementById('modalSuscripcionTitulo').textContent = titulo;
            document.getElementById('modalSuscripcionMensaje').textContent = mensaje;
            
            const icono = document.getElementById('modalSuscripcionIcono');
            const btnRenovar = document.getElementById('btnRenovarSuscripcion');
            const btnCerrar = document.getElementById('btnCerrarModal');
            
            if (esRenovacion) {
                // Mostrar icono de reloj y botón de renovar
                icono.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a5a)';
                icono.innerHTML = '<i class="fas fa-clock fa-2x" style="color: white;"></i>';
                btnRenovar.style.display = 'block';
                btnCerrar.style.display = 'none';
            } else {
                // Mostrar icono de error y botón de cerrar
                icono.style.background = 'linear-gradient(135deg, #ff6b6b, #ee5a5a)';
                icono.innerHTML = '<i class="fas fa-exclamation-triangle fa-2x" style="color: white;"></i>';
                btnRenovar.style.display = 'none';
                btnCerrar.style.display = 'block';
            }
            
            document.getElementById('modalSuscripcion').style.display = 'flex';
        }
        
        let pendingUserNeedsPayment = false;
        
        // Cerrar modal de error simple
        function cerrarModalError() {
            document.getElementById('modalSuscripcion').style.display = 'none';
        }
        
        // ========== FUNCIONES DE RENOVACIÓN DE CARTERAS ==========
        let carterasParaRenovar = [];
        
        // Mostrar gestión de suscripciones (todas las carteras)
        function mostrarGestionSuscripciones() {
            toggleCarteraDropdown(); // Cerrar dropdown
            
            carterasParaRenovar = [];
            const lista = document.getElementById('listaCarterasRenovar');
            
            let html = '';
            const hoy = getCurrentDate();
            
            // Ordenar: primero expiradas, luego por días restantes
            const carterasOrdenadas = [...carteras].sort((a, b) => {
                const expA = a.fechaExpiracion ? new Date(a.fechaExpiracion) : new Date('2099-12-31');
                const expB = b.fechaExpiracion ? new Date(b.fechaExpiracion) : new Date('2099-12-31');
                const diasA = Math.ceil((expA - hoy) / (1000 * 60 * 60 * 24));
                const diasB = Math.ceil((expB - hoy) / (1000 * 60 * 60 * 24));
                return diasA - diasB;
            });
            
            let hayRenovables = false;
            
            carterasOrdenadas.forEach((c, idx) => {
                const expira = c.fechaExpiracion ? new Date(c.fechaExpiracion) : null;
                const diffMs = expira ? (expira - hoy) : 999999999999;
                const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
                const puedeRenovar = diffDays <= 0; // Solo puede renovar el mismo día que expira o después
                
                let estadoBadge = '';
                let estadoColor = '';
                
                if (diffDays <= 0) {
                    estadoBadge = '<i class="fas fa-exclamation-circle me-1"></i>Expirada';
                    estadoColor = 'var(--accent-red)';
                    hayRenovables = true;
                } else {
                    // Calcular tiempo restante exacto
                    const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                    const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                    const segundos = Math.floor((diffMs % (1000 * 60)) / 1000);
                    
                    const tiempoId = `tiempo_${c.id}`;
                    estadoBadge = `<span id="${tiempoId}">${dias}d ${horas}h ${minutos}m ${segundos}s</span>`;
                    
                    if (diffDays <= 5) {
                        estadoColor = 'var(--accent-yellow)';
                    } else if (diffDays <= 15) {
                        estadoColor = 'var(--accent-cyan)';
                    } else {
                        estadoColor = 'var(--accent-green)';
                    }
                }
                
                if (puedeRenovar) {
                    // Cartera expirada - puede renovarse
                    html += `
                        <div style="display: flex; align-items: center; padding: 12px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="toggleCarteraRenovar('${c.id}', this)">
                            <input type="checkbox" id="renovar_${c.id}" data-cartera-id="${c.id}" checked style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#00d4ff'}; margin-right: 12px;"></div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: 600;">${c.nombre}</div>
                                <small style="color: var(--text-secondary);">R$ 51,41/mes</small>
                            </div>
                            <span style="color: ${estadoColor}; font-size: 0.8rem;">${estadoBadge}</span>
                        </div>
                    `;
                    carterasParaRenovar.push(c.id);
                } else {
                    // Cartera activa - solo mostrar info, sin checkbox
                    html += `
                        <div style="display: flex; align-items: center; padding: 12px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 8px; opacity: 0.7;">
                            <div style="width: 20px; height: 20px; margin-right: 12px; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check" style="color: var(--accent-green); font-size: 0.9rem;"></i>
                            </div>
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#00d4ff'}; margin-right: 12px;"></div>
                            <div style="flex: 1;">
                                <div style="color: #fff; font-weight: 600;">${c.nombre}</div>
                                <small style="color: var(--accent-green);">Activa</small>
                            </div>
                            <span style="color: ${estadoColor}; font-size: 0.8rem; font-family: monospace;">${estadoBadge}</span>
                        </div>
                    `;
                }
            });
            
            if (carteras.length === 0) {
                html = `<div style="padding: 20px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-folder-open" style="font-size: 2rem; margin-bottom: 10px; display: block;"></i>
                    No tienes carteras creadas
                </div>`;
            } else if (!hayRenovables) {
                html += `<div style="padding: 15px; text-align: center; color: var(--accent-green); background: rgba(46,204,113,0.1); border-radius: 8px; margin-top: 10px;">
                    <i class="fas fa-check-circle me-2"></i>Todas tus carteras están activas
                </div>`;
            }
            
            lista.innerHTML = html;
            actualizarTotalRenovacion();
            
            // Actualizar título del modal
            document.querySelector('#modalRenovarCarteras h3').textContent = 'Gestionar Suscripciones';
            document.querySelector('#modalRenovarCarteras p').textContent = 'Solo puedes renovar carteras que ya expiraron';
            
            document.getElementById('modalRenovarCarteras').style.display = 'flex';
            
            // Iniciar contador en tiempo real
            iniciarContadorSuscripciones();
        }
        
        // Variable global para el intervalo del contador
        let contadorSuscripcionesInterval = null;
        
        // Función para iniciar el contador en tiempo real
        function iniciarContadorSuscripciones() {
            // Limpiar intervalo anterior si existe
            if (contadorSuscripcionesInterval) {
                clearInterval(contadorSuscripcionesInterval);
            }
            
            // Actualizar cada segundo
            contadorSuscripcionesInterval = setInterval(() => {
                const hoy = getCurrentDate();
                
                carteras.forEach(c => {
                    const tiempoElement = document.getElementById(`tiempo_${c.id}`);
                    if (tiempoElement && c.fechaExpiracion) {
                        const expira = new Date(c.fechaExpiracion);
                        const diffMs = expira - hoy;
                        
                        if (diffMs > 0) {
                            const dias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            const horas = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                            const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                            const segundos = Math.floor((diffMs % (1000 * 60)) / 1000);
                            
                            tiempoElement.textContent = `${dias}d ${horas}h ${minutos}m ${segundos}s`;
                        } else {
                            // Expiró, recargar la vista
                            clearInterval(contadorSuscripcionesInterval);
                            mostrarGestionSuscripciones();
                        }
                    }
                });
            }, 1000);
        }
        
        // Detener contador cuando se cierra el modal
        function cerrarModalRenovarCarteras() {
            if (contadorSuscripcionesInterval) {
                clearInterval(contadorSuscripcionesInterval);
                contadorSuscripcionesInterval = null;
            }
            document.getElementById('modalRenovarCarteras').style.display = 'none';
        }
        
        // Mostrar modal de renovación para una sola cartera (desde el dropdown)
        function mostrarModalRenovarCarteraUnica(carteraId) {
            const cartera = carteras.find(c => c.id === carteraId);
            if (cartera) {
                mostrarModalRenovarCarteras([cartera]);
            }
        }
        
        function mostrarModalRenovarCarteras(carterasExpiradas) {
            carterasParaRenovar = [];
            const lista = document.getElementById('listaCarterasRenovar');
            
            let html = '';
            carterasExpiradas.forEach((c, idx) => {
                html += `
                    <div style="display: flex; align-items: center; padding: 12px; background: var(--bg-hover); border-radius: 8px; margin-bottom: 8px; cursor: pointer;" onclick="toggleCarteraRenovar('${c.id}', this)">
                        <input type="checkbox" id="renovar_${c.id}" data-cartera-id="${c.id}" style="width: 20px; height: 20px; margin-right: 12px; cursor: pointer;">
                        <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#00d4ff'}; margin-right: 12px;"></div>
                        <div style="flex: 1;">
                            <div style="color: #fff; font-weight: 600;">${c.nombre}</div>
                            <small style="color: var(--text-secondary);">R$ 50,50/mes</small>
                        </div>
                        <span style="color: var(--accent-red); font-size: 0.8rem;"><i class="fas fa-exclamation-circle me-1"></i>Expirada</span>
                    </div>
                `;
            });
            
            lista.innerHTML = html;
            actualizarTotalRenovacion();
            
            // Restaurar título del modal
            document.querySelector('#modalRenovarCarteras h3').textContent = 'Renovar Suscripción';
            document.querySelector('#modalRenovarCarteras p').textContent = 'Selecciona las carteras que deseas renovar';
            
            document.getElementById('modalRenovarCarteras').style.display = 'flex';
        }
        
        function toggleCarteraRenovar(carteraId, elemento) {
            const checkbox = document.getElementById('renovar_' + carteraId);
            checkbox.checked = !checkbox.checked;
            
            if (checkbox.checked) {
                if (!carterasParaRenovar.includes(carteraId)) {
                    carterasParaRenovar.push(carteraId);
                }
                elemento.style.border = '2px solid var(--accent-cyan)';
            } else {
                carterasParaRenovar = carterasParaRenovar.filter(id => id !== carteraId);
                elemento.style.border = 'none';
            }
            
            actualizarTotalRenovacion();
        }
        
        function seleccionarTodasCarteras() {
            carterasParaRenovar = [];
            document.querySelectorAll('#listaCarterasRenovar input[type="checkbox"]').forEach(cb => {
                cb.checked = true;
                carterasParaRenovar.push(cb.dataset.carteraId);
                cb.closest('div[onclick]').style.border = '2px solid var(--accent-cyan)';
            });
            actualizarTotalRenovacion();
        }
        
        function actualizarTotalRenovacion() {
            const cantidad = carterasParaRenovar.length;
            const total = cantidad * PRECIO_POR_CARTERA;
            
            document.getElementById('totalRenovacion').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            document.getElementById('detalleRenovacion').textContent = cantidad + ' cartera' + (cantidad !== 1 ? 's' : '') + ' × R$ 51,41';
            
            const btn = document.getElementById('btnConfirmarRenovacion');
            btn.disabled = cantidad === 0;
            btn.style.opacity = cantidad === 0 ? '0.5' : '1';
            btn.style.cursor = cantidad === 0 ? 'not-allowed' : 'pointer';
        }
        
        function cerrarModalRenovacion() {
            // Detener contador
            if (contadorSuscripcionesInterval) {
                clearInterval(contadorSuscripcionesInterval);
                contadorSuscripcionesInterval = null;
            }
            document.getElementById('modalRenovarCarteras').style.display = 'none';
            carterasParaRenovar = [];
        }
        
        // Variable para guardar las carteras a renovar durante el pago
        let carterasRenovandose = [];
        let pagoRenovacionId = null;
        let verificacionRenovacionInterval = null;
        
        async function confirmarRenovacion() {
            if (carterasParaRenovar.length === 0) {
                alert('Selecciona al menos una cartera para renovar');
                return;
            }
            
            // Guardar las carteras seleccionadas
            carterasRenovandose = [...carterasParaRenovar];
            
            const total = carterasParaRenovar.length * PRECIO_POR_CARTERA;
            
            // Cerrar modal y mostrar pantalla de pago
            cerrarModalRenovacion();
            
            // Generar PIX con el monto de las carteras seleccionadas
            if (currentUser) {
                mostrarPagoRenovacionCarteras(currentUser.id, currentUser.nombre, currentUser.email, carterasRenovandose);
            }
        }
        
        // Mostrar modal de pago para renovación de carteras
        async function mostrarPagoRenovacionCarteras(userId, nombre, email, carteraIds) {
            const total = carteraIds.length * PRECIO_POR_CARTERA;
            
            // Actualizar el modal de renovación de pago
            document.getElementById('renewalPrecio').textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('renewalPaymentForm').style.display = 'block';
            
            try {
                const res = await fetch(API_URL + '/api/crear-pago-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId,
                        nombre,
                        email,
                        monto: parseFloat(total.toFixed(2)), // Asegurar formato correcto
                        cantidadCarteras: carteraIds.length
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    pagoRenovacionId = data.paymentId;
                    
                    // Mostrar QR
                    document.getElementById('renewalQrCode').innerHTML = `<img src="data:image/png;base64,${data.qrCodeBase64}" style="width: 200px; height: 200px;">`;
                    document.getElementById('renewalPixCode').value = data.qrCode;
                    
                    // Iniciar verificación automática
                    if (verificacionRenovacionInterval) clearInterval(verificacionRenovacionInterval);
                    verificacionRenovacionInterval = setInterval(() => verificarPagoRenovacionCarteras(data.paymentId, carteraIds), 5000);
                } else {
                    document.getElementById('renewalQrCode').innerHTML = `<p style="color: var(--accent-red);">Error: ${data.error}</p>`;
                }
            } catch (e) {
                document.getElementById('renewalQrCode').innerHTML = `<p style="color: var(--accent-red);">Error de conexión</p>`;
            }
        }
        
        // Verificar pago de renovación de carteras
        async function verificarPagoRenovacionCarteras(paymentId, carteraIds) {
            try {
                const res = await fetch(API_URL + '/api/verificar-pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId, userId: currentUser?.id })
                });
                
                const data = await res.json();
                if (data.paid) {
                    if (verificacionRenovacionInterval) clearInterval(verificacionRenovacionInterval);
                    
                    // Renovar las carteras seleccionadas
                    await fetch(API_URL + '/api/renovar-carteras', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUser?.id,
                            carteraIds: carteraIds,
                            paymentId: paymentId
                        })
                    });
                    
                    // Volver al login y recargar
                    document.getElementById('renewalPaymentForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    
                    showToast('✅ ¡Carteras renovadas! Válidas por 30 días.', 4000);
                    
                    // Recargar carteras
                    window.modalRenovacionMostrado = false;
                    await cargarCarteras();
                    
                    carterasRenovandose = [];
                    pagoRenovacionId = null;
                }
            } catch (e) {
                console.error('Error verificando pago:', e);
            }
        }
        // ========== FIN FUNCIONES DE RENOVACIÓN ==========
        
        // Cerrar modal y mostrar pantalla de pago
        function cerrarModalSuscripcion() {
            document.getElementById('modalSuscripcion').style.display = 'none';
            // Mostrar pantalla de pago
            if (pendingUser && pendingUserNeedsPayment) {
                // Mostrar modal de selección de carteras si tiene carteras
                if (pendingUser.carteras && pendingUser.carteras.length > 0) {
                    mostrarModalRenovarCarteras(pendingUser.carteras);
                } else {
                    mostrarRenovacionPago(pendingUser.id, pendingUser.nombre, pendingUser.email, 1);
                }
            }
            pendingUserNeedsPayment = false;
        }
        
        function mostrarRenovacionPago(userId, nombre, email, cantidadCarteras = 1) {
            // Ocultar login form y mostrar renewal form
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('renewalPaymentForm').style.display = 'block';
            
            // Actualizar precio mostrado
            const total = cantidadCarteras * PRECIO_POR_CARTERA;
            const precioEl = document.getElementById('renewalPrecio');
            if (precioEl) {
                precioEl.textContent = 'R$ ' + total.toFixed(2).replace('.', ',');
            }
            
            // Generar PIX para renovación
            generarPagoPixRenovacion(userId, nombre, email, cantidadCarteras);
        }
        
        function volverAlLogin() {
            document.getElementById('renewalPaymentForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            if (verificacionInterval) clearInterval(verificacionInterval);
        }
        
        function volverAlRegistro() {
            // Ocultar pantalla de pago y mostrar registro
            document.getElementById('registerStep3').style.display = 'none';
            document.getElementById('registerStep1').style.display = 'block';
            document.getElementById('registerForm').style.display = 'block';
            if (verificacionInterval) clearInterval(verificacionInterval);
            // Limpiar datos pendientes
            pendingUser = null;
            pendingPaymentId = null;
        }
        
        async function solicitarAccesoAdmin() {
            if (!pendingUser || !pendingUser.email) {
                alert('Error: No hay usuario pendiente');
                return;
            }
            
            try {
                // Marcar al usuario como "solicitó acceso admin"
                const res = await fetch(API_URL + '/api/solicitar-acceso-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingUser.email })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('⏳ Solicitud enviada!\n\nEspera a que el administrador libere tu acceso.\n\nTe notificaremos cuando tu cuenta esté activa.');
                    // Volver al login
                    document.getElementById('registerStep3').style.display = 'none';
                    document.getElementById('registerForm').style.display = 'none';
                    document.getElementById('loginForm').style.display = 'block';
                    if (verificacionInterval) clearInterval(verificacionInterval);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo enviar la solicitud'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // Solicitar acceso gratis desde pantalla de renovación
        async function solicitarAccesoAdminRenovacion() {
            if (!pendingUser || !pendingUser.email) {
                alert('Error: No hay usuario pendiente');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/solicitar-acceso-admin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingUser.email })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('⏳ Solicitud enviada!\n\nEspera a que el administrador libere tu acceso.\n\nTe notificaremos cuando tu cuenta esté activa.');
                    // Volver al login
                    volverAlLogin();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo enviar la solicitud'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function generarPagoPixRenovacion(userId, nombre, email, cantidadCarteras = 1) {
            document.getElementById('renewalPixLoading').style.display = 'block';
            document.getElementById('renewalPixQrCode').style.display = 'none';
            
            const monto = cantidadCarteras * PRECIO_POR_CARTERA;
            
            try {
                const res = await fetch(API_URL + '/api/crear-pago-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId, 
                        nombre, 
                        email, 
                        monto: parseFloat(monto.toFixed(2)), // Asegurar formato correcto
                        cantidadCarteras 
                    })
                });
                const data = await res.json();
                
                document.getElementById('renewalPixLoading').style.display = 'none';
                document.getElementById('renewalPixQrCode').style.display = 'block';
                
                // Guardar datos para verificación
                pendingUser = { id: userId, nombre, email };
                
                if (data.success && data.qrCodeBase64 && !data.manual) {
                    // PIX Automático con QR Code de Mercado Pago
                    pendingUser.paymentId = data.paymentId;
                    document.getElementById('renewalPixQrCode').innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: var(--accent-green); font-size: 1rem; margin-bottom: 15px;">
                                <i class="fas fa-bolt me-2"></i>Pago Automático
                            </p>
                            
                            <!-- Código Copia e Cola (principal para celular) -->
                            <div style="background: var(--bg-card); border: 2px solid var(--accent-green); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <p style="color: var(--accent-green); font-size: 0.9rem; margin-bottom: 10px;">
                                    <i class="fas fa-mobile-alt me-2"></i>¿Estás en el celular? Copia este código:
                                </p>
                                <div style="background: var(--bg-hover); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                                    <input type="text" id="renewalPixCopyPaste" value="${data.qrCode}" readonly style="background: transparent; border: none; color: var(--accent-cyan); width: 100%; font-size: 0.65rem; text-align: center;">
                                </div>
                                <button onclick="copyRenewalPixCode()" class="btn" style="background: var(--accent-green); color: #000; width: 100%;">
                                    <i class="fas fa-copy me-2"></i>Copiar Código PIX
                                </button>
                                <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 10px;">
                                    Pega en tu app de banco → Área PIX → Copia e Cola
                                </p>
                            </div>
                            
                            <!-- QR Code (para quien tiene 2 dispositivos) -->
                            <details style="text-align: center;">
                                <summary style="color: var(--text-secondary); cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-qrcode me-1"></i>¿Tienes otro dispositivo? Ver QR Code
                                </summary>
                                <div style="margin-top: 15px;">
                                    <img src="data:image/png;base64,${data.qrCodeBase64}" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 180px;">
                                </div>
                            </details>
                            
                            <p style="color: var(--accent-green); font-size: 0.8rem; margin-top: 20px;">
                                <i class="fas fa-check-circle me-1"></i>Al pagar, tu cuenta se renueva automáticamente
                            </p>
                        </div>
                    `;
                    // Iniciar verificación automática
                    if (verificacionInterval) clearInterval(verificacionInterval);
                    verificacionInterval = setInterval(() => verificarPagoRenovacion(true), 5000);
                } else {
                    // Error - mostrar mensaje
                    document.getElementById('renewalPixQrCode').innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: var(--accent-red); font-size: 1rem; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle me-2"></i>Error al generar pago
                            </p>
                            <p style="color: var(--text-secondary);">Sistema de pago no disponible. Intente más tarde.</p>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('renewalPixLoading').style.display = 'none';
                document.getElementById('renewalPixQrCode').style.display = 'block';
                document.getElementById('renewalPixQrCode').innerHTML = `
                    <div style="text-align: center;">
                        <p style="color: var(--accent-red); font-size: 1rem; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error de conexión
                        </p>
                        <p style="color: var(--text-secondary);">No se pudo conectar al servidor. Intente más tarde.</p>
                    </div>
                `;
            }
        }
        
        function copyRenewalPixCode() {
            const pixCode = document.getElementById('renewalPixCopyPaste').value;
            navigator.clipboard.writeText(pixCode).then(() => {
                alert('Código PIX copiado!');
            });
        }
        
        async function verificarPagoRenovacion(auto = false) {
            if (!pendingUser) {
                if (!auto) alert('Erro: Dados de pagamento não encontrados');
                return;
            }
            
            const btn = document.getElementById('btnVerificarPagoRenovacion');
            if (!auto) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
            }
            
            try {
                const res = await fetch(API_URL + '/api/verificar-pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId: pendingUser.paymentId, userId: pendingUser.id })
                });
                const data = await res.json();
                
                if (data.paid) {
                    if (verificacionInterval) clearInterval(verificacionInterval);
                    alert('Pagamento confirmado! Sua assinatura foi renovada.');
                    volverAlLogin();
                    // Intentar login automático
                    document.getElementById('loginEmail').value = pendingUser.email;
                    handleLogin();
                } else if (!auto) {
                    alert('Pagamento ainda não confirmado. Aguarde alguns instantes e tente novamente.');
                }
            } catch (e) {
                if (!auto) alert('Erro ao verificar pagamento');
            }
            
            if (!auto) {
                btn.disabled = false;
                btn.innerHTML = 'Já paguei - Verificar';
            }
        }

        async function sendVerificationCode() {
            const nombre = document.getElementById('regNombre').value;
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const recoveryEmail = document.getElementById('regRecoveryEmail').value;
            const password = document.getElementById('regPassword').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;
            if (!nombre || !username || !email || !password) return alert('Preencha todos os campos');
            if (username.includes(' ')) return alert('O nome de usuário não pode ter espaços');
            if (password.length < 6) return alert('A senha deve ter pelo menos 6 caracteres');
            if (!acceptTerms) return alert('Você deve aceitar os Termos de Uso e a Política de Privacidade');
            // Email de recuperación es OBLIGATORIO
            if (!recoveryEmail || !recoveryEmail.includes('@')) {
                return alert(currentLang === 'es' ? 
                    'El email de recuperación es obligatorio' : 
                    'O email de recuperação é obrigatório');
            }
            // Validar que el correo de recuperación sea diferente al principal
            if (recoveryEmail.toLowerCase() === email.toLowerCase()) {
                return alert(currentLang === 'es' ?
                    'El email de recuperación debe ser diferente al email principal' :
                    'O email de recuperação deve ser diferente do email principal');
            }
            const btn = document.getElementById('btnSendCode');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            try {
                const res = await fetch(API_URL + '/api/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, nombre, username, recoveryEmail })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('registerStep1').style.display = 'none';
                    document.getElementById('registerStep2').style.display = 'block';
                    document.getElementById('emailSent').textContent = email;
                } else {
                    alert(data.error || 'Error al enviar código');
                }
            } catch (e) {
                alert('Error de conexión');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar Código de Verificación';
        }

        async function verifyCode() {
            const email = document.getElementById('regEmail').value;
            const recoveryEmail = document.getElementById('regRecoveryEmail').value;
            const code = document.getElementById('verificationCode').value;
            const password = document.getElementById('regPassword').value;
            const nombre = document.getElementById('regNombre').value;
            const username = document.getElementById('regUsername').value;
            
            // Detectar zona horaria del navegador
            const timezone = Intl.DateTimeFormat().resolvedOptions().timeZone || 'America/Sao_Paulo';
            
            if (!code || code.length !== 6) return alert('Digite o código de 6 dígitos');
            
            // Mostrar estado de carga
            const btn = event.target;
            const btnTextoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>' + (currentLang === 'pt' ? 'Verificando...' : 'Verificando...');
            btn.disabled = true;
            
            try {
                const res = await fetch(API_URL + '/api/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, password, username, recoveryEmail, timezone })
                });
                const data = await res.json();
                if (data.success) {
                    // Guardar datos del usuario pendiente (cuenta no creada aún)
                    pendingUser = { ...data.user, email, recoveryEmail, timezone };
                    // Mostrar pantalla de pago
                    document.getElementById('registerStep2').style.display = 'none';
                    document.getElementById('registerStep3').style.display = 'block';
                    // Generar PIX (sin userId porque la cuenta no existe aún)
                    generarPagoPix(null, nombre, email);
                } else {
                    btn.innerHTML = btnTextoOriginal;
                    btn.disabled = false;
                    alert(data.error || 'Código incorrecto');
                }
            } catch (e) {
                btn.innerHTML = btnTextoOriginal;
                btn.disabled = false;
                alert('Error de conexión');
            }
        }

        let pendingUser = null;
        let pendingPaymentId = null;
        let pendingCarteras = 1;

        async function generarPagoPix(userId, nombre, email) {
            const pixContainer = document.getElementById('pixQrCode');
            const pixLoading = document.getElementById('pixLoading');
            
            // Obtener cantidad de carteras seleccionadas
            const cantidadCarteras = parseInt(document.getElementById('regCantidadCarteras')?.value) || 1;
            const monto = cantidadCarteras * PRECIO_POR_CARTERA;
            pendingCarteras = cantidadCarteras;
            
            console.log('🔵 Generando PIX:', { cantidadCarteras, monto, userId, nombre, email });
            console.log('🔍 Monto antes de enviar:', typeof monto, monto);
            
            // Validar monto antes de enviar
            const montoFinal = parseFloat(monto.toFixed(2));
            if (isNaN(montoFinal) || montoFinal <= 0) {
                console.error('❌ Monto inválido:', montoFinal);
                pixLoading.style.display = 'none';
                pixContainer.innerHTML = '<div style="color: var(--accent-red); text-align: center;">Error: Monto inválido</div>';
                return;
            }
            
            console.log('✅ Monto final a enviar:', montoFinal);
            
            try {
                const res = await fetch(API_URL + '/api/crear-pago-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId, 
                        nombre, 
                        email, 
                        monto: parseFloat(monto.toFixed(2)), // Asegurar formato correcto
                        cantidadCarteras 
                    })
                });
                const data = await res.json();
                
                console.log('🟢 Respuesta del servidor:', data);
                
                pixLoading.style.display = 'none';
                pixContainer.style.display = 'block';
                
                if (data.success && data.qrCodeBase64 && !data.manual) {
                    // PIX Automático con QR Code de Mercado Pago
                    pendingPaymentId = data.paymentId;
                    pixContainer.innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: var(--accent-green); font-size: 1rem; margin-bottom: 15px;">
                                <i class="fas fa-bolt me-2"></i>Pago Automático
                            </p>
                            
                            <!-- Código Copia e Cola (principal para celular) -->
                            <div style="background: var(--bg-card); border: 2px solid var(--accent-green); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                                <p style="color: var(--accent-green); font-size: 0.9rem; margin-bottom: 10px;">
                                    <i class="fas fa-mobile-alt me-2"></i>¿Estás en el celular? Copia este código:
                                </p>
                                <div style="background: var(--bg-hover); border-radius: 8px; padding: 10px; margin-bottom: 10px;">
                                    <input type="text" id="pixCopyPaste" value="${data.qrCode}" readonly style="background: transparent; border: none; color: var(--accent-cyan); width: 100%; font-size: 0.65rem; text-align: center;">
                                </div>
                                <button onclick="copyPixCode()" class="btn" style="background: var(--accent-green); color: #000; width: 100%;">
                                    <i class="fas fa-copy me-2"></i>Copiar Código PIX
                                </button>
                                <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 10px;">
                                    Pega en tu app de banco → Área PIX → Copia e Cola
                                </p>
                            </div>
                            
                            <!-- QR Code (para quien tiene 2 dispositivos) -->
                            <details style="text-align: center;">
                                <summary style="color: var(--text-secondary); cursor: pointer; font-size: 0.85rem;">
                                    <i class="fas fa-qrcode me-1"></i>¿Tienes otro dispositivo? Ver QR Code
                                </summary>
                                <div style="margin-top: 15px;">
                                    <img src="data:image/png;base64,${data.qrCodeBase64}" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 180px;">
                                </div>
                            </details>
                            
                            <p style="color: var(--accent-green); font-size: 0.8rem; margin-top: 20px;">
                                <i class="fas fa-check-circle me-1"></i>Al pagar, tu cuenta se activa automáticamente
                            </p>
                        </div>
                    `;
                    iniciarVerificacionAutomatica();
                } else {
                    // Error - mostrar mensaje específico
                    pixContainer.innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: var(--accent-red); font-size: 1rem; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-triangle me-2"></i>Error al generar pago
                            </p>
                            <p style="color: var(--text-secondary);">${data.error || 'Sistema de pago no disponible'}</p>
                        </div>
                    `;
                }
            } catch (e) {
                // Error de conexión
                pixLoading.style.display = 'none';
                pixContainer.style.display = 'block';
                pixContainer.innerHTML = `
                    <div style="text-align: center;">
                        <p style="color: var(--accent-red); font-size: 1rem; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-triangle me-2"></i>Error de conexión
                        </p>
                        <p style="color: var(--text-secondary);">${e.message || 'No se pudo conectar al servidor'}</p>
                    </div>
                `;
            }
        }

        function copyPixCode() {
            const pixCode = document.getElementById('pixCopyPaste').value;
            navigator.clipboard.writeText(pixCode);
            alert('Código PIX copiado!');
        }
        
        // Precio por cartera (precio final que paga el usuario)
        const PRECIO_BASE_POR_CARTERA = 51.41;
        
        // Función para calcular precio con comisiones de Mercado Pago incluidas
        function calcularPrecioConComisiones(precioBase) {
            // Ya incluye las comisiones, devolver el mismo precio
            return precioBase;
        }
        
        const PRECIO_FINAL_POR_CARTERA = PRECIO_BASE_POR_CARTERA; // 51.41
        
        // Función para calcular precio con comisiones de Mercado Pago incluidas
        function calcularPrecioConComisiones(precioBase) {
            // Mercado Pago cobra: 0.99% + R$ 0.40 por transacción PIX
            const tarifaFija = 0.40;
            const porcentajeComision = 0.0099; // 0.99%
            return (precioBase + tarifaFija) / (1 - porcentajeComision);
        }
        
        // Precio por cartera CON comisiones incluidas
        const PRECIO_POR_CARTERA = PRECIO_BASE_POR_CARTERA;
        
        function ajustarCarteras(delta) {
            const input = document.getElementById('regCantidadCarteras');
            let cantidad = parseInt(input.value) || 1;
            cantidad += delta;
            if (cantidad < 1) cantidad = 1;
            // Sin límite máximo de carteras
            input.value = cantidad;
            actualizarPrecioCarteras();
        }
        
        function actualizarPrecioCarteras() {
            const cantidad = parseInt(document.getElementById('regCantidadCarteras')?.value) || 1;
            
            // Calcular precio total (sin agregar comisiones extra)
            const precioBasePorCartera = PRECIO_BASE_POR_CARTERA;
            const precioTotal = cantidad * precioBasePorCartera;
            
            const totalEl = document.getElementById('regTotalPagar');
            const detalleEl = document.getElementById('regDetalleCarteras');
            
            if (totalEl) {
                totalEl.textContent = 'R$ ' + precioTotal.toFixed(2).replace('.', ',');
            }
            if (detalleEl) {
                detalleEl.innerHTML = cantidad + ' carteira' + (cantidad > 1 ? 's' : '') + ' × R$ ' + precioBasePorCartera.toFixed(2).replace('.', ',');
            }
            
            // Regenerar PIX con nuevo monto si ya está visible
            const pixQrCode = document.getElementById('pixQrCode');
            const pixLoading = document.getElementById('pixLoading');
            
            if (pixQrCode && pixQrCode.style.display !== 'none' && pendingUser) {
                // Mostrar loading mientras se regenera
                pixQrCode.style.display = 'none';
                pixLoading.style.display = 'block';
                pixLoading.innerHTML = '<i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i><p class="text-secondary">Regenerando código PIX com novo valor...</p>';
                
                // Detener verificación automática anterior
                if (verificacionInterval) {
                    clearInterval(verificacionInterval);
                    verificacionInterval = null;
                }
                
                // Regenerar PIX con la nueva cantidad de carteras
                setTimeout(() => {
                    generarPagoPix(null, pendingUser.nombre, pendingUser.email);
                }, 500);
            }
        }

        let verificacionInterval = null;

        function iniciarVerificacionAutomatica() {
            if (verificacionInterval) clearInterval(verificacionInterval);
            verificacionInterval = setInterval(async () => {
                if (pendingPaymentId) {
                    const pagado = await verificarPagoSilencioso();
                    if (pagado) {
                        clearInterval(verificacionInterval);
                    }
                }
            }, 5000); // Cada 5 segundos
        }

        async function verificarPagoSilencioso() {
            try {
                const res = await fetch(API_URL + '/api/verificar-pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: pendingUser.id, paymentId: pendingPaymentId })
                });
                const data = await res.json();
                if (data.paid || data.status === 'approved') {
                    alert('🎉 ¡Pago confirmado! Bienvenido a FinanGest');
                    currentUser = pendingUser;
                    sessionStorage.setItem('finangest_user', JSON.stringify(currentUser));
                    showMainApp();
                    return true;
                }
            } catch (e) {}
            return false;
        }

        async function verificarPago() {
            const btn = document.getElementById('btnVerificarPago');
            
            // Si es PIX manual, no hay verificación automática
            if (!pendingPaymentId) {
                alert('Para PIX manual, envie o comprovante por WhatsApp e aguarde a ativação.');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
            btn.disabled = true;
            
            try {
                const res = await fetch(API_URL + '/api/verificar-pago', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: pendingUser.email, paymentId: pendingPaymentId })
                });
                const data = await res.json();
                console.log('📥 Respuesta de verificar pago:', data);
                
                if (data.paid || data.status === 'approved' || data.accountCreated) {
                    if (data.user) {
                        // Asegurar que el id esté presente
                        if (!data.user.id && data.user._id) {
                            data.user.id = data.user._id.toString();
                        }
                        
                        currentUser = data.user;
                        sessionStorage.setItem('finangest_user', JSON.stringify(currentUser));
                        
                        console.log('✅ Usuario guardado después del pago:', currentUser);
                        
                        // Ir directamente a la app para crear carteras
                        showMainApp();
                    } else {
                        alert('🎉 ¡Pago confirmado! Por favor inicia sesión');
                        // Ocultar todos los formularios de registro y mostrar login
                        document.getElementById('registerStep1').style.display = 'none';
                        document.getElementById('registerStep2').style.display = 'none';
                        document.getElementById('registerStep3').style.display = 'none';
                        document.getElementById('renewalPaymentForm').style.display = 'none';
                        document.getElementById('registerForm').style.display = 'none';
                        document.getElementById('forgotPasswordForm').style.display = 'none';
                        document.getElementById('loginForm').style.display = 'block';
                        // Activar tab de login
                        document.querySelectorAll('.auth-tab').forEach((t, i) => {
                            if (i === 0) t.classList.add('active');
                            else t.classList.remove('active');
                        });
                    }
                    if (verificacionInterval) clearInterval(verificacionInterval);
                    alert('Sua conta foi criada! Faça login para continuar.');
                } else {
                    alert('Pagamento ainda não detectado. Aguarde alguns segundos após pagar.');
                }
            } catch (e) {
                alert('Erro ao verificar pagamento');
            }
            
            btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Ya pagué - Verificar';
            btn.disabled = false;
        }

        async function resendCode() {
            const email = document.getElementById('regEmail').value;
            const nombre = document.getElementById('regNombre').value;
            const link = document.getElementById('resendLink');
            const status = document.getElementById('resendStatus');
            
            if (!email) {
                alert('Error: email no encontrado');
                return;
            }
            
            // Mostrar estado de envío
            link.style.pointerEvents = 'none';
            link.style.opacity = '0.5';
            status.style.display = 'block';
            status.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando código...';
            
            try {
                const res = await fetch(API_URL + '/api/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, nombre })
                });
                const data = await res.json();
                if (data.success) {
                    status.style.color = 'var(--accent-green)';
                    status.innerHTML = '<i class="fas fa-check me-1"></i>Código reenviado! Llegará en 5-10 segundos.';
                } else {
                    status.style.color = 'var(--accent-red)';
                    status.innerHTML = '<i class="fas fa-times me-1"></i>' + (data.error || 'Error al reenviar');
                }
            } catch (e) {
                status.style.color = 'var(--accent-red)';
                status.innerHTML = '<i class="fas fa-times me-1"></i>Error de conexión';
            }
            
            // Reactivar link después de 30 segundos
            setTimeout(() => {
                link.style.pointerEvents = 'auto';
                link.style.opacity = '1';
            }, 30000);
        }
        
        function voltarParaRegistro() {
            document.getElementById('registerStep2').style.display = 'none';
            document.getElementById('registerStep1').style.display = 'block';
            document.getElementById('verificationCode').value = '';
        }
        
        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            const isAdmin = currentUser.role === 'admin' || currentUser.isAdmin;
            document.getElementById('userName').textContent = isAdmin ? 'Administrador' : currentUser.nombre;
            document.getElementById('userAvatar').textContent = isAdmin ? 'A' : currentUser.nombre.charAt(0).toUpperCase();
            loadTheme();
            initIdioma(); // Inicializar idioma
            buildNavMenu();
            
            // Iniciar reloj del servidor UTC
            iniciarRelojServidor();
            
            // Mostrar spinner de carga en el área de contenido
            const loader = document.getElementById('contentLoader');
            loader.style.display = 'flex';
            
            if (isAdmin) {
                showSection('adminUsuarios');
                renderAdminUsuarios();
                loader.style.display = 'none';
            } else {
                // Restaurar sección guardada
                const savedSection = localStorage.getItem('finangest_section');
                const userSections = ['dashboard', 'estadisticas', 'clientes', 'cobros', 'gastos', 'microseguros', 'mapa', 'historial', 'misBackups', 'miConfig'];
                
                // Ocultar todas las secciones primero
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                
                // Determinar sección objetivo
                const targetSection = (savedSection && userSections.includes(savedSection)) ? savedSection : 'dashboard';
                
                // Actualizar título de página
                const titles = {
                    dashboard: 'Dashboard', clientes: 'Clientes', estadisticas: 'Estadísticas', cobros: 'Cobros del Día',
                    gastos: 'Gastos', historial: 'Mi Historial', mapa: 'Mapa', misBackups: 'Backups',
                    miConfig: 'Configuración', microseguros: 'Microseguros'
                };
                document.getElementById('pageTitle').textContent = titles[targetSection] || 'Dashboard';
                
                // Marcar nav-item correcto
                document.querySelectorAll('.nav-item').forEach(n => {
                    n.classList.remove('active');
                    if (n.getAttribute('onclick')?.includes(targetSection)) n.classList.add('active');
                });
                
                // Cargar datos y ocultar spinner cuando termine
                updateEditKeyStatus().then(() => {
                    loadData().then(() => {
                        // NO llamar showSection aquí, ya lo hace actualizarMenuSegunCarteras
                        loader.style.display = 'none';
                        // Iniciar sistema de notificaciones después de cargar datos
                        initNotificationSystem();
                        // Iniciar sistema de cierre nocturno (12 AM - 6 AM)
                        initCierreNocturno();
                    });
                });
            }
            // Iniciar heartbeat cada 2 minutos
            sendHeartbeat();
            setInterval(sendHeartbeat, 120000);
        }

        async function sendHeartbeat() {
            if (!currentUser || !currentUser.id) return;
            try {
                await fetch(API_URL + '/api/heartbeat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
            } catch (e) {}
        }

        function buildNavMenu() {
            const menu = document.getElementById('navMenu');
            const isAdmin = currentUser.role === 'admin' || currentUser.isAdmin;
            if (isAdmin) {
                menu.innerHTML = `
                    <div class="nav-item active" onclick="showSection('adminUsuarios')"><i class="fas fa-users"></i><span data-translate="usuarios">Usuarios</span></div>
                    <div class="nav-item" onclick="showSection('adminCalendario')"><i class="fas fa-calendar-alt"></i><span data-translate="calendario">Calendario</span></div>
                    <div class="nav-item" onclick="showSection('adminBackups')"><i class="fas fa-database"></i><span data-translate="backups">Backups</span></div>
                    <div class="nav-item" onclick="showSection('adminConfig')"><i class="fas fa-cog"></i><span data-translate="configuracion">Configuración</span></div>
                    <div class="nav-item" onclick="showSection('adminSeguridad')"><i class="fas fa-shield-alt"></i><span data-translate="seguridad">Seguridad</span></div>
                `;
                // Restaurar sección guardada o ir a Usuarios por defecto
                const savedSection = localStorage.getItem('finangest_section');
                const adminSections = ['adminUsuarios', 'adminCalendario', 'adminBackups', 'adminConfig', 'adminSeguridad'];
                setTimeout(() => {
                    if (savedSection && adminSections.includes(savedSection)) {
                        showSection(savedSection);
                        // Marcar nav-item correcto como activo
                        document.querySelectorAll('.nav-item').forEach(n => {
                            n.classList.remove('active');
                            if (n.getAttribute('onclick')?.includes(savedSection)) n.classList.add('active');
                        });
                    } else {
                        const usuariosBtn = menu.querySelector('.nav-item');
                        if (usuariosBtn) usuariosBtn.click();
                    }
                }, 100);
            }
            // Para usuarios normales, el menú se genera en actualizarMenuSegunCarteras() después de cargar carteras
            // Aplicar traducciones al menú
            cambiarIdioma(currentLang);
        }
        
        // Actualizar menú según si hay carteras
        function actualizarMenuSegunCarteras() {
            const menu = document.getElementById('navMenu');
            const sidebar = document.getElementById('sidebar');
            const carteraBtn = document.getElementById('carteraBtn');
            if (!menu) return;
            
            const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.isAdmin);
            if (isAdmin) return; // Admin siempre ve todo
            
            if (!carteras || carteras.length === 0) {
                // Sin carteras: mostrar sidebar con opciones limitadas
                if (sidebar) sidebar.style.display = 'block';
                if (carteraBtn) carteraBtn.style.display = 'none';
                // Restaurar margen del contenido
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.marginLeft = '';
                // Menú limitado (solo configuración)
                menu.innerHTML = `
                    <div class="nav-item" onclick="showSection('miConfig')"><i class="fas fa-cog"></i><span data-translate="configuracion">Configuración</span></div>
                `;
                // Mostrar sección de bienvenida
                showSection('sinCarteraInicio');
            } else if (!carteraActual) {
                // Tiene carteras pero ninguna desbloqueada: mostrar pantalla de cartera bloqueada
                if (sidebar) sidebar.style.display = 'block';
                if (carteraBtn) carteraBtn.style.display = 'flex';
                // Restaurar margen del contenido
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.marginLeft = '';
                // Actualizar botón de cartera
                document.getElementById('carteraActualNombre').textContent = 'Seleccionar Cartera';
                // Menú limitado (solo configuración)
                menu.innerHTML = `
                    <div class="nav-item" onclick="showSection('miConfig')"><i class="fas fa-cog"></i><span data-translate="configuracion">Configuración</span></div>
                `;
                // Mostrar pantalla de cartera bloqueada
                showSection('carteraBloqueada');
                renderCarterasDropdown();
            } else {
                // Con cartera desbloqueada: mostrar todo normal
                if (sidebar) sidebar.style.display = 'block';
                if (carteraBtn) carteraBtn.style.display = 'flex';
                // Restaurar margen del contenido
                const mainContent = document.querySelector('.main-content');
                if (mainContent) mainContent.style.marginLeft = '';
                // Generar menú completo (sin Historial Carteras porque está dentro de Mi Historial)
                menu.innerHTML = `
                    <div class="nav-item active" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i><span data-translate="dashboard">Dashboard</span></div>
                    <div class="nav-item" onclick="showSection('estadisticas')"><i class="fas fa-chart-bar"></i><span data-translate="estadisticas">Estadísticas</span></div>
                    <div class="nav-item" onclick="showSection('clientes')"><i class="fas fa-users"></i><span data-translate="clientes">Clientes</span></div>
                    <div class="nav-item" onclick="showSection('cobros')"><i class="fas fa-calendar-check"></i><span data-translate="cobros">Cobros del Día</span></div>
                    <div class="nav-item" onclick="showSection('gastos')"><i class="fas fa-wallet"></i><span data-translate="gastos">Gastos</span></div>
                    <div class="nav-item" onclick="showSection('microseguros')"><i class="fas fa-shield-alt"></i><span data-translate="microseguros">Microseguros</span></div>
                    <div class="nav-item" onclick="showSection('mapa')"><i class="fas fa-map-marked-alt"></i><span data-translate="mapa">Mapa</span></div>
                    <div class="nav-item" onclick="showSection('historial')"><i class="fas fa-history"></i><span data-translate="historial">Mi Historial</span></div>
                    <div class="nav-item" onclick="showSection('misBackups')"><i class="fas fa-database"></i><span data-translate="backups">Backups</span></div>
                    <div class="nav-item" onclick="showSection('miConfig')"><i class="fas fa-cog"></i><span data-translate="configuracion">Configuración</span></div>
                `;
                // Ir al dashboard
                showSection('dashboard');
            }
            cambiarIdioma(currentLang);
        }

        // Helper para obtener fecha local en formato YYYY-MM-DD
        function getFechaLocal() {
            const hoy = getCurrentDate();
            return hoy.getFullYear() + '-' + 
                String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                String(hoy.getDate()).padStart(2, '0');
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            
            // Quitar active de todos los nav-items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            // Buscar el nav-item que corresponde a esta sección y marcarlo como activo
            document.querySelectorAll('.nav-item').forEach(n => {
                const onclick = n.getAttribute('onclick');
                if (onclick && onclick.includes("showSection('" + id + "')")) {
                    n.classList.add('active');
                }
            });
            
            // Resetear filtros de clientes cuando se entra a la sección
            if (id === 'clientes') {
                const filtroTipo = document.getElementById('clientesFiltroTipo');
                const filtroEstado = document.getElementById('clientesFiltroEstado');
                const buscar = document.getElementById('clientesBuscar');
                if (filtroTipo) filtroTipo.value = '';
                if (filtroEstado) filtroEstado.value = '';
                if (buscar) buscar.value = '';
                renderClientes();
            }
            
            // Mostrar/ocultar botón volver en configuración
            const btnVolver = document.getElementById('btnVolverCartera');
            if (btnVolver) {
                // Mostrar solo si estamos en miConfig y no hay cartera desbloqueada
                if (id === 'miConfig' && !carteraActual) {
                    btnVolver.style.display = 'block';
                    // Cambiar destino según si hay carteras o no
                    if (carteras && carteras.length > 0) {
                        btnVolver.onclick = () => showSection('carteraBloqueada');
                    } else {
                        btnVolver.onclick = () => showSection('sinCarteraInicio');
                    }
                } else {
                    btnVolver.style.display = 'none';
                }
            }
            
            // Guardar sección actual en localStorage
            localStorage.setItem('finangest_section', id);
            
            // Cargar backups si es la sección de backups
            if (id === 'adminBackups') {
                cargarBackups();
            }
            if (id === 'misBackups') {
                cargarMisBackups();
                inicializarSistemaBackupLock();
            }
            // Inicializar sistema de edición si es la sección de clientes
            if (id === 'clientes') {
                inicializarSistemaEditLock();
            }
            
            const titles = {
                dashboard: t('dashboard'), clientes: t('clientes'), estadisticas: t('misEstadisticas'), cobros: t('cobros'),
                gastos: t('gastosPersonales'), historial: t('historial'), mapa: t('mapaClientes'), misBackups: t('backups'),
                miConfig: t('miConfiguracion'), microseguros: t('microseguros'),
                adminUsuarios: t('usuariosRegistrados'),
                adminCalendario: t('calendario'), adminHistorial: t('historial'), 
                adminVerTodo: 'Control Total', adminBackups: t('backups'),
                adminConfig: t('configuracion'), adminSeguridad: t('seguridad')
            };
            document.getElementById('pageTitle').textContent = titles[id] || 'Dashboard';
            if (id === 'cobros') {
                document.getElementById('fechaCobros').value = getFechaLocal();
                renderCobros();
            }
            if (id === 'gastos') {
                document.getElementById('gastoFechaFiltro').value = getFechaLocal();
                renderGastos();
            }
            if (id === 'historial') {
                initHistorial();
                renderHistorial();
            }
            if (id === 'mapa') initMapa();
            if (id === 'adminUsuarios') renderAdminUsuarios();
            if (id === 'adminCalendario') {
                document.getElementById('calendarioFecha').value = getFechaLocal();
                renderCalendarioClientes();
            }
            if (id === 'adminHistorial') renderAdminHistorialTrabajador();
            if (id === 'adminClientes') renderAdminClientes();
            if (id === 'estadisticas') {
                initEstadisticas();
                renderEstadisticas();
            }
            if (id === 'adminVerTodo') renderVerTodo();
            if (id === 'miConfig') {
                cargarMiConfig();
                cargarSesiones();
            }
            if (id === 'adminConfig') {
                cargarConfigAdmin();
                cargarEstadisticasSistema();
            }
            if (id === 'adminSeguridad') {
                cargarConfigSeguridad();
                cargarEstadisticasSeguridad();
                cargarLogSeguridad();
            }
            if (id === 'microseguros') {
                renderMicroseguros();
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        function logout() {
            // Cerrar sesión en el servidor
            const sessionId = sessionStorage.getItem('finangest_session');
            if (sessionId) {
                fetch(API_URL + '/api/sessions/' + sessionId + '/close', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).catch(() => {});
            }
            
            // Limpiar estado de backup y edición antes de limpiar currentUser
            if (currentUser && currentUser.id) {
                sessionStorage.removeItem('finangest_backup_unlocked_' + currentUser.id);
                sessionStorage.removeItem('finangest_edit_unlocked_' + currentUser.id);
                // Limpiar cartera desbloqueada al cerrar sesión
                localStorage.removeItem('finangest_cartera_unlocked_' + currentUser.id);
            }
            
            sessionStorage.removeItem('finangest_user');
            sessionStorage.removeItem('finangest_session');
            localStorage.removeItem('finangest_section');
            currentUser = null;
            clientes = [];
            carteras = [];
            carteraActual = null;
            // Resetear estado de backup y edit lock para próxima sesión
            backupUnlocked = false;
            backupLockInitialized = false;
            editUnlocked = false;
            editLockInitialized = false;
            
            // Recargar página para resetear completamente el estado
            window.location.href = window.location.pathname;
        }
        
        // Alias para cerrar sesión
        function cerrarSesion() {
            logout();
        }
        
        // ============ GESTIÓN DE SESIONES ============
        
        // Cargar sesiones activas del usuario
        async function cargarSesiones() {
            if (!currentUser) return;
            const container = document.getElementById('listaSesiones');
            if (!container) return;
            
            try {
                const res = await fetch(API_URL + '/api/sessions/' + currentUser.id);
                const data = await res.json();
                
                if (data.success && data.sessions) {
                    const currentSessionId = localStorage.getItem('finangest_session');
                    
                    if (data.sessions.length === 0) {
                        container.innerHTML = `
                            <div class="text-center py-3 text-secondary">
                                <i class="fas fa-info-circle me-2"></i>No hay sesiones activas
                            </div>
                        `;
                        return;
                    }
                    
                    container.innerHTML = data.sessions.map(s => {
                        const isCurrentSession = s.sessionId === currentSessionId;
                        const icon = getDeviceIcon(s.deviceType, s.deviceName);
                        const timeAgo = getTimeAgo(s.lastActivity);
                        
                        return `
                            <div class="d-flex justify-content-between align-items-center p-3 mb-2" style="background: var(--bg-hover); border-radius: 8px; ${isCurrentSession ? 'border: 1px solid var(--accent-green);' : ''}">
                                <div class="d-flex align-items-center">
                                    <div class="me-3" style="font-size: 1.5rem; color: ${isCurrentSession ? 'var(--accent-green)' : 'var(--text-secondary)'};">
                                        ${icon}
                                    </div>
                                    <div>
                                        <div class="fw-bold">${s.deviceName || 'Dispositivo'}</div>
                                        <small class="text-secondary">
                                            ${s.browser || ''} • ${s.os || ''}<br>
                                            ${isCurrentSession ? '<span class="text-success">Este dispositivo</span>' : timeAgo}
                                        </small>
                                    </div>
                                </div>
                                <div>
                                    ${isCurrentSession ? 
                                        '<span class="badge" style="background: var(--accent-green);">Activo</span>' : 
                                        `<button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="cerrarSesionRemota('${s.sessionId}')">
                                            <i class="fas fa-times"></i>
                                        </button>`
                                    }
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = `
                        <div class="text-center py-3 text-secondary">
                            <i class="fas fa-exclamation-circle me-2"></i>Error al cargar sesiones
                        </div>
                    `;
                }
            } catch (e) {
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center p-3" style="background: var(--bg-hover); border-radius: 8px;">
                        <div>
                            <i class="fas fa-laptop me-2" style="color: var(--accent-green);"></i>
                            <span>Este dispositivo</span>
                            <span class="badge" style="background: var(--accent-green);">Activo</span>
                        </div>
                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="cerrarSesion()">
                            <i class="fas fa-sign-out-alt me-1"></i>Cerrar
                        </button>
                    </div>
                `;
            }
        }
        
        // Obtener icono según tipo de dispositivo
        function getDeviceIcon(deviceType, deviceName) {
            if (deviceName && deviceName.toLowerCase().includes('iphone')) return '<i class="fab fa-apple"></i>';
            if (deviceName && deviceName.toLowerCase().includes('ipad')) return '<i class="fab fa-apple"></i>';
            if (deviceName && (deviceName.toLowerCase().includes('motorola') || deviceName.toLowerCase().includes('samsung') || deviceName.toLowerCase().includes('xiaomi') || deviceName.toLowerCase().includes('android'))) return '<i class="fab fa-android"></i>';
            if (deviceType === 'mobile') return '<i class="fas fa-mobile-alt"></i>';
            if (deviceType === 'tablet') return '<i class="fas fa-tablet-alt"></i>';
            if (deviceName && deviceName.toLowerCase().includes('mac')) return '<i class="fab fa-apple"></i>';
            if (deviceName && deviceName.toLowerCase().includes('windows')) return '<i class="fab fa-windows"></i>';
            return '<i class="fas fa-laptop"></i>';
        }
        
        // Calcular tiempo transcurrido
        function getTimeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = getCurrentDate();
            const diff = Math.floor((now - date) / 1000);
            
            if (diff < 60) return 'Hace un momento';
            if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
            if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
            if (diff < 604800) return `Hace ${Math.floor(diff / 86400)} días`;
            return date.toLocaleDateString();
        }
        
        // Cerrar sesión remota
        async function cerrarSesionRemota(sessionId) {
            if (!confirm('Encerrar esta sessão?\n\nO dispositivo será desconectado.')) return;
            
            try {
                const res = await fetch(API_URL + '/api/sessions/' + sessionId + '/close', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Sessão encerrada');
                    cargarSesiones();
                }
            } catch (e) {
                alert('Erro ao encerrar sessão');
            }
        }
        
        // Cerrar todas las sesiones excepto la actual
        async function cerrarTodasSesiones() {
            if (!confirm('Encerrar todas as outras sessões?\n\nTodos os outros dispositivos serão desconectados.')) return;
            
            const currentSessionId = localStorage.getItem('finangest_session');
            
            try {
                const res = await fetch(API_URL + '/api/sessions/' + currentUser.id + '/close-all', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentSessionId })
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Todas as outras sessões foram encerradas');
                    cargarSesiones();
                }
            } catch (e) {
                alert('Error al cerrar sesiones');
            }
        }
        
        // Confirmar y ejecutar reset de todos los datos del usuario
        async function confirmarResetDatos() {
            const t = translations[currentLang] || translations['es'];
            
            const confirmMsg = currentLang === 'pt' 
                ? '⚠️ ATENÇÃO!\n\nIsso vai ELIMINAR PERMANENTEMENTE:\n- Todos os clientes\n- Todos os gastos\n- Todo o histórico de pagamentos\n- Todas as caixas\n- Todos os backups\n\nSuas carteiras pagas serão mantidas.\n\nDigite "ELIMINAR" para confirmar:'
                : '⚠️ ¡ATENCIÓN!\n\nEsto ELIMINARÁ PERMANENTEMENTE:\n- Todos los clientes\n- Todos los gastos\n- Todo el historial de pagos\n- Todas las cajas\n- Todos los backups\n\nTus carteras pagadas se mantendrán.\n\nEscribe "ELIMINAR" para confirmar:';
            
            const confirmacion = prompt(confirmMsg);
            
            if (confirmacion !== 'ELIMINAR') {
                showToast('❌ ' + (currentLang === 'pt' ? 'Operação cancelada' : 'Operación cancelada'), 2000);
                return;
            }
            
            try {
                showToast('🔄 ' + (currentLang === 'pt' ? 'Eliminando dados...' : 'Eliminando datos...'), 3000);
                
                const res = await fetch(API_URL + '/api/reset-datos-usuario', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
                
                const data = await res.json();
                
                if (data.success) {
                    const msg = currentLang === 'pt'
                        ? `✅ Dados eliminados!\n\nClientes: ${data.eliminados.clientes}\nGastos: ${data.eliminados.gastos}\nCaixas: ${data.eliminados.cajas}\nBackups: ${data.eliminados.backups}`
                        : `✅ ¡Datos eliminados!\n\nClientes: ${data.eliminados.clientes}\nGastos: ${data.eliminados.gastos}\nCajas: ${data.eliminados.cajas}\nBackups: ${data.eliminados.backups}`;
                    
                    alert(msg);
                    
                    // Limpiar datos locales
                    clientes = [];
                    gastos = [];
                    dineroAgregado = {};
                    
                    // Recargar la página para empezar limpio
                    window.location.reload();
                } else {
                    alert('❌ Error: ' + (data.error || 'No se pudieron eliminar los datos'));
                }
            } catch (e) {
                console.error('Error en reset:', e);
                alert('❌ Error de conexión');
            }
        }

        // ============ CONFIGURACIÓN Y SEGURIDAD ============
        
        // Cargar configuración del usuario
        function cargarMiConfig() {
            if (!currentUser) return;
            
            // Solo cargar si los elementos existen
            const configNombre = document.getElementById('configNombre');
            const configEmail = document.getElementById('configEmail');
            const configUsername = document.getElementById('configUsername');
            const configSuscripcion = document.getElementById('configSuscripcion');
            
            if (configNombre) configNombre.value = currentUser.nombre || '';
            if (configEmail) configEmail.value = currentUser.email || '';
            if (configUsername) configUsername.value = currentUser.username || '';
            if (configSuscripcion) configSuscripcion.value = currentUser.role === 'admin' ? 'Administrador (Ilimitado)' : 'Plan Mensual Activo';
            
            // Cargar preferencias
            const prefs = JSON.parse(localStorage.getItem('finangest_prefs_' + currentUser.id) || '{}');
            const notifCobros = document.getElementById('notifCobros');
            const notifVencimientos = document.getElementById('notifVencimientos');
            const notifSonido = document.getElementById('notifSonido');
            
            if (notifCobros) notifCobros.checked = prefs.notifCobros !== false;
            if (notifVencimientos) notifVencimientos.checked = prefs.notifVencimientos !== false;
            if (notifSonido) notifSonido.checked = prefs.notifSonido !== false;
        }
        
        // Guardar preferencias del usuario
        function guardarPreferencias() {
            if (!currentUser) return;
            const prefs = {
                notifCobros: document.getElementById('notifCobros').checked,
                notifVencimientos: document.getElementById('notifVencimientos').checked,
                notifSonido: document.getElementById('notifSonido').checked
            };
            localStorage.setItem('finangest_prefs_' + currentUser.id, JSON.stringify(prefs));
        }
        
        // ============ SISTEMA DE NOTIFICACIONES ============
        
        // Obtener preferencias de notificación
        function getNotifPrefs() {
            if (!currentUser) return { notifCobros: true, notifVencimientos: true, notifSonido: true };
            const prefs = JSON.parse(localStorage.getItem('finangest_prefs_' + currentUser.id) || '{}');
            return {
                notifCobros: prefs.notifCobros !== false,
                notifVencimientos: prefs.notifVencimientos !== false,
                notifSonido: prefs.notifSonido !== false
            };
        }
        
        // Reproducir sonido de notificación
        function playNotificationSound(urgent = false) {
            const prefs = getNotifPrefs();
            if (!prefs.notifSonido) return;
            
            // Crear sonido con Web Audio API
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                if (urgent) {
                    // Sonido urgente: 3 beeps rápidos
                    for (let i = 0; i < 3; i++) {
                        setTimeout(() => {
                            const oscillator = audioCtx.createOscillator();
                            const gainNode = audioCtx.createGain();
                            
                            oscillator.connect(gainNode);
                            gainNode.connect(audioCtx.destination);
                            
                            oscillator.frequency.value = 1000;
                            oscillator.type = 'sine';
                            gainNode.gain.setValueAtTime(0.5, audioCtx.currentTime);
                            gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15);
                            
                            oscillator.start(audioCtx.currentTime);
                            oscillator.stop(audioCtx.currentTime + 0.15);
                        }, i * 200);
                    }
                } else {
                    // Sonido normal: 1 beep
                    const oscillator = audioCtx.createOscillator();
                    const gainNode = audioCtx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioCtx.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    gainNode.gain.setValueAtTime(0.4, audioCtx.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.3);
                }
            } catch (e) {
                console.log('Audio no disponible');
            }
        }
        
        // Mostrar notificación toast en la app
        function showToastNotification(title, message, type = 'info') {
            // Crear contenedor si no existe
            let container = document.getElementById('toastContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toastContainer';
                container.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999; display: flex; flex-direction: column; gap: 10px;';
                document.body.appendChild(container);
            }
            
            const colors = {
                info: { bg: 'rgba(0, 212, 255, 0.95)', icon: 'fa-bell' },
                warning: { bg: 'rgba(230, 167, 0, 0.95)', icon: 'fa-exclamation-triangle' },
                success: { bg: 'rgba(46, 204, 113, 0.95)', icon: 'fa-check-circle' },
                danger: { bg: 'rgba(255, 71, 87, 0.95)', icon: 'fa-times-circle' }
            };
            const color = colors[type] || colors.info;
            
            const toast = document.createElement('div');
            toast.style.cssText = `
                background: ${color.bg}; color: #000; padding: 15px 20px; border-radius: 12px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3); min-width: 300px; max-width: 400px;
                animation: slideIn 0.3s ease; cursor: pointer;
            `;
            toast.innerHTML = `
                <div style="display: flex; align-items: flex-start; gap: 12px;">
                    <i class="fas ${color.icon}" style="font-size: 1.2rem; margin-top: 2px;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">${title}</div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${message}</div>
                    </div>
                    <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;" onclick="this.parentElement.parentElement.remove()"></i>
                </div>
            `;
            
            container.appendChild(toast);
            playNotificationSound();
            
            // Auto-remove después de 8 segundos
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 8000);
        }
        
        // Solicitar permiso para notificaciones del navegador
        async function requestNotificationPermission() {
            if (!('Notification' in window)) return false;
            if (Notification.permission === 'granted') return true;
            if (Notification.permission !== 'denied') {
                const permission = await Notification.requestPermission();
                return permission === 'granted';
            }
            return false;
        }
        
        // Enviar notificación del navegador (funciona fuera de la app)
        function sendBrowserNotification(title, body, urgent = false) {
            if (Notification.permission === 'granted') {
                // Reproducir sonido si está habilitado
                playNotificationSound(urgent);
                
                const notif = new Notification(title, {
                    body: body,
                    icon: '/icon-192.svg',
                    badge: '/icon-192.svg',
                    tag: 'finangest-' + Date.now(),
                    requireInteraction: true, // La notificación persiste hasta que el usuario la cierre
                    silent: false // Permitir sonido del sistema
                });
                
                notif.onclick = () => {
                    window.focus();
                    notif.close();
                };
                
                // Auto-cerrar después de 30 segundos si el usuario no interactúa
                setTimeout(() => notif.close(), 30000);
            }
        }
        
        // Obtener clientes con cobros del día
        function getClientesCobrosHoy() {
            if (!clientes || clientes.length === 0) return [];
            
            return clientes.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return false;
                
                // Usar la función que considera la hora de registro (regla de las 12 PM)
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                const numeroParcelas = c.numeroParcelas || 1;
                
                // Tiene cobro hoy si diasDePago > parcelasPagas y aún tiene parcelas pendientes
                return diasDePago > parcelasPagas && parcelasPagas < numeroParcelas;
            });
        }
        
        // Obtener clientes con cobros del día agrupados por cartera
        function getClientesCobrosHoyPorCartera() {
            if (!clientes || clientes.length === 0) return {};
            
            const cobrosPorCartera = {};
            
            clientes.forEach(c => {
                if (!esEstadoActivo(c.estado)) return;
                
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return;
                
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                const numeroParcelas = c.numeroParcelas || 1;
                
                // Tiene cobro hoy si diasDePago > parcelasPagas y aún tiene parcelas pendientes
                if (diasDePago > parcelasPagas && parcelasPagas < numeroParcelas) {
                    const carteraId = c.carteraId || 'sin_cartera';
                    if (!cobrosPorCartera[carteraId]) {
                        cobrosPorCartera[carteraId] = [];
                    }
                    cobrosPorCartera[carteraId].push({
                        nombre: c.nombre,
                        valorParcela: c.valorParcela || 0
                    });
                }
            });
            
            return cobrosPorCartera;
        }
        
        // Obtener clientes con vencimientos (atrasados)
        function getClientesVencidos() {
            if (!clientes || clientes.length === 0) return [];
            
            return clientes.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return false;
                
                // Usar la función que considera la hora de registro (regla de las 12 PM)
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                
                // Está atrasado si diasDePago > parcelasPagas
                return diasDePago > parcelasPagas;
            });
        }
        
        // Obtener clientes atrasados agrupados por cartera
        function getClientesAtrasadosPorCartera() {
            if (!clientes || clientes.length === 0) return {};
            
            const atrasadosPorCartera = {};
            
            clientes.forEach(c => {
                if (!esEstadoActivo(c.estado)) return;
                
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return;
                
                // Usar la función que considera la hora de registro (regla de las 12 PM)
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                const diasAtraso = Math.max(0, diasDePago - parcelasPagas);
                
                // Está atrasado si diasDePago > parcelasPagas
                if (diasDePago > parcelasPagas) {
                    const carteraId = c.carteraId || 'sin_cartera';
                    if (!atrasadosPorCartera[carteraId]) {
                        atrasadosPorCartera[carteraId] = [];
                    }
                    atrasadosPorCartera[carteraId].push({
                        nombre: c.nombre,
                        diasAtraso: diasAtraso,
                        restante: (c.totalAPagar || 0) - (c.montoPagado || 0)
                    });
                }
            });
            
            return atrasadosPorCartera;
        }
        
        // Verificar y mostrar notificaciones
        async function checkAndShowNotifications(isInitial = false) {
            // No enviar notificaciones durante el horario de cierre (12 AM - 6 AM)
            const ahora = getCurrentDate();
            const hora = ahora.getHours();
            if (hora >= 0 && hora < 6) {
                console.log('⏸️ Notificaciones pausadas durante horario de cierre');
                return;
            }
            
            const prefs = getNotifPrefs();
            const lang = localStorage.getItem('finangest_idioma') || 'pt';
            
            // Textos según idioma
            const texts = {
                es: {
                    cobrosTitle: '📋 Cobros del Día',
                    cobrosMsg: (n) => `${n} cliente${n > 1 ? 's' : ''} con cobro pendiente`,
                    vencTitle: '⚠️ Clientes Atrasados',
                    vencMsg: (n) => `${n} cliente${n > 1 ? 's' : ''} con pagos vencidos`,
                    cartera: 'Cartera',
                    diasAtraso: 'días de atraso',
                    diaAtraso: 'día de atraso'
                },
                pt: {
                    cobrosTitle: '📋 Cobranças do Dia',
                    cobrosMsg: (n) => `${n} cliente${n > 1 ? 's' : ''} com cobrança pendente`,
                    vencTitle: '⚠️ Clientes Atrasados',
                    vencMsg: (n) => `${n} cliente${n > 1 ? 's' : ''} com pagamentos vencidos`,
                    cartera: 'Carteira',
                    diasAtraso: 'dias de atraso',
                    diaAtraso: 'dia de atraso'
                }
            };
            const t = texts[lang] || texts.pt;
            
            // Notificación de cobros del día POR CARTERA
            if (prefs.notifCobros) {
                const cobrosPorCartera = getClientesCobrosHoyPorCartera();
                const carterasConCobros = Object.keys(cobrosPorCartera);
                
                if (carterasConCobros.length > 0) {
                    let delay = 0;
                    carterasConCobros.forEach(carteraId => {
                        setTimeout(async () => {
                            const clientesCobro = cobrosPorCartera[carteraId];
                            const cartera = carteras.find(c => c.id === carteraId);
                            const nombreCartera = cartera ? cartera.nombre : 'Sin cartera';
                            
                            const titulo = `📋 ${t.cartera}: ${nombreCartera}`;
                            const mensaje = t.cobrosMsg(clientesCobro.length);
                            
                            showToastNotification(titulo, mensaje, 'info');
                            await requestNotificationPermission();
                            sendBrowserNotification(titulo, mensaje);
                        }, delay);
                        delay += 1500;
                    });
                }
            }
            
            // Notificación de vencimientos POR CARTERA
            if (prefs.notifVencimientos) {
                setTimeout(() => {
                    const atrasadosPorCartera = getClientesAtrasadosPorCartera();
                    const carterasConAtrasos = Object.keys(atrasadosPorCartera);
                    
                    if (carterasConAtrasos.length > 0) {
                        let delay = 0;
                        carterasConAtrasos.forEach(carteraId => {
                            setTimeout(() => {
                                const clientesAtrasados = atrasadosPorCartera[carteraId];
                                const cartera = carteras.find(c => c.id === carteraId);
                                const nombreCartera = cartera ? cartera.nombre : 'Sin cartera';
                                
                                // Crear mensaje detallado con los clientes atrasados
                                const detalles = clientesAtrasados.slice(0, 3).map(c => 
                                    `• ${c.nombre}: ${c.diasAtraso} ${c.diasAtraso === 1 ? t.diaAtraso : t.diasAtraso}`
                                ).join('\n');
                                
                                const masClientes = clientesAtrasados.length > 3 ? 
                                    `\n... y ${clientesAtrasados.length - 3} más` : '';
                                
                                const titulo = `⚠️ ${t.cartera}: ${nombreCartera}`;
                                const mensaje = `${clientesAtrasados.length} cliente${clientesAtrasados.length > 1 ? 's' : ''} atrasado${clientesAtrasados.length > 1 ? 's' : ''}:\n${detalles}${masClientes}`;
                                
                                showToastNotification(titulo, mensaje, 'warning');
                                
                                // Siempre enviar notificación push del navegador (funciona fuera de la app)
                                // urgent=true para notificaciones de atrasos
                                sendBrowserNotification(titulo, mensaje.replace(/\n/g, ' | '), true);
                            }, delay);
                            delay += 1500; // Espaciar notificaciones por cartera
                        });
                    }
                }, isInitial ? 3000 : 0);
            }
        }
        
        // Inicializar sistema de notificaciones
        let notificationCheckInterval = null;
        let midnightCheckTimeout = null;
        
        function initNotificationSystem() {
            // Verificar al inicio (después de cargar datos)
            setTimeout(() => checkAndShowNotifications(true), 2000);
            
            // Verificar estados de atraso al inicio
            setTimeout(() => verificarYActualizarAtrasos(), 3000);
            
            // Verificar cada 30 minutos
            if (notificationCheckInterval) clearInterval(notificationCheckInterval);
            notificationCheckInterval = setInterval(() => checkAndShowNotifications(false), 30 * 60 * 1000);
            
            // Programar verificación a medianoche
            programarVerificacionMedianoche();
            
            // Solicitar permiso de notificaciones
            requestNotificationPermission();
            
            // Suscribirse a notificaciones push de Firebase
            setTimeout(async () => {
                try {
                    const token = await subscribeToPushNotifications();
                    if (token) {
                        await savePushToken(token);
                        console.log('✅ Suscrito a notificaciones push');
                    }
                } catch (e) {
                    console.error('Error suscribiendo a push:', e);
                }
            }, 5000);
        }
        
        // Programar verificación de atrasos a las 12:00 AM (medianoche) hora local
        function programarVerificacionMedianoche() {
            if (midnightCheckTimeout) clearTimeout(midnightCheckTimeout);
            
            const ahora = getCurrentDate();
            const medianoche = new Date(ahora);
            
            // Programar para las 00:00:05 del día siguiente
            medianoche.setDate(medianoche.getDate() + 1);
            medianoche.setHours(0, 0, 5, 0); // 12:00:05 AM (medianoche)
            
            const msHastaMedianoche = medianoche - ahora;
            
            midnightCheckTimeout = setTimeout(async () => {
                console.log('🕛 Verificación de medianoche (12 AM) - Actualizando estados de atraso...');
                await verificarYActualizarAtrasos();
                
                // Enviar notificaciones push de atrasos a medianoche (funciona fuera de la app)
                await checkAndShowNotifications(true);
                
                // Reprogramar para la siguiente medianoche
                programarVerificacionMedianoche();
            }, msHastaMedianoche);
            
            console.log(`⏰ Próxima verificación de atrasos programada para: ${medianoche.toLocaleString()} (hora local)`);
        }
        
        // Verificar y actualizar estados de atraso de todos los clientes
        async function verificarYActualizarAtrasos() {
            if (!clientes || clientes.length === 0) return;
            
            const hoy = getCurrentDate();
            hoy.setHours(0, 0, 0, 0);
            
            let clientesActualizados = 0;
            
            for (const c of clientes) {
                // Solo verificar clientes activos
                if (!esEstadoActivo(c.estado)) continue;
                
                // Si ya pagó todo, marcar como finalizado
                if ((c.montoPagado || 0) >= (c.totalAPagar || 0)) {
                    if (c.estado !== 'finalizado') {
                        c.estado = 'finalizado';
                        clientesActualizados++;
                        await actualizarClienteEnServidor(c);
                    }
                    continue;
                }
                
                // Calcular si está atrasado usando la función que considera la hora de registro
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) continue;
                
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                
                // Si los días de pago son mayores que las parcelas pagas, está atrasado
                if (diasDePago > parcelasPagas) {
                    if (c.estado !== 'atrasado') {
                        c.estado = 'atrasado';
                        clientesActualizados++;
                        await actualizarClienteEnServidor(c);
                    }
                } else {
                    // Si estaba atrasado pero ya se puso al día, volver a activo
                    if (c.estado === 'atrasado') {
                        c.estado = 'ativo';
                        clientesActualizados++;
                        await actualizarClienteEnServidor(c);
                    }
                }
            }
            
            if (clientesActualizados > 0) {
                console.log(`✅ ${clientesActualizados} cliente(s) actualizado(s)`);
                // Actualizar vistas
                if (typeof updateStats === 'function') updateStats();
                if (typeof renderClientes === 'function') renderClientes();
            }
        }
        
        // Actualizar cliente en el servidor
        async function actualizarClienteEnServidor(cliente) {
            try {
                await fetch(API_URL + '/api/clientes/' + cliente.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cliente)
                });
            } catch (e) {
                console.error('Error actualizando cliente:', e);
            }
        }
        
        // Agregar estilos de animación para toasts
        if (!document.getElementById('toastStyles')) {
            const style = document.createElement('style');
            style.id = 'toastStyles';
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes slideOut {
                    from { transform: translateX(0); opacity: 1; }
                    to { transform: translateX(100%); opacity: 0; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // Cambiar tema
        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-theme');
                localStorage.setItem('finangest_theme', 'light');
            } else {
                document.body.classList.remove('light-theme');
                localStorage.setItem('finangest_theme', 'dark');
            }
        }
        
        // Cambiar contraseña del usuario
        async function cambiarMiPassword() {
            const actual = document.getElementById('passActual').value;
            const nueva = document.getElementById('passNueva').value;
            const confirmar = document.getElementById('passConfirmar').value;
            
            if (!actual || !nueva || !confirmar) {
                return alert('Preencha todos os campos');
            }
            if (nueva.length < 6) {
                return alert('A nova senha deve ter pelo menos 6 caracteres');
            }
            if (nueva !== confirmar) {
                return alert('As senhas não coincidem');
            }
            
            try {
                // Verificar contraseña actual
                const loginRes = await fetch(API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email, password: actual })
                });
                const loginData = await loginRes.json();
                
                if (!loginData.success) {
                    return alert('Senha atual incorreta');
                }
                
                // Cambiar contraseña
                const res = await fetch(API_URL + '/api/users/' + currentUser.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: nueva })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Senha alterada com sucesso');
                    document.getElementById('passActual').value = '';
                    document.getElementById('passNueva').value = '';
                    document.getElementById('passConfirmar').value = '';
                } else {
                    alert('Erro ao alterar senha');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // ============ ADMIN: CONFIGURACIÓN ============
        
        function guardarConfigAdmin() {
            const config = {
                nombreEmpresa: document.getElementById('cfgNombreEmpresa')?.value || 'FinanGest',
                moneda: document.getElementById('cfgMoneda')?.value || 'R$',
                precioSuscripcion: document.getElementById('cfgPrecioSuscripcion')?.value || 51.41,
                diasPrueba: document.getElementById('cfgDiasPrueba')?.value || 0,
                backupFreq: document.getElementById('cfgBackupFreq')?.value || 1,
                backupRetencion: document.getElementById('cfgBackupRetencion')?.value || 7,
                backupMax: document.getElementById('cfgBackupMax')?.value || 50,
                emailNuevoUsuario: document.getElementById('cfgEmailNuevoUsuario')?.checked,
                emailPago: document.getElementById('cfgEmailPago')?.checked,
                emailBackup: document.getElementById('cfgEmailBackup')?.checked
            };
            localStorage.setItem('finangest_admin_config', JSON.stringify(config));
        }
        
        function cargarConfigAdmin() {
            const config = JSON.parse(localStorage.getItem('finangest_admin_config') || '{}');
            if (document.getElementById('cfgNombreEmpresa')) {
                document.getElementById('cfgNombreEmpresa').value = config.nombreEmpresa || 'FinanGest';
                document.getElementById('cfgMoneda').value = config.moneda || 'R$';
                document.getElementById('cfgPrecioSuscripcion').value = config.precioSuscripcion || 51.41;
                document.getElementById('cfgDiasPrueba').value = config.diasPrueba || 0;
                document.getElementById('cfgBackupFreq').value = config.backupFreq || 1;
                document.getElementById('cfgBackupRetencion').value = config.backupRetencion || 7;
                document.getElementById('cfgBackupMax').value = config.backupMax || 50;
                document.getElementById('cfgEmailNuevoUsuario').checked = config.emailNuevoUsuario !== false;
                document.getElementById('cfgEmailPago').checked = config.emailPago !== false;
                document.getElementById('cfgEmailBackup').checked = config.emailBackup || false;
            }
        }
        
        // ============ ADMIN: ESTADÍSTICAS DEL SISTEMA ============
        
        async function cargarEstadisticasSistema() {
            const container = document.getElementById('systemStatsContainer');
            if (!container) return;
            
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i>
                    <p class="text-secondary">Cargando estadísticas...</p>
                </div>
            `;
            
            try {
                const res = await fetch(API_URL + '/api/admin/system-stats');
                const data = await res.json();
                
                if (!data.success) {
                    container.innerHTML = '<p class="text-danger text-center">Error al cargar estadísticas</p>';
                    return;
                }
                
                const s = data.stats;
                
                // Determinar colores según porcentaje
                const getColor = (percent) => {
                    if (percent < 50) return 'var(--accent-green)';
                    if (percent < 80) return 'var(--accent-yellow)';
                    return 'var(--accent-red)';
                };
                
                const storageColor = getColor(s.storagePercent);
                const apiColor = getColor(s.apiCallsPercent);
                
                container.innerHTML = `
                    <!-- Barras de progreso -->
                    <div class="row g-4 mb-4">
                        <div class="col-md-6">
                            <div class="p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <div class="d-flex justify-content-between mb-2">
                                    <span><i class="fas fa-database me-2"></i>Almacenamiento (MongoDB)</span>
                                    <span style="color: ${storageColor}; font-weight: bold;">${s.storagePercent}%</span>
                                </div>
                                <div style="background: #2d2d44; border-radius: 10px; height: 20px; overflow: hidden;">
                                    <div style="background: ${storageColor}; height: 100%; width: ${s.storagePercent}%; transition: width 0.5s;"></div>
                                </div>
                                <small class="text-secondary">${s.storageUsedMB} MB de ${s.storageLimitMB} MB usados</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <div class="d-flex justify-content-between mb-2">
                                    <span><i class="fas fa-exchange-alt me-2"></i>API Calls (Netlify) - Estimado</span>
                                    <span style="color: ${apiColor}; font-weight: bold;">${s.apiCallsPercent}%</span>
                                </div>
                                <div style="background: #2d2d44; border-radius: 10px; height: 20px; overflow: hidden;">
                                    <div style="background: ${apiColor}; height: 100%; width: ${Math.min(100, s.apiCallsPercent)}%; transition: width 0.5s;"></div>
                                </div>
                                <small class="text-secondary">~${s.apiCallsEstimadas.toLocaleString()} de ${s.apiCallsLimite.toLocaleString()} este mes</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Contadores -->
                    <div class="row g-3 mb-4">
                        <div class="col-6 col-md-3">
                            <div class="text-center p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <i class="fas fa-users fa-2x mb-2" style="color: var(--accent-cyan);"></i>
                                <div style="font-size: 1.5rem; font-weight: bold;">${s.totalTrabajadores}</div>
                                <small class="text-secondary">Trabajadores</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <i class="fas fa-user-friends fa-2x mb-2" style="color: var(--accent-green);"></i>
                                <div style="font-size: 1.5rem; font-weight: bold;">${s.totalClientes}</div>
                                <small class="text-secondary">Clientes</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <i class="fas fa-wallet fa-2x mb-2" style="color: var(--accent-yellow);"></i>
                                <div style="font-size: 1.5rem; font-weight: bold;">${s.totalGastos}</div>
                                <small class="text-secondary">Gastos</small>
                            </div>
                        </div>
                        <div class="col-6 col-md-3">
                            <div class="text-center p-3" style="background: var(--bg-hover); border-radius: 8px;">
                                <i class="fas fa-archive fa-2x mb-2" style="color: var(--accent-purple);"></i>
                                <div style="font-size: 1.5rem; font-weight: bold;">${s.totalBackups}</div>
                                <small class="text-secondary">Backups</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recomendaciones -->
                    <div class="p-3 mb-3" style="background: ${s.estado === 'ok' ? 'rgba(0,200,100,0.1)' : s.estado === 'warning' ? 'rgba(255,200,0,0.1)' : 'rgba(255,50,50,0.1)'}; border-radius: 8px; border-left: 4px solid ${s.estado === 'ok' ? 'var(--accent-green)' : s.estado === 'warning' ? 'var(--accent-yellow)' : 'var(--accent-red)'};">
                        <h6 class="mb-2"><i class="fas fa-lightbulb me-2"></i>Estado y Recomendaciones</h6>
                        ${s.recomendaciones.map(r => `<p class="mb-1" style="font-size: 0.9rem;">${r}</p>`).join('')}
                        <div class="mt-3 p-2" style="background: rgba(0,212,255,0.1); border-radius: 6px;">
                            <p class="mb-0" style="font-size: 0.95rem;">
                                <i class="fas fa-hourglass-half me-2" style="color: var(--accent-cyan);"></i>
                                <strong>Plan ${s.planActual ? s.planActual.toUpperCase() : 'FREE'} te dura aproximadamente: </strong>
                                <span style="color: var(--accent-cyan); font-size: 1.1rem; font-weight: bold;">${s.aniosRestantes} años</span>
                                <small class="text-secondary"> (${s.mesesRestantes} meses)</small>
                            </p>
                        </div>
                    </div>
                    
                    <!-- Límites del Plan Actual -->
                    <div class="p-3" style="background: rgba(138,43,226,0.1); border-radius: 8px; border-left: 4px solid var(--accent-purple);">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0"><i class="fas fa-layer-group me-2" style="color: var(--accent-purple);"></i>Capacidad del Plan ${s.planActual ? s.planActual.toUpperCase() : 'FREE'}</h6>
                            ${s.planActual !== 'enterprise' ? '<button onclick="mostrarModalUpgradePlan()" class="btn btn-sm" style="background: var(--accent-purple); color: #fff;"><i class="fas fa-rocket me-1"></i>Mejorar</button>' : ''}
                        </div>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <div class="p-2 text-center" style="background: var(--bg-hover); border-radius: 6px;">
                                    <i class="fas fa-users mb-1" style="color: var(--accent-cyan);"></i>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${s.limitesTrabajadores || 200}+</div>
                                    <small class="text-secondary">Trabajadores</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-2 text-center" style="background: var(--bg-hover); border-radius: 6px;">
                                    <i class="fas fa-user-friends mb-1" style="color: var(--accent-green);"></i>
                                    <div style="font-size: 1.3rem; font-weight: bold;">${s.limitesClientesPorTrabajador || 500}+</div>
                                    <small class="text-secondary">Clientes por trabajador</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-2 text-center" style="background: var(--bg-hover); border-radius: 6px;">
                                    <i class="fas fa-infinity mb-1" style="color: var(--accent-yellow);"></i>
                                    <div style="font-size: 1.3rem; font-weight: bold;">∞</div>
                                    <small class="text-secondary">Carteras/Gastos</small>
                                </div>
                            </div>
                        </div>
                        
                        ${(parseFloat(s.storagePercent) >= 80 || parseFloat(s.apiCallsPercent) >= 80) ? `
                        <!-- Alerta de límite cercano -->
                        <div class="mt-3 p-3" style="background: rgba(255,100,100,0.15); border-radius: 8px; border: 1px solid var(--accent-red);">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-exclamation-circle fa-lg me-2" style="color: var(--accent-red);"></i>
                                <strong style="color: var(--accent-red);">¡Atención! Estás cerca del límite</strong>
                            </div>
                            <p class="mb-3" style="font-size: 0.9rem; color: var(--text-secondary);">
                                ${parseFloat(s.storagePercent) >= 80 ? 'Almacenamiento al ' + s.storagePercent + '%. ' : ''}
                                ${parseFloat(s.apiCallsPercent) >= 80 ? 'API Calls al ' + s.apiCallsPercent + '%. ' : ''}
                                Mejora tu plan para aumentar los límites.
                            </p>
                            <button onclick="mostrarModalUpgradePlan()" class="btn w-100" style="background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; font-weight: 600; padding: 12px;">
                                <i class="fas fa-rocket me-2"></i>Mejorar Plan - Aumentar Límites
                            </button>
                        </div>
                        ` : ''}
                        
                        <p class="mt-2 mb-0 text-secondary" style="font-size: 0.8rem;">
                            <i class="fas fa-info-circle me-1"></i>
                            Si superas estos límites, revisa el uso mensual en <a href="https://app.netlify.com" target="_blank" style="color: var(--accent-cyan);">Netlify</a> y <a href="https://cloud.mongodb.com" target="_blank" style="color: var(--accent-cyan);">MongoDB Atlas</a>
                        </p>
                    </div>
                    
                    <div class="mt-3 text-end">
                        <small class="text-secondary">Última actualización: ${new Date(s.fechaConsulta).toLocaleString()}</small>
                    </div>
                `;
            } catch (e) {
                container.innerHTML = `<p class="text-danger text-center">Error de conexión: ${e.message}</p>`;
            }
        }
        
        // Modal para mejorar plan cuando se acercan a los límites
        function mostrarModalUpgradePlan() {
            const modal = document.createElement('div');
            modal.id = 'modalUpgradePlan';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px;';
            modal.innerHTML = `
                <div style="background: var(--bg-card); border-radius: 20px; padding: 30px; max-width: 500px; width: 100%; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; position: relative;">
                    <!-- Botón X para cerrar -->
                    <button onclick="cerrarModalUpgrade()" style="position: absolute; top: 15px; right: 15px; background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 5px 10px; line-height: 1;">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <div class="text-center mb-4">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, #00d4ff, #0099cc); border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                            <i class="fas fa-rocket fa-2x" style="color: #000;"></i>
                        </div>
                        <h3 style="color: #fff; margin-bottom: 10px;">Mejorar Plan</h3>
                        <p style="color: var(--text-secondary);">Aumenta los límites de tu sistema</p>
                    </div>
                    
                    <!-- Plan Pro -->
                    <div style="background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(138,43,226,0.1)); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 style="color: var(--accent-cyan); margin: 0;"><i class="fas fa-crown me-2"></i>Plan Pro</h5>
                            <span style="background: var(--accent-cyan); color: #000; padding: 4px 12px; border-radius: 20px; font-weight: bold;">R$ 149/mes</span>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>2 GB de almacenamiento</li>
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>500,000 API calls/mes</li>
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>200 trabajadores</li>
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>500 clientes por trabajador</li>
                            <li style="color: #fff;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>Soporte prioritario</li>
                        </ul>
                    </div>
                    
                    <!-- Plan Enterprise -->
                    <div style="background: rgba(138,43,226,0.1); border: 1px solid var(--accent-purple); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 style="color: var(--accent-purple); margin: 0;"><i class="fas fa-building me-2"></i>Plan Enterprise</h5>
                            <span style="background: var(--accent-purple); color: #fff; padding: 4px 12px; border-radius: 20px; font-weight: bold;">Contactar</span>
                        </div>
                        <ul style="list-style: none; padding: 0; margin: 0;">
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>10 GB de almacenamiento</li>
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>2,000,000 API calls/mes</li>
                            <li style="color: #fff; margin-bottom: 8px;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>1000 trabajadores</li>
                            <li style="color: #fff;"><i class="fas fa-check me-2" style="color: var(--accent-green);"></i>Soporte dedicado 24/7</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button onclick="contactarParaUpgrade('pro')" class="btn" style="background: linear-gradient(135deg, #00d4ff, #0099cc); color: #000; font-weight: 600; padding: 14px;">
                            <i class="fas fa-credit-card me-2"></i>Contratar Plan Pro
                        </button>
                        <button onclick="contactarParaUpgrade('enterprise')" class="btn" style="background: var(--accent-purple); color: #fff; padding: 12px;">
                            <i class="fas fa-envelope me-2"></i>Contactar para Enterprise
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Cerrar al hacer clic fuera del modal
            modal.addEventListener('click', (e) => {
                if (e.target === modal) cerrarModalUpgrade();
            });
        }
        
        function cerrarModalUpgrade() {
            const modal = document.getElementById('modalUpgradePlan');
            if (modal) modal.remove();
        }
        
        function contactarParaUpgrade(plan) {
            const mensaje = plan === 'pro' 
                ? 'Hola, quiero contratar el Plan Pro de FinanGest para aumentar mis límites.'
                : 'Hola, me interesa el Plan Enterprise de FinanGest. Quisiera más información.';
            
            // Abrir WhatsApp o email
            const whatsapp = 'https://wa.me/5579985555813?text=' + encodeURIComponent(mensaje);
            window.open(whatsapp, '_blank');
            
            cerrarModalUpgrade();
            alert('📱 Te redirigimos a WhatsApp para completar tu solicitud.\\n\\nTambién puedes escribirnos a: finangestsoftware@gmail.com');
        }
        
        // ============ ADMIN: SEGURIDAD ============
        
        function guardarConfigSeguridad() {
            const segConfig = {
                passMinLength: document.getElementById('segPassMinLength')?.value || 6,
                passExpira: document.getElementById('segPassExpira')?.value || 0,
                maxIntentos: document.getElementById('segMaxIntentos')?.value || 5,
                requiereMayuscula: document.getElementById('segRequiereMayuscula')?.checked,
                requiereNumero: document.getElementById('segRequiereNumero')?.checked,
                requiereEspecial: document.getElementById('segRequiereEspecial')?.checked,
                timeoutSesion: document.getElementById('segTimeoutSesion')?.value || 30,
                sesionesMax: document.getElementById('segSesionesMax')?.value || 3
            };
            localStorage.setItem('finangest_seguridad_config', JSON.stringify(segConfig));
        }
        
        function cargarConfigSeguridad() {
            const config = JSON.parse(localStorage.getItem('finangest_seguridad_config') || '{}');
            if (document.getElementById('segPassMinLength')) {
                document.getElementById('segPassMinLength').value = config.passMinLength || 6;
                document.getElementById('segPassExpira').value = config.passExpira || 0;
                document.getElementById('segMaxIntentos').value = config.maxIntentos || 5;
                document.getElementById('segRequiereMayuscula').checked = config.requiereMayuscula || false;
                document.getElementById('segRequiereNumero').checked = config.requiereNumero || false;
                document.getElementById('segRequiereEspecial').checked = config.requiereEspecial || false;
                document.getElementById('segTimeoutSesion').value = config.timeoutSesion || 30;
                document.getElementById('segSesionesMax').value = config.sesionesMax || 3;
            }
        }
        
        async function cargarEstadisticasSeguridad() {
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                
                const activos = users.filter(u => !u.blocked && u.role !== 'admin').length;
                const bloqueados = users.filter(u => u.blocked).length;
                const online = users.filter(u => u.lastSeen && (Date.now() - new Date(u.lastSeen).getTime()) < 300000).length;
                
                document.getElementById('segUsuariosActivos').textContent = activos;
                document.getElementById('segUsuariosBloqueados').textContent = bloqueados;
                document.getElementById('segSesionesHoy').textContent = online;
                document.getElementById('segIntentosLogin').textContent = '0';
            } catch (e) {
                console.log('Error cargando estadísticas de seguridad');
            }
        }
        
        function cargarLogSeguridad() {
            const logs = JSON.parse(localStorage.getItem('finangest_security_log') || '[]');
            const table = document.getElementById('logSeguridadTable');
            
            if (logs.length === 0) {
                table.innerHTML = '<tr><td colspan="5" class="text-center text-secondary">No hay registros de actividad</td></tr>';
                return;
            }
            
            table.innerHTML = logs.slice(-20).reverse().map(log => `
                <tr>
                    <td>${new Date(log.fecha).toLocaleString()}</td>
                    <td>${log.usuario || 'Sistema'}</td>
                    <td>${log.accion}</td>
                    <td>${log.ip || '-'}</td>
                    <td><span class="badge ${log.estado === 'success' ? 'badge-active' : 'badge-late'}">${log.estado === 'success' ? 'OK' : 'Error'}</span></td>
                </tr>
            `).join('');
        }
        
        function registrarLogSeguridad(accion, estado = 'success') {
            const logs = JSON.parse(localStorage.getItem('finangest_security_log') || '[]');
            logs.push({
                fecha: getCurrentDate().toISOString(),
                usuario: currentUser?.email || 'Sistema',
                accion: accion,
                ip: '-',
                estado: estado
            });
            // Mantener solo los últimos 100 registros
            if (logs.length > 100) logs.shift();
            localStorage.setItem('finangest_security_log', JSON.stringify(logs));
        }
        
        // ============ ACCIONES DE EMERGENCIA (ADMIN) ============
        
        // Modal para confirmar con contraseña
        function mostrarModalConfirmacion(titulo, mensaje, callback) {
            // Crear modal si no existe
            let modal = document.getElementById('modalConfirmPassword');
            if (!modal) {
                const modalHtml = `
                    <div class="modal fade modal-dark" id="modalConfirmPassword" tabindex="-1">
                        <div class="modal-dialog modal-dialog-centered">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="confirmModalTitle"><i class="fas fa-shield-alt me-2"></i>Confirmar Acción</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <p id="confirmModalMessage" class="mb-3"></p>
                                    <div class="mb-3">
                                        <label class="form-label">Ingresa tu contraseña para confirmar:</label>
                                        <input type="password" class="form-control form-control-dark" id="confirmPassword" placeholder="Tu contraseña">
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn" style="background: var(--accent-red); color: #fff;" id="btnConfirmAction">
                                        <i class="fas fa-check me-2"></i>Confirmar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('modalConfirmPassword');
            }
            
            document.getElementById('confirmModalTitle').innerHTML = '<i class="fas fa-shield-alt me-2"></i>' + titulo;
            document.getElementById('confirmModalMessage').textContent = mensaje;
            document.getElementById('confirmPassword').value = '';
            
            const btnConfirm = document.getElementById('btnConfirmAction');
            btnConfirm.onclick = async () => {
                const password = document.getElementById('confirmPassword').value;
                if (!password) {
                    alert('Digite sua senha');
                    return;
                }
                
                // Verificar contraseña
                try {
                    const res = await fetch(API_URL + '/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: currentUser.email, password })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        bootstrap.Modal.getInstance(modal).hide();
                        callback();
                    } else {
                        alert('❌ Senha incorreta');
                    }
                } catch (e) {
                    alert('Error al verificar contraseña');
                }
            };
            
            new bootstrap.Modal(modal).show();
            document.getElementById('confirmPassword').focus();
        }
        
        async function cerrarTodasSesionesAdmin() {
            if (!confirm('⚠️ Esto cerrará la sesión de TODOS los usuarios (excepto tú). ¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                
                for (const user of users) {
                    if (user._id !== currentUser.id && user.id !== currentUser.id) {
                        await fetch(API_URL + '/api/users/' + (user._id || user.id), {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ forceLogout: true, lastSeen: null })
                        });
                    }
                }
                
                // Cerrar sesiones en la colección sessions
                await fetch(API_URL + '/api/sessions/admin/close-all-users', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ exceptUserId: currentUser.id })
                }).catch(() => {});
                
                alert('✅ Todas las sesiones han sido cerradas');
            } catch (e) {
                alert('Error al cerrar sesiones');
            }
        }
        
        async function bloquearTodosUsuarios() {
            if (!confirm('⚠️ ATENCIÓN: Esto bloqueará a TODOS los usuarios (excepto admin). ¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                
                let bloqueados = 0;
                for (const user of users) {
                    if (user.role !== 'admin' && !user.isAdmin) {
                        await fetch(API_URL + '/api/users/' + (user._id || user.id), {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ blocked: true })
                        });
                        bloqueados++;
                    }
                }
                
                alert('✅ ' + bloqueados + ' usuarios han sido bloqueados');
            } catch (e) {
                alert('Error al bloquear usuarios');
            }
        }
        
        async function desbloquearTodosUsuarios() {
            if (!confirm('¿Desbloquear a todos los usuarios bloqueados?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                
                let desbloqueados = 0;
                for (const user of users) {
                    if (user.blocked) {
                        await fetch(API_URL + '/api/users/' + (user._id || user.id), {
                            method: 'PUT',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ blocked: false })
                        });
                        desbloqueados++;
                    }
                }
                
                alert('✅ ' + desbloqueados + ' usuarios han sido desbloqueados');
            } catch (e) {
                alert('Error al desbloquear usuarios');
            }
        }

        // Tema claro/oscuro
        let isDarkTheme = true;
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light-theme', !isDarkTheme);
            localStorage.setItem('finangest_theme', isDarkTheme ? 'dark' : 'light');
            updateThemeButtons();
        }
        
        function setTheme(theme) {
            isDarkTheme = (theme === 'dark');
            document.body.classList.toggle('light-theme', !isDarkTheme);
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('finangest_theme', theme);
            updateThemeButtons();
        }
        
        function updateThemeButtons() {
            const btnOscuro = document.getElementById('btnTemaOscuro');
            const btnClaro = document.getElementById('btnTemaClaro');
            if (btnOscuro && btnClaro) {
                if (isDarkTheme) {
                    btnOscuro.style.background = 'var(--accent-cyan)';
                    btnOscuro.style.color = '#000';
                    btnClaro.style.background = 'var(--bg-hover)';
                    btnClaro.style.color = 'var(--text-primary)';
                } else {
                    btnClaro.style.background = 'var(--accent-cyan)';
                    btnClaro.style.color = '#000';
                    btnOscuro.style.background = 'var(--bg-hover)';
                    btnOscuro.style.color = 'var(--text-primary)';
                }
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('finangest_theme');
            if (savedTheme === 'light') {
                isDarkTheme = false;
                document.body.classList.add('light-theme');
                document.body.setAttribute('data-theme', 'light');
            } else {
                document.body.setAttribute('data-theme', 'dark');
            }
            updateThemeButtons();
        }

        // Soporte
        function openSupport() {
            const supportNumber = '5579985555813'; // WhatsApp de soporte FinanGest
            const message = encodeURIComponent('Hola, necesito ayuda con FinanGest');
            window.open(`https://wa.me/${supportNumber}?text=${message}`, '_blank');
        }

        async function loadData() {
            // Mostrar spinner de carga
            const dashboardSection = document.getElementById('dashboard');
            if (dashboardSection) {
                const statsCards = dashboardSection.querySelector('.row');
                if (statsCards) {
                    statsCards.insertAdjacentHTML('beforebegin', '<div id="loadingSpinner" class="text-center py-4"><i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i><p class="mt-2 text-secondary">Cargando datos...</p></div>');
                }
            }
            
            const userId = currentUser.id || currentUser._id;
            
            try {
                // Cargar carteras primero
                await cargarCarteras();
                
                const res = await fetch(API_URL + '/api/clientes?userId=' + userId);
                clientes = await res.json();
                if (clientes.error) clientes = [];
                
                // Cargar gastos
                const gastosRes = await fetch(API_URL + '/api/gastos?userId=' + userId);
                gastos = await gastosRes.json();
                if (gastos.error) gastos = [];
                
                // Ocultar spinner
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) spinner.remove();
                
                if (currentUser.role === 'admin' || currentUser.isAdmin) {
                    const usersRes = await fetch(API_URL + '/api/users');
                    allUsers = await usersRes.json();
                    showSection('adminUsuarios');
                } else {
                    // Actualizar menú según si hay carteras
                    actualizarMenuSegunCarteras();
                    // Cargar carteras eliminadas siempre
                    cargarCarterasEliminadas();
                    // Si hay carteras, mostrar datos normales
                    if (carteras && carteras.length > 0) {
                        cargarCajaInicial();
                        mostrarSoloHoy(); // Mostrar fecha de hoy por defecto
                        updateStats(); // Actualizar estadísticas
                        renderClientes();
                        renderChart();
                        cargarClientesEliminados();
                        // Establecer límites de fecha para todos los calendarios
                        establecerLimitesFechaTodosCalendarios();
                    }
                }
                // Aplicar traducciones después de cargar datos
                setTimeout(() => {
                    // Forzar aplicación de traducciones según idioma guardado
                    const savedLang = localStorage.getItem('finangest_lang') || 'pt';
                    document.querySelectorAll('[data-translate]').forEach(el => {
                        const key = el.getAttribute('data-translate');
                        const translated = translations[savedLang][key] || translations['es'][key];
                        if (translated && translated !== key) {
                            el.textContent = translated;
                        }
                    });
                    // Actualizar botones de idioma
                    const btnEs = document.getElementById('btnLangEs');
                    const btnPt = document.getElementById('btnLangPt');
                    if (btnEs && btnPt) {
                        if (savedLang === 'es') {
                            btnEs.style.background = 'var(--accent-cyan)';
                            btnEs.style.color = '#000';
                            btnPt.style.background = 'var(--bg-hover)';
                            btnPt.style.color = 'var(--text-primary)';
                        } else {
                            btnPt.style.background = 'var(--accent-cyan)';
                            btnPt.style.color = '#000';
                            btnEs.style.background = 'var(--bg-hover)';
                            btnEs.style.color = 'var(--text-primary)';
                        }
                    }
                }, 200);
            } catch (e) {
                console.error('Error loading data:', e);
                // Ocultar spinner en caso de error
                const spinner = document.getElementById('loadingSpinner');
                if (spinner) spinner.remove();
            }
        }
        
        // ========== FUNCIONES HELPER DE FECHAS ==========
        // Estas funciones aseguran que las comparaciones de fechas funcionen
        // correctamente independientemente de la zona horaria
        
        // Obtiene la fecha local en formato YYYY-MM-DD
        function getFechaLocalString(date = getCurrentDate()) {
            const d = new Date(date);
            return d.getFullYear() + '-' + 
                   String(d.getMonth() + 1).padStart(2, '0') + '-' + 
                   String(d.getDate()).padStart(2, '0');
        }
        
        // Crea una fecha para guardar en BD
        // Para clientes nuevos: guarda la hora real (importante para la regla de las 12 PM)
        // Para filtros/comparaciones: usa mediodía para evitar problemas de zona horaria
        function crearFechaParaGuardar(fechaStr = null, guardarHoraReal = true) {
            if (fechaStr) {
                // Si viene un string YYYY-MM-DD, crear fecha al mediodía local
                return new Date(fechaStr + 'T12:00:00').toISOString();
            }
            // Si no hay fecha, usar ahora con la hora real (para clientes nuevos)
            if (guardarHoraReal) {
                return getCurrentDate().toISOString();
            }
            // O usar mediodía si es para comparaciones
            const hoy = getCurrentDate();
            hoy.setHours(12, 0, 0, 0);
            return hoy.toISOString();
        }
        
        // Normaliza una fecha para comparación (solo día, sin hora)
        function normalizarFechaParaComparar(fecha) {
            // Si es un string en formato YYYY-MM-DD, agregar T12:00:00 para evitar problemas de zona horaria
            if (typeof fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
                fecha = fecha + 'T12:00:00';
            }
            const d = new Date(fecha);
            d.setHours(12, 0, 0, 0);
            return d;
        }
        
        // Compara si dos fechas son el mismo día
        function esMismoDia(fecha1, fecha2) {
            const d1 = normalizarFechaParaComparar(fecha1);
            const d2 = normalizarFechaParaComparar(fecha2);
            return d1.toDateString() === d2.toDateString();
        }
        
        // Compara si fecha1 está en el rango [fechaInicio, fechaFin]
        function fechaEnRango(fecha, fechaInicio, fechaFin) {
            const d = normalizarFechaParaComparar(fecha);
            const inicio = normalizarFechaParaComparar(fechaInicio);
            const fin = normalizarFechaParaComparar(fechaFin);
            fin.setHours(23, 59, 59, 999); // Incluir todo el día final
            return d >= inicio && d <= fin;
        }
        
        // Función helper para verificar si el estado es "activo" de forma tolerante
        // Maneja caracteres corruptos, variaciones de escritura, etc.
        function esEstadoActivo(estado) {
            if (!estado) return false;
            const estadoLower = String(estado).toLowerCase().trim();
            // Verificar variaciones: activo, ativo, activ, ativ, etc.
            if (estadoLower === 'activo' || estadoLower === 'ativo') return true;
            if (estadoLower.startsWith('activ') || estadoLower.startsWith('ativ')) return true;
            // Verificar si contiene las letras principales (para caracteres corruptos)
            if (estadoLower.includes('ctiv') || estadoLower.includes('tivo') || estadoLower.includes('tiv')) return true;
            // Verificar por longitud y primeras letras (a, at, ac)
            if (estadoLower.length >= 4 && estadoLower.length <= 7) {
                if (estadoLower[0] === 'a' && (estadoLower[1] === 't' || estadoLower[1] === 'c')) return true;
            }
            return false;
        }
        
        // Calcula los días de pago (parcelas que debería haber pagado hasta ahora)
        // REGLA DE PAGO:
        // - Cliente agregado después de las 6 AM → debe pagar ese mismo día antes de las 12 AM
        // - Si no paga antes de las 12 AM → queda atrasado (día 1 de atraso)
        // - Cada día que pasa sin pagar suma 1 día de atraso
        function calcularDiasDePago(fechaCreacion) {
            if (!fechaCreacion) return 0;
            
            const ahora = getCurrentDate();
            const fechaRegistro = new Date(fechaCreacion);
            
            // Validar que la fecha sea válida
            if (isNaN(fechaRegistro.getTime())) {
                return 0;
            }
            
            // Si la fecha de registro es en el futuro, no debe nada
            if (fechaRegistro > ahora) {
                return 0;
            }
            
            // Normalizar fechas a medianoche para comparación
            const ahoraInicioDia = new Date(ahora.getFullYear(), ahora.getMonth(), ahora.getDate());
            const registroInicioDia = new Date(fechaRegistro.getFullYear(), fechaRegistro.getMonth(), fechaRegistro.getDate());
            
            // Calcular diferencia en días completos
            const diffMs = ahoraInicioDia - registroInicioDia;
            const diasTranscurridos = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            // El cliente debe pagar el MISMO día que se registra (día 1)
            // Ejemplo: registrado hoy = debe 1 parcela hoy
            //          registrado ayer = debe 2 parcelas (ayer + hoy)
            //          registrado hace 2 días = debe 3 parcelas
            return Math.max(0, diasTranscurridos + 1);
        }
        
        // ========== FIN FUNCIONES HELPER DE FECHAS ==========
        
        // Función para obtener clientes filtrados por cartera actual
        function getClientesFiltrados() {
            try {
                // Si no hay cartera seleccionada, no mostrar clientes
                if (carteraActual === null || !carteras || carteras.length === 0) {
                    return [];
                }
                if (!clientes || !Array.isArray(clientes)) return [];
                return clientes.filter(c => {
                    const clienteCartera = c.carteraId || c.cliente?.carteraId;
                    return clienteCartera === carteraActual;
                });
            } catch (e) {
                console.error('Error en getClientesFiltrados:', e);
                return [];
            }
        }
        
        // Función para obtener gastos filtrados por cartera actual
        function getGastosFiltrados() {
            try {
                // Si no hay cartera seleccionada, no mostrar gastos
                if (carteraActual === null || !carteras || carteras.length === 0) {
                    return [];
                }
                if (!gastos || !Array.isArray(gastos)) return [];
                return gastos.filter(g => {
                    return g.carteraId === carteraActual;
                });
            } catch (e) {
                console.error('Error en getGastosFiltrados:', e);
                return [];
            }
        }

        let dashboardFechaFiltro = null; // null = todos los tiempos
        
        function filtrarDashboardPorFecha() {
            const fecha = document.getElementById('dashboardFecha').value;
            if (fecha) {
                dashboardFechaFiltro = fecha;
                document.getElementById('dashboardFechaLabel').textContent = 'Mostrando: ' + new Date(fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
                
                // Sincronizar fecha con todos los demás calendarios
                sincronizarFechaGlobal(fecha);
            } else {
                dashboardFechaFiltro = null;
                document.getElementById('dashboardFechaLabel').textContent = '';
            }
            updateStats();
            calcularCajaDelDia(); // Recalcular caja para la fecha seleccionada
        }
        
        // Sincronizar la fecha del dashboard con todos los demás calendarios
        function sincronizarFechaGlobal(fecha) {
            // Historial - día específico
            const historialDia = document.getElementById('historialDia');
            if (historialDia) historialDia.value = fecha;
            
            // Gastos - filtro de fecha
            const gastoFechaFiltro = document.getElementById('gastoFechaFiltro');
            if (gastoFechaFiltro) gastoFechaFiltro.value = fecha;
            
            // Microseguros - fecha inicio y fin (mismo día)
            const microseguroFechaInicio = document.getElementById('microseguroFechaInicio');
            const microseguroFechaFin = document.getElementById('microseguroFechaFin');
            if (microseguroFechaInicio) microseguroFechaInicio.value = fecha;
            if (microseguroFechaFin) microseguroFechaFin.value = fecha;
            
            // Estadísticas - fecha inicio y fin (mismo día)
            const estFechaInicio = document.getElementById('estFechaInicio');
            const estFechaFin = document.getElementById('estFechaFin');
            if (estFechaInicio) estFechaInicio.value = fecha;
            if (estFechaFin) estFechaFin.value = fecha;
        }
        
        function mostrarTodosTiempos() {
            dashboardFechaFiltro = null;
            document.getElementById('dashboardFecha').value = '';
            document.getElementById('dashboardFechaLabel').textContent = translations[currentLang]?.todosTiempos ? 'Mostrando: ' + translations[currentLang].todosTiempos : 'Mostrando: Todos los tiempos';
            
            // Limpiar todos los calendarios
            sincronizarFechaGlobal('');
            
            updateStats();
            calcularCajaDelDia(); // Recalcular caja
        }
        
        // Establecer fecha mínima del calendario (fecha de registro del usuario o primera cartera)
        function establecerFechaMinimaDashboard() {
            const dashboardFechaInput = document.getElementById('dashboardFecha');
            if (!dashboardFechaInput || !currentUser) return;
            
            // Usar la fecha de creación del usuario como mínimo
            let fechaMinima = null;
            
            if (currentUser.createdAt) {
                fechaMinima = new Date(currentUser.createdAt);
            }
            
            // Si hay carteras, usar la fecha de la cartera más antigua
            if (carteras && carteras.length > 0) {
                carteras.forEach(c => {
                    if (c.createdAt) {
                        const fechaCartera = new Date(c.createdAt);
                        if (!fechaMinima || fechaCartera < fechaMinima) {
                            fechaMinima = fechaCartera;
                        }
                    }
                });
            }
            
            // Si no hay fecha, usar hace 30 días como fallback
            if (!fechaMinima) {
                fechaMinima = getCurrentDate();
                fechaMinima.setDate(fechaMinima.getDate() - 30);
            }
            
            // Formatear fecha para el input
            const fechaMinimaStr = fechaMinima.getFullYear() + '-' + 
                                   String(fechaMinima.getMonth() + 1).padStart(2, '0') + '-' + 
                                   String(fechaMinima.getDate()).padStart(2, '0');
            
            dashboardFechaInput.min = fechaMinimaStr;
            
            // También establecer fecha máxima como hoy
            const hoy = getCurrentDate();
            const fechaMaxStr = hoy.getFullYear() + '-' + 
                               String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(hoy.getDate()).padStart(2, '0');
            dashboardFechaInput.max = fechaMaxStr;
        }
        
        // Establecer límites de fecha para TODOS los calendarios del sistema con Flatpickr
        function establecerLimitesFechaTodosCalendarios() {
            if (!currentUser) return;
            
            // Calcular fecha mínima (fecha de registro del usuario o primera cartera)
            let fechaMinima = new Date();
            
            if (currentUser.createdAt) {
                fechaMinima = new Date(currentUser.createdAt);
            } else if (currentUser.fechaCreacion) {
                fechaMinima = new Date(currentUser.fechaCreacion);
            }
            
            // Buscar la fecha más antigua entre carteras
            if (carteras && carteras.length > 0) {
                carteras.forEach(c => {
                    if (c.fechaCreacion) {
                        const fechaCartera = new Date(c.fechaCreacion);
                        if (fechaCartera < fechaMinima) {
                            fechaMinima = fechaCartera;
                        }
                    }
                });
            }
            
            // Buscar la fecha más antigua entre clientes
            if (clientes && clientes.length > 0) {
                clientes.forEach(c => {
                    const fechaCliente = c.fechaCreacion || c.fechaInicio || c.fechaRegistro;
                    if (fechaCliente) {
                        const fecha = new Date(fechaCliente);
                        if (fecha < fechaMinima) {
                            fechaMinima = fecha;
                        }
                    }
                });
            }
            
            const hoy = getCurrentDate();
            
            // Configuración de idioma para flatpickr
            const locale = currentLang === 'pt' ? 'pt' : 'es';
            
            // Lista de todos los inputs de fecha del sistema
            const inputsFecha = [
                'dashboardFecha',
                'historialDia',
                'gastoFechaFiltro',
                'gastoFecha',
                'pagoFecha',
                'microseguroFechaInicio',
                'microseguroFechaFin',
                'estFecha',
                'estFechaInicio',
                'estFechaFin',
                'fechaCobros',
                'calendarioFecha',
                'adminHistDia'
            ];
            
            // Aplicar flatpickr a cada input
            inputsFecha.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    // Destruir instancia anterior si existe
                    if (input._flatpickr) {
                        input._flatpickr.destroy();
                    }
                    
                    // Crear nueva instancia de flatpickr
                    flatpickr(input, {
                        locale: locale,
                        dateFormat: 'Y-m-d',
                        minDate: fechaMinima,
                        maxDate: hoy,
                        defaultDate: input.value || null,
                        allowInput: false,
                        clickOpens: true,
                        disable: [
                            function(date) {
                                // Deshabilitar fechas futuras
                                return date > hoy;
                            }
                        ],
                        onChange: function(selectedDates, dateStr, instance) {
                            // Validación adicional
                            if (selectedDates.length > 0) {
                                const selected = selectedDates[0];
                                if (selected > hoy) {
                                    instance.clear();
                                    showToast('⚠️ No puedes seleccionar fechas futuras', 3000);
                                } else if (selected < fechaMinima) {
                                    instance.clear();
                                    showToast('⚠️ No puedes seleccionar fechas anteriores a tu registro', 3000);
                                }
                            }
                        },
                        onReady: function(selectedDates, dateStr, instance) {
                            // Personalizar el calendario después de crearlo
                            instance.calendarContainer.style.zIndex = '9999';
                        }
                    });
                }
            });
            
            // Aplicar flatpickr a todos los inputs de búsqueda de préstamos (dinámicos)
            const inputsPrestamos = document.querySelectorAll('.fecha-input-prestamo');
            inputsPrestamos.forEach(input => {
                // Destruir instancia anterior si existe
                if (input._flatpickr) {
                    input._flatpickr.destroy();
                }
                
                // Crear nueva instancia de flatpickr
                flatpickr(input, {
                    locale: locale,
                    dateFormat: 'Y-m-d',
                    minDate: fechaMinima,
                    maxDate: hoy,
                    defaultDate: input.value || null,
                    allowInput: false,
                    clickOpens: true,
                    disable: [
                        function(date) {
                            return date > hoy;
                        }
                    ],
                    onChange: function(selectedDates, dateStr, instance) {
                        if (selectedDates.length > 0) {
                            const selected = selectedDates[0];
                            if (selected > hoy) {
                                instance.clear();
                                showToast('⚠️ No puedes seleccionar fechas futuras', 3000);
                            }
                        }
                    }
                });
            });
            
            console.log('📅 Flatpickr inicializado con límites:', fechaMinima.toISOString().split('T')[0], 'a', hoy.toISOString().split('T')[0]);
        }
        
        // Sincronizar datos sin recargar la página
        async function sincronizarDatos() {
            if (!currentUser) return;
            
            try {
                showToast('🔄 Sincronizando datos...', 1500);
                
                // Recargar carteras
                await cargarCarteras();
                
                // Actualizar estadísticas
                updateStats();
                
                // Recalcular caja del día
                calcularCajaDelDia();
                
                // Renderizar clientes
                renderClientes();
                
                // Renderizar gastos
                renderGastos();
                
                // Actualizar límites de calendarios
                establecerLimitesFechaTodosCalendarios();
                
                showToast('✅ Datos sincronizados correctamente', 4000);
            } catch (error) {
                console.error('Error al sincronizar:', error);
                showToast('❌ Error al sincronizar datos', 4000);
            }
        }
        
        // Reloj del servidor UTC en tiempo real
        let relojServidorInterval = null;
        
        function iniciarRelojServidor() {
            // Limpiar intervalo anterior si existe
            if (relojServidorInterval) {
                clearInterval(relojServidorInterval);
            }
            
            // Actualizar inmediatamente
            actualizarRelojServidor();
            
            // Actualizar cada segundo
            relojServidorInterval = setInterval(actualizarRelojServidor, 1000);
        }
        
        function actualizarRelojServidor() {
            const ahora = getCurrentDate(); // Ya devuelve UTC
            const horas = String(ahora.getHours()).padStart(2, '0');
            const minutos = String(ahora.getMinutes()).padStart(2, '0');
            const segundos = String(ahora.getSeconds()).padStart(2, '0');
            
            const relojElement = document.getElementById('serverTimeUTC');
            if (relojElement) {
                relojElement.textContent = `${horas}:${minutos}:${segundos}`;
            }
        }
        
        // Función para mostrar solo los datos de hoy (desde las 12 AM)
        function mostrarSoloHoy() {
            const hoy = getCurrentDate();
            // Usar fecha local, no UTC
            const fechaHoy = hoy.getFullYear() + '-' + 
                            String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(hoy.getDate()).padStart(2, '0');
            dashboardFechaFiltro = fechaHoy;
            document.getElementById('dashboardFecha').value = fechaHoy;
            document.getElementById('dashboardFechaLabel').textContent = translations[currentLang]?.mostrandoHoy || 'Mostrando: Hoy';
            
            // Establecer límites del calendario
            establecerFechaMinimaDashboard();
            
            updateStats();
        }
        
        // ========== SISTEMA DE CIERRE NOCTURNO (12 AM - 6 AM) ==========
        let sistemaCerrado = false;
        let cierreNocturnoInterval = null;
        
        function verificarHorarioCierre() {
            const ahora = getCurrentDate();
            const hora = ahora.getHours();
            
            // Guardar el día actual para detectar cambios
            const diaActual = ahora.getDate();
            const diaGuardado = parseInt(localStorage.getItem('finangest_ultimo_dia') || '0');
            
            // Si cambió el día (pasó medianoche), actualizar calendarios
            if (diaGuardado !== 0 && diaActual !== diaGuardado) {
                console.log('🌅 Nuevo día detectado - Actualizando calendarios');
                localStorage.setItem('finangest_ultimo_dia', diaActual.toString());
                establecerLimitesFechaTodosCalendarios();
                if (typeof updateStats === 'function') updateStats();
            } else if (diaGuardado === 0) {
                // Primera vez, guardar el día actual
                localStorage.setItem('finangest_ultimo_dia', diaActual.toString());
            }
            
            // Sistema cerrado de 00:00 (12 AM) a 05:59 (antes de 6 AM)
            const estaCerrado = hora >= 0 && hora < 6;
            
            if (estaCerrado !== sistemaCerrado) {
                sistemaCerrado = estaCerrado;
                
                if (sistemaCerrado) {
                    mostrarBannerCerrado();
                } else {
                    ocultarBannerCerrado();
                }
                
                // Deshabilitar/habilitar botón de backup
                const btnBackup = document.getElementById('btnCrearBackup');
                if (btnBackup) {
                    btnBackup.disabled = sistemaCerrado;
                    btnBackup.style.opacity = sistemaCerrado ? '0.5' : '1';
                    btnBackup.style.cursor = sistemaCerrado ? 'not-allowed' : 'pointer';
                }
            }
            
            // Actualizar cuenta regresiva si está cerrado
            if (sistemaCerrado) {
                actualizarCuentaRegresiva();
            }
            
            return sistemaCerrado;
        }
        
        function calcularTiempoHastaApertura() {
            const ahora = getCurrentDate();
            const apertura = new Date(ahora);
            apertura.setHours(6, 0, 0, 0); // 6:00 AM
            
            // Si ya pasó las 6 AM, la apertura es mañana (no debería pasar si estamos cerrados)
            if (ahora >= apertura) {
                apertura.setDate(apertura.getDate() + 1);
            }
            
            const diffMs = apertura - ahora;
            const horas = Math.floor(diffMs / (1000 * 60 * 60));
            const minutos = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const segundos = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            return { horas, minutos, segundos };
        }
        
        function mostrarBannerCerrado() {
            // Crear banner si no existe
            let banner = document.getElementById('bannerSistemaCerrado');
            if (!banner) {
                banner = document.createElement('div');
                banner.id = 'bannerSistemaCerrado';
                banner.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    right: 0;
                    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
                    border-bottom: 3px solid #ff6b6b;
                    padding: 15px 20px;
                    z-index: 99999;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 20px;
                    flex-wrap: wrap;
                    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
                `;
                document.body.prepend(banner);
                
                // Ajustar el contenido principal
                const mainContent = document.querySelector('.main-content');
                if (mainContent) {
                    mainContent.style.paddingTop = '100px';
                }
            }
            
            const t = translations[currentLang] || translations['es'];
            const tiempo = calcularTiempoHastaApertura();
            
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px; flex: 1;">
                    <i class="fas fa-moon" style="font-size: 2rem; color: #a78bfa;"></i>
                    <div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: #fff;">${t.sistemaCerrado || '🌙 Sistema Cerrado'}</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;">${t.sistemaCerradoMsg || 'El sistema está cerrado de 12:00 AM a 6:00 AM'}</div>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 15px; background: rgba(255,107,107,0.15); padding: 10px 20px; border-radius: 10px;">
                    <div style="text-align: center;">
                        <div id="cierreHoras" style="font-size: 1.8rem; font-weight: 700; color: #ff6b6b;">${tiempo.horas}</div>
                        <div style="font-size: 0.7rem; color: #9ca3af;">${t.horas || 'horas'}</div>
                    </div>
                    <div style="font-size: 1.5rem; color: #ff6b6b;">:</div>
                    <div style="text-align: center;">
                        <div id="cierreMinutos" style="font-size: 1.8rem; font-weight: 700; color: #ff6b6b;">${String(tiempo.minutos).padStart(2, '0')}</div>
                        <div style="font-size: 0.7rem; color: #9ca3af;">${t.minutos || 'minutos'}</div>
                    </div>
                    <div style="font-size: 1.5rem; color: #ff6b6b;">:</div>
                    <div style="text-align: center;">
                        <div id="cierreSegundos" style="font-size: 1.8rem; font-weight: 700; color: #ff6b6b;">${String(tiempo.segundos).padStart(2, '0')}</div>
                        <div style="font-size: 0.7rem; color: #9ca3af;">${t.segundos || 'segundos'}</div>
                    </div>
                </div>
                <button onclick="toggleCierreBanner()" style="background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-left: 15px; transition: all 0.3s;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                    <i id="cierreBannerIcon" class="fas fa-chevron-up" style="font-size: 1.2rem;"></i>
                </button>
            `;
            
            // Función para colapsar/expandir el banner
            window.toggleCierreBanner = function() {
                const banner = document.getElementById('cierreBanner');
                const icon = document.getElementById('cierreBannerIcon');
                const mainContent = document.querySelector('.main-content');
                
                if (banner.style.height === '20px') {
                    // Expandir
                    banner.style.height = 'auto';
                    banner.style.overflow = 'visible';
                    icon.className = 'fas fa-chevron-up';
                    if (mainContent) mainContent.style.paddingTop = '100px';
                } else {
                    // Colapsar
                    banner.style.height = '20px';
                    banner.style.overflow = 'hidden';
                    icon.className = 'fas fa-chevron-down';
                    if (mainContent) mainContent.style.paddingTop = '50px';
                }
            };
        }
        
        function actualizarCuentaRegresiva() {
            const tiempo = calcularTiempoHastaApertura();
            const horasEl = document.getElementById('cierreHoras');
            const minutosEl = document.getElementById('cierreMinutos');
            const segundosEl = document.getElementById('cierreSegundos');
            
            if (horasEl) horasEl.textContent = tiempo.horas;
            if (minutosEl) minutosEl.textContent = String(tiempo.minutos).padStart(2, '0');
            if (segundosEl) segundosEl.textContent = String(tiempo.segundos).padStart(2, '0');
        }
        
        function ocultarBannerCerrado() {
            const banner = document.getElementById('bannerSistemaCerrado');
            if (banner) {
                banner.remove();
            }
            
            // Restaurar padding del contenido principal
            const mainContent = document.querySelector('.main-content');
            if (mainContent) {
                mainContent.style.paddingTop = '30px';
            }
        }
        
        // Función para verificar si se puede realizar una acción (crear/modificar)
        function puedeRealizarAccion() {
            if (verificarHorarioCierre()) {
                const t = translations[currentLang] || translations['es'];
                showToastNotification(
                    t.sistemaCerrado || '🌙 Sistema Cerrado',
                    t.sistemaCerradoMsg || 'El sistema está cerrado de 12:00 AM a 6:00 AM',
                    'warning'
                );
                return false;
            }
            return true;
        }
        
        // Iniciar verificación de horario de cierre
        let contadorInterval = null;
        
        function initCierreNocturno() {
            // Verificar inmediatamente
            verificarHorarioCierre();
            
            // Verificar cada minuto
            if (cierreNocturnoInterval) clearInterval(cierreNocturnoInterval);
            cierreNocturnoInterval = setInterval(verificarHorarioCierre, 60000);
            
            // Actualizar contador cada segundo si está cerrado
            if (contadorInterval) clearInterval(contadorInterval);
            contadorInterval = setInterval(() => {
                if (sistemaCerrado) {
                    actualizarCuentaRegresiva();
                }
            }, 1000);
        }
        
        function updateStats() {
            try {
                ensureArrays();
                
                // Primero filtrar por cartera Y excluir renovados
                let clientesFiltrados = (getClientesFiltrados() || []).filter(c => !c.renovado);
                let gastosFiltrados = getGastosFiltrados() || [];
                
                // Clientes activos siempre son TODOS los de la cartera (no filtrar por fecha, pero sí excluir renovados)
                const todosClientesCartera = (getClientesFiltrados() || []).filter(c => !c.renovado);
                const activos = todosClientesCartera.filter(c => esEstadoActivo(c.estado)) || [];
                
                // Para préstamos y pendiente, filtrar por fecha si hay filtro
                let clientesParaStats = clientesFiltrados;
                if (dashboardFechaFiltro) {
                    const fechaFiltro = dashboardFechaFiltro;
                    
                    // Clientes creados en esa fecha (para Total Prestado del día)
                    clientesParaStats = clientesFiltrados.filter(c => {
                        const fechaCliente = (c.fechaCreacion || c.fechaInicio || c.fechaRegistro || '').substring(0, 10);
                        return fechaCliente === fechaFiltro;
                    });
                    
                    // Gastos de esa fecha
                    gastosFiltrados = gastosFiltrados.filter(g => {
                        const fechaGasto = (g.fecha || '').substring(0, 10);
                        return fechaGasto === fechaFiltro;
                    });
                }
                
                const totalPrestado = clientesParaStats.reduce((s, c) => s + (c.montoTotal || 0), 0);
                
                // Calcular cobrado según filtro - SIEMPRE usar clientes de la cartera
                let totalCobrado = 0;
                const clientesCartera = getClientesFiltrados() || [];
                
                if (dashboardFechaFiltro) {
                    // Solo pagos de esa fecha
                    clientesCartera.forEach(c => {
                        if (c.pagos && Array.isArray(c.pagos)) {
                            c.pagos.forEach(p => {
                                const fechaPago = (p.fecha || '').substring(0, 10);
                                if (fechaPago === dashboardFechaFiltro) {
                                    totalCobrado += parseFloat(p.valor || p.monto || 0);
                                }
                            });
                        }
                        if (c.historialPagos && Array.isArray(c.historialPagos)) {
                            c.historialPagos.forEach(p => {
                                const fechaPago = (p.fecha || '').substring(0, 10);
                                if (fechaPago === dashboardFechaFiltro) {
                                    totalCobrado += parseFloat(p.monto || p.valor || 0);
                                }
                            });
                        }
                    });
                } else {
                    // Total cobrado de clientes de la cartera actual
                    totalCobrado = clientesCartera.reduce((s, c) => s + (c.montoPagado || 0), 0);
                }
                
                const totalPendiente = todosClientesCartera.reduce((s, c) => {
                    if (esEstadoActivo(c.estado)) {
                        return s + Math.max(0, (c.totalAPagar || 0) - (c.montoPagado || 0));
                    }
                    return s;
                }, 0);
                
                // Calcular gastos (puede ser monto o valor)
                const totalGastos = gastosFiltrados.reduce((s, g) => s + (parseFloat(g.monto) || parseFloat(g.valor) || 0), 0);
                
                // Calcular microseguros (solo de la cartera actual, excluyendo renovados)
                let totalMicroseguros = 0;
                const clientesParaMicroseguros = dashboardFechaFiltro ? clientesFiltrados : getClientesFiltrados().filter(c => !c.renovado);
                clientesParaMicroseguros.forEach(c => {
                    if (c.microseguro && parseFloat(c.microseguro) > 0) {
                        totalMicroseguros += parseFloat(c.microseguro);
                    }
                });
                
                // Calcular clientes atrasados
                const atrasados = todosClientesCartera.filter(c => {
                    if (!esEstadoActivo(c.estado)) return false;
                    if ((c.montoPagado || 0) >= (c.totalAPagar || 0)) return false;
                    
                    const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                    if (!fechaStr) return false;
                    
                    // Usar la función que considera la hora de registro (regla de las 12 PM)
                    const diasDePago = calcularDiasDePago(fechaStr);
                    const parcelasPagas = c.parcelasPagas || 0;
                    
                    // Está atrasado si los días de pago son mayores que las parcelas pagas
                    return diasDePago > parcelasPagas;
                });
                
                safeSetText('statClientes', activos.length);
                safeSetText('statPrestado', 'R$ ' + totalPrestado.toFixed(2));
                safeSetText('statCobrado', 'R$ ' + totalCobrado.toFixed(2));
                safeSetText('statPendiente', 'R$ ' + totalPendiente.toFixed(2));
                safeSetText('statGastos', 'R$ ' + totalGastos.toFixed(2));
                
                // Actualizar caja total
                actualizarCajaTotal(totalCobrado, totalGastos, totalPrestado);
                
                safeExecute(() => renderCobrosPreview(), null, 'renderCobrosPreview');
                safeExecute(() => renderClientesAtrasados(), null, 'renderClientesAtrasados');
                safeExecute(() => renderMejoresClientes(), null, 'renderMejoresClientes');
                safeExecute(() => renderResumenMes(), null, 'renderResumenMes');
                safeExecute(() => renderActividadReciente(), null, 'renderActividadReciente');
                safeExecute(() => renderChart(), null, 'renderChart');
            } catch (e) {
                console.error('Error en updateStats:', e);
            }
        }
        
        // ========== FUNCIONES DE CAJA ==========
        // cajasIniciales guarda la caja total del día anterior por cartera
        // dineroAgregado guarda el dinero extra agregado hoy por cartera
        let dineroAgregado = {};
        
        async function agregarDineroCaja() {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            const input = document.getElementById('cajaActualInput');
            if (!input) return;
            
            const valor = parseFloat(input.value) || 0;
            
            if (valor <= 0) {
                showToast('⚠️ Ingresa un valor mayor a 0', 2000);
                return;
            }
            
            // Verificar si tiene contraseña de caja configurada
            try {
                const checkRes = await fetch(API_URL + '/api/tiene-password-caja?userId=' + currentUser?.id);
                const checkData = await checkRes.json();
                
                if (checkData.success && checkData.hasPassword) {
                    // Pedir contraseña
                    const password = prompt('🔐 Ingresa la contraseña de caja:');
                    if (!password) {
                        showToast('❌ Operación cancelada', 2000);
                        return;
                    }
                    
                    // Verificar contraseña
                    const res = await fetch(API_URL + '/api/verificar-password-caja', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            userId: currentUser?.id,
                            password: password
                        })
                    });
                    const data = await res.json();
                    
                    if (!data.success || !data.valid) {
                        showToast('❌ Contraseña incorrecta', 2000);
                        return;
                    }
                }
            } catch (e) {
                console.error('Error verificando contraseña:', e);
            }
            
            const carteraKey = carteraActual || 'todas';
            const hoy = getCurrentDateString();
            
            // Sumar al dinero agregado del día
            if (!dineroAgregado[carteraKey]) dineroAgregado[carteraKey] = {};
            dineroAgregado[carteraKey][hoy] = (dineroAgregado[carteraKey][hoy] || 0) + valor;
            
            // Guardar en MongoDB
            guardarDineroAgregadoMongo(carteraKey, hoy, dineroAgregado[carteraKey][hoy]);
            
            // Limpiar input
            input.value = '';
            
            // Recalcular cajas
            calcularCajaDelDia();
            
            showToast(`✅ R$ ${valor.toFixed(2)} agregado a la caja`, 2000);
        }
        
        // Configurar contraseña de caja
        async function configurarPasswordCaja() {
            // Primero verificar si ya tiene contraseña configurada
            try {
                const checkRes = await fetch(API_URL + '/api/tiene-password-caja?userId=' + currentUser?.id);
                const checkData = await checkRes.json();
                
                if (checkData.success && checkData.hasPassword) {
                    // Ya tiene contraseña, mostrar opciones
                    mostrarModalConfigCaja();
                } else {
                    // No tiene contraseña, crear una nueva
                    crearNuevaPasswordCaja();
                }
            } catch (e) {
                console.error('Error verificando contraseña:', e);
                // Si hay error, intentar crear nueva
                crearNuevaPasswordCaja();
            }
        }
        
        function mostrarModalConfigCaja() {
            // Crear modal para configurar contraseña de caja
            let modal = document.getElementById('cajaPasswordModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'cajaPasswordModal';
                modal.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 99999; display: flex; align-items: center; justify-content: center;">
                        <div style="background: var(--bg-card); border-radius: 16px; padding: 30px; max-width: 450px; width: 90%; border: 2px solid var(--accent-purple);">
                            <h4 style="color: var(--accent-purple); margin-bottom: 20px;"><i class="fas fa-lock me-2"></i>${t('configurarContraseniaCaja')}</h4>
                            <div id="cajaPasswordContent">
                                <!-- Contenido dinámico -->
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } else {
                // Actualizar título si ya existe
                modal.querySelector('h4').innerHTML = `<i class="fas fa-lock me-2"></i>${t('configurarContraseniaCaja')}`;
            }
            
            document.getElementById('cajaPasswordContent').innerHTML = `
                <p class="text-secondary mb-4">Ya tienes una contraseña configurada. ¿Qué deseas hacer?</p>
                <div class="d-flex flex-column gap-3">
                    <button class="btn" style="background: var(--accent-cyan); color: #000; padding: 12px;" onclick="cambiarPasswordCajaConActual()">
                        <i class="fas fa-key me-2"></i>Cambiar con contraseña actual
                    </button>
                    <button class="btn" style="background: var(--accent-purple); color: #fff; padding: 12px;" onclick="recuperarPasswordCajaPorEmail()">
                        <i class="fas fa-envelope me-2"></i>Recuperar por email
                    </button>
                    <button class="btn" style="background: var(--accent-red); color: #fff; padding: 12px;" onclick="eliminarPasswordCaja()">
                        <i class="fas fa-trash me-2"></i>Eliminar contraseña
                    </button>
                    <button class="btn" style="background: var(--bg-hover); color: var(--text-secondary); padding: 12px;" onclick="cerrarModalCaja()">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                </div>
            `;
            modal.style.display = 'block';
        }
        
        function cerrarModalCaja() {
            const modal = document.getElementById('cajaPasswordModal');
            if (modal) modal.style.display = 'none';
        }
        
        function cambiarPasswordCajaConActual() {
            document.getElementById('cajaPasswordContent').innerHTML = `
                <p class="text-secondary mb-3">Ingresa tu contraseña actual para cambiarla:</p>
                <div class="mb-3">
                    <label class="form-label text-secondary">Contraseña actual</label>
                    <input type="password" id="cajaCurrentPass" class="form-control form-control-dark" placeholder="••••••">
                </div>
                <div class="mb-3">
                    <label class="form-label text-secondary">Nueva contraseña</label>
                    <input type="password" id="cajaNewPass" class="form-control form-control-dark" placeholder="Mínimo 4 caracteres">
                </div>
                <div class="mb-4">
                    <label class="form-label text-secondary">Confirmar nueva contraseña</label>
                    <input type="password" id="cajaConfirmPass" class="form-control form-control-dark" placeholder="••••••">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn flex-grow-1" style="background: var(--accent-green); color: #000;" onclick="confirmarCambioPasswordCaja()">
                        <i class="fas fa-check me-2"></i>Cambiar
                    </button>
                    <button class="btn" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="mostrarModalConfigCaja()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            `;
        }
        
        async function confirmarCambioPasswordCaja() {
            const current = document.getElementById('cajaCurrentPass').value;
            const newPass = document.getElementById('cajaNewPass').value;
            const confirm = document.getElementById('cajaConfirmPass').value;
            
            if (!current) {
                showToast('❌ Ingresa tu contraseña actual', 3000);
                return;
            }
            if (!newPass || newPass.length < 4) {
                showToast('❌ La nueva contraseña debe tener al menos 4 caracteres', 3000);
                return;
            }
            if (newPass !== confirm) {
                showToast('❌ Las contraseñas no coinciden', 3000);
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/cambiar-password-caja', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUser?.id,
                        currentPassword: current,
                        newPassword: newPass
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ ' + t('contraseniaCajaActualizada'), 3000);
                    cerrarModalCaja();
                } else {
                    showToast('❌ ' + (data.error || 'Contraseña actual incorrecta'), 3000);
                }
            } catch (e) {
                showToast('❌ Error de conexión', 3000);
            }
        }
        
        async function recuperarPasswordCajaPorEmail() {
            document.getElementById('cajaPasswordContent').innerHTML = `
                <p class="text-secondary mb-3">Se enviará un código de verificación a tu email registrado.</p>
                <p class="mb-4"><strong>Email:</strong> ${currentUser?.email || 'No configurado'}</p>
                <button class="btn w-100 mb-3" style="background: var(--accent-cyan); color: #000; padding: 12px;" onclick="enviarCodigoRecuperacionCaja()">
                    <i class="fas fa-paper-plane me-2"></i>Enviar Código
                </button>
                <button class="btn w-100" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="mostrarModalConfigCaja()">
                    <i class="fas fa-arrow-left me-2"></i>Volver
                </button>
            `;
        }
        
        async function enviarCodigoRecuperacionCaja() {
            // Mostrar loading
            document.getElementById('cajaPasswordContent').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: var(--accent-purple);"></i>
                    <p class="text-secondary">Enviando código a tu email...</p>
                </div>
            `;
            
            try {
                const res = await fetch(API_URL + '/api/caja-password-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser?.id })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ Código enviado a tu email', 3000);
                    document.getElementById('cajaPasswordContent').innerHTML = `
                        <p class="text-secondary mb-3">Ingresa el código de 6 dígitos enviado a tu email:</p>
                        <div class="mb-3">
                            <input type="text" id="cajaResetCode" class="form-control form-control-dark text-center" placeholder="000000" maxlength="6" style="font-size: 1.5rem; letter-spacing: 8px;">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Nueva contraseña</label>
                            <input type="password" id="cajaNewPassReset" class="form-control form-control-dark" placeholder="Mínimo 4 caracteres">
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-secondary">Confirmar contraseña</label>
                            <input type="password" id="cajaConfirmPassReset" class="form-control form-control-dark" placeholder="••••••">
                        </div>
                        <button class="btn w-100 mb-3" style="background: var(--accent-green); color: #000; padding: 12px;" onclick="confirmarResetPasswordCaja()">
                            <i class="fas fa-check me-2"></i>Restablecer Contraseña
                        </button>
                        <div class="d-flex justify-content-between">
                            <a href="#" onclick="mostrarModalConfigCaja(); return false;" style="color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-arrow-left me-1"></i>Volver
                            </a>
                            <a href="#" onclick="reenviarCodigoCaja(); return false;" style="color: var(--accent-cyan); font-size: 0.85rem;">
                                <i class="fas fa-redo me-1"></i>Reenviar código
                            </a>
                        </div>
                    `;
                } else {
                    showToast('❌ ' + (data.error || 'No se pudo enviar el código'), 3000);
                    recuperarPasswordCajaPorEmail();
                }
            } catch (e) {
                showToast('❌ Error de conexión', 3000);
                recuperarPasswordCajaPorEmail();
            }
        }
        
        async function reenviarCodigoCaja() {
            // Mostrar loading en el link
            const content = document.getElementById('cajaPasswordContent');
            const reenviarLink = content.querySelector('a[onclick*="reenviarCodigoCaja"]');
            if (reenviarLink) {
                reenviarLink.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';
            }
            
            try {
                const res = await fetch(API_URL + '/api/caja-password-reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser?.id })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ Código reenviado a tu email', 3000);
                } else {
                    showToast('❌ ' + (data.error || 'No se pudo reenviar'), 3000);
                }
            } catch (e) {
                showToast('❌ Error de conexión', 3000);
            }
            
            // Restaurar link
            if (reenviarLink) {
                reenviarLink.innerHTML = '<i class="fas fa-redo me-1"></i>Reenviar código';
            }
        }
        
        async function confirmarResetPasswordCaja() {
            const code = document.getElementById('cajaResetCode').value;
            const newPass = document.getElementById('cajaNewPassReset').value;
            const confirm = document.getElementById('cajaConfirmPassReset').value;
            
            if (!code || code.length !== 6) {
                showToast('❌ Ingresa el código de 6 dígitos', 3000);
                return;
            }
            if (!newPass || newPass.length < 4) {
                showToast('❌ La contraseña debe tener al menos 4 caracteres', 3000);
                return;
            }
            if (newPass !== confirm) {
                showToast('❌ Las contraseñas no coinciden', 3000);
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/caja-password-confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUser?.id,
                        code: code,
                        newPassword: newPass
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ Contraseña restablecida correctamente', 3000);
                    cerrarModalCaja();
                } else {
                    showToast('❌ ' + (data.error || 'Código incorrecto o expirado'), 3000);
                }
            } catch (e) {
                showToast('❌ Error de conexión', 3000);
            }
        }
        
        async function eliminarPasswordCaja() {
            document.getElementById('cajaPasswordContent').innerHTML = `
                <p class="text-secondary mb-3">Para eliminar la contraseña, ingresa tu contraseña actual:</p>
                <div class="mb-4">
                    <input type="password" id="cajaDeletePass" class="form-control form-control-dark" placeholder="Contraseña actual">
                </div>
                <div class="d-flex gap-2">
                    <button class="btn flex-grow-1" style="background: var(--accent-red); color: #fff;" onclick="confirmarEliminarPasswordCaja()">
                        <i class="fas fa-trash me-2"></i>Eliminar
                    </button>
                    <button class="btn" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="mostrarModalConfigCaja()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
            `;
        }
        
        async function confirmarEliminarPasswordCaja() {
            const password = document.getElementById('cajaDeletePass').value;
            
            if (!password) {
                showToast('❌ Ingresa tu contraseña', 3000);
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/eliminar-password-caja', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUser?.id,
                        password: password
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ ' + t('contraseniaCajaEliminada'), 3000);
                    cerrarModalCaja();
                } else {
                    showToast('❌ ' + (data.error || 'Contraseña incorrecta'), 3000);
                }
            } catch (e) {
                showToast('❌ Error de conexión', 3000);
            }
        }
        
        function crearNuevaPasswordCaja() {
            const password = prompt('🔐 Crea una contraseña para proteger la caja (mínimo 4 caracteres):');
            if (!password) return;
            
            if (password.length < 4) {
                showToast('❌ La contraseña debe tener al menos 4 caracteres', 3000);
                return;
            }
            
            const confirm = prompt('🔐 Confirma la contraseña:');
            if (password !== confirm) {
                showToast('❌ Las contraseñas no coinciden', 3000);
                return;
            }
            
            guardarPasswordCaja(password);
        }
        
        async function guardarPasswordCaja(password) {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/configurar-password-caja', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUser?.id,
                        password: password
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    showToast('✅ ' + t('contraseniaCajaConfigurada'), 3000);
                } else {
                    showToast('❌ Error: ' + (data.error || 'No se pudo configurar'), 3000);
                }
            } catch (e) {
                console.error('Error configurando contraseña:', e);
                showToast('❌ Error de conexión', 3000);
            }
        }
        
        // Resetear todas las cajas (para limpiar datos corruptos)
        async function resetearCajas() {
            if (!confirm('¿Resetear CAJAS y GASTOS? Esto eliminará todos los gastos y cajas guardados.')) return;
            try {
                const res = await fetch(API_URL + '/api/reset-todo', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser?.id })
                });
                const data = await res.json();
                if (data.success) {
                    showToast(`✅ Eliminados: ${data.cajasEliminadas} cajas, ${data.gastosEliminados} gastos`, 3000);
                    // Limpiar variables locales
                    cajasIniciales = {};
                    dineroAgregado = {};
                    gastos = [];
                    // Recargar
                    await cargarCajas();
                    await cargarGastos();
                    calcularCajaDelDia();
                    renderGastos();
                    updateStats();
                }
            } catch (e) {
                console.error('Error reseteando:', e);
                showToast('❌ Error al resetear', 3000);
            }
        }
        
        // Guardar dinero agregado en MongoDB
        async function guardarDineroAgregadoMongo(carteraId, fecha, valor) {
            try {
                await fetch(API_URL + '/api/dinero-agregado', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser?.id,
                        carteraId: carteraId,
                        fecha: fecha,
                        dineroAgregado: valor,
                        timezone: userTimezone
                    })
                });
            } catch (e) {
                console.error('Error guardando dinero agregado:', e);
            }
        }
        
        // Guardar caja del día en MongoDB
        async function guardarCajaMongo(carteraId, fecha, cajaInicial, cajaActual, cajaTotal, dineroHoy, cobros, prestamos, gastosVal) {
            try {
                await fetch(API_URL + '/api/caja', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser?.id,
                        carteraId: carteraId,
                        fecha: fecha,
                        cajaInicial: cajaInicial,
                        cajaActual: cajaActual,
                        cajaTotal: cajaTotal,
                        dineroAgregado: dineroHoy,
                        cobros: cobros,
                        prestamos: prestamos,
                        gastos: gastosVal,
                        timezone: userTimezone
                    })
                });
            } catch (e) {
                console.error('Error guardando caja:', e);
            }
        }
        
        // Cargar caja inicial desde MongoDB
        async function cargarCajaInicialMongo(carteraId) {
            try {
                const res = await fetch(API_URL + '/api/caja-inicial?userId=' + currentUser?.id + '&carteraId=' + (carteraId || 'todas') + '&timezone=' + encodeURIComponent(userTimezone));
                const data = await res.json();
                console.log('📦 Caja Inicial Response:', data);
                
                // Mostrar de dónde viene la caja inicial
                const sourceEl = document.getElementById('cajaInicialSource');
                if (sourceEl) {
                    if (data.source === 'primer_dia') {
                        sourceEl.textContent = '🆕 Inicio del negocio (día 1)';
                    } else if (data.source === 'mongodb') {
                        sourceEl.textContent = '✅ Guardado del ' + data.fecha;
                    } else if (data.source === 'calculado') {
                        sourceEl.textContent = '📊 Calculado del ' + data.fecha;
                    } else {
                        sourceEl.textContent = 'Total del día anterior';
                    }
                }
                
                if (data.success) {
                    return data.cajaInicial || 0;
                }
            } catch (e) {
                console.error('Error cargando caja inicial:', e);
            }
            return 0;
        }
        
        // Cargar dinero agregado desde MongoDB
        async function cargarDineroAgregadoMongo(carteraId, fecha) {
            try {
                const res = await fetch(API_URL + '/api/dinero-agregado?userId=' + currentUser?.id + '&carteraId=' + (carteraId || 'todas') + '&fecha=' + fecha);
                const data = await res.json();
                if (data.success) {
                    return data.dineroAgregado || 0;
                }
            } catch (e) {
                console.error('Error cargando dinero agregado:', e);
            }
            return 0;
        }
        
        // Limpiar cajas de días anteriores al primer día de actividad (solo una vez)
        let cajasLimpiadas = false;
        async function limpiarCajasAnteriores() {
            if (cajasLimpiadas || !currentUser?.id) return;
            cajasLimpiadas = true;
            try {
                await fetch(API_URL + '/api/limpiar-cajas-anteriores', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        carteraId: carteraActual || 'todas',
                        timezone: userTimezone
                    })
                });
            } catch (e) {
                console.error('Error limpiando cajas anteriores:', e);
            }
        }
        
        async function cargarCajas() {
            try {
                // Cargar dinero agregado desde MongoDB para la cartera actual
                await cargarTodoDineroAgregado();
                // Calcular la caja basándose en los datos
                calcularCajaDelDia();
            } catch (e) {
                console.error('Error cargando cajas:', e);
            }
        }
        
        // Cargar todo el dinero agregado desde MongoDB
        async function cargarTodoDineroAgregado() {
            try {
                const carteraKey = carteraActual || 'todas';
                const res = await fetch(API_URL + '/api/dinero-agregado-todo?userId=' + currentUser?.id + '&carteraId=' + carteraKey);
                const data = await res.json();
                if (data.success && data.registros) {
                    // Inicializar si no existe
                    if (!dineroAgregado[carteraKey]) dineroAgregado[carteraKey] = {};
                    // Cargar todos los registros
                    data.registros.forEach(r => {
                        if (r.fecha && r.dineroAgregado) {
                            dineroAgregado[carteraKey][r.fecha] = r.dineroAgregado;
                        }
                    });
                    console.log('💰 Dinero agregado cargado:', dineroAgregado[carteraKey]);
                }
            } catch (e) {
                console.error('Error cargando todo el dinero agregado:', e);
            }
        }
        
        function calcularCajaDelDia() {
            const carteraKey = carteraActual || 'todas';
            
            // Usar la fecha del dashboard si está seleccionada, sino usar hoy
            const fechaCalculo = dashboardFechaFiltro || getCurrentDateString();
            
            // Obtener clientes de la cartera actual
            const clientesCartera = getClientesFiltrados() || [];
            
            // ========== COBROS HASTA LA FECHA ==========
            let cobrosHastaFecha = 0;
            clientesCartera.forEach(c => {
                const todosPagos = [...(c.pagos || []), ...(c.historialPagos || [])];
                todosPagos.forEach(p => {
                    const fechaPago = (p.fecha || '').substring(0, 10);
                    if (fechaPago <= fechaCalculo && !p.esMicroseguro) {
                        const valor = parseFloat(p.valor) || parseFloat(p.monto) || 0;
                        if (valor > 0) {
                            cobrosHastaFecha += valor;
                        } else if (valor < 0) {
                            console.warn('⚠️ Pago con valor negativo encontrado:', { cliente: c.nombre, pago: p, valor });
                        }
                    }
                });
            });
            
            // ========== PRÉSTAMOS ENTREGADOS HASTA LA FECHA ==========
            let prestamosHastaFecha = 0;
            clientesCartera.filter(c => !c.renovado).forEach(c => {
                const fechaCreacion = (c.fechaCreacion || c.fechaInicio || '').substring(0, 10);
                if (fechaCreacion <= fechaCalculo) {
                    const monto = parseFloat(c.montoTotal) || 0;
                    if (monto > 0) { // Solo valores positivos
                        prestamosHastaFecha += monto;
                    }
                }
            });
            
            // ========== GASTOS HASTA LA FECHA ==========
            let gastosHastaFecha = 0;
            const gastosCartera = getGastosFiltrados() || [];
            gastosCartera.forEach(g => {
                const fechaGasto = (g.fecha || '').substring(0, 10);
                if (fechaGasto <= fechaCalculo) {
                    const valor = parseFloat(g.valor) || parseFloat(g.monto) || 0;
                    if (valor > 0) { // Solo valores positivos
                        gastosHastaFecha += valor;
                    }
                }
            });
            
            // ========== DINERO AGREGADO HASTA LA FECHA ==========
            let dineroAgregadoHastaFecha = 0;
            if (dineroAgregado[carteraKey]) {
                Object.keys(dineroAgregado[carteraKey]).forEach(fecha => {
                    if (fecha <= fechaCalculo) {
                        dineroAgregadoHastaFecha += dineroAgregado[carteraKey][fecha] || 0;
                    }
                });
            }
            
            // ========== CAPITAL PENDIENTE ==========
            let capitalPendiente = 0;
            clientesCartera.forEach(c => {
                if (esEstadoActivo(c.estado)) {
                    const totalAPagar = parseFloat(c.totalAPagar) || 0;
                    const montoPagado = parseFloat(c.montoPagado) || 0;
                    capitalPendiente += Math.max(0, totalAPagar - montoPagado);
                }
            });
            
            // ========== CÁLCULOS FINALES ==========
            // Caja Actual = Dinero agregado + Cobros - Préstamos entregados - Gastos
            // Representa el dinero físico que tienes en mano AHORA
            let cajaActual = dineroAgregadoHastaFecha + cobrosHastaFecha - prestamosHastaFecha - gastosHastaFecha;
            
            // AJUSTE: Si no hay dinero agregado y la caja es negativa, pero todos los clientes están finalizados
            // significa que los gastos superan las ganancias. En este caso, mostrar la ganancia neta.
            if (dineroAgregadoHastaFecha === 0 && cajaActual < 0) {
                const clientesActivos = clientesCartera.filter(c => esEstadoActivo(c.estado));
                // Si no hay clientes activos (todos finalizados), mostrar ganancia neta
                if (clientesActivos.length === 0) {
                    const gananciaNeta = cobrosHastaFecha - prestamosHastaFecha;
                    // Si la ganancia es positiva pero los gastos la hacen negativa, mostrar 0
                    if (gananciaNeta > 0 && gananciaNeta < gastosHastaFecha) {
                        cajaActual = 0;
                    } else if (gananciaNeta > 0) {
                        cajaActual = gananciaNeta - gastosHastaFecha;
                    }
                }
            }
            
            // Caja Total = Caja Actual + Capital pendiente por cobrar
            // Representa cuánto dinero tendrás cuando cobres todo lo pendiente
            const cajaTotal = cajaActual + capitalPendiente;
            
            // Para la Caja Inicial, calculamos lo mismo pero hasta AYER
            const fechaCalculoDate = new Date(fechaCalculo + 'T12:00:00');
            const ayer = new Date(fechaCalculoDate);
            ayer.setDate(ayer.getDate() - 1);
            const ayerStr = ayer.getFullYear() + '-' + String(ayer.getMonth() + 1).padStart(2, '0') + '-' + String(ayer.getDate()).padStart(2, '0');
            
            // Buscar primer día de actividad (solo fechas válidas desde 2024)
            let primerDia = null;
            clientesCartera.forEach(c => {
                const fechaCreacion = (c.fechaCreacion || c.fechaInicio || '').substring(0, 10);
                // Solo considerar fechas válidas (año 2024 o posterior)
                if (fechaCreacion && fechaCreacion >= '2024-01-01') {
                    if (!primerDia || fechaCreacion < primerDia) {
                        primerDia = fechaCreacion;
                    }
                }
            });
            
            let cajaInicial = 0;
            // Si ayer es anterior al primer día de actividad, inicial = 0
            if (!primerDia || ayerStr < primerDia) {
                cajaInicial = 0;
            } else {
                // Calcular caja total de ayer
                let cobrosHastaAyer = 0;
                clientesCartera.forEach(c => {
                    const todosPagos = [...(c.pagos || []), ...(c.historialPagos || [])];
                    todosPagos.forEach(p => {
                        const fechaPago = (p.fecha || '').substring(0, 10);
                        if (fechaPago <= ayerStr && !p.esMicroseguro) {
                            const valor = parseFloat(p.valor) || parseFloat(p.monto) || 0;
                            if (valor > 0) cobrosHastaAyer += valor;
                        }
                    });
                });
                
                let prestamosHastaAyer = 0;
                clientesCartera.filter(c => !c.renovado).forEach(c => {
                    const fechaCreacion = (c.fechaCreacion || c.fechaInicio || '').substring(0, 10);
                    if (fechaCreacion <= ayerStr) {
                        const monto = parseFloat(c.montoTotal) || 0;
                        if (monto > 0) prestamosHastaAyer += monto;
                    }
                });
                
                let gastosHastaAyer = 0;
                gastosCartera.forEach(g => {
                    const fechaGasto = (g.fecha || '').substring(0, 10);
                    if (fechaGasto <= ayerStr) {
                        const valor = parseFloat(g.valor) || parseFloat(g.monto) || 0;
                        if (valor > 0) gastosHastaAyer += valor;
                    }
                });
                
                let dineroHastaAyer = 0;
                if (dineroAgregado[carteraKey]) {
                    Object.keys(dineroAgregado[carteraKey]).forEach(fecha => {
                        if (fecha <= ayerStr) {
                            const valor = dineroAgregado[carteraKey][fecha] || 0;
                            if (valor > 0) dineroHastaAyer += valor;
                        }
                    });
                }
                
                const cajaActualAyer = dineroHastaAyer + cobrosHastaAyer - prestamosHastaAyer - gastosHastaAyer;
                // Caja Inicial = Caja Actual de ayer (dinero físico, sin capital pendiente)
                // Si no hay dinero agregado y es negativo, ajustar a 0
                cajaInicial = (dineroHastaAyer === 0 && cajaActualAyer < 0) ? 0 : cajaActualAyer;
            }
            
            // ========== ACTUALIZAR UI ==========
            const cajaInicialEl = document.getElementById('cajaInicialValue');
            if (cajaInicialEl) {
                cajaInicialEl.textContent = 'R$ ' + cajaInicial.toFixed(2);
                cajaInicialEl.style.color = cajaInicial >= 0 ? 'var(--accent-purple)' : 'var(--accent-red)';
            }
            
            const sourceEl = document.getElementById('cajaInicialSource');
            if (sourceEl) {
                if (!primerDia || ayerStr < primerDia) {
                    sourceEl.textContent = '🆕 Primer día de actividad';
                } else {
                    sourceEl.textContent = 'Total del ' + ayerStr;
                }
            }
            
            const cajaActualEl = document.getElementById('cajaActualValue');
            if (cajaActualEl) {
                cajaActualEl.textContent = 'R$ ' + cajaActual.toFixed(2);
                cajaActualEl.style.color = cajaActual >= 0 ? 'var(--accent-cyan)' : 'var(--accent-red)';
            }
            
            const cajaTotalEl = document.getElementById('cajaTotalValue');
            if (cajaTotalEl) {
                cajaTotalEl.textContent = 'R$ ' + cajaTotal.toFixed(2);
                cajaTotalEl.style.color = cajaTotal >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            
            // Log para debug
            console.log('📊 Caja calculada:', {
                cartera: carteraActual,
                fecha: fechaCalculo,
                clientesEnCartera: clientesCartera.length,
                primerDia,
                cajaInicial,
                cobros: cobrosHastaFecha,
                prestamos: prestamosHastaFecha,
                gastos: gastosHastaFecha,
                dineroAgregado: dineroAgregadoHastaFecha,
                cajaActual,
                capitalPendiente,
                cajaTotal
            });
        }
        
        function actualizarCajaTotal(totalCobrado, totalGastos, totalPrestado) {
            calcularCajaDelDia();
        }
        
        // Alias para compatibilidad
        async function cargarCajaInicial() {
            await cargarCajas();
        }
        // ========== FIN FUNCIONES DE CAJA ==========
        
        // Ya no se requiere verificar caja inicial manual
        function verificarCajaInicialDelDia() {
            return true; // Siempre permitir, la caja es automática
        }
        
        function renderClientesAtrasados() {
            try {
                const container = document.getElementById('clientesAtrasadosPreview');
                if (!container) return;
            
            // Filtrar por cartera actual
            const clientesCartera = getClientesFiltrados() || [];
            
            const ahora = getCurrentDate();
            ahora.setHours(0, 0, 0, 0);
            
            const atrasados = clientesCartera.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                if ((c.montoPagado || 0) >= (c.totalAPagar || 0)) return false;
                
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return false;
                
                // Usar la función que considera la hora de registro (regla de las 12 PM)
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                
                // Está atrasado si los días de pago son mayores que las parcelas pagas
                return diasDePago > parcelasPagas;
            });
            
            // Ordenar por fecha más reciente primero
            atrasados.sort((a, b) => {
                const fechaA = new Date(a.fechaCreacion || a.fechaInicio || 0);
                const fechaB = new Date(b.fechaCreacion || b.fechaInicio || 0);
                return fechaB - fechaA;
            });
            
            // Mostrar máximo 10
            const atrasadosMostrar = atrasados.slice(0, 10);
            
            if (atrasadosMostrar.length === 0) {
                container.innerHTML = '<p class="text-center" style="color: var(--accent-green);"><i class="fas fa-check-circle me-2"></i>Sin clientes atrasados</p>';
                return;
            }
            
            container.innerHTML = atrasadosMostrar.map(c => {
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                const diasAtraso = Math.max(0, diasDePago - parcelasPagas);
                const valorParcela = c.valorParcela || 0;
                const debeHoy = diasAtraso * valorParcela; // Lo que debería haber pagado hasta hoy
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                
                // Calcular fecha de finalización estimada
                const fechaInicio = new Date(fechaStr);
                let primerPago = new Date(fechaInicio.getTime());
                if (fechaInicio.getHours() >= 12) {
                    primerPago.setDate(primerPago.getDate() + 1);
                }
                const parcelasRestantes = (c.numeroParcelas || 0) - parcelasPagas;
                const fechaFinalizacion = new Date(primerPago.getTime());
                fechaFinalizacion.setDate(fechaFinalizacion.getDate() + (c.numeroParcelas || 0) - 1);
                const fechaFinStr = fechaFinalizacion.toLocaleDateString();
                
                return `
                <div class="mb-3 pb-2" style="border-bottom: 1px solid var(--border-color);">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="font-weight: 600; color: var(--text-primary);">${c.nombre}</div>
                        <span class="badge" style="background: var(--accent-red); color: #fff;">${diasAtraso} día${diasAtraso !== 1 ? 's' : ''}</span>
                    </div>
                    <div class="d-flex justify-content-between mt-1" style="font-size: 0.85rem;">
                        <span class="text-secondary">Prestado:</span>
                        <span style="color: var(--accent-cyan);">R$ ${(c.montoTotal || 0).toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between" style="font-size: 0.85rem;">
                        <span class="text-secondary">Parcelas:</span>
                        <span>${parcelasPagas}/${c.numeroParcelas || 0}</span>
                    </div>
                    <div class="d-flex justify-content-between" style="font-size: 0.85rem;">
                        <span class="text-secondary">Debe hoy:</span>
                        <span style="color: var(--accent-yellow); font-weight: 600;">R$ ${debeHoy.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between" style="font-size: 0.85rem;">
                        <span class="text-secondary">Total restante:</span>
                        <span style="color: var(--accent-red); font-weight: 600;">R$ ${restante.toFixed(2)}</span>
                    </div>
                    <div class="d-flex justify-content-between" style="font-size: 0.85rem;">
                        <span class="text-secondary">Finaliza:</span>
                        <span style="color: var(--accent-purple);">${fechaFinStr}</span>
                    </div>
                </div>
            `}).join('');
            } catch (e) {
                console.error('Error en renderClientesAtrasados:', e);
            }
        }
        
        function renderMejoresClientes() {
            try {
                const container = document.getElementById('mejoresClientesPreview');
                if (!container) return;
                
                // Filtrar por cartera actual
                const clientesCartera = getClientesFiltrados() || [];
            
            // Solo clientes que han pagado algo (montoPagado > 0)
            const buenos = clientesCartera.filter(c => (c.montoPagado || 0) > 0)
                .sort((a, b) => (b.montoPagado || 0) - (a.montoPagado || 0))
                .slice(0, 5);
            
            if (buenos.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary">Sin datos aún</p>';
                return;
            }
            
            container.innerHTML = buenos.map((c, i) => {
                const renovaciones = c.renovaciones || 0;
                return `
                <div class="d-flex justify-content-between align-items-center mb-2 pb-2" style="border-bottom: 1px solid var(--border-color);">
                    <div class="d-flex align-items-center">
                        <span style="color: ${i === 0 ? '#FFD700' : i === 1 ? '#C0C0C0' : i === 2 ? '#CD7F32' : 'var(--text-secondary)'}; margin-right: 10px;">
                            ${i < 3 ? '<i class="fas fa-medal"></i>' : (i + 1) + '.'}
                        </span>
                        <div>
                            <span>${c.nombre}</span>
                            ${renovaciones > 0 ? `<br><small style="color: var(--accent-purple);">🔄 ${renovaciones}x renovado</small>` : ''}
                        </div>
                    </div>
                    <span style="color: var(--accent-green); font-weight: bold;">R$ ${(c.montoPagado || 0).toFixed(2)}</span>
                </div>
            `}).join('');
            } catch (e) {
                console.error('Error en renderMejoresClientes:', e);
            }
        }
        
        async function renderResumenSemana() {
            try {
                const hoy = getCurrentDate();
                // Calcular inicio de la semana (lunes)
                const diaSemana = hoy.getDay();
                const diasDesdelunes = diaSemana === 0 ? 6 : diaSemana - 1;
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - diasDesdelunes);
                inicioSemana.setHours(0, 0, 0, 0);
                
                // Filtrar por cartera actual y excluir renovados
                let clientesParaResumen = (getClientesFiltrados() || []).filter(c => !c.renovado);
            
            // Si es admin, obtener TODOS los clientes de todos los trabajadores (pero filtrar por cartera)
            if (currentUser && (currentUser.role === 'admin' || currentUser.isAdmin)) {
                try {
                    const res = await fetch(API_URL + '/api/clientes?userId=admin');
                    const todosClientes = await res.json();
                    // Filtrar por cartera actual y excluir renovados
                    if (carteraActual !== null && carteras.length > 0) {
                        clientesParaResumen = todosClientes.filter(c => c.carteraId === carteraActual && !c.renovado);
                    } else {
                        clientesParaResumen = [];
                    }
                } catch (e) {
                    console.log('Error cargando clientes para resumen:', e);
                }
            }
            
            // Clientes nuevos esta semana (por fecha de creación)
            const clientesSemana = clientesParaResumen.filter(c => {
                const fecha = new Date(c.fechaInicio || c.fechaCreacion || c.createdAt);
                return fecha >= inicioSemana && !isNaN(fecha.getTime());
            });
            
            // Total prestado esta semana
            const prestamosSemana = clientesSemana.reduce((s, c) => s + (c.montoTotal || 0), 0);
            
            // Total cobrado esta semana (de todos los clientes, no solo los nuevos)
            const cobrosSemana = clientesParaResumen.reduce((s, c) => {
                // Buscar en ambos arrays: pagos (nuevo) y historialPagos (legacy)
                const todosPagos = [...(c.pagos || []), ...(c.historialPagos || [])];
                const pagosSemana = todosPagos.filter(p => {
                    const fechaPago = new Date(p.fecha);
                    return fechaPago >= inicioSemana && !isNaN(fechaPago.getTime());
                });
                return s + pagosSemana.reduce((ps, p) => ps + (p.valor || p.monto || 0), 0);
            }, 0);
            
            // Ganancia estimada = Total a Pagar - Total prestado (la Comisión/interés)
            const gananciaEstimada = clientesSemana.reduce((s, c) => {
                const totalAPagar = c.totalAPagar || 0;
                const montoTotal = c.montoTotal || 0;
                return s + (totalAPagar - montoTotal);
            }, 0);
            
            const el1 = document.getElementById('semanaNuevosClientes');
            const el2 = document.getElementById('semanaPrestamos');
            const el3 = document.getElementById('semanaCobros');
            const el4 = document.getElementById('semanaGanancia');
            
            if (el1) el1.textContent = clientesSemana.length;
            if (el2) el2.textContent = 'R$ ' + prestamosSemana.toFixed(2);
            if (el3) el3.textContent = 'R$ ' + cobrosSemana.toFixed(2);
            if (el4) {
                el4.textContent = 'R$ ' + gananciaEstimada.toFixed(2);
                el4.style.color = gananciaEstimada >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
            } catch (e) {
                console.error('Error en renderResumenSemana:', e);
            }
        }
        
        // Alias para compatibilidad
        function renderResumenMes() {
            renderResumenSemana();
        }
        
        function renderActividadReciente() {
            try {
                const container = document.getElementById('actividadReciente');
                if (!container) return;
                
                // Obtener búsqueda
                const busqueda = (document.getElementById('buscarActividad')?.value || '').toLowerCase().trim();
                
                // Filtrar por cartera actual
            const clientesCartera = getClientesFiltrados();
            
            const actividades = [];
            
            // Recopilar pagos recientes (de ambos arrays: pagos y historialPagos)
            clientesCartera.forEach(c => {
                const todosPagos = [...(c.pagos || []), ...(c.historialPagos || [])];
                const totalAPagar = parseFloat(c.totalAPagar) || 0;
                
                // Ordenar pagos por fecha para calcular acumulado correctamente
                const pagosOrdenados = todosPagos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                
                let acumulado = 0;
                pagosOrdenados.forEach(p => {
                    const montoPago = parseFloat(p.valor || p.monto || 0);
                    const acumuladoAntes = acumulado;
                    acumulado += montoPago;
                    
                    // Verificar si este pago saldó la deuda (acumulado >= total Y antes no estaba saldada)
                    const esPagoFinal = totalAPagar > 0 && acumulado >= totalAPagar && acumuladoAntes < totalAPagar;
                    
                    actividades.push({
                        tipo: esPagoFinal ? 'deuda_saldada' : 'pago',
                        cliente: c.nombre,
                        monto: montoPago,
                        fecha: new Date(p.fecha),
                        icon: esPagoFinal ? 'fa-check-circle' : 'fa-money-bill-wave',
                        color: esPagoFinal ? 'var(--accent-purple)' : 'var(--accent-green)'
                    });
                });
                
                // Agregar creación de cliente
                if (c.fechaInicio || c.createdAt) {
                    actividades.push({
                        tipo: 'nuevo',
                        cliente: c.nombre,
                        monto: c.montoTotal,
                        fecha: new Date(c.fechaInicio || c.createdAt),
                        icon: 'fa-user-plus',
                        color: 'var(--accent-cyan)'
                    });
                }
            });
            
            // Ordenar por fecha descendente
            actividades.sort((a, b) => b.fecha - a.fecha);
            
            // Filtrar por búsqueda si hay
            let recientes = actividades;
            if (busqueda) {
                recientes = actividades.filter(a => a.cliente.toLowerCase().includes(busqueda));
            }
            
            // Mostrar hasta 20 actividades
            recientes = recientes.slice(0, 20);
            
            if (recientes.length === 0) {
                container.innerHTML = `<p class="text-center text-secondary">${busqueda ? 'No se encontró actividad para ese cliente' : 'Sin actividad reciente'}</p>`;
                return;
            }
            
            container.innerHTML = recientes.map(a => {
                const fechaStr = a.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' });
                let tipoTexto = 'Pago recibido';
                if (a.tipo === 'deuda_saldada') tipoTexto = '✅ Deuda saldada';
                else if (a.tipo === 'nuevo') tipoTexto = 'Nuevo préstamo';
                
                return `
                    <div class="d-flex align-items-center mb-2 pb-2" style="border-bottom: 1px solid var(--border-color);">
                        <div style="width: 35px; height: 35px; border-radius: 50%; background: ${a.color}20; display: flex; align-items: center; justify-content: center; margin-right: 12px;">
                            <i class="fas ${a.icon}" style="color: ${a.color};"></i>
                        </div>
                        <div style="flex: 1;">
                            <div style="font-size: 0.9rem;">${tipoTexto} - <strong>${a.cliente}</strong></div>
                            <small class="text-secondary">${fechaStr}</small>
                        </div>
                        <span style="color: ${a.color}; font-weight: bold;">R$ ${(a.monto || 0).toFixed(2)}</span>
                    </div>
                `;
            }).join('');
            } catch (e) {
                console.error('Error en renderActividadReciente:', e);
            }
        }
        
        function resetChartDates() {
            document.getElementById('chartFechaInicio').value = '';
            document.getElementById('chartFechaFin').value = '';
            renderChart();
        }
        
        // Función para establecer rango de fechas rápido
        function setChartRange(range) {
            const hoy = getCurrentDate();
            let fechaInicio = new Date(hoy);
            let fechaFin = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23, 59, 59);
            
            // Actualizar botones activos
            document.querySelectorAll('.chart-range-btn').forEach(btn => {
                btn.classList.remove('active');
                // Marcar el botón correcto basado en el rango
                if (btn.textContent.trim() === '1s' && range === '1w') btn.classList.add('active');
                if (btn.textContent.trim() === '1m' && range === '1m') btn.classList.add('active');
                if (btn.textContent.trim() === '3m' && range === '3m') btn.classList.add('active');
                if (btn.textContent.trim() === '6m' && range === '6m') btn.classList.add('active');
                if (btn.textContent.trim() === '1a' && range === '1y') btn.classList.add('active');
                if (btn.textContent.trim() === 'Todo' && range === 'all') btn.classList.add('active');
            });
            
            // Desde el PASADO hasta HOY (datos reales)
            switch(range) {
                case '1w': // última semana
                    fechaInicio.setDate(hoy.getDate() - 7);
                    break;
                case '1m': // último mes
                    fechaInicio.setMonth(hoy.getMonth() - 1);
                    break;
                case '3m': // últimos 3 meses
                    fechaInicio.setMonth(hoy.getMonth() - 3);
                    break;
                case '6m': // últimos 6 meses
                    fechaInicio.setMonth(hoy.getMonth() - 6);
                    break;
                case '1y': // último año
                    fechaInicio.setFullYear(hoy.getFullYear() - 1);
                    break;
                case 'all': // Todo - desde el primer dato REAL hasta hoy
                    let fechaMasAntigua = new Date(hoy);
                    let hayDatos = false;
                    
                    if (clientes && clientes.length > 0) {
                        clientes.forEach(c => {
                            // Solo considerar clientes con montoTotal > 0
                            if (parseFloat(c.montoTotal) > 0) {
                                const fechaCliente = new Date(c.fechaInicio || c.fechaRegistro || c.fechaCreacion || c.createdAt);
                                if (!isNaN(fechaCliente.getTime()) && fechaCliente < fechaMasAntigua) {
                                    fechaMasAntigua = new Date(fechaCliente);
                                    hayDatos = true;
                                }
                            }
                            
                            // Buscar fecha del primer pago real
                            if (c.pagos && c.pagos.length > 0) {
                                c.pagos.forEach(p => {
                                    if (parseFloat(p.valor) > 0) {
                                        const fechaPago = new Date(p.fecha);
                                        if (!isNaN(fechaPago.getTime()) && fechaPago < fechaMasAntigua) {
                                            fechaMasAntigua = new Date(fechaPago);
                                            hayDatos = true;
                                        }
                                    }
                                });
                            }
                        });
                    }
                    
                    // Si no hay datos, mostrar solo hoy
                    if (!hayDatos) {
                        fechaMasAntigua = new Date(hoy);
                    }
                    
                    fechaInicio = fechaMasAntigua;
                    break;
            }
            
            // Formato local sin problemas de zona horaria
            const formatDate = (d) => {
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
            };
            
            document.getElementById('chartFechaInicio').value = formatDate(fechaInicio);
            document.getElementById('chartFechaFin').value = formatDate(fechaFin);
            renderChart();
        }
        
        function renderChart() {
            try {
                const canvas = document.getElementById('mainChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                if (mainChart) mainChart.destroy();
                
                // Obtener clientes de la cartera actual
                const clientesCartera = getClientesFiltrados() || [];
                
                // Si no hay clientes, mostrar mensaje
                if (clientesCartera.length === 0) {
                    canvas.style.display = 'none';
                    const msgContainer = document.getElementById('chartNoDataMsg');
                    if (msgContainer) {
                        msgContainer.style.display = 'block';
                        msgContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px;">
                                <i class="fas fa-chart-line fa-3x mb-3" style="color: var(--accent-cyan); opacity: 0.5;"></i>
                                <h5 style="color: var(--text-secondary);">Sin datos para mostrar</h5>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Los gráficos aparecerán cuando haya clientes y transacciones registradas.
                                </p>
                            </div>
                        `;
                    }
                    const navContainer = document.getElementById('chartNavContainer');
                    if (navContainer) navContainer.style.display = 'none';
                    return;
                }
                
                // Mostrar canvas y ocultar mensaje
                canvas.style.display = 'block';
                const msgContainer = document.getElementById('chartNoDataMsg');
                if (msgContainer) msgContainer.style.display = 'none';
                
                // Mostrar navegador si estaba oculto
                const navContainer = document.getElementById('chartNavContainer');
                if (navContainer) navContainer.style.display = 'block';
                
                // Recopilar TODOS los eventos con fechas reales
                const eventos = [];
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                
                clientesCartera.forEach(c => {
                    // Préstamo realizado
                    if (parseFloat(c.montoTotal) > 0) {
                        const fechaStr = c.fechaInicio || c.fechaRegistro || c.fechaCreacion || c.fecha || c.createdAt;
                        if (fechaStr) {
                            // Normalizar la fecha para evitar problemas de zona horaria
                            let fecha;
                            if (typeof fechaStr === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(fechaStr)) {
                                fecha = new Date(fechaStr + 'T12:00:00');
                            } else {
                                fecha = new Date(fechaStr);
                            }
                            if (!isNaN(fecha.getTime())) {
                                eventos.push({
                                    fecha: fecha,
                                    tipo: 'prestamo',
                                    valor: parseFloat(c.montoTotal) || 0
                                });
                            }
                        }
                    }
                    
                    // Pagos/Cobros realizados
                    if (c.pagos && c.pagos.length > 0) {
                        c.pagos.forEach(p => {
                            if (parseFloat(p.valor) > 0) {
                                let fecha;
                                if (typeof p.fecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(p.fecha)) {
                                    fecha = new Date(p.fecha + 'T12:00:00');
                                } else {
                                    fecha = new Date(p.fecha);
                                }
                                if (!isNaN(fecha.getTime())) {
                                    eventos.push({
                                        fecha: fecha,
                                        tipo: 'cobro',
                                        valor: parseFloat(p.valor) || 0
                                    });
                                }
                            }
                        });
                    }
                });
                
                // Si no hay eventos, mostrar mensaje
                if (eventos.length === 0) {
                    canvas.style.display = 'none';
                    const msgContainer = document.getElementById('chartNoDataMsg');
                    if (msgContainer) {
                        msgContainer.style.display = 'block';
                        msgContainer.innerHTML = `
                            <div style="text-align: center; padding: 40px 20px;">
                                <i class="fas fa-chart-line fa-3x mb-3" style="color: var(--accent-cyan); opacity: 0.5;"></i>
                                <h5 style="color: var(--text-secondary);">Sin datos para mostrar</h5>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Registra préstamos y cobros para ver el gráfico.
                                </p>
                            </div>
                        `;
                    }
                    const navContainer = document.getElementById('chartNavContainer');
                    if (navContainer) navContainer.style.display = 'none';
                    return;
                }
                
                // Ordenar eventos por fecha
                eventos.sort((a, b) => a.fecha - b.fecha);
                
                // Agrupar por día y acumular
                const datosPorDia = {};
                let cobradoAcum = 0;
                let prestadoAcum = 0;
                
                eventos.forEach(e => {
                    const key = e.fecha.toISOString().split('T')[0];
                    if (!datosPorDia[key]) {
                        datosPorDia[key] = { cobrado: 0, prestado: 0, fecha: e.fecha };
                    }
                    if (e.tipo === 'cobro') {
                        datosPorDia[key].cobrado += e.valor;
                } else {
                    datosPorDia[key].prestado += e.valor;
                }
            });
            
            // Convertir a arrays para el gráfico
            const labels = [];
            const datosCobrado = [];
            const datosPrestado = [];
            
            // Ordenar las fechas
            const fechasOrdenadas = Object.keys(datosPorDia).sort();
            
            // Si hay datos, incluir desde el día anterior al primer dato hasta hoy
            if (fechasOrdenadas.length > 0) {
                const primeraFecha = new Date(fechasOrdenadas[0] + 'T12:00:00');
                const hoy = getCurrentDate();
                hoy.setHours(12, 0, 0, 0);
                
                // Empezar desde un día antes del primer dato (para mostrar la subida desde 0)
                let current = new Date(primeraFecha);
                current.setDate(current.getDate() - 1);
                
                while (current <= hoy) {
                    const key = `${current.getFullYear()}-${String(current.getMonth() + 1).padStart(2, '0')}-${String(current.getDate()).padStart(2, '0')}`;
                    labels.push(current.getDate() + ' ' + meses[current.getMonth()]);
                    
                    if (datosPorDia[key]) {
                        // Día con datos
                        datosCobrado.push(datosPorDia[key].cobrado);
                        datosPrestado.push(datosPorDia[key].prestado);
                    } else {
                        // Día sin datos = 0 (crea la bajada/subida)
                        datosCobrado.push(0);
                        datosPrestado.push(0);
                    }
                    
                    current.setDate(current.getDate() + 1);
                }
            }
            
            // Actualizar inputs de fecha
            const inputInicio = document.getElementById('chartFechaInicio');
            const inputFin = document.getElementById('chartFechaFin');
            if (fechasOrdenadas.length > 0) {
                inputInicio.value = fechasOrdenadas[0];
                inputFin.value = fechasOrdenadas[fechasOrdenadas.length - 1];
            }
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cobrado',
                        data: datosCobrado,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#00d4ff',
                        pointHoverBackgroundColor: '#00d4ff',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }, {
                        label: 'Prestado',
                        data: datosPrestado,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#e74c3c',
                        pointHoverBackgroundColor: '#e74c3c',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: { 
                        legend: { 
                            position: 'top',
                            align: 'center',
                            labels: { 
                                color: '#8892b0',
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: { size: 12 }
                            } 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26,26,46,0.95)',
                            titleColor: '#fff',
                            bodyColor: '#8892b0',
                            borderColor: '#2d2d44',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': R$ ' + context.parsed.y.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { 
                                color: 'rgba(45,45,68,0.3)', 
                                drawBorder: false,
                                tickLength: 0
                            }, 
                            ticks: { 
                                color: '#6b7280', 
                                maxRotation: 0,
                                font: { size: 10 },
                                maxTicksLimit: 10
                            } 
                        },
                        y: { 
                            position: 'left',
                            grid: { 
                                color: 'rgba(45,45,68,0.3)', 
                                drawBorder: false 
                            }, 
                            ticks: { 
                                color: '#6b7280',
                                font: { size: 10 },
                                callback: function(value) {
                                    if (value >= 1000) {
                                        return 'R$ ' + (value/1000).toFixed(0) + 'k';
                                    }
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            },
                            beginAtZero: true
                        }
                    }
                }
            });
            
            // Crear mini gráfico de navegación
            renderMiniChart(datosCobrado, datosPrestado, labels);
            } catch (e) {
                console.error('Error en renderChart:', e);
            }
        }
        
        let miniChart = null;
        let allChartData = { cobrado: [], prestado: [], labels: [] };
        
        function renderMiniChart(datosCobrado, datosPrestado, labels) {
            const ctx = document.getElementById('miniChart');
            if (!ctx) return;
            
            // Guardar datos globalmente para el selector
            allChartLabels = labels;
            allChartData = { cobrado: datosCobrado, prestado: datosPrestado, labels: labels };
            
            if (miniChart) miniChart.destroy();
            
            miniChart = new Chart(ctx.getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: datosCobrado,
                        borderColor: '#00d4ff',
                        backgroundColor: 'rgba(0, 212, 255, 0.3)',
                        borderWidth: 1,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }, {
                        data: datosPrestado,
                        borderColor: '#e74c3c',
                        backgroundColor: 'rgba(231, 76, 60, 0.3)',
                        borderWidth: 1,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false, beginAtZero: true }
                    },
                    interaction: { enabled: false }
                }
            });
            
            // Inicializar selector de rango después de un pequeño delay
            setTimeout(() => initRangeSelector(), 100);
        }
        
        function initRangeSelector() {
            const wrapper = document.getElementById('miniChartWrapper');
            const selector = document.getElementById('rangeSelector');
            const overlayLeft = document.getElementById('rangeOverlayLeft');
            const overlayRight = document.getElementById('rangeOverlayRight');
            const handleLeft = document.getElementById('handleLeft');
            const handleRight = document.getElementById('handleRight');
            const helpText = document.getElementById('navHelpText');
            
            if (!wrapper || !selector) return;
            
            const wrapperWidth = wrapper.offsetWidth;
            const numDays = allChartLabels.length;
            
            // Si hay pocos datos (menos de 7 días), el selector ocupa todo y no es interactivo
            // Si hay más datos, el selector ocupa un porcentaje proporcional
            let selectorWidth, selectorLeft;
            if (numDays <= 7) {
                selectorWidth = wrapperWidth;
                selectorLeft = 0;
                // Ocultar handles y mostrar mensaje informativo
                if (handleLeft) handleLeft.style.display = 'none';
                if (handleRight) handleRight.style.display = 'none';
                if (helpText) {
                    helpText.textContent = translations[currentLang]?.navUsaApp || '📊 Usa la app por más días para navegar';
                    helpText.style.color = '#8892b0';
                }
                selector.style.cursor = 'default';
                selector.style.borderColor = '#4a4a6a';
            } else {
                // Mostrar últimos 7 días o 30% del total, lo que sea mayor
                const daysToShow = Math.max(7, Math.floor(numDays * 0.3));
                selectorWidth = Math.max(60, (daysToShow / numDays) * wrapperWidth);
                selectorLeft = wrapperWidth - selectorWidth;
                // Mostrar handles y mensaje de navegación
                if (handleLeft) handleLeft.style.display = 'flex';
                if (handleRight) handleRight.style.display = 'flex';
                if (helpText) {
                    helpText.textContent = translations[currentLang]?.navArrastra || '⟵ Arrastra para navegar ⟶';
                    helpText.style.color = '#00d4ff';
                }
                selector.style.cursor = 'grab';
                selector.style.borderColor = '#00d4ff';
            }
            
            selector.style.width = selectorWidth + 'px';
            selector.style.left = selectorLeft + 'px';
            
            // Actualizar overlays
            updateOverlays();
            
            let isDragging = false;
            let isResizingLeft = false;
            let isResizingRight = false;
            let startX = 0;
            let startLeft = 0;
            let startWidth = 0;
            
            function getClientX(e) {
                return e.touches ? e.touches[0].clientX : e.clientX;
            }
            
            function onStart(e) {
                const target = e.target;
                if (target === handleLeft || target.closest('#handleLeft')) {
                    isResizingLeft = true;
                } else if (target === handleRight || target.closest('#handleRight')) {
                    isResizingRight = true;
                } else if (target === selector || target.closest('#rangeSelector')) {
                    isDragging = true;
                    selector.style.cursor = 'grabbing';
                }
                
                // Si hay pocos datos, no permitir interacción
                if (numDays <= 7) {
                    isDragging = false;
                    isResizingLeft = false;
                    isResizingRight = false;
                    return;
                }
                
                startX = getClientX(e);
                startLeft = selector.offsetLeft;
                startWidth = selector.offsetWidth;
                e.preventDefault();
            }
            
            // Ancho mínimo del selector basado en cantidad de datos
            const minSelectorWidth = numDays <= 14 ? wrapperWidth * 0.5 : 50;
            
            function onMove(e) {
                if (!isDragging && !isResizingLeft && !isResizingRight) return;
                
                const dx = getClientX(e) - startX;
                const maxRight = wrapper.offsetWidth;
                
                if (isDragging) {
                    let newLeft = startLeft + dx;
                    newLeft = Math.max(0, Math.min(newLeft, maxRight - selector.offsetWidth));
                    selector.style.left = newLeft + 'px';
                } else if (isResizingLeft) {
                    let newLeft = startLeft + dx;
                    let newWidth = startWidth - dx;
                    if (newLeft >= 0 && newWidth >= minSelectorWidth) {
                        selector.style.left = newLeft + 'px';
                        selector.style.width = newWidth + 'px';
                    }
                } else if (isResizingRight) {
                    let newWidth = startWidth + dx;
                    if (newWidth >= minSelectorWidth && startLeft + newWidth <= maxRight) {
                        selector.style.width = newWidth + 'px';
                    }
                }
                
                updateOverlays();
                e.preventDefault();
            }
            
            function onEnd() {
                if (isDragging || isResizingLeft || isResizingRight) {
                    actualizarGraficoPorSelector();
                }
                isDragging = false;
                isResizingLeft = false;
                isResizingRight = false;
                selector.style.cursor = 'grab';
            }
            
            function updateOverlays() {
                const sLeft = selector.offsetLeft;
                const sWidth = selector.offsetWidth;
                const sRight = sLeft + sWidth;
                
                overlayLeft.style.width = sLeft + 'px';
                overlayRight.style.width = (wrapper.offsetWidth - sRight) + 'px';
                
                // Actualizar fechas mostradas
                updateNavDates(sLeft, sRight, wrapper.offsetWidth);
            }
            
            // Mouse events
            selector.addEventListener('mousedown', onStart);
            handleLeft.addEventListener('mousedown', onStart);
            handleRight.addEventListener('mousedown', onStart);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onEnd);
            
            // Touch events para celular
            selector.addEventListener('touchstart', onStart, { passive: false });
            handleLeft.addEventListener('touchstart', onStart, { passive: false });
            handleRight.addEventListener('touchstart', onStart, { passive: false });
            document.addEventListener('touchmove', onMove, { passive: false });
            document.addEventListener('touchend', onEnd);
        }
        
        // Variable global para almacenar todas las fechas del gráfico
        let allChartLabels = [];
        
        function updateNavDates(sLeft, sRight, totalWidth) {
            const startEl = document.getElementById('navDateStart');
            const endEl = document.getElementById('navDateEnd');
            
            if (!startEl || !endEl || allChartLabels.length === 0) return;
            
            const startIdx = Math.floor((sLeft / totalWidth) * allChartLabels.length);
            const endIdx = Math.min(Math.floor((sRight / totalWidth) * allChartLabels.length), allChartLabels.length - 1);
            
            startEl.textContent = allChartLabels[Math.max(0, startIdx)] || '-';
            endEl.textContent = allChartLabels[Math.max(0, endIdx)] || '-';
        }
        
        function actualizarGraficoPorSelector() {
            const wrapper = document.getElementById('miniChartWrapper');
            const selector = document.getElementById('rangeSelector');
            if (!wrapper || !selector || !mainChart || allChartData.labels.length === 0) return;
            
            const wrapperWidth = wrapper.offsetWidth;
            const selectorLeft = selector.offsetLeft;
            const selectorWidth = selector.offsetWidth;
            
            // Calcular índices basados en la posición del selector
            const totalLabels = allChartData.labels.length;
            const startIdx = Math.floor((selectorLeft / wrapperWidth) * totalLabels);
            const endIdx = Math.min(Math.ceil(((selectorLeft + selectorWidth) / wrapperWidth) * totalLabels), totalLabels);
            
            // Obtener datos filtrados
            const filteredLabels = allChartData.labels.slice(startIdx, endIdx);
            const filteredCobrado = allChartData.cobrado.slice(startIdx, endIdx);
            const filteredPrestado = allChartData.prestado.slice(startIdx, endIdx);
            
            // Actualizar gráfico principal
            mainChart.data.labels = filteredLabels;
            mainChart.data.datasets[0].data = filteredCobrado;
            mainChart.data.datasets[1].data = filteredPrestado;
            mainChart.update('none');
        }

        function renderCobrosPreview() {
            const container = document.getElementById('cobrosHoyPreview');
            
            // Usar fecha local (no UTC)
            const ahora = getCurrentDate();
            const hoyLocal = ahora.getFullYear() + '-' + 
                String(ahora.getMonth() + 1).padStart(2, '0') + '-' + 
                String(ahora.getDate()).padStart(2, '0');
            
            // Filtrar clientes de la cartera actual registrados hoy (hora local)
            // Excluir clientes renovados (ya tienen un nuevo préstamo)
            const clientesCartera = getClientesFiltrados().filter(c => !c.renovado);
            const clientesHoy = clientesCartera.filter(c => {
                const fechaStr = c.fechaInicio || c.fechaRegistro || c.fechaCreacion || c.fecha || c.createdAt || '';
                if (!fechaStr) return false;
                
                // Convertir a fecha local
                const fechaCliente = new Date(fechaStr);
                const fechaClienteLocal = fechaCliente.getFullYear() + '-' + 
                    String(fechaCliente.getMonth() + 1).padStart(2, '0') + '-' + 
                    String(fechaCliente.getDate()).padStart(2, '0');
                
                return fechaClienteLocal === hoyLocal;
            });
            
            if (clientesHoy.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-user-plus fa-2x mb-3" style="color: var(--accent-green); opacity: 0.5;"></i>
                        <p class="text-secondary" style="font-size: 0.9rem;">No hay clientes registrados hoy</p>
                        <small class="text-secondary">Los clientes aparecerán cuando los registres</small>
                    </div>
                `;
                return;
            }
            
            // Mostrar clientes registrados hoy
            container.innerHTML = clientesHoy.map(c => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <div>${c.nombre}</div>
                        <small class="text-secondary">${c.parcelasPagas || 0}/${c.numeroParcelas} parcelas</small>
                    </div>
                    <div class="text-end">
                        <div style="color: var(--accent-cyan);">R$ ${(parseFloat(c.montoTotal) || 0).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function filtrarClientesPorTipo(tipo) {
            document.getElementById('clientesFiltroTipo').value = tipo;
            renderClientes();
        }

        // Variable global para el estado de la llave de edición
        let userHasEditKey = true;
        let editKeyActive = true; // Alias para compatibilidad
        
        async function updateEditKeyStatus() {
            if (!currentUser || currentUser.role === 'admin' || currentUser.isAdmin) {
                userHasEditKey = true;
                editKeyActive = true;
                return;
            }
            try {
                const res = await fetch(API_URL + '/api/users');
                const users = await res.json();
                const myUser = users.find(u => u.id === currentUser.id || u._id === currentUser.id);
                userHasEditKey = myUser?.editKeyEnabled === true;
                editKeyActive = userHasEditKey;
            } catch (e) {
                userHasEditKey = false;
                editKeyActive = false;
            }
        }
        
        function renderClientes() {
            try {
                const tbody = document.getElementById('clientesTable');
                if (!tbody) return;
                
                // Obtener filtros
                const filtroTipo = document.getElementById('clientesFiltroTipo')?.value || '';
                const filtroEstado = document.getElementById('clientesFiltroEstado')?.value || '';
                const buscar = (document.getElementById('clientesBuscar')?.value || '').toLowerCase();
                
                // Verificar si puede editar: admin siempre puede, trabajadores solo si tienen llave desbloqueada
                const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.isAdmin);
                // Para trabajadores: si tiene contraseña de edición, debe estar desbloqueada
                // Si no tiene contraseña de edición, puede editar libremente
                const canEdit = isAdmin || (!userHasEditPassword && editLockInitialized) || editUnlocked;
            
            // Obtener clientes filtrados por cartera
            const clientesCartera = getClientesFiltrados();
            
            // Filtrar clientes (ocultar los que ya fueron renovados)
            let clientesFiltrados = clientesCartera.filter(c => !c.renovado);
            
            // Contar por tipo (excluyendo renovados)
            const nuevos = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = clientesFiltrados.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = clientesFiltrados.filter(c => c.tipoCliente === 'regular').length;
            const malos = clientesFiltrados.filter(c => c.tipoCliente === 'malo').length;
            
            if (document.getElementById('clientesNuevos')) {
                document.getElementById('clientesNuevos').textContent = nuevos;
                document.getElementById('clientesBuenos').textContent = buenos;
                document.getElementById('clientesRegulares').textContent = regulares;
                document.getElementById('clientesMalos').textContent = malos;
            }
            
            if (filtroTipo) {
                clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === filtroTipo);
            }
            
            if (filtroEstado) {
                clientesFiltrados = clientesFiltrados.filter(c => c.estado === filtroEstado);
            }
            
            if (buscar) {
                clientesFiltrados = clientesFiltrados.filter(c => 
                    c.nombre.toLowerCase().includes(buscar) || 
                    (c.telefono && c.telefono.includes(buscar))
                );
            }
            
            // Ordenar: primero por renovaciones (más renovaciones arriba), luego por fecha
            clientesFiltrados.sort((a, b) => {
                const renovA = a.renovaciones || 0;
                const renovB = b.renovaciones || 0;
                if (renovB !== renovA) return renovB - renovA;
                const fechaA = new Date(a.fechaCreacion || a.fechaInicio || 0);
                const fechaB = new Date(b.fechaCreacion || b.fechaInicio || 0);
                return fechaB - fechaA;
            });
            
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
                return;
            }
            
            const tipoLabels = { nuevo: '🆕', bueno: '✅', regular: '⚠️', malo: '❌' };
            const hoy = getCurrentDate();
            hoy.setHours(0, 0, 0, 0);
            
            tbody.innerHTML = clientesFiltrados.map(c => {
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                const tipoIcon = tipoLabels[c.tipoCliente] || '🆕';
                const renovaciones = c.renovaciones || 0;
                const telefonoLimpio = (c.telefono || '').replace(/\D/g, '');
                const whatsappLink = telefonoLimpio ? `https://wa.me/${telefonoLimpio}` : '';
                
                // Calcular días de atraso
                // El primer pago es al día siguiente de la creación
                let diasAtraso = 0;
                if (esEstadoActivo(c.estado) && (c.montoPagado || 0) < (c.totalAPagar || 0)) {
                    const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                    if (fechaStr) {
                        // Usar la función que considera la hora de registro (regla de las 12 PM)
                        const diasDePago = calcularDiasDePago(fechaStr);
                        const parcelasPagas = c.parcelasPagas || 0;
                        diasAtraso = Math.max(0, diasDePago - parcelasPagas);
                    }
                }
                
                // Sincronizar estado con el cálculo real de atraso
                let estadoMostrar = c.estado;
                if (esEstadoActivo(c.estado)) {
                    if (diasAtraso > 0 && c.estado !== 'atrasado') {
                        estadoMostrar = 'atrasado';
                    } else if (diasAtraso === 0 && c.estado === 'atrasado') {
                        estadoMostrar = 'ativo';
                    }
                }
                const statusClassCalc = esEstadoActivo(estadoMostrar) ? (estadoMostrar === 'atrasado' ? 'late' : 'active') : estadoMostrar === 'finalizado' ? 'finished' : 'late';
                
                return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td><strong>${c.nombre}</strong>${renovaciones > 0 ? `<br><small style="color: var(--accent-purple);">🔄 ${renovaciones}x renovado</small>` : ''}</td>
                    <td style="font-size: 1.2rem;">${tipoIcon}</td>
                    <td>
                        ${c.telefono ? `
                            ${c.telefono}
                            <a href="${whatsappLink}" target="_blank" class="btn btn-sm ms-1" style="background: #25D366; color: #fff; padding: 2px 6px;" title="Abrir WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </a>
                        ` : '-'}
                    </td>
                    <td>R$ ${(c.montoTotal || 0).toFixed(2)}</td>
                    <td style="color: var(--accent-green);">R$ ${(c.montoPagado || 0).toFixed(2)}</td>
                    <td style="color: var(--accent-red);">R$ ${restante.toFixed(2)}</td>
                    <td>${c.parcelasPagas || 0}/${c.numeroParcelas}</td>
                    <td style="color: ${diasAtraso > 0 ? 'var(--accent-red)' : 'var(--accent-green)'}; font-weight: ${diasAtraso > 0 ? 'bold' : 'normal'};">
                        ${diasAtraso > 0 ? `⚠️ ${diasAtraso} día${diasAtraso !== 1 ? 's' : ''}` : '✅ Al día'}
                    </td>
                    <td><span class="badge-status badge-${statusClassCalc}">${estadoMostrar}</span></td>
                    <td>
                        ${(c.estado === 'finalizado' || c.estado === 'pagado') && !c.renovado ? `
                        <button class="btn btn-sm me-1" style="background: var(--accent-purple); color: #fff;" onclick="renovarCliente('${c.id}')" title="Renovar préstamo">
                            <i class="fas fa-redo"></i>
                        </button>
                        ` : c.estado !== 'finalizado' && c.estado !== 'pagado' ? `
                        <button class="btn btn-sm btn-success-custom me-1" onclick="abrirPago('${c.id}')" title="Registrar pago">
                            <i class="fas fa-dollar-sign"></i>
                        </button>
                        ` : ''}
                        <button class="btn btn-sm me-1" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="verDetalles('${c.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                        ${canEdit ? `
                        <button class="btn btn-sm me-1" style="background: var(--accent-cyan); color: #000;" onclick="editarClienteTrabajador('${c.id}')" title="Editar cliente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="eliminarCliente('${c.id}')" title="Eliminar cliente">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>`;
            }).join('');
            } catch (e) {
                console.error('Error en renderClientes:', e);
            }
        }
        function setFechaHoy() {
            const hoy = getCurrentDate();
            const fecha = hoy.getFullYear() + '-' + 
                String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                String(hoy.getDate()).padStart(2, '0');
            document.getElementById('fechaCobros').value = fecha;
            renderCobros();
        }

        function renderCobros() {
            try {
                const container = document.getElementById('cobrosLista');
                const resumenContainer = document.getElementById('cobrosResumen');
                if (!container) return;
                
                const fechaSeleccionada = document.getElementById('fechaCobros')?.value || '';
                const busqueda = (document.getElementById('cobrosBuscar')?.value || '').toLowerCase().trim();
                const filtroEstado = document.getElementById('cobrosFiltroEstado')?.value || '';
                
                // Obtener clientes de la cartera actual
                const clientesCartera = getClientesFiltrados() || [];
                
                // Filtrar pagos realizados en la fecha seleccionada
                let pagosDelDia = [];
                const clientesQuePagaronHoy = new Set();
                
                clientesCartera.forEach(c => {
                    if (c.pagos && c.pagos.length > 0) {
                        c.pagos.forEach(p => {
                            // Comparar solo la parte de fecha (YYYY-MM-DD)
                            const fechaPago = (p.fecha || '').split('T')[0];
                            if (fechaPago === fechaSeleccionada) {
                            // Marcar que este cliente ya pagó hoy
                            clientesQuePagaronHoy.add(c.id);
                            // Extraer hora si existe
                            let hora = '';
                            if (p.fecha && p.fecha.includes('T')) {
                                const fechaObj = new Date(p.fecha);
                                hora = fechaObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            }
                            pagosDelDia.push({
                                cliente: c.nombre,
                                telefono: c.telefono,
                                valor: p.valor,
                                hora: hora,
                                clienteId: c.id
                            });
                        }
                    });
                }
            });
            
            // Filtrar clientes activos de la cartera que DEBEN PAGAR HOY según la regla de las 12 PM
            // y que NO han pagado hoy
            let activos = clientesCartera.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                if (clientesQuePagaronHoy.has(c.id)) return false;
                
                // Verificar si debe pagar hoy usando la regla de las 12 PM
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                
                // Solo mostrar si debe pagar (diasDePago > parcelasPagas)
                return diasDePago > parcelasPagas;
            });
            
            // Aplicar búsqueda a clientes activos
            if (busqueda) {
                activos = activos.filter(c => 
                    (c.nombre || '').toLowerCase().includes(busqueda) ||
                    (c.telefono || '').toLowerCase().includes(busqueda)
                );
            }
            
            // Aplicar búsqueda a pagos del día
            if (busqueda) {
                pagosDelDia = pagosDelDia.filter(p => 
                    (p.cliente || '').toLowerCase().includes(busqueda) ||
                    (p.telefono || '').toLowerCase().includes(busqueda)
                );
            }
            
            // Aplicar filtro de estado
            let mostrarPagados = true;
            let mostrarPendientes = true;
            if (filtroEstado === 'pendiente') {
                mostrarPagados = false;
            } else if (filtroEstado === 'pagado') {
                mostrarPendientes = false;
            }
            
            // Calcular totales del día
            const totalCobradoHoy = pagosDelDia.reduce((s, p) => s + p.valor, 0);
            const totalPendienteHoy = activos.reduce((s, c) => s + (c.valorParcela || 0), 0);
            
            // Mostrar resumen
            resumenContainer.innerHTML = `
                <div class="col-md-4">
                    <div class="stat-card green">
                        <div class="stat-value">R$ ${totalCobradoHoy.toFixed(2)}</div>
                        <div class="stat-label"><i class="fas fa-check-circle me-2"></i>${t('cobradoEsteDia')}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card yellow">
                        <div class="stat-value">${pagosDelDia.length}</div>
                        <div class="stat-label"><i class="fas fa-receipt me-2"></i>${t('pagosRegistrados')}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value">${activos.length}</div>
                        <div class="stat-label"><i class="fas fa-users me-2"></i>${t('clientesPendientes')}</div>
                    </div>
                </div>
            `;
            
            // Mostrar pagos del día si hay
            let html = '';
            
            if (pagosDelDia.length > 0) {
                html += `<h6 class="mb-3" style="color: var(--accent-green);"><i class="fas fa-check-circle me-2"></i>${t('pagosDel')} ${fechaSeleccionada}</h6>`;
                html += pagosDelDia.map(p => `
                    <div class="client-card" style="border-left: 3px solid var(--accent-green);">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>${p.cliente}</strong><br>
                                <small class="text-secondary">${p.telefono || t('sinTelefono')}</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-secondary">${t('pagoRealizado')}${p.hora ? ' ' + t('aLas') + ' ' + p.hora : ''}</small><br>
                                <span style="color: var(--accent-green); font-size: 1.2rem;">R$ ${p.valor.toFixed(2)}</span>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge-status badge-active"><i class="fas fa-check me-1"></i>${t('pagado')}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Mostrar clientes pendientes
            if (activos.length > 0) {
                html += `<h6 class="mb-3 mt-4" style="color: var(--accent-yellow);"><i class="fas fa-clock me-2"></i>${t('pendientesCobro')}</h6>`;
                html += activos.map(c => `
                    <div class="client-card">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong>${c.nombre}</strong><br>
                                <small class="text-secondary">${c.telefono || t('sinTelefono')}</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-secondary">${t('parcela')}</small><br>
                                <span style="color: var(--accent-cyan);">R$ ${(c.valorParcela || 0).toFixed(2)}</span>
                            </div>
                            <div class="col-md-2">
                                <small class="text-secondary">${t('restante')}</small><br>
                                <span style="color: var(--accent-red);">R$ ${((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2)}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-secondary">Progreso</small>
                                <div class="progress-custom mt-1">
                                    <div class="bar" style="width: ${((c.montoPagado || 0) / (c.totalAPagar || 1)) * 100}%"></div>
                                </div>
                                <small class="text-secondary">${c.parcelasPagas || 0}/${c.numeroParcelas} parcelas</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-success-custom" onclick="abrirPago('${c.id}')">
                                    <i class="fas fa-money-bill me-1"></i>Cobrar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            if (html === '') {
                html = '<p class="text-center text-secondary py-4">No hay cobros ni pagos para esta fecha</p>';
            }
            
            container.innerHTML = html;
            } catch (e) {
                console.error('Error en renderCobros:', e);
            }
        }

        // Ver datos pendientes (debug para admin)
        async function verDatosPendientes() {
            try {
                const res = await fetch(API_URL + '/admin/pending-data');
                const data = await res.json();
                
                console.log('🔍 DATOS PENDIENTES:');
                console.log('📋 Pending Users:', data.pendingUsers);
                console.log('💳 Pending Payments:', data.pendingPayments);
                
                alert(`Datos Pendientes:\n\n` +
                      `Pending Users: ${data.pendingUsers.length}\n` +
                      `Pending Payments: ${data.pendingPayments.length}\n\n` +
                      `Ver consola (F12) para detalles completos`);
                
                // Mostrar tabla en consola
                if (data.pendingUsers.length > 0) {
                    console.table(data.pendingUsers.map(u => ({
                        nombre: u.nombre,
                        email: u.email,
                        createdAt: u.createdAt
                    })));
                }
                
                if (data.pendingPayments.length > 0) {
                    console.table(data.pendingPayments.map(p => ({
                        email: p.email,
                        paymentId: p.paymentId,
                        cantidadCarteras: p.cantidadCarteras,
                        createdAt: p.createdAt
                    })));
                }
            } catch (e) {
                console.error('Error obteniendo datos pendientes:', e);
                alert('Error obteniendo datos pendientes. Ver consola.');
            }
        }

        // Admin Functions
        async function renderAdminUsuarios() {
            // Cargar usuarios pendientes del nuevo sistema
            cargarUsuariosPendientesNuevos();
            
            // Mostrar spinner de carga
            const container = document.getElementById('usuariosList');
            const pendientesList = document.getElementById('pendientesList');
            container.innerHTML = '<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-3x" style="color: var(--primary);"></i><p class="mt-3 text-secondary">Cargando usuarios...</p></div>';
            
            try {
                const usersRes = await fetch(API_URL + '/api/users');
                allUsers = await usersRes.json();
                
                console.log('📊 Total usuarios cargados:', allUsers.length);
                console.log('📊 Usuarios con paid=true:', allUsers.filter(u => u.paid).length);
                console.log('📊 Usuarios con carterasPagadas:', allUsers.filter(u => u.carterasPagadas).map(u => ({ nombre: u.nombre, carterasPagadas: u.carterasPagadas })));
                
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                adminAllClients = allClients;
                
                // Separar usuarios activos y pendientes (excluir admin de ambas listas)
                const usuariosPendientes = allUsers.filter(u => !u.paid && !u.pagado && !u.activo && u.role !== 'admin' && !u.isAdmin);
                const usuariosActivos = allUsers.filter(u => (u.paid || u.pagado || u.activo) && u.role !== 'admin' && !u.isAdmin);
                
                // Calcular online/offline (activo si lastSeen < 5 minutos)
                const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000);
                const usuariosOnline = usuariosActivos.filter(u => u.lastSeen && new Date(u.lastSeen) > fiveMinutesAgo);
                const usuariosOffline = usuariosActivos.filter(u => !u.lastSeen || new Date(u.lastSeen) <= fiveMinutesAgo);
                
                document.getElementById('adminTotalUsers').textContent = usuariosActivos.length;
                document.getElementById('adminOnline').textContent = usuariosOnline.length;
                document.getElementById('adminOffline').textContent = usuariosOffline.length;
                document.getElementById('adminPendientes').textContent = usuariosPendientes.length;
                document.getElementById('adminTotalClients').textContent = allClients.length;
                const totalPrestado = allClients.reduce((s, c) => s + (c.montoTotal || 0), 0);
                document.getElementById('adminTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                
                // Mostrar sección de pendientes si hay
                const pendientesSection = document.getElementById('pendientesSection');
                const pendientesList = document.getElementById('pendientesList');
                const pendientesBadge = document.getElementById('pendientesBadge');
                
                if (usuariosPendientes.length > 0) {
                    pendientesSection.style.display = 'block';
                    pendientesBadge.textContent = usuariosPendientes.length;
                    pendientesList.innerHTML = usuariosPendientes.map(u => {
                        const fechaReg = u.fechaRegistro ? new Date(u.fechaRegistro).toLocaleString('es-BR') : 'Desconocida';
                        const odId = u.id || u._id; // Usar id o _id
                        console.log('Usuario pendiente:', u.nombre, 'ID:', odId);
                        return `
                        <div class="d-flex justify-content-between align-items-center py-3 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <strong style="color: #ff6b35;">
                                    <i class="fas fa-user-clock me-2"></i>${u.nombre}
                                </strong>
                                <br><small class="text-secondary"><i class="fas fa-envelope me-1"></i>${u.email}</small>
                                <br><small class="text-secondary"><i class="fas fa-clock me-1"></i>Registrado: ${fechaReg}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success-custom" onclick="activarUsuario('${odId}')">
                                    <i class="fas fa-check me-1"></i>Activar
                                </button>
                                <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="rechazarUsuario('${odId}')">
                                    <i class="fas fa-times me-1"></i>Rechazar
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    pendientesSection.style.display = 'none';
                }
                
                // Mostrar usuarios activos
                const container = document.getElementById('usuariosList');
                if (usuariosActivos.length === 0) {
                    container.innerHTML = '<div class="card-dark text-center py-4"><p class="text-secondary">No hay usuarios activos</p></div>';
                    return;
                }
                container.innerHTML = usuariosActivos.map(u => {
                    const userClients = allClients.filter(c => c.creadoPor === u.id);
                    const userPrestado = userClients.reduce((s, c) => s + (c.montoTotal || 0), 0);
                    const userCobrado = userClients.reduce((s, c) => s + (c.montoPagado || 0), 0);
                    const bloqueado = u.blocked || u.bloqueado || false;
                    const isOnline = u.lastSeen && new Date(u.lastSeen) > fiveMinutesAgo;
                    const statusColor = isOnline ? '#2ecc71' : '#6c757d';
                    const statusText = isOnline ? 'Online' : 'Offline';
                    return `
                    <div class="card-dark mb-3" style="${bloqueado ? 'opacity: 0.6; border-left: 3px solid var(--accent-red);' : ''}">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div style="cursor: pointer;" onclick="toggleUserClients('${u.id}')">
                                <strong>
                                    <span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background: ${statusColor}; margin-right: 8px;"></span>
                                    <i class="fas fa-user me-2" style="color: ${bloqueado ? 'var(--accent-red)' : 'var(--accent-cyan)'};"></i>
                                    ${u.nombre}
                                    <span style="font-size: 0.7rem; color: ${statusColor}; margin-left: 5px;">${statusText}</span>
                                    ${bloqueado ? '<span class="badge-status badge-late ms-2">BLOQUEADO</span>' : ''}
                                </strong>
                                <br><small class="text-secondary">${u.email}</small>
                                <br><span class="badge-status badge-active mt-1">${userClients.length} clientes</span>
                                <span style="color: var(--accent-green); margin-left: 10px;">R$ ${userPrestado.toFixed(2)}</span>
                                ${u.carterasPagadas ? `<span class="badge-status badge-active ms-2" style="background: var(--accent-purple);">${u.carterasPagadas} carteras pagadas</span>` : ''}
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm" style="background: var(--accent-purple); color: #fff;"
                                        onclick="event.stopPropagation(); verCarterasTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-eye me-1"></i>Ver Todo
                                </button>
                                <button class="btn btn-sm btn-primary-custom" 
                                        onclick="event.stopPropagation(); verHistorialTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-history me-1"></i>Historial
                                </button>
                                <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;"
                                        onclick="event.stopPropagation(); verBackupsTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-database me-1"></i>Backups
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: ${bloqueado ? 'var(--accent-red)' : 'var(--accent-green)'}; color: #fff;"
                                        onclick="event.stopPropagation(); toggleBlockUser('${u.id}')"
                                        title="${bloqueado ? 'Clic para desbloquear' : 'Clic para bloquear'}">
                                    <i class="fas fa-${bloqueado ? 'lock' : 'lock-open'}"></i>
                                    ${bloqueado ? 'Bloqueado' : 'Activo'}
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: ${u.editKeyEnabled ? 'var(--accent-green)' : 'var(--accent-red)'}; color: #fff;"
                                        onclick="event.stopPropagation(); toggleEditKey('${u.id}')"
                                        title="${u.editKeyEnabled ? 'Llave ACTIVA - Clic para desactivar' : 'Llave BLOQUEADA - Clic para activar'}">
                                    <i class="fas fa-key"></i> Llave
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: var(--accent-purple); color: #fff;"
                                        onclick="event.stopPropagation(); recuperarCuentaUsuario('${u.id}', '${u.nombre}', '${u.email}')"
                                        title="Recuperar cuenta - Cambiar email o resetear contraseña">
                                    <i class="fas fa-life-ring"></i>
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: #dc3545; color: #fff;"
                                        onclick="event.stopPropagation(); cancelarSuscripcion('${u.id}', '${u.nombre}')"
                                        title="Cancelar suscripción - El usuario tendrá que pagar de nuevo">
                                    <i class="fas fa-ban"></i>
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: #ff4757; color: #fff;"
                                        onclick="event.stopPropagation(); eliminarDatosTrabajador('${u.id}', '${u.nombre}')"
                                        title="Eliminar todos los datos del trabajador (clientes, gastos, sesiones)">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleUserClients('${u.id}')">
                                    <i class="fas fa-chevron-down" id="icon-${u.id}"></i>
                                </button>
                            </div>
                        </div>
                        <div id="clients-${u.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            ${userClients.length === 0 ? '<p class="text-secondary mb-0">Sin clientes</p>' : 
                            userClients.map(c => {
                                const fechaCreacion = c.fechaCreacion || c.fechaInicio || c.createdAt;
                                const fechaStr = fechaCreacion ? new Date(fechaCreacion).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Sin fecha';
                                return `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                                    <div>
                                        <strong>${c.nombre}</strong>
                                        <br><small class="text-secondary">R$ ${(c.montoTotal || 0).toFixed(2)} prestado</small>
                                        <br><small style="color: var(--accent-cyan);"><i class="fas fa-calendar-alt me-1"></i>${fechaStr}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary-custom" onclick="event.stopPropagation(); verClienteAdmin('${c.id}', '${u.id}')">
                                        <i class="fas fa-eye me-1"></i>VER
                                    </button>
                                </div>
                            `}).join('')}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { console.error(e); }
        }
        
        async function activarUsuario(userId) {
            if (!confirm('¿Activar este usuario? Podrá acceder a la aplicación.')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId, { 
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paid: true, activo: true, pagado: true })
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Usuario activado correctamente');
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo activar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function rechazarUsuario(userId) {
            if (!confirm('¿Rechazar y eliminar este usuario?')) return;
            if (!confirm('⚠️ Esta acción eliminará al usuario permanentemente. ¿Continuar?')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('Usuario eliminado');
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        // Variable para guardar clientes del admin
        let adminAllClients = [];

        // ========== CALENDARIO ADMIN ==========
        async function renderCalendarioClientes() {
            try {
                // Cargar usuarios y clientes
                const usersRes = await fetch(API_URL + '/api/users');
                const users = await usersRes.json();
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                
                // Llenar select de trabajadores (solo activos, no admin)
                const selectTrabajador = document.getElementById('calendarioTrabajador');
                const currentValue = selectTrabajador.value;
                const trabajadoresActivos = users.filter(u => (u.paid || u.pagado || u.activo) && u.role !== 'admin' && !u.isAdmin);
                selectTrabajador.innerHTML = '<option value="">Todos los trabajadores</option>' + 
                    trabajadoresActivos.map(u => `<option value="${u.id || u._id}" ${currentValue === (u.id || u._id) ? 'selected' : ''}>${u.nombre}</option>`).join('');
                
                // Obtener filtros
                const trabajadorId = document.getElementById('calendarioTrabajador').value;
                const fechaSeleccionada = document.getElementById('calendarioFecha').value || getCurrentDateString();
                const vista = document.getElementById('calendarioVista').value;
                
                // Filtrar clientes
                let clientesFiltrados = [...allClients];
                
                // Filtrar por trabajador
                if (trabajadorId) {
                    clientesFiltrados = clientesFiltrados.filter(c => c.creadoPor === trabajadorId);
                }
                
                // Filtrar por fecha solo si no es "todos"
                if (vista !== 'todos') {
                    const fechaBase = new Date(fechaSeleccionada + 'T12:00:00');
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        // Buscar cualquier campo de fecha disponible
                        const fechaStr = c.fechaCreacion || c.fechaInicio || c.fechaRegistro || c.createdAt || c.fecha;
                        if (!fechaStr) return false;
                        
                        const fechaCliente = new Date(fechaStr);
                        if (isNaN(fechaCliente.getTime())) return false;
                        
                        if (vista === 'dia') {
                            return fechaCliente.toDateString() === fechaBase.toDateString();
                        } else if (vista === 'semana') {
                            const inicioSemana = new Date(fechaBase);
                            inicioSemana.setDate(fechaBase.getDate() - fechaBase.getDay());
                            inicioSemana.setHours(0, 0, 0, 0);
                            const finSemana = new Date(inicioSemana);
                            finSemana.setDate(inicioSemana.getDate() + 6);
                            finSemana.setHours(23, 59, 59, 999);
                            return fechaCliente >= inicioSemana && fechaCliente <= finSemana;
                        } else if (vista === 'mes') {
                            return fechaCliente.getMonth() === fechaBase.getMonth() && 
                                   fechaCliente.getFullYear() === fechaBase.getFullYear();
                        }
                        return true;
                    });
                }
                
                // Ordenar por fecha (más reciente primero)
                clientesFiltrados.sort((a, b) => {
                    const fechaA = new Date(a.fechaCreacion || a.fechaInicio || a.fechaRegistro || a.createdAt || 0);
                    const fechaB = new Date(b.fechaCreacion || b.fechaInicio || b.fechaRegistro || b.createdAt || 0);
                    return fechaB - fechaA;
                });
                
                // Calcular totales
                const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                
                document.getElementById('calTotalClientes').textContent = clientesFiltrados.length;
                document.getElementById('calTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('calTotalCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                
                // Renderizar tabla
                const tbody = document.getElementById('calendarioClientesTable');
                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-4">No hay clientes para esta fecha</td></tr>';
                    return;
                }
                
                tbody.innerHTML = clientesFiltrados.map(c => {
                    const fechaRegistro = c.fechaCreacion || c.fechaInicio || c.fechaRegistro;
                    const fechaFormateada = fechaRegistro ? new Date(fechaRegistro).toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    }) : 'Sin fecha';
                    
                    const trabajador = users.find(u => (u.id || u._id) === c.creadoPor);
                    const nombreTrabajador = trabajador ? trabajador.nombre : 'Desconocido';
                    
                    const prestado = parseFloat(c.montoTotal) || 0;
                    const cobrado = parseFloat(c.montoPagado) || 0;
                    
                    const statusClass = esEstadoActivo(c.estado) ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                    const statusText = esEstadoActivo(c.estado) ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                    
                    return `
                    <tr>
                        <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                        <td><strong>${c.nombre}</strong><br><small class="text-secondary">${c.telefono || ''}</small></td>
                        <td><i class="fas fa-user-tie me-2" style="color: var(--accent-cyan);"></i>${nombreTrabajador}</td>
                        <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                        <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                        <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                    </tr>`;
                }).join('');
                
            } catch (e) { 
                console.error('Error en calendario:', e); 
            }
        }
        // ========== FIN CALENDARIO ADMIN ==========

        // ========== HISTORIAL TRABAJADOR (PARA TRABAJADORES) ==========
        function initHistorial() {
            const selectAnio = document.getElementById('historialAnio');
            const anioActual = getCurrentDate().getFullYear();
            
            // Calcular año de registro del usuario
            let anioRegistro = anioActual;
            if (currentUser && currentUser.createdAt) {
                anioRegistro = new Date(currentUser.createdAt).getFullYear();
            } else if (currentUser && currentUser.fechaCreacion) {
                anioRegistro = new Date(currentUser.fechaCreacion).getFullYear();
            } else if (currentUser && currentUser.fechaRegistro) {
                anioRegistro = new Date(currentUser.fechaRegistro).getFullYear();
            }
            
            // Generar opciones solo desde año de registro hasta año actual
            let opciones = '';
            for (let a = anioActual; a >= anioRegistro; a--) {
                opciones += `<option value="${a}">${a}</option>`;
            }
            
            // Si no hay años (usuario registrado este año), mostrar solo el año actual
            if (opciones === '') {
                opciones = `<option value="${anioActual}">${anioActual}</option>`;
            }
            
            selectAnio.innerHTML = opciones;
            
            // Establecer año actual por defecto
            selectAnio.value = anioActual;
            
            // Establecer fecha de hoy por defecto
            const hoy = getCurrentDate();
            const fechaHoy = hoy.getFullYear() + '-' + 
                            String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                            String(hoy.getDate()).padStart(2, '0');
            document.getElementById('historialDia').value = fechaHoy;
        }

        function limpiarFiltrosHistorial() {
            document.getElementById('historialAnio').value = '';
            document.getElementById('historialMes').value = '';
            document.getElementById('historialDia').value = '';
            document.getElementById('historialEstado').value = '';
            document.getElementById('historialTipo').value = '';
            renderHistorial();
        }

        function renderHistorial() {
            const anio = document.getElementById('historialAnio').value;
            const mes = document.getElementById('historialMes').value;
            const dia = document.getElementById('historialDia').value;
            const estado = document.getElementById('historialEstado').value;
            const tipo = document.getElementById('historialTipo').value;
            
            // Filtrar clientes por cartera actual (excluyendo renovados)
            let clientesFiltrados = getClientesFiltrados().filter(c => !c.renovado);
            
            // Filtrar por año
            if (anio) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.getFullYear() === parseInt(anio);
                });
            }
            
            // Filtrar por mes
            if (mes !== '') {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.getMonth() === parseInt(mes);
                });
            }
            
            // Filtrar por día específico
            if (dia) {
                // Parsear la fecha correctamente sin problemas de zona horaria
                const [anioD, mesD, diaD] = dia.split('-').map(Number);
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.getFullYear() === anioD && 
                           fecha.getMonth() === (mesD - 1) && 
                           fecha.getDate() === diaD;
                });
            }
            
            // Filtrar por estado
            if (estado) {
                clientesFiltrados = clientesFiltrados.filter(c => c.estado === estado);
            }
            
            // Filtrar por tipo de cliente
            if (tipo) {
                clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === tipo);
            }
            
            // Ordenar por fecha (más reciente primero)
            clientesFiltrados.sort((a, b) => {
                const fechaA = new Date(a.fechaInicio || a.fechaRegistro || 0);
                const fechaB = new Date(b.fechaInicio || b.fechaRegistro || 0);
                return fechaB - fechaA;
            });
            
            // Calcular totales - IMPORTANTE: Los contadores de estado usan TODOS los clientes de la cartera
            // El filtro de fecha solo aplica a la tabla, no a los contadores de estado
            const todosClientesCartera = getClientesFiltrados().filter(c => !c.renovado);
            
            const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0), 0);
            const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
            const totalPendiente = totalPrestado - totalCobrado;
            
            // Contadores de estado usan TODOS los clientes de la cartera (no filtrados por fecha)
            const activos = todosClientesCartera.filter(c => esEstadoActivo(c.estado)).length;
            const finalizados = todosClientesCartera.filter(c => c.estado === 'finalizado').length;
            // Contar atrasados usando el cálculo real, no el estado guardado
            const atrasados = todosClientesCartera.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                if ((c.montoPagado || 0) >= (c.totalAPagar || 0)) return false;
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return false;
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                return diasDePago > parcelasPagas;
            }).length;
            
            // Contar por tipo (de TODOS los clientes de la cartera, excluyendo renovados)
            const nuevos = todosClientesCartera.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = todosClientesCartera.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = todosClientesCartera.filter(c => c.tipoCliente === 'regular').length;
            const malos = todosClientesCartera.filter(c => c.tipoCliente === 'malo').length;
            
            document.getElementById('histTotalClientes').textContent = clientesFiltrados.length;
            document.getElementById('histTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('histTotalCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('histTotalPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            document.getElementById('histActivos').textContent = activos;
            document.getElementById('histFinalizados').textContent = finalizados;
            document.getElementById('histAtrasados').textContent = atrasados;
            document.getElementById('histNuevos').textContent = nuevos;
            document.getElementById('histBuenos').textContent = buenos;
            document.getElementById('histRegulares').textContent = regulares;
            document.getElementById('histMalos').textContent = malos;
            
            // Renderizar tabla
            const tbody = document.getElementById('historialTable');
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
            } else {
                const tipoLabels = { nuevo: '🆕', bueno: '✅', regular: '⚠️', malo: '❌' };
                tbody.innerHTML = clientesFiltrados.map(c => {
                    const fecha = c.fechaInicio || c.fechaRegistro;
                    const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    }) : 'Sin fecha';
                    
                    const prestado = parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0;
                    const cobrado = parseFloat(c.montoPagado) || 0;
                    const pendiente = prestado - cobrado;
                    
                    const statusClass = esEstadoActivo(c.estado) ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                    const statusText = esEstadoActivo(c.estado) ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                    const tipoIcon = tipoLabels[c.tipoCliente] || '🆕';
                    
                    return `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                        <td><strong>${c.nombre}</strong></td>
                        <td style="font-size: 1.2rem;">${tipoIcon}</td>
                        <td>${c.telefono || '-'}</td>
                        <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                        <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                        <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                        <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                    </tr>`;
                }).join('');
            }
            
            // Renderizar últimos pagos
            renderHistorialPagos(clientesFiltrados);
        }

        function renderHistorialPagos(clientesFiltrados) {
            const container = document.getElementById('historialPagos');
            let todosPagos = [];
            
            clientesFiltrados.forEach(c => {
                // Buscar en historialPagos
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.monto || p.valor,
                            fecha: p.fecha,
                            parcela: p.parcela
                        });
                    });
                }
                // También buscar en pagos (donde se guardan normalmente)
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.valor || p.monto,
                            fecha: p.fecha,
                            parcela: p.parcela
                        });
                    });
                }
            });
            
            // Ordenar por fecha más reciente
            todosPagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Mostrar últimos 20
            todosPagos = todosPagos.slice(0, 20);
            
            if (todosPagos.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center py-3">${t('noPagosRegistrados')}</p>`;
                return;
            }
            
            container.innerHTML = todosPagos.map(p => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <strong>${p.cliente}</strong>
                        <br><small class="text-secondary">${new Date(p.fecha).toLocaleDateString('es-ES')} - Parcela ${p.parcela || '?'}</small>
                    </div>
                    <span style="color: var(--accent-green); font-weight: bold;">+ R$ ${parseFloat(p.monto).toFixed(2)}</span>
                </div>
            `).join('');
        }
        // ========== FIN HISTORIAL TRABAJADOR ==========

        // ========== HISTORIAL ADMIN (VER TRABAJADOR ESPECÍFICO) ==========
        let adminHistorialUserId = null;

        function verHistorialTrabajador(userId, nombre) {
            adminHistorialUserId = userId;
            document.getElementById('adminHistNombre').textContent = nombre;
            
            // Buscar usuario para obtener su fecha de registro
            const usuario = allUsers.find(u => u.id === userId || u._id === userId || u.id?.toString() === userId || u._id?.toString() === userId);
            
            // Inicializar años
            const selectAnio = document.getElementById('adminHistAnio');
            const anioActual = getCurrentDate().getFullYear();
            
            // Calcular año de registro del trabajador
            let anioRegistro = anioActual;
            if (usuario && usuario.createdAt) {
                anioRegistro = new Date(usuario.createdAt).getFullYear();
            } else if (usuario && usuario.fechaCreacion) {
                anioRegistro = new Date(usuario.fechaCreacion).getFullYear();
            } else if (usuario && usuario.fechaRegistro) {
                anioRegistro = new Date(usuario.fechaRegistro).getFullYear();
            }
            
            // Generar opciones solo desde año de registro hasta año actual
            let opciones = '';
            for (let a = anioActual; a >= anioRegistro; a--) {
                opciones += `<option value="${a}">${a}</option>`;
            }
            
            // Si no hay años (usuario registrado este año), mostrar solo el año actual
            if (opciones === '') {
                opciones = `<option value="${anioActual}">${anioActual}</option>`;
            }
            
            selectAnio.innerHTML = opciones;
            
            // Establecer año actual por defecto
            selectAnio.value = anioActual;
            
            // Limpiar filtros
            document.getElementById('adminHistMes').value = '';
            document.getElementById('adminHistDia').value = '';
            document.getElementById('adminHistEstado').value = '';
            
            showSection('adminHistorial');
        }

        async function renderAdminHistorialTrabajador() {
            if (!adminHistorialUserId) return;
            
            try {
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                
                // Filtrar por trabajador (todos los clientes de este trabajador)
                const clientesTrabajador = allClients.filter(c => c.creadoPor === adminHistorialUserId);
                let clientesFiltrados = [...clientesTrabajador];
                
                // Aplicar filtros
                const anio = document.getElementById('adminHistAnio').value;
                const mes = document.getElementById('adminHistMes').value;
                const dia = document.getElementById('adminHistDia').value;
                const estado = document.getElementById('adminHistEstado').value;
                const tipo = document.getElementById('adminHistTipo').value;
                
                if (anio) {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.getFullYear() === parseInt(anio);
                    });
                }
                
                if (mes !== '') {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.getMonth() === parseInt(mes);
                    });
                }
                
                if (dia) {
                    const fechaDia = new Date(dia);
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.toDateString() === fechaDia.toDateString();
                    });
                }
                
                if (estado) {
                    clientesFiltrados = clientesFiltrados.filter(c => c.estado === estado);
                }
                
                if (tipo) {
                    clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === tipo);
                }
                
                // Ordenar por fecha (más reciente primero)
                clientesFiltrados.sort((a, b) => {
                    const fechaA = new Date(a.fechaInicio || a.fechaRegistro || 0);
                    const fechaB = new Date(b.fechaInicio || b.fechaRegistro || 0);
                    return fechaB - fechaA;
                });
                
                // Calcular totales
                const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                const totalPendiente = totalPrestado - totalCobrado;
                
                // Contar por tipo (de todos los clientes del trabajador)
                const nuevos = clientesTrabajador.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
                const buenos = clientesTrabajador.filter(c => c.tipoCliente === 'bueno').length;
                const regulares = clientesTrabajador.filter(c => c.tipoCliente === 'regular').length;
                const malos = clientesTrabajador.filter(c => c.tipoCliente === 'malo').length;
                
                document.getElementById('adminHistTotal').textContent = clientesFiltrados.length;
                document.getElementById('adminHistPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('adminHistCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                document.getElementById('adminHistPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
                document.getElementById('adminHistNuevos').textContent = nuevos;
                document.getElementById('adminHistBuenos').textContent = buenos;
                document.getElementById('adminHistRegulares').textContent = regulares;
                document.getElementById('adminHistMalos').textContent = malos;
                
                // Renderizar tabla
                const tbody = document.getElementById('adminHistTable');
                const tipoLabels = { nuevo: '🆕', bueno: '✅', regular: '⚠️', malo: '❌' };
                
                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
                } else {
                    tbody.innerHTML = clientesFiltrados.map(c => {
                        const fecha = c.fechaInicio || c.fechaRegistro;
                        const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', {
                            day: '2-digit', month: '2-digit', year: 'numeric'
                        }) : 'Sin fecha';
                        
                        const prestado = parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0;
                        const cobrado = parseFloat(c.montoPagado) || 0;
                        const pendiente = prestado - cobrado;
                        
                        const statusClass = esEstadoActivo(c.estado) ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                        const statusText = esEstadoActivo(c.estado) ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                        const tipoIcon = tipoLabels[c.tipoCliente] || '🆕';
                        
                        return `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                            <td><strong>${c.nombre}</strong></td>
                            <td style="font-size: 1.2rem;">${tipoIcon}</td>
                            <td>${c.telefono || '-'}</td>
                            <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                            <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                            <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                            <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) {
                console.error('Error en historial admin:', e);
            }
        }
        // ========== FIN HISTORIAL ADMIN ==========

        // ========== ESTADÍSTICAS TRABAJADOR ==========
        function initEstadisticas() {
            const hoy = getCurrentDate();
            // Usar fecha local, no UTC
            const fechaLocal = hoy.getFullYear() + '-' + 
                              String(hoy.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(hoy.getDate()).padStart(2, '0');
            document.getElementById('estFecha').value = fechaLocal;
            document.getElementById('estMes').value = hoy.getMonth();
            
            const selectAnio = document.getElementById('estAnio');
            const anioActual = hoy.getFullYear();
            let opciones = '';
            // Incluir años desde actual+1 hasta actual-5
            for (let a = anioActual + 1; a >= anioActual - 5; a--) {
                opciones += `<option value="${a}" ${a === anioActual ? 'selected' : ''}>${a}</option>`;
            }
            selectAnio.innerHTML = opciones;
        }

        function renderEstadisticas() {
            const vista = document.getElementById('estVista').value;
            const fecha = document.getElementById('estFecha').value;
            const mes = parseInt(document.getElementById('estMes').value);
            const anio = parseInt(document.getElementById('estAnio').value);
            
            const hoy = getCurrentDate();
            let fechaInicio, fechaFin;
            
            // Sincronizar selectores según la vista
            if (vista === 'dia' && fecha) {
                const fechaSel = new Date(fecha + 'T12:00:00');
                document.getElementById('estMes').value = fechaSel.getMonth();
                // Verificar si el año existe en el selector
                const selectAnio = document.getElementById('estAnio');
                const anioFecha = fechaSel.getFullYear();
                if (!Array.from(selectAnio.options).some(opt => parseInt(opt.value) === anioFecha)) {
                    selectAnio.innerHTML += `<option value="${anioFecha}">${anioFecha}</option>`;
                }
                selectAnio.value = anioFecha;
            }
            
            if (vista === 'dia') {
                const fechaSel = fecha ? new Date(fecha + 'T12:00:00') : hoy;
                fechaInicio = new Date(fechaSel);
                fechaInicio.setHours(0, 0, 0, 0);
                fechaFin = new Date(fechaSel);
                fechaFin.setHours(23, 59, 59, 999);
            } else if (vista === 'semana') {
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                inicioSemana.setHours(0, 0, 0, 0);
                fechaInicio = inicioSemana;
                fechaFin = new Date(inicioSemana);
                fechaFin.setDate(fechaFin.getDate() + 6);
                fechaFin.setHours(23, 59, 59, 999);
            } else if (vista === 'mes') {
                fechaInicio = new Date(anio, mes, 1);
                fechaFin = new Date(anio, mes + 1, 0, 23, 59, 59, 999);
            } else if (vista === 'anio') {
                fechaInicio = new Date(anio, 0, 1);
                fechaFin = new Date(anio, 11, 31, 23, 59, 59, 999);
            } else {
                fechaInicio = new Date(2000, 0, 1);
                fechaFin = new Date(2100, 11, 31);
            }
            
            const clientesCartera = getClientesFiltrados().filter(c => !c.renovado);
            const clientesFiltrados = clientesCartera.filter(c => {
                const fechaCliente = normalizarFechaParaComparar(c.fechaCreacion || c.fechaInicio || c.fechaRegistro || 0);
                return fechaCliente >= fechaInicio && fechaCliente <= fechaFin;
            });
            
            const totalClientes = clientesFiltrados.length;
            const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
            const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
            const totalPendiente = clientesFiltrados.reduce((s, c) => {
                const total = parseFloat(c.totalAPagar) || 0;
                const pagado = parseFloat(c.montoPagado) || 0;
                return s + (total - pagado);
            }, 0);
            
            let pagosCount = 0;
            let pagosTotal = 0;
            clientesCartera.forEach(c => {
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        const fechaPago = normalizarFechaParaComparar(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            pagosCount++;
                            pagosTotal += parseFloat(p.valor) || 0;
                        }
                    });
                }
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        const fechaPago = normalizarFechaParaComparar(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            pagosCount++;
                            pagosTotal += parseFloat(p.monto) || 0;
                        }
                    });
                }
            });
            
            const gastosCartera = getGastosFiltrados();
            const gastosFiltrados = gastosCartera.filter(g => {
                const fechaGasto = normalizarFechaParaComparar(g.fecha);
                return fechaGasto >= fechaInicio && fechaGasto <= fechaFin;
            });
            const gastosCount = gastosFiltrados.length;
            const gastosTotal = gastosFiltrados.reduce((s, g) => s + (parseFloat(g.monto) || parseFloat(g.valor) || 0), 0);
            
            const balance = pagosTotal - gastosTotal;
            
            const nuevos = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = clientesFiltrados.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = clientesFiltrados.filter(c => c.tipoCliente === 'regular').length;
            const malos = clientesFiltrados.filter(c => c.tipoCliente === 'malo').length;
            
            const activos = clientesFiltrados.filter(c => esEstadoActivo(c.estado)).length;
            const finalizados = clientesFiltrados.filter(c => c.estado === 'finalizado').length;
            // Contar atrasados usando el cálculo real, no el estado guardado
            const atrasados = clientesFiltrados.filter(c => {
                if (!esEstadoActivo(c.estado)) return false;
                if ((c.montoPagado || 0) >= (c.totalAPagar || 0)) return false;
                const fechaStr = c.fechaInicio || c.fechaCreacion || c.fechaRegistro || c.fecha || c.createdAt;
                if (!fechaStr) return false;
                const diasDePago = calcularDiasDePago(fechaStr);
                const parcelasPagas = c.parcelasPagas || 0;
                return diasDePago > parcelasPagas;
            }).length;
            
            document.getElementById('estClientes').textContent = totalClientes;
            document.getElementById('estPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('estCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('estPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            
            document.getElementById('estPagosCount').textContent = pagosCount;
            document.getElementById('estPagosTotal').textContent = 'R$ ' + pagosTotal.toFixed(2);
            document.getElementById('estGastosCount').textContent = gastosCount;
            document.getElementById('estGastosTotal').textContent = 'R$ ' + gastosTotal.toFixed(2);
            
            const balanceEl = document.getElementById('estBalance');
            balanceEl.textContent = 'R$ ' + balance.toFixed(2);
            balanceEl.style.color = balance >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            document.getElementById('estNuevos').textContent = nuevos;
            document.getElementById('estBuenos').textContent = buenos;
            document.getElementById('estRegulares').textContent = regulares;
            document.getElementById('estMalos').textContent = malos;
            
            document.getElementById('estActivos').textContent = activos;
            document.getElementById('estFinalizados').textContent = finalizados;
            document.getElementById('estAtrasados').textContent = atrasados;
            
            renderEstadisticasActividad(fechaInicio, fechaFin, clientesFiltrados, gastosFiltrados);
        }

        function renderEstadisticasActividad(fechaInicio, fechaFin, clientesFiltrados, gastosFiltrados) {
            const container = document.getElementById('estActividad');
            let actividades = [];
            
            // Solo pagos de clientes filtrados por cartera
            clientesFiltrados.forEach(c => {
                const totalAPagar = parseFloat(c.totalAPagar) || 0;
                let acumuladoPagos = 0;
                
                // Combinar y ordenar todos los pagos por fecha
                const todosPagos = [];
                if (c.pagos) {
                    c.pagos.forEach(p => todosPagos.push({ ...p, monto: p.valor }));
                }
                if (c.historialPagos) {
                    c.historialPagos.forEach(p => todosPagos.push(p));
                }
                todosPagos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
                
                todosPagos.forEach(p => {
                    const fechaPago = new Date(p.fecha);
                    const montoPago = parseFloat(p.monto || p.valor || 0);
                    const acumuladoAntes = acumuladoPagos;
                    acumuladoPagos += montoPago;
                    
                    // Verificar si este pago finalizó la deuda
                    const esFinalizacion = totalAPagar > 0 && acumuladoPagos >= totalAPagar && acumuladoAntes < totalAPagar;
                    
                    if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                        actividades.push({
                            tipo: esFinalizacion ? 'finalizado' : 'pago',
                            fecha: fechaPago,
                            texto: esFinalizacion ? `✅ ${c.nombre} - FINALIZADO` : `Pago de ${c.nombre}`,
                            monto: montoPago,
                            icono: esFinalizacion ? 'fa-check-circle' : 'fa-money-bill-wave',
                            color: esFinalizacion ? 'var(--accent-purple)' : 'var(--accent-green)'
                        });
                    }
                });
            });
            
            gastosFiltrados.forEach(g => {
                actividades.push({
                    tipo: 'gasto',
                    fecha: new Date(g.fecha),
                    texto: `Gasto: ${g.descripcion}`,
                    monto: g.valor || g.monto,
                    icono: 'fa-wallet',
                    color: 'var(--accent-red)'
                });
            });
            
            actividades.sort((a, b) => b.fecha - a.fecha);
            actividades = actividades.slice(0, 50);
            
            if (actividades.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center py-3">No hay actividad en este período</p>';
                return;
            }
            
            container.innerHTML = actividades.map(a => {
                const fechaStr = a.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const horaStr = a.fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const signo = a.tipo === 'gasto' ? '-' : '+';
                return `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas ${a.icono}" style="color: ${a.color}; width: 20px;"></i>
                        <div>
                            <span style="${a.tipo === 'finalizado' ? 'color: var(--accent-purple); font-weight: bold;' : ''}">${a.texto}</span>
                            <br><small class="text-secondary">${fechaStr} - ${horaStr}</small>
                        </div>
                    </div>
                    <span style="color: ${a.color}; font-weight: bold; white-space: nowrap;">${signo} R$ ${parseFloat(a.monto).toFixed(2)}</span>
                </div>`;
            }).join('');
        }
        // ========== FIN ESTADÍSTICAS TRABAJADOR ==========

        // ========== VER TODO TRABAJADOR (ADMIN) ==========
        let verTodoUserId = null;
        let verTodoUserData = null;
        let verTodoClientes = [];
        let verTodoGastos = [];
        let verTodoCarteras = [];
        let verTodoTabActual = 'clientes';
        let verTodoCarteraActual = null; // Para saber de qué cartera volver

        // Nueva función: Mostrar carteras del trabajador
        async function verCarterasTrabajador(userId, nombre) {
            verTodoUserId = userId;
            
            // Buscar usuario en allUsers
            verTodoUserData = allUsers.find(u => u.id === userId || u._id === userId || u.id?.toString() === userId || u._id?.toString() === userId);
            
            document.getElementById('carterasTrabajadorNombre').textContent = nombre || verTodoUserData?.nombre || 'Trabajador';
            document.getElementById('carterasTrabajadorEmail').textContent = verTodoUserData?.email || '-';
            document.getElementById('carterasTrabajadorEstado').innerHTML = (verTodoUserData?.blocked || verTodoUserData?.bloqueado) ? 
                '<span class="badge-status badge-late">Bloqueado</span>' :
                '<span class="badge-status badge-active">Activo</span>';
            
            try {
                // Cargar carteras del usuario
                const carterasRes = await fetch(API_URL + '/api/carteras/' + userId);
                const carterasData = await carterasRes.json();
                verTodoCarteras = carterasData.success && Array.isArray(carterasData.carteras) ? carterasData.carteras : [];
                
                document.getElementById('carterasTrabajadorTotal').textContent = verTodoCarteras.length;
                
                // Cargar todos los clientes del usuario para contar por cartera
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                verTodoClientes = Array.isArray(allClients) ? allClients.filter(c => 
                    c.creadoPor === userId || 
                    c.creadoPor?.toString() === userId?.toString() ||
                    c.userId === userId ||
                    c.userId?.toString() === userId?.toString()
                ) : [];
                
                // Renderizar lista de carteras
                const container = document.getElementById('carterasTrabajadorLista');
                
                if (verTodoCarteras.length === 0) {
                    container.innerHTML = '<div class="card-dark text-center py-5"><p class="text-secondary">Este trabajador no tiene carteras</p></div>';
                } else {
                    container.innerHTML = verTodoCarteras.map(cartera => {
                        // Contar clientes de esta cartera
                        const clientesCartera = verTodoClientes.filter(c => c.carteraId === cartera.id || c.carteraId === cartera._id?.toString());
                        const totalClientes = clientesCartera.length;
                        const totalPrestado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                        const totalCobrado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                        const totalPendiente = totalPrestado - totalCobrado;
                        
                        const fechaCreacion = cartera.createdAt || cartera.fechaCreacion;
                        const fechaStr = fechaCreacion ? new Date(fechaCreacion).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'Sin fecha';
                        
                        const carteraColor = cartera.color || '#00d4ff';
                        
                        return `
                        <div class="card-dark mb-3" style="border-left: 4px solid ${carteraColor};">
                            <div class="d-flex justify-content-between align-items-start flex-wrap gap-3">
                                <div style="flex: 1;">
                                    <h5 style="color: ${carteraColor}; margin-bottom: 10px;">
                                        <i class="fas fa-folder me-2"></i>${cartera.nombre}
                                    </h5>
                                    <div class="row g-3 mb-3">
                                        <div class="col-md-3 col-6">
                                            <p class="text-secondary mb-1" style="font-size: 0.85rem;">Clientes</p>
                                            <p style="font-weight: bold; font-size: 1.2rem; color: var(--accent-cyan);">${totalClientes}</p>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <p class="text-secondary mb-1" style="font-size: 0.85rem;">Prestado</p>
                                            <p style="font-weight: bold; font-size: 1.2rem; color: var(--accent-green);">R$ ${totalPrestado.toFixed(2)}</p>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <p class="text-secondary mb-1" style="font-size: 0.85rem;">Cobrado</p>
                                            <p style="font-weight: bold; font-size: 1.2rem; color: var(--accent-yellow);">R$ ${totalCobrado.toFixed(2)}</p>
                                        </div>
                                        <div class="col-md-3 col-6">
                                            <p class="text-secondary mb-1" style="font-size: 0.85rem;">Pendiente</p>
                                            <p style="font-weight: bold; font-size: 1.2rem; color: var(--accent-red);">R$ ${totalPendiente.toFixed(2)}</p>
                                        </div>
                                    </div>
                                    <p class="text-secondary mb-0" style="font-size: 0.85rem;">
                                        <i class="fas fa-calendar-alt me-1"></i>Creada: ${fechaStr}
                                    </p>
                                </div>
                                <div class="d-flex flex-column gap-2">
                                    <button class="btn btn-primary-custom" onclick="verClientesDeCartera('${cartera.id || cartera._id}', '${cartera.nombre}')">
                                        <i class="fas fa-users me-1"></i>Ver Clientes (${totalClientes})
                                    </button>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                }
                
                showSection('adminCarterasTrabajador');
                
            } catch (e) {
                console.error('Error cargando carteras:', e);
                alert('Error al cargar carteras del trabajador');
            }
        }

        // Nueva función: Ver clientes de una cartera específica
        async function verClientesDeCartera(carteraId, carteraNombre) {
            verTodoCarteraActual = carteraId;
            
            // Filtrar clientes de esta cartera
            const clientesCartera = verTodoClientes.filter(c => 
                c.carteraId === carteraId || 
                c.carteraId === carteraId?.toString() ||
                c.carteraId?._id === carteraId ||
                c.carteraId?._id?.toString() === carteraId?.toString()
            );
            
            // Calcular estadísticas de la cartera
            const totalClientes = clientesCartera.length;
            const totalPrestado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
            const totalCobrado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
            const totalPendiente = clientesCartera.reduce((s, c) => {
                const total = parseFloat(c.totalAPagar) || 0;
                const pagado = parseFloat(c.montoPagado) || 0;
                return s + (total - pagado);
            }, 0);
            
            let totalPagos = 0;
            clientesCartera.forEach(c => {
                if (c.pagos) totalPagos += c.pagos.length;
                if (c.historialPagos) totalPagos += c.historialPagos.length;
            });
            
            // Actualizar UI
            document.getElementById('verTodoNombre').textContent = carteraNombre + ' - ' + (verTodoUserData?.nombre || 'Trabajador');
            document.getElementById('verTodoEmail').textContent = verTodoUserData?.email || '-';
            document.getElementById('verTodoFechaReg').textContent = verTodoUserData?.createdAt ? 
                new Date(verTodoUserData.createdAt).toLocaleDateString('es-ES') : 
                (verTodoUserData?.fechaRegistro ? new Date(verTodoUserData.fechaRegistro).toLocaleDateString('es-ES') : '-');
            document.getElementById('verTodoEstado').innerHTML = (verTodoUserData?.blocked || verTodoUserData?.bloqueado) ? 
                '<span class="badge-status badge-late">Bloqueado</span>' :
                '<span class="badge-status badge-active">Activo</span>';
            
            document.getElementById('vtTotalClientes').textContent = totalClientes;
            document.getElementById('vtPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('vtCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('vtPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            document.getElementById('vtGastos').textContent = 'R$ 0.00'; // Gastos no se filtran por cartera
            document.getElementById('vtPagosRecibidos').textContent = totalPagos;
            
            // Guardar clientes filtrados temporalmente
            const clientesOriginales = verTodoClientes;
            verTodoClientes = clientesCartera;
            
            showSection('adminVerTodo');
            verTodoTabActual = 'clientes';
            mostrarTabVerTodo('clientes');
            
            // Restaurar clientes originales después de renderizar
            setTimeout(() => {
                verTodoClientes = clientesOriginales;
            }, 100);
        }

        // Nueva función: Volver a la vista de carteras
        function volverACarteras() {
            if (verTodoUserId && verTodoUserData) {
                verCarterasTrabajador(verTodoUserId, verTodoUserData.nombre);
            } else {
                showSection('adminUsuarios');
            }
        }

        async function verTodoTrabajador(userId, nombre) {
            verTodoUserId = userId;
            
            // Buscar usuario en allUsers por id o _id
            verTodoUserData = allUsers.find(u => u.id === userId || u._id === userId || u.id?.toString() === userId || u._id?.toString() === userId);
            
            document.getElementById('verTodoNombre').textContent = nombre || verTodoUserData?.nombre || 'Trabajador';
            document.getElementById('verTodoEmail').textContent = verTodoUserData?.email || '-';
            document.getElementById('verTodoFechaReg').textContent = verTodoUserData?.createdAt ? 
                new Date(verTodoUserData.createdAt).toLocaleDateString('es-ES') : 
                (verTodoUserData?.fechaRegistro ? new Date(verTodoUserData.fechaRegistro).toLocaleDateString('es-ES') : '-');
            document.getElementById('verTodoEstado').innerHTML = (verTodoUserData?.blocked || verTodoUserData?.bloqueado) ? 
                '<span class="badge-status badge-late">Bloqueado</span>' :
                '<span class="badge-status badge-active">Activo</span>';
            
            try {
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                // Filtrar por creadoPor comparando como string
                verTodoClientes = Array.isArray(allClients) ? allClients.filter(c => 
                    c.creadoPor === userId || 
                    c.creadoPor?.toString() === userId?.toString() ||
                    c.userId === userId ||
                    c.userId?.toString() === userId?.toString()
                ) : [];
                
                const gastosRes = await fetch(API_URL + '/api/gastos?userId=' + userId);
                const gastosData = await gastosRes.json();
                verTodoGastos = Array.isArray(gastosData) ? gastosData : [];
                
                // Cargar carteras del usuario
                const carterasRes = await fetch(API_URL + '/api/carteras/' + userId);
                const carterasData = await carterasRes.json();
                verTodoCarteras = carterasData.success && Array.isArray(carterasData.carteras) ? carterasData.carteras : [];
                
                const totalClientes = verTodoClientes.length;
                const totalPrestado = verTodoClientes.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = verTodoClientes.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                const totalPendiente = verTodoClientes.reduce((s, c) => {
                    const total = parseFloat(c.totalAPagar) || 0;
                    const pagado = parseFloat(c.montoPagado) || 0;
                    return s + (total - pagado);
                }, 0);
                const totalGastos = verTodoGastos.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                let totalPagos = 0;
                verTodoClientes.forEach(c => {
                    if (c.pagos) totalPagos += c.pagos.length;
                    if (c.historialPagos) totalPagos += c.historialPagos.length;
                });
                
                document.getElementById('vtTotalClientes').textContent = totalClientes;
                document.getElementById('vtPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('vtCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                document.getElementById('vtPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
                document.getElementById('vtGastos').textContent = 'R$ ' + totalGastos.toFixed(2);
                document.getElementById('vtPagosRecibidos').textContent = totalPagos;
                
                showSection('adminVerTodo');
                verTodoTabActual = 'clientes';
                mostrarTabVerTodo('clientes');
                
            } catch (e) {
                console.error('Error cargando datos:', e);
                alert('Error al cargar datos del trabajador');
            }
        }

        function mostrarTabVerTodo(tab) {
            verTodoTabActual = tab;
            
            ['clientes', 'carteras', 'gastos', 'pagos', 'actividad'].forEach(t => {
                const btn = document.getElementById('vtTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    btn.className = t === tab ? 'btn btn-primary-custom' : 'btn btn-secondary';
                }
            });
            
            const container = document.getElementById('vtContenido');
            
            if (tab === 'clientes') {
                renderVerTodoClientes(container);
            } else if (tab === 'carteras') {
                renderVerTodoCarteras(container);
            } else if (tab === 'gastos') {
                renderVerTodoGastos(container);
            } else if (tab === 'pagos') {
                renderVerTodoPagos(container);
            } else if (tab === 'actividad') {
                renderVerTodoActividad(container);
            }
        }

        function filtrarVerTodo() {
            mostrarTabVerTodo(verTodoTabActual);
        }

        function renderVerTodo() {
            if (verTodoUserId) {
                mostrarTabVerTodo(verTodoTabActual);
            }
        }

        function renderVerTodoClientes(container) {
            const tipoLabels = { nuevo: '🆕', bueno: '✅', regular: '⚠️', malo: '❌' };
            const busqueda = (document.getElementById('vtBuscador')?.value || '').toLowerCase().trim();
            
            let clientesFiltrados = verTodoClientes;
            if (busqueda) {
                clientesFiltrados = verTodoClientes.filter(c => 
                    (c.nombre || '').toLowerCase().includes(busqueda) ||
                    (c.telefono || '').toLowerCase().startsWith(busqueda)
                );
            }
            
            if (clientesFiltrados.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${busqueda ? 'No se encontraron resultados para "' + busqueda + '"' : 'No hay clientes'}</p></div>`;
                return;
            }
            
            // Agrupar clientes por nombre+teléfono para detectar renovados
            const clientesAgrupados = {};
            clientesFiltrados.forEach(c => {
                const key = (c.nombre || '').toLowerCase() + '_' + (c.telefono || '');
                if (!clientesAgrupados[key]) {
                    clientesAgrupados[key] = [];
                }
                clientesAgrupados[key].push(c);
            });
            
            // Crear lista de clientes únicos con info de renovaciones
            const clientesUnicos = [];
            Object.values(clientesAgrupados).forEach(grupo => {
                // Ordenar por fecha (más reciente primero)
                grupo.sort((a, b) => new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0));
                
                // El más reciente es el principal
                const principal = grupo[0];
                // Usar el valor de renovaciones del cliente principal, no contar registros
                const renovaciones = principal.renovaciones || 0;
                
                // Sumar totales de todos los préstamos
                const totalPrestado = grupo.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = grupo.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                const totalAPagar = grupo.reduce((s, c) => s + (parseFloat(c.totalAPagar) || 0), 0);
                
                clientesUnicos.push({
                    ...principal,
                    renovaciones,
                    totalPrestadoGrupo: totalPrestado,
                    totalCobradoGrupo: totalCobrado,
                    totalAPagarGrupo: totalAPagar,
                    todosIds: grupo.map(c => c.id)
                });
            });
            
            const clientesOrdenados = [...clientesUnicos].sort((a, b) => {
                return new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0);
            });
            
            container.innerHTML = `
            <div class="card-dark">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-dark-custom mb-0">
                        <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 10;">
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Tipo</th>
                                <th>Teléfono</th>
                                <th>Prestado</th>
                                <th>Cobrado</th>
                                <th>Pendiente</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientesOrdenados.map(c => {
                                const fecha = c.fechaCreacion || c.fechaInicio;
                                const fechaStr = fecha ? new Date(fecha).toLocaleDateString('es-ES') : '-';
                                const prestado = c.totalPrestadoGrupo || parseFloat(c.montoTotal) || 0;
                                const cobrado = c.totalCobradoGrupo || parseFloat(c.montoPagado) || 0;
                                const pendiente = (c.totalAPagarGrupo || parseFloat(c.totalAPagar) || 0) - cobrado;
                                const statusClass = esEstadoActivo(c.estado) ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                                const statusText = esEstadoActivo(c.estado) ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                                const renovadoLabel = c.renovaciones > 0 ? `<span style="background: var(--accent-purple); color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">🔄 ${c.renovaciones}x Renovado</span>` : '';
                                
                                return `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td>${fechaStr}</td>
                                    <td><strong>${c.nombre}</strong>${renovadoLabel}</td>
                                    <td style="font-size: 1.2rem;">${tipoLabels[c.tipoCliente] || '🆕'}</td>
                                    <td>${c.telefono || '-'}</td>
                                    <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                                    <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                                    <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                                    <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                                    <td>
                                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000; margin-right: 5px;" onclick="adminEditarCliente('${c.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="adminEliminarCliente('${c.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderVerTodoGastos(container) {
            const busqueda = (document.getElementById('vtBuscador')?.value || '').toLowerCase().trim();
            
            let gastosFiltrados = verTodoGastos;
            if (busqueda) {
                gastosFiltrados = verTodoGastos.filter(g => 
                    (g.descripcion || '').toLowerCase().includes(busqueda) ||
                    (g.categoria || '').toLowerCase().includes(busqueda)
                );
            }
            
            if (gastosFiltrados.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${busqueda ? 'No se encontraron resultados para "' + busqueda + '"' : 'No hay gastos registrados'}</p></div>`;
                return;
            }
            
            const gastosOrdenados = [...gastosFiltrados].sort((a, b) => {
                return new Date(b.fecha || 0) - new Date(a.fecha || 0);
            });
            
            const totalGastos = gastosOrdenados.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
            
            container.innerHTML = `
            <div class="card-dark mb-3">
                <div class="row text-center">
                    <div class="col-6">
                        <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;">${gastosOrdenados.length}</div>
                        <small class="text-secondary">Total Gastos</small>
                    </div>
                    <div class="col-6">
                        <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;">R$ ${totalGastos.toFixed(2)}</div>
                        <small class="text-secondary">Valor Total</small>
                    </div>
                </div>
            </div>
            <div class="card-dark">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-dark-custom mb-0">
                        <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 10;">
                            <tr>
                                <th>Fecha</th>
                                <th>Descripción</th>
                                <th>Categoría</th>
                                <th>Valor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${gastosOrdenados.map(g => {
                                const fechaStr = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES') : '-';
                                return `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td>${fechaStr}</td>
                                    <td>${g.descripcion || '-'}</td>
                                    <td>${g.categoria || '-'}</td>
                                    <td style="color: var(--accent-red); font-weight: bold;">R$ ${(parseFloat(g.valor) || 0).toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000; margin-right: 5px;" onclick="adminEditarGasto('${g.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="adminEliminarGasto('${g.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderVerTodoPagos(container) {
            let todosPagos = [];
            
            verTodoClientes.forEach(c => {
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.valor,
                            fecha: p.fecha
                        });
                    });
                }
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.monto,
                            fecha: p.fecha,
                            parcela: p.parcela
                        });
                    });
                }
            });
            
            todosPagos.sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));
            
            if (todosPagos.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${t('noPagosRegistrados')}</p></div>`;
                return;
            }
            
            const totalPagos = todosPagos.reduce((s, p) => s + (parseFloat(p.monto) || 0), 0);
            
            container.innerHTML = `
            <div class="card-dark mb-3">
                <div class="row text-center">
                    <div class="col-6">
                        <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;">${todosPagos.length}</div>
                        <small class="text-secondary">Total Pagos</small>
                    </div>
                    <div class="col-6">
                        <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;">R$ ${totalPagos.toFixed(2)}</div>
                        <small class="text-secondary">Valor Total</small>
                    </div>
                </div>
            </div>
            <div class="card-dark">
                <div style="max-height: 400px; overflow-y: auto;">
                    ${todosPagos.map(p => {
                        const fechaStr = p.fecha ? new Date(p.fecha).toLocaleDateString('es-ES') : '-';
                        return `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <strong>${p.cliente}</strong>
                                <br><small class="text-secondary">${fechaStr}${p.parcela ? ' - Parcela ' + p.parcela : ''}</small>
                            </div>
                            <span style="color: var(--accent-green); font-weight: bold;">+ R$ ${(parseFloat(p.monto) || 0).toFixed(2)}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderVerTodoActividad(container) {
            let actividades = [];
            
            verTodoClientes.forEach(c => {
                actividades.push({
                    tipo: 'cliente',
                    fecha: new Date(c.fechaCreacion || c.fechaInicio || 0),
                    texto: `Nuevo cliente: ${c.nombre}`,
                    detalle: `Préstamo: R$ ${(c.montoTotal || 0).toFixed(2)}`,
                    icono: 'fa-user-plus',
                    color: 'var(--accent-cyan)'
                });
            });
            
            verTodoClientes.forEach(c => {
                if (c.pagos) {
                    c.pagos.forEach(p => {
                        actividades.push({
                            tipo: 'pago',
                            fecha: new Date(p.fecha || 0),
                            texto: `Pago recibido de ${c.nombre}`,
                            detalle: `R$ ${(parseFloat(p.valor) || 0).toFixed(2)}`,
                            icono: 'fa-money-bill-wave',
                            color: 'var(--accent-green)'
                        });
                    });
                }
                if (c.historialPagos) {
                    c.historialPagos.forEach(p => {
                        actividades.push({
                            tipo: 'pago',
                            fecha: new Date(p.fecha || 0),
                            texto: `Pago de ${c.nombre} (Parcela ${p.parcela || '?'})`,
                            detalle: `R$ ${(parseFloat(p.monto) || 0).toFixed(2)}`,
                            icono: 'fa-money-bill-wave',
                            color: 'var(--accent-green)'
                        });
                    });
                }
            });
            
            verTodoGastos.forEach(g => {
                actividades.push({
                    tipo: 'gasto',
                    fecha: new Date(g.fecha || 0),
                    texto: `Gasto: ${g.descripcion || 'Sin descripción'}`,
                    detalle: `R$ ${(parseFloat(g.valor) || 0).toFixed(2)}`,
                    icono: 'fa-wallet',
                    color: 'var(--accent-red)'
                });
            });
            
            actividades.sort((a, b) => b.fecha - a.fecha);
            
            if (actividades.length === 0) {
                container.innerHTML = '<div class="card-dark"><p class="text-secondary text-center py-4">No hay actividad registrada</p></div>';
                return;
            }
            
            container.innerHTML = `
            <div class="card-dark">
                <div style="max-height: 500px; overflow-y: auto;">
                    ${actividades.map(a => {
                        const fechaStr = a.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        return `
                        <div class="d-flex align-items-center gap-3 py-3 border-bottom" style="border-color: var(--border-color) !important;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${a.color}20; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${a.icono}" style="color: ${a.color};"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${a.texto}</strong>
                                <br><small class="text-secondary">${fechaStr}</small>
                            </div>
                            <span style="color: ${a.color}; font-weight: bold;">${a.detalle}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderVerTodoCarteras(container) {
            const busqueda = (document.getElementById('vtBuscador')?.value || '').toLowerCase().trim();
            
            let carterasFiltradas = verTodoCarteras;
            if (busqueda) {
                carterasFiltradas = verTodoCarteras.filter(c => 
                    (c.nombre || '').toLowerCase().includes(busqueda) ||
                    (c.descripcion || '').toLowerCase().includes(busqueda)
                );
            }
            
            if (carterasFiltradas.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${busqueda ? 'No se encontraron carteras para "' + busqueda + '"' : 'Este usuario no tiene carteras'}</p></div>`;
                return;
            }
            
            container.innerHTML = `
            <div class="row g-3">
                ${carterasFiltradas.map(cartera => {
                    const color = cartera.color || '#00d4ff';
                    const clientesCartera = verTodoClientes.filter(c => c.carteraId === cartera.id || c.carteraId === cartera._id?.toString());
                    const gastosCartera = verTodoGastos.filter(g => g.carteraId === cartera.id || g.carteraId === cartera._id?.toString());
                    
                    const totalClientes = clientesCartera.length;
                    const totalPrestado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                    const totalCobrado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                    const totalPendiente = clientesCartera.reduce((s, c) => {
                        const total = parseFloat(c.totalAPagar) || 0;
                        const pagado = parseFloat(c.montoPagado) || 0;
                        return s + (total - pagado);
                    }, 0);
                    const totalGastos = gastosCartera.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                    
                    const fechaCreacion = cartera.createdAt ? new Date(cartera.createdAt).toLocaleDateString('es-ES') : '-';
                    
                    return `
                    <div class="col-md-6 col-lg-4">
                        <div class="card-dark h-100" style="border-left: 4px solid ${color};">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <div>
                                    <h5 style="color: ${color}; margin-bottom: 5px;">
                                        <i class="fas fa-folder me-2"></i>${cartera.nombre || 'Sin nombre'}
                                        ${cartera.esPrincipal ? '<span class="badge" style="background: var(--accent-yellow); color: #000; font-size: 0.65rem; margin-left: 8px;">Principal</span>' : ''}
                                    </h5>
                                    <small class="text-secondary">${cartera.descripcion || 'Sin descripción'}</small>
                                </div>
                                <span class="badge" style="background: ${color}20; color: ${color};">
                                    <i class="fas fa-lock me-1"></i>Protegida
                                </span>
                            </div>
                            
                            <div class="row g-2 mb-3">
                                <div class="col-6">
                                    <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-cyan);">${totalClientes}</div>
                                        <small class="text-secondary">Clientes</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-green);">R$ ${totalPrestado.toFixed(0)}</div>
                                        <small class="text-secondary">Prestado</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-yellow);">R$ ${totalCobrado.toFixed(0)}</div>
                                        <small class="text-secondary">Cobrado</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div style="background: var(--bg-hover); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-red);">R$ ${totalPendiente.toFixed(0)}</div>
                                        <small class="text-secondary">Pendiente</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex justify-content-between align-items-center" style="border-top: 1px solid var(--border-color); padding-top: 12px;">
                                <small class="text-secondary"><i class="fas fa-calendar me-1"></i>Creada: ${fechaCreacion}</small>
                                <small style="color: var(--accent-red);"><i class="fas fa-wallet me-1"></i>Gastos: R$ ${totalGastos.toFixed(0)}</small>
                            </div>
                        </div>
                    </div>`;
                }).join('')}
            </div>`;
        }
        // ========== FIN VER TODO TRABAJADOR ==========

        // ========== BACKUPS POR TRABAJADOR ==========
        let backupTrabajadorId = null;
        let backupTrabajadorNombre = null;
        let backupTrabajadorBlocked = false;

        async function verBackupsTrabajador(userId, nombre) {
            backupTrabajadorId = userId;
            backupTrabajadorNombre = nombre;
            document.getElementById('backupTrabajadorNombre').textContent = nombre;
            
            // Cargar datos del trabajador
            try {
                // Obtener estado de backupBlocked del usuario
                const usersRes = await fetch(API_URL + '/api/users');
                const allUsers = await usersRes.json();
                const targetUser = allUsers.find(u => u.id === userId || u._id === userId || u.id?.toString() === userId?.toString());
                backupTrabajadorBlocked = targetUser?.backupBlocked || false;
                updateBackupBlockButton();
                
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                const userClients = Array.isArray(allClients) ? allClients.filter(c => 
                    c.creadoPor === userId || 
                    c.creadoPor?.toString() === userId?.toString()
                ) : [];
                
                const gastosRes = await fetch(API_URL + '/api/gastos?userId=' + userId);
                const gastosData = await gastosRes.json();
                const userGastos = Array.isArray(gastosData) ? gastosData : [];
                
                const totalPrestado = userClients.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalGastos = userGastos.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                document.getElementById('btClientes').textContent = userClients.length;
                document.getElementById('btPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('btGastos').textContent = 'R$ ' + totalGastos.toFixed(2);
                
                // Cargar backups del trabajador
                await cargarBackupsTrabajador();
                
                showSection('adminBackupsTrabajador');
            } catch (e) {
                console.error('Error:', e);
                alert('Error al cargar datos');
            }
        }
        
        function updateBackupBlockButton() {
            const btn = document.getElementById('btnToggleBackupBlock');
            if (backupTrabajadorBlocked) {
                btn.style.background = 'var(--accent-red)';
                btn.style.color = '#fff';
                btn.innerHTML = '<i class="fas fa-lock"></i> Bloqueado';
            } else {
                btn.style.background = 'var(--accent-green)';
                btn.style.color = '#000';
                btn.innerHTML = '<i class="fas fa-lock-open"></i> Desbloqueado';
            }
        }
        
        async function toggleBackupBlock() {
            if (!backupTrabajadorId) return;
            
            const action = backupTrabajadorBlocked ? 'desbloquear' : 'bloquear';
            if (!confirm(`¿${action.charAt(0).toUpperCase() + action.slice(1)} el uso de backups para ${backupTrabajadorNombre}?`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + backupTrabajadorId + '/toggle-backup-block', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    backupTrabajadorBlocked = data.backupBlocked;
                    updateBackupBlockButton();
                    alert(data.backupBlocked ? '🔒 Backups bloqueados para ' + backupTrabajadorNombre : '🔓 Backups desbloqueados para ' + backupTrabajadorNombre);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo cambiar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function cargarBackupsTrabajador() {
            try {
                const res = await fetch(API_URL + '/api/admin/backups-trabajador/' + backupTrabajadorId);
                const backups = await res.json();
                const container = document.getElementById('backupsTrabajadorList');
                
                if (backups.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center py-3">No hay backups para este trabajador. Crea uno ahora.</p>';
                    return;
                }
                
                container.innerHTML = backups.map((b, i) => {
                    const fecha = new Date(b.fecha).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const nombreBackup = b.nombre || `Backup ${fecha}`;
                    return `
                    <div class="d-flex justify-content-between align-items-center py-2 ${i > 0 ? 'border-top' : ''}" style="border-color: var(--border-color) !important;">
                        <div>
                            <strong><i class="fas fa-file-archive me-2" style="color: var(--accent-yellow);"></i>${nombreBackup}</strong>
                            <br><small class="text-secondary">${fecha} - ${b.clientes || 0} clientes, ${b.gastos || 0} gastos</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;" onclick="restaurarBackupTrabajador('${b.id}')" title="Restaurar">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="eliminarBackupTrabajador('${b.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('Error cargando backups:', e);
            }
        }

        async function crearBackupTrabajador() {
            if (!backupTrabajadorId) return;
            try {
                const res = await fetch(API_URL + '/api/admin/backup-trabajador/' + backupTrabajadorId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    mostrarMensajeExito('✅ Backup creado correctamente');
                    cargarBackupsTrabajador();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function restaurarBackupTrabajador(backupId) {
            const password = prompt('🔐 RESTAURAR BACKUP DE ' + backupTrabajadorNombre.toUpperCase() + '\n\n⚠️ Esto reemplazará TODOS los datos de este trabajador con los del backup.\n\nIngresa la contraseña para continuar:');
            
            if (!password) return;
            if (password !== 'Pipe16137356') {
                alert('❌ Contraseña incorrecta');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore-trabajador/' + backupId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Backup restaurado correctamente para ' + backupTrabajadorNombre);
                    verBackupsTrabajador(backupTrabajadorId, backupTrabajadorNombre);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function eliminarBackupTrabajador(backupId) {
            if (!confirm('¿Eliminar este backup?')) return;
            try {
                const res = await fetch(API_URL + '/api/admin/delete-backup-trabajador/' + backupId, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('Backup eliminado');
                    cargarBackupsTrabajador();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        // ========== FIN BACKUPS POR TRABAJADOR ==========

        function verClienteAdmin(clienteId, userId) {
            const cliente = adminAllClients.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            const tipoLabels = { nuevo: '🆕 Nuevo', bueno: '✅ Buen Cliente', regular: '⚠️ Regular', malo: '❌ Mala Paga' };
            const tipoLabel = tipoLabels[cliente.tipoCliente] || '🆕 Nuevo';
            const restante = (cliente.totalAPagar || 0) - (cliente.montoPagado || 0);
            
            const info = `
📋 DATOS DEL CLIENTE

👤 Nombre: ${cliente.nombre}
📞 Teléfono: ${cliente.telefono || 'No registrado'}
📍 Ubicación: ${cliente.ubicacion || 'No registrada'}
⭐ Tipo: ${tipoLabel}
📝 Notas: ${cliente.notas || 'Sin notas'}

💰 INFORMACIÓN FINANCIERA

💵 Prestado: R$ ${(cliente.montoTotal || 0).toFixed(2)}
📊 Comisión: ${cliente.comisionPorcentaje || 20}%
💳 Total a Pagar: R$ ${(cliente.totalAPagar || 0).toFixed(2)}
✅ Cobrado: R$ ${(cliente.montoPagado || 0).toFixed(2)}
❌ Restante: R$ ${restante.toFixed(2)}
📅 Parcelas: ${cliente.parcelasPagas || 0}/${cliente.numeroParcelas}
🔄 Estado: ${cliente.estado}
            `.trim();
            
            alert(info);
        }

        async function toggleBlockUser(userId) {
            if (!confirm('¿Estás seguro de cambiar el estado de este usuario?')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId + '/toggle-block', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    renderAdminUsuarios();
                } else {
                    alert(data.error || 'Error al cambiar estado');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function darAccesoGratis() {
            const email = document.getElementById('emailAccesoGratis').value.trim();
            if (!email) {
                alert('Ingresa el email del usuario');
                return;
            }
            
            if (!confirm(`¿Dar acceso GRATIS a ${email}?\n\nSe creará su cuenta sin necesidad de pago.`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/confirmar-pago-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Cuenta activada!\n\nUsuario: ' + data.user.nombre + '\nEmail: ' + data.user.email + '\n\nYa puede iniciar sesión.');
                    document.getElementById('emailAccesoGratis').value = '';
                    renderAdminUsuarios();
                } else {
                    alert('❌ ' + (data.error || 'Error al activar cuenta'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function activarUsuarioPendiente(email) {
            if (!confirm(`¿Activar cuenta de ${email} GRATIS?`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/confirmar-pago-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Cuenta activada! El usuario ya puede iniciar sesión.');
                    renderAdminUsuarios();
                } else {
                    alert('❌ ' + (data.error || 'Error al activar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function rechazarUsuarioPendiente(email) {
            if (!confirm(`¿Rechazar y eliminar solicitud de ${email}?\n\nEl usuario tendrá que registrarse de nuevo.`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/rechazar-usuario-pendiente', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('Usuario rechazado');
                    renderAdminUsuarios();
                } else {
                    alert('Error al rechazar');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function cargarUsuariosPendientesNuevos() {
            try {
                const res = await fetch(API_URL + '/api/pending-users');
                if (!res.ok) {
                    console.log('Error al cargar pendientes:', res.status);
                    return;
                }
                const pendientes = await res.json();
                
                const section = document.getElementById('pendientesNuevosSection');
                const list = document.getElementById('pendientesNuevosList');
                const badge = document.getElementById('pendientesNuevosBadge');
                
                if (!section || !list || !badge) return;
                
                if (pendientes.length > 0) {
                    section.style.display = 'block';
                    badge.textContent = pendientes.length;
                    list.innerHTML = pendientes.map(u => {
                        const fecha = u.createdAt ? new Date(u.createdAt).toLocaleString('pt-BR') : 'Desconocida';
                        return `
                        <div class="d-flex justify-content-between align-items-center py-3 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <strong style="color: var(--accent-purple);">
                                    <i class="fas fa-user-clock me-2"></i>${u.nombre}
                                </strong>
                                <span class="badge ms-2" style="background: var(--accent-cyan); color: #000;">@${u.username}</span>
                                <br><small class="text-secondary"><i class="fas fa-envelope me-1"></i>${u.email}</small>
                                <br><small class="text-secondary"><i class="fas fa-clock me-1"></i>${fecha}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm" style="background: var(--accent-green); color: #000;" onclick="activarUsuarioPendiente('${u.email}')">
                                    <i class="fas fa-check me-1"></i>Activar
                                </button>
                                <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="rechazarUsuarioPendiente('${u.email}')">
                                    <i class="fas fa-times me-1"></i>Rechazar
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    section.style.display = 'none';
                }
            } catch (e) {
                console.log('Error cargando pendientes (esto es normal si no hay pendientes):', e.message);
                // Ocultar sección si hay error
                const section = document.getElementById('pendientesNuevosSection');
                if (section) section.style.display = 'none';
            }
        }

        async function cancelarSuscripcion(userId, nombre) {
            if (!confirm(`⚠️ ¿Cancelar suscripción de ${nombre}?\n\nEsto:\n- Cerrará su sesión\n- Tendrá que pagar de nuevo para entrar\n- NO elimina sus clientes ni datos`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + userId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paid: false, activo: false, pagado: false })
                });
                const data = await res.json();
                
                // También cerrar sus sesiones
                await fetch(API_URL + '/api/sessions/user/' + userId, { method: 'DELETE' });
                
                if (data.success) {
                    alert('✅ Suscripción cancelada. El usuario tendrá que pagar de nuevo.');
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo cancelar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function eliminarDatosTrabajador(userId, nombre) {
            const confirmacion = confirm(`🗑️ ELIMINAR DATOS DE: ${nombre}\n\n⚠️ Esto eliminará PERMANENTEMENTE:\n- Todos sus clientes\n- Todos sus gastos\n- Todas sus sesiones\n- Sus backups\n- SU CUENTA (podrá registrarse de nuevo)\n\n¿Continuar?`);
            if (!confirmacion) return;
            
            const password = prompt('🔐 Ingresa tu contraseña de ADMIN para confirmar:');
            if (!password) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/eliminar-datos-trabajador', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        adminPassword: password,
                        trabajadorId: userId,
                        adminId: currentUser.id
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert(`✅ Eliminado completamente:\n- ${data.deleted.clientes} clientes\n- ${data.deleted.gastos} gastos\n- ${data.deleted.sesiones} sesiones\n- ${data.deleted.backups} backups\n- Cuenta: ${data.deleted.cuenta ? 'Eliminada' : 'No eliminada'}`);
                    renderAdminUsuarios();
                } else {
                    alert('❌ Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function toggleEditKey(userId) {
            const user = allUsers.find(u => u.id === userId || u._id === userId);
            const currentStatus = user?.editKeyEnabled ? 'ACTIVADA' : 'DESACTIVADA';
            const newStatus = user?.editKeyEnabled ? 'DESACTIVAR' : 'ACTIVAR';
            
            if (!confirm(`La llave de edición está ${currentStatus}.\n\n¿${newStatus} la llave de edición para este usuario?\n\nCon la llave ACTIVADA podrá editar préstamos e información de clientes.`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + userId + '/toggle-edit-key', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert('🔑 ' + data.message);
                    renderAdminUsuarios();
                } else {
                    alert(data.error || 'Error al cambiar llave');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // ============ RECUPERAR CUENTA DE USUARIO (ADMIN) ============
        async function recuperarCuentaUsuario(userId, nombre, email) {
            // Primero obtener el usuario para ver su email de recuperación actual
            let recoveryEmailActual = 'No configurado';
            try {
                const userRes = await fetch(API_URL + '/api/users/' + userId);
                const userData = await userRes.json();
                if (userData.recoveryEmail) {
                    recoveryEmailActual = userData.recoveryEmail;
                }
            } catch(e) {}
            
            const opcion = prompt(
                `🛟 RECUPERAR CUENTA DE: ${nombre}\n` +
                `Email actual: ${email}\n` +
                `Email de recuperación: ${recoveryEmailActual}\n\n` +
                `¿Qué deseas hacer?\n\n` +
                `1 = Cambiar email del usuario\n` +
                `2 = Cambiar contraseña\n` +
                `3 = Cambiar email Y contraseña\n` +
                `4 = Cambiar email de recuperación\n\n` +
                `Escribe 1, 2, 3 o 4:`
            );
            
            if (!opcion || !['1', '2', '3', '4'].includes(opcion)) return;
            
            // Opción 4: Cambiar email de recuperación
            if (opcion === '4') {
                const nuevoRecoveryEmail = prompt(
                    `📧 CAMBIAR EMAIL DE RECUPERACIÓN\n\n` +
                    `Usuario: ${nombre}\n` +
                    `Email de recuperación actual: ${recoveryEmailActual}\n\n` +
                    `Ingresa el nuevo email de recuperación:`
                );
                
                if (!nuevoRecoveryEmail) return;
                if (!nuevoRecoveryEmail.includes('@')) {
                    return alert('Email inválido');
                }
                
                try {
                    const res = await fetch(API_URL + '/api/users/' + userId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ recoveryEmail: nuevoRecoveryEmail })
                    });
                    const data = await res.json();
                    
                    if (data.success) {
                        alert(`✅ Email de recuperación actualizado!\n\nNuevo email: ${nuevoRecoveryEmail}`);
                        renderAdminUsuarios();
                    } else {
                        alert('Error: ' + (data.error || 'No se pudo actualizar'));
                    }
                } catch (e) {
                    alert('Error de conexión');
                }
                return;
            }
            
            let nuevoEmail = null;
            let nuevaPassword = null;
            
            if (opcion === '1' || opcion === '3') {
                nuevoEmail = prompt(`Ingresa el NUEVO email para ${nombre}:`);
                if (!nuevoEmail || !nuevoEmail.includes('@')) {
                    return alert('Email inválido');
                }
            }
            
            if (opcion === '2' || opcion === '3') {
                nuevaPassword = prompt(`Ingresa la NUEVA contraseña para ${nombre}:`);
                if (!nuevaPassword || nuevaPassword.length < 4) {
                    return alert('La contraseña debe tener al menos 4 caracteres');
                }
                const confirmarPassword = prompt(`Confirma la contraseña:`);
                if (nuevaPassword !== confirmarPassword) {
                    return alert('Las contraseñas no coinciden');
                }
            }
            
            try {
                const res = await fetch(API_URL + '/api/admin/recuperar-cuenta', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId, 
                        nuevoEmail: nuevoEmail,
                        nuevaPassword: nuevaPassword
                    })
                });
                const data = await res.json();
                
                if (data.success) {
                    let mensaje = '✅ Cuenta actualizada:\n\n';
                    if (data.emailCambiado) mensaje += `📧 Email cambiado a: ${nuevoEmail}\n`;
                    if (data.passwordCambiado) mensaje += `🔑 Contraseña cambiada correctamente\n`;
                    alert(mensaje);
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function toggleUserClients(userId) {
            const div = document.getElementById('clients-' + userId);
            const icon = document.getElementById('icon-' + userId);
            
            if (div.style.display === 'none') {
                // Cargar carteras del usuario si aún no están cargadas
                if (!div.dataset.loaded) {
                    div.innerHTML = '<div class="text-center py-3"><i class="fas fa-spinner fa-spin"></i> Cargando carteras...</div>';
                    
                    try {
                        // Cargar carteras del usuario
                        const carterasRes = await fetch(API_URL + '/api/carteras/' + userId);
                        const carterasData = await carterasRes.json();
                        const carteras = carterasData.success && Array.isArray(carterasData.carteras) ? carterasData.carteras : [];
                        
                        // Cargar clientes del usuario
                        const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                        const allClients = await clientsRes.json();
                        const userClients = Array.isArray(allClients) ? allClients.filter(c => 
                            c.creadoPor === userId || 
                            c.creadoPor?.toString() === userId?.toString() ||
                            c.userId === userId ||
                            c.userId?.toString() === userId?.toString()
                        ) : [];
                        
                        // Guardar datos para búsqueda
                        div.dataset.carteras = JSON.stringify(carteras);
                        div.dataset.clientes = JSON.stringify(userClients);
                        
                        if (carteras.length === 0) {
                            div.innerHTML = '<p class="text-secondary mb-0 py-2">Sin carteras</p>';
                        } else {
                            // Agregar buscador de carteras
                            let html = `
                            <div class="mb-3">
                                <div class="input-group">
                                    <span class="input-group-text" style="background: var(--bg-hover); border-color: var(--border-color);">
                                        <i class="fas fa-search" style="color: var(--accent-cyan);"></i>
                                    </span>
                                    <input type="text" 
                                           class="form-control form-control-dark" 
                                           id="search-carteras-${userId}"
                                           placeholder="Buscar cartera por nombre..."
                                           oninput="filtrarCarterasUsuario('${userId}')"
                                           style="border-left: none;">
                                </div>
                            </div>
                            <div id="carteras-list-${userId}">`;
                            
                            // Renderizar carteras con sus clientes
                            html += carteras.map(cartera => {
                                const clientesCartera = userClients.filter(c => 
                                    c.carteraId === cartera.id || 
                                    c.carteraId === cartera._id?.toString()
                                );
                                const totalClientes = clientesCartera.length;
                                const totalPrestado = clientesCartera.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                                const carteraColor = cartera.color || '#00d4ff';
                                const carteraId = cartera.id || cartera._id;
                                const carteraNombre = cartera.nombre || 'Sin nombre';
                                
                                return `
                                <div class="cartera-item mb-3 p-3" data-cartera-nombre="${carteraNombre.toLowerCase()}" style="background: var(--bg-hover); border-radius: 8px; border-left: 3px solid ${carteraColor};">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div style="cursor: pointer; flex: 1;" onclick="toggleCarteraClients('${userId}', '${carteraId}')">
                                            <strong style="color: ${carteraColor};">
                                                <i class="fas fa-folder me-2"></i>${carteraNombre}
                                            </strong>
                                            <span class="badge-status badge-active ms-2">${totalClientes} clientes</span>
                                            <span style="color: var(--accent-green); margin-left: 10px;">R$ ${totalPrestado.toFixed(2)}</span>
                                        </div>
                                        <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation(); toggleCarteraClients('${userId}', '${carteraId}')">
                                            <i class="fas fa-chevron-down" id="cartera-icon-${carteraId}"></i>
                                        </button>
                                    </div>
                                    <div id="cartera-clients-${carteraId}" style="display: none; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border-color);">
                                        ${clientesCartera.length === 0 ? '<p class="text-secondary mb-0">Sin clientes</p>' : 
                                        clientesCartera.map(c => {
                                            const fechaCreacion = c.fechaCreacion || c.fechaInicio || c.createdAt;
                                            const fechaStr = fechaCreacion ? new Date(fechaCreacion).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Sin fecha';
                                            return `
                                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                                                <div>
                                                    <strong>${c.nombre}</strong>
                                                    <br><small class="text-secondary">R$ ${(c.montoTotal || 0).toFixed(2)} prestado</small>
                                                    <br><small style="color: var(--accent-cyan);"><i class="fas fa-calendar-alt me-1"></i>${fechaStr}</small>
                                                </div>
                                                <button class="btn btn-sm btn-primary-custom" onclick="event.stopPropagation(); verClienteAdmin('${c.id}', '${userId}')">
                                                    <i class="fas fa-eye me-1"></i>VER
                                                </button>
                                            </div>
                                        `}).join('')}
                                    </div>
                                </div>`;
                            }).join('');
                            
                            html += '</div>';
                            div.innerHTML = html;
                        }
                        
                        div.dataset.loaded = 'true';
                    } catch (e) {
                        console.error('Error cargando carteras:', e);
                        div.innerHTML = '<p class="text-danger mb-0 py-2">Error al cargar carteras</p>';
                    }
                }
                
                div.style.display = 'block';
                icon.className = 'fas fa-chevron-up';
            } else {
                div.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        }
        
        // Nueva función para filtrar carteras por nombre
        function filtrarCarterasUsuario(userId) {
            const searchInput = document.getElementById('search-carteras-' + userId);
            const searchTerm = searchInput.value.toLowerCase().trim();
            const carterasList = document.getElementById('carteras-list-' + userId);
            const carteraItems = carterasList.querySelectorAll('.cartera-item');
            
            let visibleCount = 0;
            carteraItems.forEach(item => {
                const carteraNombre = item.dataset.carteraNombre || '';
                if (carteraNombre.includes(searchTerm)) {
                    item.style.display = 'block';
                    visibleCount++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostrar mensaje si no hay resultados
            let noResultsMsg = carterasList.querySelector('.no-results-msg');
            if (visibleCount === 0 && searchTerm !== '') {
                if (!noResultsMsg) {
                    noResultsMsg = document.createElement('p');
                    noResultsMsg.className = 'no-results-msg text-secondary text-center py-3';
                    noResultsMsg.textContent = 'No se encontraron carteras con ese nombre';
                    carterasList.appendChild(noResultsMsg);
                }
                noResultsMsg.style.display = 'block';
            } else if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }
        
        // Nueva función para expandir/colapsar clientes de una cartera
        function toggleCarteraClients(userId, carteraId) {
            const div = document.getElementById('cartera-clients-' + carteraId);
            const icon = document.getElementById('cartera-icon-' + carteraId);
            if (div && icon) {
                if (div.style.display === 'none') {
                    div.style.display = 'block';
                    icon.className = 'fas fa-chevron-up';
                } else {
                    div.style.display = 'none';
                    icon.className = 'fas fa-chevron-down';
                }
            }
        }

        // ============ SISTEMA DE LLAVE DE EDICIÓN DE CLIENTES ============
        
        async function inicializarSistemaEditLock() {
            console.log('>>> inicializarSistemaEditLock llamada, currentUser:', currentUser?.id);
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id);
                const user = await res.json();
                console.log('>>> Usuario obtenido:', user.editPassword, 'editKeyEnabled:', user.editKeyEnabled);
                
                userHasEditPassword = user.editPassword === true;
                const adminKeyEnabled = user.editKeyEnabled === true;
                
                const lockSystem = document.getElementById('editLockSystem');
                const createPassword = document.getElementById('editCreatePassword');
                const configModal = document.getElementById('editConfigModal');
                const adminBlockedMsg = document.getElementById('editAdminBlocked');
                
                // Si el admin bloqueó la llave, mostrar mensaje y no permitir nada
                if (!adminKeyEnabled && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                    if (lockSystem) lockSystem.style.display = 'none';
                    if (createPassword) createPassword.style.display = 'none';
                    if (configModal) configModal.style.display = 'none';
                    if (adminBlockedMsg) adminBlockedMsg.style.display = 'block';
                    editUnlocked = false;
                    editLockInitialized = true;
                    renderClientes(); // Actualizar tabla sin botones
                    return;
                }
                
                // Admin habilitó la llave, mostrar sistema normal
                if (adminBlockedMsg) adminBlockedMsg.style.display = 'none';
                
                // Recuperar estado de sessionStorage si existe
                const savedUnlockState = sessionStorage.getItem('finangest_edit_unlocked_' + currentUser.id);
                if (savedUnlockState === 'true') {
                    editUnlocked = true;
                    editLockInitialized = true;
                }
                
                console.log('Sistema edit lock - tiene contraseña:', userHasEditPassword, 'desbloqueado:', editUnlocked);
                
                if (userHasEditPassword) {
                    if (lockSystem) lockSystem.style.display = 'block';
                    if (createPassword) createPassword.style.display = 'none';
                    if (configModal) configModal.style.display = 'none';
                    
                    if (!editLockInitialized) {
                        editUnlocked = false;
                        editLockInitialized = true;
                    }
                    actualizarEstadoLlaveEdit();
                } else {
                    if (lockSystem) lockSystem.style.display = 'none';
                    if (createPassword) createPassword.style.display = 'block';
                    if (configModal) configModal.style.display = 'none';
                    editUnlocked = true;
                    editLockInitialized = true;
                }
                renderClientes(); // Actualizar tabla con estado correcto de botones
            } catch (e) {
                console.error('Error inicializando sistema edit lock:', e);
            }
        }
        
        function actualizarEstadoLlaveEdit() {
            const icon = document.getElementById('editLockIcon');
            const iconI = document.getElementById('editLockIconI');
            const title = document.getElementById('editLockTitle');
            const desc = document.getElementById('editLockDesc');
            const passwordInput = document.getElementById('editUnlockPassword');
            const toggleBtn = document.getElementById('editToggleBtn');
            const toggleBtnIcon = document.getElementById('editToggleBtnIcon');
            const lockSystem = document.getElementById('editLockSystem');
            
            if (editUnlocked) {
                if (icon) {
                    icon.style.background = 'var(--accent-green)';
                    icon.style.boxShadow = '0 0 20px rgba(0,230,118,0.6)';
                }
                if (iconI) iconI.className = 'fas fa-lock-open';
                if (title) {
                    title.innerHTML = '🔓 Edición Desbloqueada';
                    title.style.color = 'var(--accent-green)';
                }
                if (desc) desc.innerHTML = 'Puedes editar clientes libremente';
                if (passwordInput) passwordInput.style.display = 'none';
                if (toggleBtn) toggleBtn.style.background = 'var(--accent-green)';
                if (toggleBtnIcon) toggleBtnIcon.className = 'fas fa-lock-open';
                if (lockSystem) lockSystem.style.borderColor = 'var(--accent-green)';
            } else {
                if (icon) {
                    icon.style.background = 'var(--accent-red)';
                    icon.style.boxShadow = '0 0 20px rgba(255,82,82,0.6)';
                }
                if (iconI) iconI.className = 'fas fa-lock';
                if (title) {
                    title.innerHTML = '🔒 Edición Bloqueada';
                    title.style.color = 'var(--accent-red)';
                }
                if (desc) desc.innerHTML = 'Ingresa tu contraseña para editar clientes';
                if (passwordInput) passwordInput.style.display = 'block';
                if (toggleBtn) toggleBtn.style.background = 'var(--accent-red)';
                if (toggleBtnIcon) toggleBtnIcon.className = 'fas fa-lock';
                if (lockSystem) lockSystem.style.borderColor = 'var(--accent-red)';
            }
        }
        
        function bloquearEdit() {
            editUnlocked = false;
            sessionStorage.removeItem('finangest_edit_unlocked_' + currentUser.id);
            actualizarEstadoLlaveEdit();
            renderClientes(); // Actualizar botones en la tabla
        }
        
        async function desbloquearEdit() {
            const password = document.getElementById('editUnlockPassword').value;
            if (!password) {
                alert('Ingresa tu contraseña');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/verify-edit-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (data.valid) {
                    editUnlocked = true;
                    sessionStorage.setItem('finangest_edit_unlocked_' + currentUser.id, 'true');
                    document.getElementById('editUnlockPassword').value = '';
                    actualizarEstadoLlaveEdit();
                    renderClientes(); // Actualizar botones en la tabla
                } else {
                    alert('❌ Contraseña incorrecta');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function toggleEditLockBtn() {
            if (editUnlocked) {
                bloquearEdit();
            } else {
                desbloquearEdit();
            }
        }
        
        async function crearEditPassword() {
            const password = document.getElementById('newEditPass').value;
            const confirm = document.getElementById('confirmEditPass').value;
            
            if (!password || password.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            if (password !== confirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/edit-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Contraseña creada.\nAhora deberás desbloquear para editar clientes.');
                    editUnlocked = false;
                    userHasEditPassword = true;
                    document.getElementById('newEditPass').value = '';
                    document.getElementById('confirmEditPass').value = '';
                    inicializarSistemaEditLock();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo guardar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function mostrarConfigEditPassword() {
            const configModal = document.getElementById('editConfigModal');
            if (configModal.style.display === 'block') {
                configModal.style.display = 'none';
            } else {
                configModal.style.display = 'block';
                
                const section = document.getElementById('editPasswordSection');
                section.innerHTML = `
                    <p class="text-secondary mb-3">Para cambiar tu contraseña de edición, te enviaremos un código a tu email.</p>
                    <button class="btn" style="background: var(--accent-yellow); color: #000;" onclick="iniciarRecuperacionEditPassword()">
                        <i class="fas fa-envelope me-2"></i>Enviar código al email
                    </button>
                `;
            }
        }
        
        async function iniciarRecuperacionEditPassword() {
            if (!confirm('Se enviará un código a tu email para restablecer la contraseña de edición.\n\n¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/edit-password-reset', {
                    method: 'POST'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Código enviado a tu email');
                    
                    const section = document.getElementById('editPasswordSection');
                    if (section) {
                        section.innerHTML = `
                            <p class="text-secondary mb-2">Ingresa el código que recibiste y tu nueva contraseña:</p>
                            <div class="row g-2">
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Código</label>
                                    <input type="text" id="resetEditCode" class="form-control form-control-dark text-center" placeholder="000000" maxlength="6" style="letter-spacing: 3px;">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Nueva contraseña</label>
                                    <input type="password" id="newEditPassword" class="form-control form-control-dark" placeholder="Mínimo 4">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Confirmar</label>
                                    <input type="password" id="confirmEditPassword" class="form-control form-control-dark" placeholder="Confirmar">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label" style="visibility: hidden;">.</label>
                                    <button class="btn btn-success-custom w-100" onclick="confirmarRecuperacionEditPassword()">
                                        <i class="fas fa-check me-1"></i>Restablecer
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <a href="#" onclick="mostrarConfigEditPassword(); return false;" style="color: var(--text-secondary); font-size: 0.85rem;">
                                    <i class="fas fa-arrow-left me-1"></i>Volver
                                </a>
                            </div>
                        `;
                    }
                } else {
                    alert('Error: ' + (data.error || 'No se pudo enviar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function confirmarRecuperacionEditPassword() {
            const codigo = document.getElementById('resetEditCode').value;
            const newPassword = document.getElementById('newEditPassword').value;
            const confirmPassword = document.getElementById('confirmEditPassword').value;
            
            if (!codigo || codigo.length !== 6) {
                alert('Ingresa el código de 6 dígitos');
                return;
            }
            if (!newPassword || newPassword.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            if (newPassword !== confirmPassword) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/edit-password-confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codigo, newPassword })
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Contraseña restablecida correctamente');
                    editUnlocked = false;
                    cerrarConfigEditPassword();
                    actualizarEstadoLlaveEdit();
                } else {
                    alert('Error: ' + (data.error || 'Código inválido'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function cerrarConfigEditPassword() {
            document.getElementById('editConfigModal').style.display = 'none';
        }
        
        // Función para verificar si puede editar (usada por otras funciones)
        function canEditClients() {
            if (!userHasEditPassword) return true; // Sin contraseña = puede editar
            return editUnlocked;
        }

        // ============ FUNCIONES DE MIS BACKUPS (TRABAJADORES) ============
        async function cargarMisBackups() {
            try {
                // Verificar si el usuario tiene backups bloqueados
                const usersRes = await fetch(API_URL + '/api/users');
                const allUsers = await usersRes.json();
                const myUser = allUsers.find(u => u.id === currentUser.id || u._id === currentUser.id || u.id?.toString() === currentUser.id?.toString());
                
                if (myUser?.backupBlocked) {
                    document.getElementById('misBackupsList').innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-lock fa-3x mb-3" style="color: var(--accent-red);"></i>
                            <h5 style="color: var(--accent-red);">Backups Bloqueados</h5>
                            <p class="text-secondary">El administrador ha bloqueado el uso de backups para tu cuenta.</p>
                            <p class="text-secondary">Contacta al administrador si necesitas acceso.</p>
                        </div>`;
                    return;
                }
                
                const userId = currentUser.id || currentUser._id;
                const res = await fetch(API_URL + '/api/admin/backups-trabajador/' + userId);
                const backups = await res.json();
                const container = document.getElementById('misBackupsList');
                
                if (!backups || backups.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center py-3">No hay backups disponibles. Se crearán automáticamente.</p>';
                    return;
                }
                
                container.innerHTML = backups.map((b, i) => {
                    const fecha = new Date(b.fecha).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                    const backupId = b.id || b._id;
                    return `
                    <div class="d-flex justify-content-between align-items-center py-2 ${i > 0 ? 'border-top' : ''}" style="border-color: var(--border-color) !important;">
                        <div>
                            <strong><i class="fas fa-file-archive me-2" style="color: var(--accent-cyan);"></i>Backup ${fecha}</strong>
                            <br><small class="text-secondary">${fecha} - ${b.clientes || 0} clientes, ${b.gastos || 0} gastos ${b.auto ? '(Auto)' : '(Manual)'}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;" onclick="restaurarMiBackup('${backupId}')" title="Restaurar">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                document.getElementById('misBackupsList').innerHTML = '<p class="text-secondary text-center py-3">Error al cargar backups</p>';
            }
        }

        // ============ CONTRASEÑA DE BACKUPS (Sistema de Llave Individual) ============
        // Variables ya declaradas al inicio del script
        
        async function inicializarSistemaBackupLock() {
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id);
                const user = await res.json();
                
                // backupPassword ahora es true/false desde el API
                userHasBackupPassword = user.backupPassword === true;
                
                const lockSystem = document.getElementById('backupLockSystem');
                const createPassword = document.getElementById('backupCreatePassword');
                const configModal = document.getElementById('backupConfigModal');
                
                // Recuperar estado de sessionStorage si existe
                const savedUnlockState = sessionStorage.getItem('finangest_backup_unlocked_' + currentUser.id);
                if (savedUnlockState === 'true') {
                    backupUnlocked = true;
                    backupLockInitialized = true;
                }
                
                console.log('Sistema backup lock - tiene contraseña:', userHasBackupPassword, 'desbloqueado:', backupUnlocked, 'inicializado:', backupLockInitialized);
                
                if (userHasBackupPassword) {
                    // Tiene contraseña - mostrar sistema de llave
                    if (lockSystem) lockSystem.style.display = 'block';
                    if (createPassword) createPassword.style.display = 'none';
                    if (configModal) configModal.style.display = 'none';
                    
                    // Solo bloquear si es la primera vez que se inicializa en esta sesión
                    if (!backupLockInitialized) {
                        backupUnlocked = false;
                        backupLockInitialized = true;
                    }
                    actualizarEstadoLlaveBackup();
                } else {
                    // No tiene contraseña - mostrar formulario de creación
                    if (lockSystem) lockSystem.style.display = 'none';
                    if (createPassword) createPassword.style.display = 'block';
                    if (configModal) configModal.style.display = 'none';
                    backupUnlocked = true; // Sin contraseña = acceso libre
                }
            } catch (e) {
                console.error('Error inicializando sistema backup lock:', e);
            }
        }
        
        function actualizarEstadoLlaveBackup() {
            const icon = document.getElementById('backupLockIcon');
            const iconI = document.getElementById('backupLockIconI');
            const title = document.getElementById('backupLockTitle');
            const desc = document.getElementById('backupLockDesc');
            const passwordInput = document.getElementById('backupUnlockPassword');
            const toggleBtn = document.getElementById('backupToggleBtn');
            const toggleBtnIcon = document.getElementById('backupToggleBtnIcon');
            
            if (backupUnlocked) {
                // DESBLOQUEADO - Todo Verde
                if (icon) {
                    icon.style.background = 'var(--accent-green)';
                    icon.style.boxShadow = '0 0 20px rgba(0,230,118,0.6)';
                }
                if (iconI) iconI.className = 'fas fa-lock-open';
                if (title) {
                    title.innerHTML = '🔓 Backups Desbloqueados';
                    title.style.color = 'var(--accent-green)';
                }
                if (desc) desc.innerHTML = 'Puedes usar backups libremente';
                // Campo oculto, botón verde para bloquear
                if (passwordInput) passwordInput.style.display = 'none';
                if (toggleBtn) toggleBtn.style.background = 'var(--accent-green)';
                if (toggleBtnIcon) toggleBtnIcon.className = 'fas fa-lock-open';
            } else {
                // BLOQUEADO - Todo Rojo
                if (icon) {
                    icon.style.background = 'var(--accent-red)';
                    icon.style.boxShadow = '0 0 20px rgba(255,82,82,0.6)';
                }
                if (iconI) iconI.className = 'fas fa-lock';
                if (title) {
                    title.innerHTML = '🔒 Backups Bloqueados';
                    title.style.color = 'var(--accent-red)';
                }
                if (desc) desc.innerHTML = 'Ingresa tu contraseña para desbloquear';
                // Campo visible, botón rojo
                if (passwordInput) passwordInput.style.display = 'block';
                if (toggleBtn) toggleBtn.style.background = 'var(--accent-red)';
                if (toggleBtnIcon) toggleBtnIcon.className = 'fas fa-lock';
            }
        }
        
        async function desbloquearBackup() {
            const password = document.getElementById('backupUnlockPassword').value;
            if (!password) {
                alert('Ingresa tu contraseña');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/verify-backup-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (data.valid) {
                    backupUnlocked = true;
                    // Guardar estado en sessionStorage para mantenerlo entre navegaciones
                    sessionStorage.setItem('finangest_backup_unlocked_' + currentUser.id, 'true');
                    document.getElementById('backupUnlockPassword').value = '';
                    actualizarEstadoLlaveBackup();
                } else {
                    alert('❌ Contraseña incorrecta');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function bloquearBackup() {
            backupUnlocked = false;
            // Limpiar estado de sessionStorage
            sessionStorage.removeItem('finangest_backup_unlocked_' + currentUser.id);
            actualizarEstadoLlaveBackup();
        }
        
        function toggleBackupLockBtn() {
            // Botón único: si desbloqueado -> bloquear, si bloqueado -> desbloquear
            if (backupUnlocked) {
                bloquearBackup();
            } else {
                desbloquearBackup();
            }
        }
        
        // Funciones legacy (círculo grande ya no es clickeable)
        function clickLlaveBackup() { }
        async function toggleBackupLock() { toggleBackupLockBtn(); }
        
        async function crearBackupPassword() {
            const password = document.getElementById('newBackupPass').value;
            const confirm = document.getElementById('confirmBackupPass').value;
            
            if (!password || password.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            if (password !== confirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            try {
                const url = API_URL + '/api/users/' + currentUser.id + '/backup-password';
                console.log('Guardando contraseña backup para:', currentUser.id, 'URL:', url);
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                
                if (!res.ok) {
                    alert('Error HTTP: ' + res.status);
                    return;
                }
                
                const data = await res.json();
                console.log('Respuesta:', data);
                
                if (data.success) {
                    alert('✅ Contraseña creada.\nAhora deberás desbloquear la llave para usar backups.');
                    backupUnlocked = false;
                    userHasBackupPassword = true;
                    inicializarSistemaBackupLock();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo guardar'));
                }
            } catch (e) {
                console.error('Error guardando contraseña backup:', e);
                alert('Error de conexión: ' + e.message);
            }
        }
        
        function mostrarConfigBackupPassword() {
            const configModal = document.getElementById('backupConfigModal');
            // Toggle: si está visible lo oculta, si está oculto lo muestra
            if (configModal.style.display === 'none' || configModal.style.display === '') {
                configModal.style.display = 'block';
                
                const section = document.getElementById('backupPasswordSection');
                section.innerHTML = `
                    <p class="text-secondary mb-3">Para cambiar tu contraseña de backups, te enviaremos un código a tu email.</p>
                    <button class="btn" style="background: var(--accent-yellow); color: #000;" onclick="iniciarRecuperacionBackupPassword()">
                        <i class="fas fa-envelope me-2"></i>Enviar código al email
                    </button>
                `;
            } else {
                configModal.style.display = 'none';
            }
        }
        
        async function iniciarRecuperacionBackupPassword() {
            if (!confirm('Se enviará un código a tu email para restablecer la contraseña de backups.\n\n¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/backup-password-reset', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    // Asegurar que el modal esté visible
                    const configModal = document.getElementById('backupConfigModal');
                    if (configModal) configModal.style.display = 'block';
                    
                    // Mostrar formulario para ingresar código y nueva contraseña
                    const section = document.getElementById('backupPasswordSection');
                    if (section) {
                        section.innerHTML = `
                            <div class="alert" style="background: var(--accent-cyan); color: #000; padding: 10px; border-radius: 8px; margin-bottom: 15px;">
                                <i class="fas fa-envelope me-2"></i>Se envió un código a tu email. Revisa tu bandeja de entrada.
                            </div>
                            <div class="row g-2 align-items-end">
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Código</label>
                                    <input type="text" id="resetBackupCode" class="form-control form-control-dark" placeholder="6 dígitos" maxlength="6">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Nueva contraseña</label>
                                    <input type="password" id="newBackupPassword" class="form-control form-control-dark" placeholder="Mínimo 4">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label text-secondary" style="font-size: 0.85rem;">Confirmar</label>
                                    <input type="password" id="confirmBackupPassword" class="form-control form-control-dark" placeholder="Confirmar">
                                </div>
                                <div class="col-md-3">
                                    <button class="btn btn-success-custom w-100" onclick="confirmarRecuperacionBackupPassword()">
                                        <i class="fas fa-check me-1"></i>Restablecer
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2 d-flex justify-content-between">
                                <a href="#" onclick="mostrarConfigBackupPassword(); return false;" style="color: var(--text-secondary); font-size: 0.85rem;">
                                    <i class="fas fa-arrow-left me-1"></i>Volver
                                </a>
                                <a href="#" onclick="reenviarCodigoBackup(); return false;" style="color: var(--accent-cyan); font-size: 0.85rem;">
                                    <i class="fas fa-redo me-1"></i>Reenviar código
                                </a>
                            </div>
                        `;
                    }
                    alert('✅ Código enviado a tu email');
                } else {
                    alert('Error: ' + (data.error || 'No se pudo enviar el código'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function confirmarRecuperacionBackupPassword() {
            const codigo = document.getElementById('resetBackupCode').value;
            const newPass = document.getElementById('newBackupPassword').value;
            const confirmPass = document.getElementById('confirmBackupPassword').value;
            
            if (!codigo || codigo.length !== 6) {
                alert('Ingresa el código de 6 dígitos');
                return;
            }
            if (!newPass || newPass.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            if (newPass !== confirmPass) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/backup-password-confirm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code: codigo, newPassword: newPass })
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Contraseña restablecida correctamente');
                    backupUnlocked = false;
                    cerrarConfigBackupPassword();
                    actualizarEstadoLlaveBackup();
                } else {
                    alert('Error: ' + (data.error || 'Código incorrecto o expirado'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function reenviarCodigoBackup() {
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/backup-password-reset', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Código reenviado a tu email');
                } else {
                    alert('Error: ' + (data.error || 'No se pudo reenviar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function cerrarConfigBackupPassword() {
            document.getElementById('backupConfigModal').style.display = 'none';
        }
        
        async function actualizarContraseñaBackup() {
            const current = document.getElementById('currentBackupPassword').value;
            const password = document.getElementById('newBackupPassword').value;
            const confirm = document.getElementById('confirmBackupPassword').value;
            
            if (!current) {
                alert('Ingresa tu contraseña actual');
                return;
            }
            if (!password || password.length < 4) {
                alert('La nueva contraseña debe tener al menos 4 caracteres');
                return;
            }
            if (password !== confirm) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/backup-password', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ currentPassword: current, newPassword: password })
                });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Contraseña actualizada');
                    backupUnlocked = false;
                    cerrarConfigBackupPassword();
                    actualizarEstadoLlaveBackup();
                } else {
                    alert('Error: ' + (data.error || 'Contraseña actual incorrecta'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        function verificarAccesoBackups() {
            // Retorna true si puede usar backups (sin contraseña o desbloqueado)
            if (!userHasBackupPassword) return true;
            return backupUnlocked;
        }
        
        async function pedirContraseñaBackup() {
            const password = prompt('🔐 Ingresa tu contraseña de backups:');
            if (!password) return false;
            
            try {
                const res = await fetch(API_URL + '/api/users/' + currentUser.id + '/verify-backup-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });
                const data = await res.json();
                if (data.valid) {
                    return true;
                } else {
                    alert('❌ Contraseña incorrecta');
                    return false;
                }
            } catch (e) {
                alert('Error de conexión');
                return false;
            }
        }

        async function crearMiBackup() {
            // Verificar si backups están bloqueados por admin
            try {
                const usersRes = await fetch(API_URL + '/api/users');
                const allUsers = await usersRes.json();
                const myUser = allUsers.find(u => u.id === currentUser.id || u._id === currentUser.id || u.id?.toString() === currentUser.id?.toString());
                
                if (myUser?.backupBlocked) {
                    alert('🔒 El administrador ha bloqueado el uso de backups para tu cuenta.');
                    return;
                }
                
                // Verificar si tiene contraseña y está desbloqueado
                if (myUser?.backupPassword && !backupUnlocked) {
                    alert('🔒 Debes desbloquear la llave de backups primero.\nHaz clic en el candado rojo para ingresar tu contraseña.');
                    return;
                }
            } catch (e) {}
            
            if (!confirm('¿Crear un backup de tus datos ahora?')) return;
            try {
                const userId = currentUser.id || currentUser._id;
                const res = await fetch(API_URL + '/api/admin/backup-trabajador/' + userId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    mostrarMensajeExito('✅ Backup creado correctamente');
                    cargarMisBackups();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        async function restaurarMiBackup(backupId) {
            // Verificar si backups están bloqueados por admin
            let myUser = null;
            try {
                const usersRes = await fetch(API_URL + '/api/users');
                if (!usersRes.ok) throw new Error('Error cargando usuarios');
                const allUsers = await usersRes.json();
                myUser = allUsers.find(u => u.id === currentUser.id || u._id === currentUser.id || u.id?.toString() === currentUser.id?.toString());
                
                if (myUser?.backupBlocked) {
                    alert('🔒 El administrador ha bloqueado el uso de backups para tu cuenta.');
                    return;
                }
                
                // Verificar si tiene contraseña y está desbloqueado
                if (myUser?.backupPassword && !backupUnlocked) {
                    alert('🔒 Debes desbloquear la llave de backups primero.\nHaz clic en el candado rojo para ingresar tu contraseña.');
                    return;
                }
            } catch (e) {
                console.error('Error verificando usuario:', e);
                // Continuar sin verificación si falla
            }
            
            if (!confirm('⚠️ ¿RESTAURAR este backup?\n\nEsto reemplazará TODOS tus datos actuales con los del backup.\n\n¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore-trabajador/' + backupId, { method: 'POST' });
                if (!res.ok) {
                    alert('Error HTTP: ' + res.status);
                    return;
                }
                const data = await res.json();
                if (data.success) {
                    alert('✅ Backup restaurado correctamente');
                    cargarMisBackups();
                    // Recargar datos
                    await loadData();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                console.error('Error restaurando backup:', e);
                alert('Error de conexión: ' + e.message);
            }
        }

        // ============ FUNCIONES DE BACKUP ============
        async function cargarBackups() {
            try {
                const res = await fetch(API_URL + '/api/admin/backups');
                if (!res.ok) {
                    document.getElementById('backupsList').innerHTML = '<p class="text-secondary text-center py-3">No hay backups disponibles</p>';
                    return;
                }
                const backups = await res.json();
                const container = document.getElementById('backupsList');
                
                if (!backups || backups.length === 0 || backups.error) {
                    container.innerHTML = '<p class="text-secondary text-center py-3">No hay backups disponibles</p>';
                    return;
                }
                
                container.innerHTML = backups.map((b, i) => {
                    const fecha = b.fecha ? new Date(b.fecha).toLocaleString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Fecha desconocida';
                    const info = `${b.usuarios || 0} usuarios, ${b.clientes || 0} clientes, ${b.gastos || 0} gastos`;
                    const backupId = b.id || b._id;
                    return `
                    <div class="d-flex justify-content-between align-items-center py-2 ${i > 0 ? 'border-top' : ''}" style="border-color: var(--border-color) !important;">
                        <div>
                            <strong><i class="fas fa-file-archive me-2" style="color: var(--accent-cyan);"></i>Backup ${fecha}</strong>
                            <br><small class="text-secondary">${fecha} - ${info}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;" onclick="restaurarBackupGeneral('${backupId}')" title="Restaurar">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                document.getElementById('backupsList').innerHTML = '<p class="text-secondary text-center py-3">No hay backups disponibles</p>';
            }
        }

        async function crearBackupManual() {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            if (!confirm('¿Crear un backup del sistema ahora?')) return;
            try {
                const res = await fetch(API_URL + '/api/admin/backup', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const data = await res.json();
                if (data.success) {
                    mostrarMensajeExito('✅ Backup del sistema creado');
                    cargarBackups();
                } else {
                    alert('Error creando backup: ' + (data.error || 'Error desconocido'));
                }
            } catch (e) {
                console.error('Error backup:', e);
                alert('Error de conexión: ' + e.message);
            }
        }

        async function restaurarBackupGeneral(backupId) {
            const password = prompt('🔐 RESTAURACIÓN DE BACKUP DEL SISTEMA\n\n⚠️ ADVERTENCIA: Esto restaurará TODOS los datos de TODOS los trabajadores a la fecha del backup.\n\nIngresa la contraseña de administrador para continuar:');
            
            if (!password) return;
            if (password !== 'Pipe16137356') {
                alert('❌ Contraseña incorrecta');
                return;
            }
            
            if (!confirm('⚠️ ÚLTIMA CONFIRMACIÓN\n\nSe restaurarán TODOS los usuarios, clientes y gastos del sistema.\n\n¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore-sistema/' + backupId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Backup restaurado correctamente');
                    cargarBackups();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }

        function descargarBackup(filename) {
            window.open(API_URL + '/api/admin/backup/' + filename, '_blank');
        }

        async function restaurarBackup(filename) {
            if (!confirm('⚠️ ¿RESTAURAR este backup?\n\nEsto reemplazará TODOS los datos actuales con los del backup.\n\n¿Estás seguro?')) return;
            if (!confirm('⚠️ ÚLTIMA CONFIRMACIÓN\n\nSe perderán todos los cambios desde que se creó este backup.\n\n¿Continuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore/' + filename, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('✅ Backup restaurado correctamente');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        // ============ FIN FUNCIONES DE BACKUP ============

        async function renderAdminClientes() {
            try {
                const res = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await res.json();
                const tbody = document.getElementById('adminClientesTable');
                if (allClients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-4">No hay clientes</td></tr>';
                    return;
                }
                tbody.innerHTML = allClients.map(c => {
                    const user = allUsers.find(u => u.id === c.creadoPor) || { nombre: 'Desconocido' };
                    return `
                    <tr>
                        <td><strong>${c.nombre}</strong></td>
                        <td>${user.nombre}</td>
                        <td>R$ ${(c.montoTotal || 0).toFixed(2)}</td>
                        <td style="color: var(--accent-green);">R$ ${(c.montoPagado || 0).toFixed(2)}</td>
                        <td style="color: var(--accent-red);">R$ ${((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2)}</td>
                        <td><span class="badge-status badge-${esEstadoActivo(c.estado) ? 'active' : 'finished'}">${c.estado}</span></td>
                    </tr>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        // Client Functions
        function openNewClientModal() {
            // Verificar si hay caja inicial del día
            if (!verificarCajaInicialDelDia()) {
                return;
            }
            
            // Resetear variables de restablecimiento/renovación
            clienteRestableciendo = null;
            clienteRenovandoId = null;
            clienteEnProceso = false; // Resetear protección doble clic
            
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            document.getElementById('clienteUbicacion').value = '';
            document.getElementById('clienteLat').value = '';
            document.getElementById('clienteLng').value = '';
            document.getElementById('coordsInfo').style.display = 'none';
            document.getElementById('clienteTipo').value = 'nuevo';
            document.getElementById('clienteNegocio').value = '';
            document.getElementById('clienteNegocioOtro').value = '';
            document.getElementById('clienteNegocioOtro').style.display = 'none';
            document.getElementById('clienteNombreNegocio').value = '';
            document.getElementById('clienteNotas').value = '';
            document.getElementById('clienteMonto').value = '';
            document.getElementById('clienteParcelas').value = '';
            document.getElementById('clienteComision').value = '20';
            calcularTotal();
            
            // Resetear texto del botón
            document.getElementById('btnCrearCliente').textContent = 'Crear Cliente';
            
            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }

        function toggleOtroNegocio() {
            const select = document.getElementById('clienteNegocio');
            const input = document.getElementById('clienteNegocioOtro');
            if (select.value === 'otro') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
                input.value = '';
            }
        }

        function calcularTotal() {
            const monto = parseFloat(document.getElementById('clienteMonto').value) || 0;
            const parcelas = parseInt(document.getElementById('clienteParcelas').value) || 1;
            const porcentaje = parseInt(document.getElementById('clienteComision').value) || 20;
            const microseguro = parseFloat(document.getElementById('clienteMicroseguro').value) || 0;
            const comision = monto * (porcentaje / 100);
            const totalParcelas = monto + comision; // Total a pagar SIN microseguro
            const porParcela = totalParcelas / parcelas;
            document.getElementById('comisionLabel').textContent = porcentaje;
            document.getElementById('calcComision').textContent = 'R$ ' + comision.toFixed(2);
            document.getElementById('calcMicroseguro').textContent = 'R$ ' + microseguro.toFixed(2);
            document.getElementById('calcTotal').textContent = 'R$ ' + totalParcelas.toFixed(2); // Sin microseguro
            document.getElementById('calcParcela').textContent = 'R$ ' + porParcela.toFixed(2);
        }

        let clienteEnProceso = false; // Prevenir doble clic
        
        async function crearCliente() {
            console.log('crearCliente llamado, clienteEnProceso:', clienteEnProceso);
            
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            if (clienteEnProceso) {
                console.log('Bloqueado por clienteEnProceso');
                return;
            }
            
            // VALIDACIÓN: Verificar que haya caja inicial configurada antes de prestar
            const carteraKey = carteraActual || 'todas';
            const tieneCajaInicial = dineroAgregado[carteraKey] && Object.keys(dineroAgregado[carteraKey]).length > 0;
            
            if (!tieneCajaInicial && !window.clienteEditandoId) {
                alert('⚠️ Debes configurar una Caja Actual antes de crear clientes.\n\nHaz clic en "Configurar" en la sección de Contraseña de Caja para agregar dinero inicial.');
                return;
            }
            
            const nombre = document.getElementById('clienteNombre').value;
            const telefono = document.getElementById('clienteTelefono').value;
            const ubicacion = document.getElementById('clienteUbicacion').value;
            const lat = document.getElementById('clienteLat').value;
            const lng = document.getElementById('clienteLng').value;
            const tipoCliente = document.getElementById('clienteTipo').value;
            let tipoNegocio = document.getElementById('clienteNegocio').value;
            const negocioOtro = document.getElementById('clienteNegocioOtro').value;
            if (tipoNegocio === 'otro' && negocioOtro) {
                tipoNegocio = negocioOtro;
            }
            const nombreNegocio = document.getElementById('clienteNombreNegocio').value;
            const notas = document.getElementById('clienteNotas').value;
            const monto = parseFloat(document.getElementById('clienteMonto').value);
            const parcelas = parseInt(document.getElementById('clienteParcelas').value);
            const porcentaje = parseInt(document.getElementById('clienteComision').value) || 20;
            const microseguro = parseFloat(document.getElementById('clienteMicroseguro').value) || 0;
            if (!nombre || !monto || !parcelas) return alert('Completa los campos requeridos');
            
            clienteEnProceso = true; // Bloquear más clics
            
            const comision = monto * (porcentaje / 100);
            const totalParcelas = monto + comision;
            const total = totalParcelas; // Total a pagar SIN microseguro
            
            // ========== MODO EDICIÓN (trabajador con llave activa) ==========
            if (window.clienteEditandoId) {
                const clienteExistente = clientes.find(c => c.id === window.clienteEditandoId);
                if (!clienteExistente) {
                    alert('Cliente no encontrado');
                    window.clienteEditandoId = null;
                    return;
                }
                
                // Actualizar solo los campos editables (no recalcular pagos ni estado)
                clienteExistente.nombre = nombre;
                clienteExistente.telefono = telefono;
                clienteExistente.ubicacion = ubicacion;
                clienteExistente.lat = lat ? parseFloat(lat) : clienteExistente.lat;
                clienteExistente.lng = lng ? parseFloat(lng) : clienteExistente.lng;
                clienteExistente.tipoCliente = tipoCliente;
                clienteExistente.tipoNegocio = tipoNegocio;
                clienteExistente.nombreNegocio = nombreNegocio;
                clienteExistente.notas = notas;
                
                // Solo actualizar montos si cambiaron (recalcular)
                if (clienteExistente.montoTotal !== monto || clienteExistente.numeroParcelas !== parcelas || clienteExistente.comisionPorcentaje !== porcentaje) {
                    clienteExistente.montoTotal = monto;
                    clienteExistente.numeroParcelas = parcelas;
                    clienteExistente.comisionPorcentaje = porcentaje;
                    clienteExistente.comisionTotal = comision;
                    clienteExistente.totalAPagar = total;
                    clienteExistente.valorParcela = total / parcelas;
                    // Recalcular parcelas pagas basado en monto pagado
                    clienteExistente.parcelasPagas = Math.floor((clienteExistente.montoPagado || 0) / clienteExistente.valorParcela);
                    // Verificar si ya está pagado
                    if ((clienteExistente.montoPagado || 0) >= total) {
                        clienteExistente.estado = 'finalizado';
                        clienteExistente.parcelasPagas = parcelas;
                    }
                }
                
                try {
                    const res = await fetch(API_URL + '/api/clientes/' + window.clienteEditandoId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clienteExistente)
                    });
                    const data = await res.json();
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
                        window.clienteEditandoId = null;
                        document.getElementById('btnCrearCliente').innerHTML = '<i class="fas fa-plus me-2"></i>Crear Cliente';
                        updateStats();
                        renderClientes();
                        showToast('✅ Cliente actualizado', 2000);
                    } else {
                        alert('Error al actualizar: ' + (data.error || 'Error desconocido'));
                    }
                } catch (e) {
                    alert('Error al actualizar cliente: ' + e.message);
                }
                return;
            }
            // ========== FIN MODO EDICIÓN ==========
            
            // ========== MODO RENOVACIÓN ==========
            if (clienteRenovandoId) {
                const clienteExistente = clientes.find(c => c.id === clienteRenovandoId);
                if (!clienteExistente) {
                    alert('Cliente no encontrado');
                    clienteRenovandoId = null;
                    clienteEnProceso = false;
                    return;
                }
                
                // Guardar historial del préstamo anterior
                if (!clienteExistente.historialPrestamos) {
                    clienteExistente.historialPrestamos = [];
                }
                
                clienteExistente.historialPrestamos.push({
                    montoTotal: clienteExistente.montoTotal,
                    totalAPagar: clienteExistente.totalAPagar,
                    montoPagado: clienteExistente.montoPagado,
                    numeroParcelas: clienteExistente.numeroParcelas,
                    parcelasPagas: clienteExistente.parcelasPagas,
                    comisionPorcentaje: clienteExistente.comisionPorcentaje,
                    fechaInicio: clienteExistente.fechaCreacion || clienteExistente.fechaInicio,
                    fechaFin: crearFechaParaGuardar(),
                    estado: clienteExistente.estado
                });
                
                // Mover pagos actuales al historial
                if (!clienteExistente.historialPagos) {
                    clienteExistente.historialPagos = [];
                }
                if (clienteExistente.pagos && clienteExistente.pagos.length > 0) {
                    clienteExistente.historialPagos.push(...clienteExistente.pagos);
                }
                
                // Incrementar contador de renovaciones
                clienteExistente.renovaciones = (clienteExistente.renovaciones || 0) + 1;
                
                // Actualizar con nuevos valores del préstamo
                clienteExistente.montoTotal = monto;
                clienteExistente.numeroParcelas = parcelas;
                clienteExistente.comisionPorcentaje = porcentaje;
                clienteExistente.comisionTotal = comision;
                clienteExistente.microseguro = microseguro;
                clienteExistente.totalAPagar = total;
                clienteExistente.valorParcela = totalParcelas / parcelas;
                clienteExistente.estado = 'ativo';
                clienteExistente.fechaCreacion = crearFechaParaGuardar();
                clienteExistente.fechaInicio = crearFechaParaGuardar();
                clienteExistente.montoPagado = 0;
                clienteExistente.parcelasPagas = 0;
                clienteExistente.pagos = [];
                
                // Actualizar datos personales si cambiaron
                clienteExistente.nombre = nombre;
                clienteExistente.telefono = telefono;
                clienteExistente.ubicacion = ubicacion;
                clienteExistente.lat = lat ? parseFloat(lat) : clienteExistente.lat;
                clienteExistente.lng = lng ? parseFloat(lng) : clienteExistente.lng;
                clienteExistente.tipoCliente = tipoCliente;
                clienteExistente.tipoNegocio = tipoNegocio;
                clienteExistente.nombreNegocio = nombreNegocio;
                clienteExistente.notas = notas;
                
                try {
                    // Actualizar en servidor
                    const res = await fetch(API_URL + '/api/clientes/' + clienteRenovandoId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clienteExistente)
                    });
                    
                    if (res.ok) {
                        mostrarMensajeExito('✅ Cliente renovado exitosamente');
                        bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
                        refreshAllDebounced();
                    } else {
                        throw new Error('Error al renovar');
                    }
                } catch (error) {
                    console.error('Error al renovar cliente:', error);
                    alert('Error al renovar cliente');
                } finally {
                    clienteRenovandoId = null;
                    clienteEnProceso = false;
                }
                return;
            }
            // ========== FIN MODO RENOVACIÓN ==========
            
            // Contar renovaciones previas de este cliente (por teléfono, solo en la cartera actual)
            let renovacionesPrevias = 0;
            if (telefono && carteraActual) {
                clientes.forEach(c => {
                    // Solo contar clientes de la misma cartera con el mismo teléfono
                    // que NO estén marcados como renovados (clientes activos)
                    if (c.telefono === telefono && 
                        c.carteraId === carteraActual && 
                        !c.renovado) {
                        renovacionesPrevias += (c.renovaciones || 0);
                    }
                });
            }
            
            const cliente = {
                id: Date.now().toString(),
                nombre, telefono, ubicacion, tipoCliente, tipoNegocio, nombreNegocio, notas,
                lat: lat ? parseFloat(lat) : null,
                lng: lng ? parseFloat(lng) : null,
                montoTotal: monto,
                numeroParcelas: parcelas,
                comisionPorcentaje: porcentaje,
                comisionTotal: comision,
                microseguro: microseguro,
                totalAPagar: total,
                valorParcela: totalParcelas / parcelas,
                estado: 'ativo',
                fechaCreacion: crearFechaParaGuardar(),
                fechaInicio: crearFechaParaGuardar(), // Para el gráfico de resumen
                montoPagado: 0,
                parcelasPagas: 0,
                pagos: [],
                renovaciones: 0,
                historialPrestamos: [],
                historialPagos: [],
                creadoPor: currentUser.id,
                creadoPorNombre: currentUser.nombre,
                carteraId: carteraActual || null
            };
            
            // Guardar si es restablecimiento antes de resetear la variable
            const esRestablecimiento = clienteRestableciendo !== null;
            const idClienteEliminado = clienteRestableciendo ? (clienteRestableciendo._id || clienteRestableciendo.id) : null;
            
            try {
                // Si es un restablecimiento, eliminar de la papelera primero
                if (esRestablecimiento && idClienteEliminado) {
                    fetch(API_URL + '/api/clientes-eliminados/' + idClienteEliminado, { method: 'DELETE' });
                }
                
                // Actualizar UI inmediatamente
                clientes.push(cliente);
                
                // MOSTRAR MENSAJE INMEDIATAMENTE
                mostrarMensajeExito('✅ Cliente creado exitosamente');
                
                bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
                refreshAllDebounced();
                
                // Guardar en servidor en segundo plano
                fetch(API_URL + '/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, cliente })
                });
                
                if (esRestablecimiento) {
                    clienteRestableciendo = null;
                    clientesEliminados = clientesEliminados.filter(c => (c._id || c.id) !== idClienteEliminado);
                    renderClientesEliminados();
                }
                
                clienteEnProceso = false; // Permitir crear otro cliente
            } catch (e) { 
                clienteEnProceso = false; // Permitir reintentar
                alert('Error: ' + e.message); 
            }
        }

        let clienteParaPago = null;
        let pagoEnProceso = false; // Prevenir doble clic
        
        function abrirPago(id) {
            clienteParaPago = clientes.find(c => c.id === id);
            if (!clienteParaPago) return;
            pagoEnProceso = false; // Resetear al abrir modal
            
            const restante = (clienteParaPago.totalAPagar || 0) - (clienteParaPago.montoPagado || 0);
            const parcelasPagadas = clienteParaPago.parcelasPagas || 0;
            const parcelasTotal = clienteParaPago.numeroParcelas || 1;
            const parcelasRestantes = parcelasTotal - parcelasPagadas;
            
            document.getElementById('pagoClienteInfo').innerHTML = `
                <strong>${clienteParaPago.nombre}</strong><br>
                <small class="text-secondary">Restante: R$ ${restante.toFixed(2)} | Parcelas: ${parcelasPagadas}/${parcelasTotal}</small>
            `;
            
            // Resetear cantidad de parcelas a 1
            document.getElementById('pagoCantidadParcelas').value = 1;
            document.getElementById('pagoCantidadParcelas').max = parcelasRestantes;
            document.getElementById('pagoParcelasRestantes').textContent = `(máx: ${parcelasRestantes})`;
            
            document.getElementById('pagoValor').value = clienteParaPago.valorParcela.toFixed(2);
            document.getElementById('pagoValorInfo').textContent = `1 parcela = R$ ${clienteParaPago.valorParcela.toFixed(2)}`;
            document.getElementById('pagoFecha').value = getFechaLocal();
            new bootstrap.Modal(document.getElementById('pagoModal')).show();
        }
        
        function cambiarCantidadParcelas(delta) {
            if (!clienteParaPago) return;
            const input = document.getElementById('pagoCantidadParcelas');
            const parcelasPagadas = clienteParaPago.parcelasPagas || 0;
            const parcelasTotal = clienteParaPago.numeroParcelas || 1;
            const parcelasRestantes = parcelasTotal - parcelasPagadas;
            
            let cantidad = parseInt(input.value) || 1;
            cantidad += delta;
            if (cantidad < 1) cantidad = 1;
            if (cantidad > parcelasRestantes) cantidad = parcelasRestantes;
            input.value = cantidad;
            actualizarValorPago();
        }
        
        function actualizarValorPago() {
            if (!clienteParaPago) return;
            const cantidad = parseInt(document.getElementById('pagoCantidadParcelas').value) || 1;
            const valorParcela = clienteParaPago.valorParcela || 0;
            const valorTotal = valorParcela * cantidad;
            
            document.getElementById('pagoValor').value = valorTotal.toFixed(2);
            document.getElementById('pagoValorInfo').textContent = `${cantidad} parcela${cantidad > 1 ? 's' : ''} × R$ ${valorParcela.toFixed(2)} = R$ ${valorTotal.toFixed(2)}`;
        }

        async function confirmarPago() {
            if (!clienteParaPago) return;
            
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            if (pagoEnProceso) return; // Prevenir doble clic
            
            const valor = parseFloat(document.getElementById('pagoValor').value);
            const cantidadParcelas = parseInt(document.getElementById('pagoCantidadParcelas').value) || 1;
            if (!valor || valor <= 0) return alert('Ingresa un valor válido');
            
            pagoEnProceso = true; // Bloquear más clics
            
            clienteParaPago.montoPagado = (clienteParaPago.montoPagado || 0) + valor;
            clienteParaPago.parcelasPagas = Math.floor(clienteParaPago.montoPagado / (clienteParaPago.valorParcela || 1));
            if (clienteParaPago.montoPagado >= (clienteParaPago.totalAPagar || 0)) {
                clienteParaPago.estado = 'finalizado';
                clienteParaPago.parcelasPagas = clienteParaPago.numeroParcelas;
            }
            // Asegurar que pagos existe
            if (!clienteParaPago.pagos) clienteParaPago.pagos = [];
            // Guardar fecha y hora completa
            const fechaSeleccionada = document.getElementById('pagoFecha').value;
            const horaActual = getCurrentDate().toTimeString().slice(0, 8);
            const fechaHoraCompleta = new Date(fechaSeleccionada + 'T' + horaActual).toISOString();
            
            // Registrar cada parcela como un pago individual
            const valorPorParcela = clienteParaPago.valorParcela || valor;
            for (let i = 0; i < cantidadParcelas; i++) {
                clienteParaPago.pagos.push({ valor: valorPorParcela, fecha: fechaHoraCompleta });
            }
            
            try {
                const res = await fetch(API_URL + '/api/clientes/' + clienteParaPago.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clienteParaPago)
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Error');
                bootstrap.Modal.getInstance(document.getElementById('pagoModal')).hide();
                updateStats();
                renderClientes();
                renderCobros();
                showToast(`✅ ${cantidadParcelas} parcela${cantidadParcelas > 1 ? 's' : ''} pagada${cantidadParcelas > 1 ? 's' : ''} - R$ ${valor.toFixed(2)}`, 2500);
            } catch (e) { 
                console.error('Error pago:', e);
                alert('Error al registrar pago: ' + e.message);
                pagoEnProceso = false; // Permitir reintentar si hay error
            }
        }
        
        async function pagarTodo() {
            if (!clienteParaPago) return;
            const restante = (clienteParaPago.totalAPagar || 0) - (clienteParaPago.montoPagado || 0);
            if (restante <= 0) {
                alert('Este cliente ya no tiene deuda pendiente');
                return;
            }
            if (!confirm(`¿Confirmar pago total de R$ ${restante.toFixed(2)}?\n\nEsto saldará toda la deuda de ${clienteParaPago.nombre}.`)) return;
            
            document.getElementById('pagoValor').value = restante.toFixed(2);
            await confirmarPago();
        }
        
        // Función para filtrar préstamos anteriores por fecha
        function filtrarPrestamosPorFecha(clienteId, fecha) {
            const contenedor = document.getElementById('listaPrestamosAnteriores_' + clienteId);
            if (!contenedor) return;
            
            const items = contenedor.querySelectorAll('.prestamo-anterior-item');
            let encontrados = 0;
            
            items.forEach(item => {
                if (!fecha) {
                    // Si no hay fecha, mostrar todos
                    item.style.display = 'block';
                    encontrados++;
                } else {
                    const fechaInicio = item.getAttribute('data-fecha-inicio');
                    const fechasPagos = item.getAttribute('data-fechas-pagos') || '';
                    
                    // Buscar si la fecha coincide con inicio o algún pago
                    if (fechaInicio === fecha || fechasPagos.includes(fecha)) {
                        item.style.display = 'block';
                        item.style.animation = 'pulse 0.5s';
                        encontrados++;
                    } else {
                        item.style.display = 'none';
                    }
                }
            });
            
            // Mostrar mensaje si no hay resultados
            let msgNoResultados = contenedor.querySelector('.no-resultados-fecha');
            if (encontrados === 0 && fecha) {
                if (!msgNoResultados) {
                    msgNoResultados = document.createElement('div');
                    msgNoResultados.className = 'no-resultados-fecha';
                    msgNoResultados.style.cssText = 'text-align: center; padding: 20px; color: var(--text-secondary);';
                    msgNoResultados.innerHTML = '<i class="fas fa-search me-2"></i>No se encontraron préstamos para esta fecha';
                    contenedor.appendChild(msgNoResultados);
                }
            } else if (msgNoResultados) {
                msgNoResultados.remove();
            }
        }

        function verDetalles(id) {
            const c = clientes.find(cl => cl.id === id);
            if (!c) return;
            
            // Calcular estadísticas de pago
            const pagos = c.pagos || [];
            const fechaInicio = new Date(c.fechaCreacion || c.fechaInicio);
            const renovaciones = c.renovaciones || 0;
            const numeroParcelas = c.numeroParcelas || 1;
            
            // Analizar cada pago para ver si fue a tiempo o atrasado
            let pagosATiempo = 0;
            let pagosAtrasados = 0;
            let totalDiasAtraso = 0;
            
            // Calcular primer pago esperado según regla de 12 PM
            let primerPagoEsperado = new Date(fechaInicio.getTime());
            if (fechaInicio.getHours() >= 12) {
                primerPagoEsperado.setDate(primerPagoEsperado.getDate() + 1);
            }
            primerPagoEsperado.setHours(12, 0, 0, 0);
            
            // Crear mapa de pagos por fecha
            let pagosPorFecha = {};
            pagos.forEach((p, index) => {
                const fechaPago = new Date(p.fecha);
                const fechaKey = fechaPago.toISOString().split('T')[0];
                pagosPorFecha[fechaKey] = { valor: p.valor, index: index };
            });
            
            // Analizar pagos
            let historialPagos = pagos.map((p, index) => {
                const fechaPago = new Date(p.fecha);
                const fechaEsperada = new Date(primerPagoEsperado.getTime());
                fechaEsperada.setDate(fechaEsperada.getDate() + index);
                
                const diffMs = fechaPago - fechaEsperada;
                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffDias <= 0) {
                    pagosATiempo++;
                    return { fecha: fechaPago, valor: p.valor, estado: '✅ A tiempo', diasAtraso: 0, fechaEsperada };
                } else {
                    pagosAtrasados++;
                    totalDiasAtraso += diffDias;
                    return { fecha: fechaPago, valor: p.valor, estado: '⚠️ Atrasado', diasAtraso: diffDias, fechaEsperada };
                }
            });
            
            // Determinar tipo de pagador
            let tipoPagador = '🆕 Nuevo';
            if (pagos.length >= 3) {
                const porcentajeATiempo = (pagosATiempo / pagos.length) * 100;
                if (porcentajeATiempo >= 80) tipoPagador = '✅ Buen pagador';
                else if (porcentajeATiempo >= 50) tipoPagador = '⚠️ Regular';
                else tipoPagador = '❌ Mal pagador';
            }
            
            // Crear calendario visual de pagos
            // Detectar si se saldó antes de tiempo
            const montoPagado = c.montoPagado || 0;
            const totalAPagar = c.totalAPagar || 0;
            const saldoAnticipadoActual = montoPagado >= totalAPagar && pagos.length < numeroParcelas;
            
            let calendarioHTML = '<div style="display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px;">';
            for (let i = 0; i < numeroParcelas; i++) {
                const fechaEsperada = new Date(primerPagoEsperado.getTime());
                fechaEsperada.setDate(fechaEsperada.getDate() + i);
                const fechaKey = fechaEsperada.toISOString().split('T')[0];
                
                let color = '#3d3d5c'; // Gris - pendiente
                let icon = '⬜';
                let tooltip = `Día ${i + 1}: ${fechaEsperada.toLocaleDateString()} - Pendiente`;
                
                if (i < pagos.length) {
                    const pago = historialPagos[i];
                    if (pago.diasAtraso === 0) {
                        color = '#2ecc71'; // Verde - a tiempo
                        icon = '✅';
                        tooltip = `Día ${i + 1}: Pagó ${pago.fecha.toLocaleDateString()} - A tiempo`;
                    } else {
                        color = '#ff4757'; // Rojo - atrasado
                        icon = '⚠️';
                        tooltip = `Día ${i + 1}: Pagó ${pago.fecha.toLocaleDateString()} - ${pago.diasAtraso} días tarde`;
                    }
                } else if (saldoAnticipadoActual) {
                    // Parcela no necesaria porque se saldó antes
                    color = '#9b59b6'; // Morado
                    tooltip = `Día ${i + 1}: No aplicó (saldado anticipadamente)`;
                }
                
                calendarioHTML += `
                    <div title="${tooltip}" style="
                        width: 35px; height: 35px; 
                        background: ${color}; 
                        border-radius: 5px; 
                        display: flex; 
                        align-items: center; 
                        justify-content: center;
                        font-size: 0.8rem;
                        cursor: help;
                    ">${i + 1}</div>
                `;
            }
            calendarioHTML += '</div>';
            calendarioHTML += '<div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary);">';
            calendarioHTML += '<span style="color: #2ecc71;">■</span> A tiempo &nbsp;&nbsp;';
            calendarioHTML += '<span style="color: #ff4757;">■</span> Atrasado &nbsp;&nbsp;';
            calendarioHTML += '<span style="color: #3d3d5c;">■</span> Pendiente';
            if (saldoAnticipadoActual) {
                calendarioHTML += ' &nbsp;&nbsp;<span style="color: #9b59b6;">■</span> Saldado';
            }
            calendarioHTML += '</div>';
            
            // Buscar préstamos anteriores del mismo cliente (mismo teléfono, marcados como renovado)
            let prestamosAnterioresHTML = '';
            if (c.telefono) {
                const prestamosAnteriores = clientes.filter(cl => 
                    cl.telefono === c.telefono && 
                    cl.id !== c.id && 
                    cl.carteraId === c.carteraId &&
                    cl.renovado === true
                ).sort((a, b) => new Date(b.fechaCreacion || b.fechaInicio) - new Date(a.fechaCreacion || a.fechaInicio));
                
                if (prestamosAnteriores.length > 0) {
                    // Calcular estadísticas globales de todos los préstamos anteriores
                    let totalPrestadoHistorico = 0;
                    let totalPagadoHistorico = 0;
                    let totalDiasAtrasoHistorico = 0;
                    let totalPagosATiempoHistorico = 0;
                    let totalPagosAtrasadosHistorico = 0;
                    
                    prestamosAnteriores.forEach(pa => {
                        totalPrestadoHistorico += pa.montoTotal || 0;
                        totalPagadoHistorico += pa.montoPagado || 0;
                    });
                    
                    // Generar ID único para este cliente
                    const clienteUnicoId = c.id.replace(/[^a-zA-Z0-9]/g, '');
                    
                    prestamosAnterioresHTML = `
                        <h6 class="mt-4" style="color: var(--accent-purple);"><i class="fas fa-folder-open me-2"></i>Préstamos Anteriores (${prestamosAnteriores.length})</h6>
                        <div style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.2), rgba(142, 68, 173, 0.1)); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(155, 89, 182, 0.3);">
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-purple);">R$ ${totalPrestadoHistorico.toFixed(2)}</div>
                                    <small class="text-secondary">Total Prestado Histórico</small>
                                </div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: #2ecc71;">R$ ${totalPagadoHistorico.toFixed(2)}</div>
                                    <small class="text-secondary">Total Pagado Histórico</small>
                                </div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: bold; color: var(--accent-cyan);">${prestamosAnteriores.length}</div>
                                    <small class="text-secondary">Préstamos Completados</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Buscador de fechas -->
                        <div style="background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--accent-cyan);">
                            <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                                <i class="fas fa-calendar-alt fa-lg" style="color: var(--accent-cyan);"></i>
                                <span style="font-size: 1rem; color: #fff; font-weight: 500;">Buscar por fecha:</span>
                                <input type="date" id="buscarFechaPrestamo_${clienteUnicoId}" class="form-control fecha-input-prestamo" style="width: auto; flex: 1; min-width: 160px; background: #fff; color: #000; border: 2px solid var(--accent-cyan); font-weight: bold;" onchange="filtrarPrestamosPorFecha('${clienteUnicoId}', this.value)">
                                <button class="btn btn-danger" style="font-weight: bold;" onclick="document.getElementById('buscarFechaPrestamo_${clienteUnicoId}').value=''; filtrarPrestamosPorFecha('${clienteUnicoId}', '')">
                                    <i class="fas fa-times me-1"></i>Limpiar
                                </button>
                            </div>
                            <small style="display: block; margin-top: 10px; color: #1ee5ff;">
                                <i class="fas fa-info-circle me-1"></i>Busca préstamos por fecha de inicio o fecha de pago
                            </small>
                        </div>
                        
                        <div id="listaPrestamosAnteriores_${clienteUnicoId}">
                    `;
                    
                    prestamosAnteriores.forEach((pa, idx) => {
                        const paFechaInicio = new Date(pa.fechaCreacion || pa.fechaInicio);
                        const paFechaInicioStr = paFechaInicio.toISOString().split('T')[0];
                        const paPagos = pa.pagos || [];
                        const paNumParcelas = pa.numeroParcelas || 1;
                        const paTotalAPagar = pa.totalAPagar || 0;
                        const paMontoPagado = pa.montoPagado || 0;
                        const paRestante = paTotalAPagar - paMontoPagado;
                        const paComision = pa.comisionPorcentaje || 20;
                        const paGanancia = paTotalAPagar - (pa.montoTotal || 0);
                        
                        // Obtener todas las fechas de pagos para búsqueda
                        const fechasPagos = paPagos.map(p => new Date(p.fecha).toISOString().split('T')[0]).join(',');
                        
                        // Calcular fecha de último pago
                        let paFechaUltimoPago = null;
                        if (paPagos.length > 0) {
                            paFechaUltimoPago = new Date(Math.max(...paPagos.map(p => new Date(p.fecha).getTime())));
                        }
                        
                        // Calcular duración del préstamo
                        let duracionDias = 0;
                        if (paFechaUltimoPago) {
                            duracionDias = Math.ceil((paFechaUltimoPago - paFechaInicio) / (1000 * 60 * 60 * 24));
                        }
                        
                        // Calcular primer pago esperado para este préstamo
                        let paPrimerPago = new Date(paFechaInicio.getTime());
                        if (paFechaInicio.getHours() >= 12) {
                            paPrimerPago.setDate(paPrimerPago.getDate() + 1);
                        }
                        paPrimerPago.setHours(12, 0, 0, 0);
                        
                        // Analizar pagos de este préstamo
                        let paPagosATiempo = 0;
                        let paPagosAtrasados = 0;
                        let paTotalDiasAtraso = 0;
                        let paMaxDiasAtraso = 0;
                        let paHistorialPagos = [];
                        
                        paPagos.forEach((p, i) => {
                            const fechaPago = new Date(p.fecha);
                            const fechaEsperada = new Date(paPrimerPago.getTime());
                            fechaEsperada.setDate(fechaEsperada.getDate() + i);
                            const diffMs = fechaPago - fechaEsperada;
                            const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                            
                            if (diffDias <= 0) {
                                paPagosATiempo++;
                                paHistorialPagos.push({ 
                                    fecha: fechaPago, 
                                    fechaEsperada: fechaEsperada,
                                    valor: p.valor, 
                                    estado: '✅', 
                                    dias: 0,
                                    parcela: i + 1
                                });
                            } else {
                                paPagosAtrasados++;
                                paTotalDiasAtraso += diffDias;
                                if (diffDias > paMaxDiasAtraso) paMaxDiasAtraso = diffDias;
                                paHistorialPagos.push({ 
                                    fecha: fechaPago, 
                                    fechaEsperada: fechaEsperada,
                                    valor: p.valor, 
                                    estado: '⚠️', 
                                    dias: diffDias,
                                    parcela: i + 1
                                });
                            }
                        });
                        
                        // Actualizar totales históricos
                        totalPagosATiempoHistorico += paPagosATiempo;
                        totalPagosAtrasadosHistorico += paPagosAtrasados;
                        totalDiasAtrasoHistorico += paTotalDiasAtraso;
                        
                        // Calcular porcentaje de pagos a tiempo
                        const porcentajeATiempo = paPagos.length > 0 ? Math.round((paPagosATiempo / paPagos.length) * 100) : 0;
                        const promedioDiasAtraso = paPagosAtrasados > 0 ? Math.round(paTotalDiasAtraso / paPagosAtrasados) : 0;
                        
                        // Determinar calificación del préstamo
                        let calificacion = '';
                        let calificacionColor = '';
                        if (porcentajeATiempo >= 90) {
                            calificacion = '⭐ Excelente';
                            calificacionColor = '#2ecc71';
                        } else if (porcentajeATiempo >= 70) {
                            calificacion = '👍 Bueno';
                            calificacionColor = '#3498db';
                        } else if (porcentajeATiempo >= 50) {
                            calificacion = '⚠️ Regular';
                            calificacionColor = '#f39c12';
                        } else {
                            calificacion = '❌ Malo';
                            calificacionColor = '#e74c3c';
                        }
                        
                        // Crear mini calendario para este préstamo
                        // Detectar si se saldó antes de tiempo (pagó todo pero con menos pagos que parcelas)
                        const saldoAnticipado = paMontoPagado >= paTotalAPagar && paPagos.length < paNumParcelas;
                        
                        let miniCalendario = '<div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px;">';
                        for (let i = 0; i < paNumParcelas; i++) {
                            let color = '#3d3d5c';
                            let tooltip = `Parcela ${i + 1}: Pendiente`;
                            
                            if (i < paPagos.length) {
                                // Parcela pagada
                                const fechaPago = new Date(paPagos[i].fecha);
                                const fechaEsperada = new Date(paPrimerPago.getTime());
                                fechaEsperada.setDate(fechaEsperada.getDate() + i);
                                const diffMs = fechaPago - fechaEsperada;
                                const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                                color = diffDias <= 0 ? '#2ecc71' : '#ff4757';
                                tooltip = `Parcela ${i + 1}: ${fechaPago.toLocaleDateString()} - R$ ${paPagos[i].valor.toFixed(2)}${diffDias > 0 ? ' (' + diffDias + 'd tarde)' : ' (a tiempo)'}`;
                            } else if (saldoAnticipado) {
                                // Parcela no necesaria porque se saldó antes
                                color = '#9b59b6'; // Morado
                                tooltip = `Parcela ${i + 1}: No aplicó (saldado anticipadamente)`;
                            }
                            miniCalendario += `<div title="${tooltip}" style="width: 24px; height: 24px; background: ${color}; border-radius: 4px; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; cursor: help; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">${i + 1}</div>`;
                        }
                        miniCalendario += '</div>';
                        
                        // Leyenda del calendario
                        miniCalendario += '<div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-secondary); display: flex; flex-wrap: wrap; gap: 10px;">';
                        miniCalendario += '<span><span style="display: inline-block; width: 10px; height: 10px; background: #2ecc71; border-radius: 2px;"></span> A tiempo</span>';
                        miniCalendario += '<span><span style="display: inline-block; width: 10px; height: 10px; background: #ff4757; border-radius: 2px;"></span> Tarde</span>';
                        miniCalendario += '<span><span style="display: inline-block; width: 10px; height: 10px; background: #3d3d5c; border-radius: 2px;"></span> Pendiente</span>';
                        if (saldoAnticipado) {
                            miniCalendario += '<span><span style="display: inline-block; width: 10px; height: 10px; background: #9b59b6; border-radius: 2px;"></span> Saldado</span>';
                        }
                        miniCalendario += '</div>';
                        
                        // Crear lista de pagos detallada mejorada
                        let listaPagosHTML = paHistorialPagos.length > 0 
                            ? paHistorialPagos.map((p, i) => `
                                <div style="display: grid; grid-template-columns: auto 1fr auto auto; gap: 10px; align-items: center; padding: 8px 10px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.1); ${p.dias > 0 ? 'background: rgba(255,71,87,0.1);' : ''}">
                                    <span style="font-weight: bold; color: ${p.dias > 0 ? '#ff4757' : '#2ecc71'};">${p.estado}</span>
                                    <div>
                                        <div><strong>Parcela ${p.parcela}</strong></div>
                                        <small class="text-secondary">Esperado: ${p.fechaEsperada.toLocaleDateString()}</small>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="color: #2ecc71; font-weight: bold;">R$ ${p.valor.toFixed(2)}</div>
                                        <small class="text-secondary">${p.fecha.toLocaleDateString()}</small>
                                    </div>
                                    <div style="min-width: 70px; text-align: right;">
                                        ${p.dias > 0 ? `<span style="color:#ff4757; font-weight: bold;">${p.dias}d tarde</span>` : '<span style="color:#2ecc71;">✓ A tiempo</span>'}
                                    </div>
                                </div>
                            `).join('')
                            : '<p style="font-size: 0.85rem; color: var(--text-secondary); text-align: center; padding: 15px;">Sin pagos registrados</p>';
                        
                        prestamosAnterioresHTML += `
                            <div class="prestamo-anterior-item" data-fecha-inicio="${paFechaInicioStr}" data-fechas-pagos="${fechasPagos}" style="background: var(--bg-hover); border-radius: 12px; padding: 18px; margin-top: 12px; border-left: 4px solid ${calificacionColor}; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 10px;">
                                    <div>
                                        <strong style="font-size: 1.2rem;">📋 Préstamo #${prestamosAnteriores.length - idx}</strong>
                                        <span style="margin-left: 10px; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; background: ${calificacionColor}20; color: ${calificacionColor}; font-weight: bold;">${calificacion}</span>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.9rem;"><i class="fas fa-calendar-plus me-1"></i>${paFechaInicio.toLocaleDateString()}</div>
                                        ${paFechaUltimoPago ? `<small class="text-secondary"><i class="fas fa-calendar-check me-1"></i>Último pago: ${paFechaUltimoPago.toLocaleDateString()}</small>` : ''}
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 15px;">
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #a855f7;">R$ ${(pa.montoTotal || 0).toFixed(2)}</div>
                                        <small class="text-secondary">💰 Prestado</small>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #b7950b;">R$ ${paTotalAPagar.toFixed(2)}</div>
                                        <small class="text-secondary">📊 Total a Pagar (+${paComision}%)</small>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: #229954;">R$ ${paMontoPagado.toFixed(2)}</div>
                                        <small class="text-secondary">✅ Pagado</small>
                                    </div>
                                    <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px; text-align: center;">
                                        <div style="font-size: 1.1rem; font-weight: bold; color: ${paRestante > 0 ? '#e74c3c' : '#00bcd4'};">R$ ${paRestante.toFixed(2)}</div>
                                        <small class="text-secondary">${paRestante > 0 ? '⏳ Restante' : '✓ Completado'}</small>
                                    </div>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin-bottom: 15px; padding: 12px; background: rgba(0,0,0,0.15); border-radius: 8px;">
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold;">${pa.parcelasPagas || 0}/${paNumParcelas}</div>
                                        <small class="text-secondary">📅 Parcelas</small>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: #229954;">${paPagosATiempo}</div>
                                        <small class="text-secondary">✅ A tiempo</small>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: #e74c3c;">${paPagosAtrasados}</div>
                                        <small class="text-secondary">⚠️ Atrasados</small>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: ${porcentajeATiempo >= 70 ? '#157a36' : '#aa2233'};">${porcentajeATiempo}%</div>
                                        <small class="text-secondary">📈 Cumplimiento</small>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: ${paTotalDiasAtraso > 0 ? '#e74c3c' : '#229954'};">${paTotalDiasAtraso}</div>
                                        <small class="text-secondary">⏰ Días atraso total</small>
                                    </div>
                                    ${paPagosAtrasados > 0 ? `
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: #d68910;">${promedioDiasAtraso}</div>
                                        <small class="text-secondary">📊 Promedio atraso</small>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: #c0392b;">${paMaxDiasAtraso}</div>
                                        <small class="text-secondary">🔺 Máx días atraso</small>
                                    </div>
                                    ` : ''}
                                    ${duracionDias > 0 ? `
                                    <div style="text-align: center;">
                                        <div style="font-size: 1rem; font-weight: bold; color: #7c3aed;">${duracionDias}</div>
                                        <small class="text-secondary">📆 Días duración</small>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div style="margin-bottom: 12px;">
                                    <small class="text-secondary"><i class="fas fa-calendar-alt me-1"></i>Calendario de Pagos:</small>
                                    ${miniCalendario}
                                </div>
                                
                                <details style="margin-top: 12px;">
                                    <summary style="cursor: pointer; color: var(--accent-cyan); font-size: 0.9rem; padding: 8px; background: rgba(0,0,0,0.2); border-radius: 6px;">
                                        <i class="fas fa-list-ul me-2"></i>Ver historial detallado de pagos (${paPagos.length} pagos)
                                    </summary>
                                    <div style="margin-top: 10px; background: rgba(0,0,0,0.25); border-radius: 8px; max-height: 250px; overflow-y: auto;">
                                        ${listaPagosHTML}
                                    </div>
                                </details>
                            </div>
                        `;
                    });
                    
                    // Cerrar el contenedor de la lista
                    prestamosAnterioresHTML += '</div>';
                }
            }
            
            // Crear contenido del modal
            let historialHTML = historialPagos.length > 0 
                ? historialPagos.map((p, i) => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid var(--border-color);">
                        <span>Pago ${i + 1}: ${p.fecha.toLocaleDateString()}</span>
                        <span>R$ ${p.valor.toFixed(2)}</span>
                        <span>${p.estado}${p.diasAtraso > 0 ? ' (' + p.diasAtraso + ' días)' : ''}</span>
                    </div>
                `).join('')
                : '<p class="text-secondary text-center">Sin pagos registrados</p>';
            
            // Mostrar modal
            const modalHTML = `
                <div class="modal fade" id="detallesClienteModal" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dark">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-user me-2"></i>${c.nombre}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <h6 style="color: var(--accent-cyan);"><i class="fas fa-info-circle me-2"></i>Información</h6>
                                        <p><strong>Teléfono:</strong> ${c.telefono || 'N/A'}</p>
                                        <p><strong>Ubicación:</strong> ${c.ubicacion || 'N/A'}</p>
                                        <p><strong>Tipo Negocio:</strong> ${c.tipoNegocio || 'N/A'}</p>
                                        <p><strong>Nombre Negocio:</strong> ${c.nombreNegocio || 'N/A'}</p>
                                        <p><strong>Notas:</strong> ${c.notas || 'N/A'}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6 style="color: var(--accent-green);"><i class="fas fa-dollar-sign me-2"></i>Préstamo Actual</h6>
                                        <p><strong style="color: #8e44ad;">Prestado:</strong> <span style="color: #8e44ad; font-weight: bold;">R$ ${(c.montoTotal || 0).toFixed(2)}</span></p>
                                        <p><strong style="color: #d68910;">Total a Pagar:</strong> <span style="color: #d68910; font-weight: bold;">R$ ${(c.totalAPagar || 0).toFixed(2)}</span></p>
                                        <p><strong style="color: #27ae60;">Pagado:</strong> <span style="color: #27ae60; font-weight: bold;">R$ ${(c.montoPagado || 0).toFixed(2)}</span></p>
                                        <p><strong>Restante:</strong> R$ ${((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2)}</p>
                                        <p><strong>Parcelas:</strong> ${c.parcelasPagas || 0}/${c.numeroParcelas}</p>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="stat-card green">
                                            <div class="stat-value">${pagosATiempo}</div>
                                            <div class="stat-label">Pagos a tiempo</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card red">
                                            <div class="stat-value">${pagosAtrasados}</div>
                                            <div class="stat-label">Pagos atrasados</div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="stat-card purple">
                                            <div class="stat-value">${renovaciones}</div>
                                            <div class="stat-label">Renovaciones</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <span class="badge" style="background: var(--bg-hover); padding: 10px 15px; font-size: 1rem;">
                                        ${tipoPagador}
                                    </span>
                                    ${totalDiasAtraso > 0 ? `<span class="badge ms-2" style="background: var(--accent-red); padding: 10px 15px;">Total días atraso: ${totalDiasAtraso}</span>` : ''}
                                </div>
                                
                                <h6 style="color: var(--accent-cyan);"><i class="fas fa-calendar-alt me-2"></i>Calendario de Pagos (Préstamo Actual)</h6>
                                <div style="background: var(--bg-hover); border-radius: 8px; padding: 15px;">
                                    ${calendarioHTML}
                                </div>
                                
                                <h6 class="mt-4" style="color: var(--accent-yellow);"><i class="fas fa-history me-2"></i>Historial de Pagos</h6>
                                <div style="max-height: 150px; overflow-y: auto; background: var(--bg-hover); border-radius: 8px; padding: 10px;">
                                    ${historialHTML}
                                </div>
                                
                                ${prestamosAnterioresHTML}
                                
                                <p class="mt-3 text-secondary"><small><i class="fas fa-calendar me-1"></i>Fecha registro: ${fechaInicio.toLocaleDateString()} ${fechaInicio.toLocaleTimeString()}</small></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior si existe
            const oldModal = document.getElementById('detallesClienteModal');
            if (oldModal) oldModal.remove();
            
            // Agregar nuevo modal
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Mostrar modal
            new bootstrap.Modal(document.getElementById('detallesClienteModal')).show();
            
            // Aplicar límites de fecha a los inputs de búsqueda de préstamos
            setTimeout(() => establecerLimitesFechaTodosCalendarios(), 100);
        }
        
        // ========== EDITAR CLIENTE (TRABAJADOR) ==========
        async function editarClienteTrabajador(id) {
            // Verificar llave de edición para trabajadores
            if (currentUser && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                // Primero verificar si el admin habilitó la llave
                const hasKey = await checkEditKey();
                if (!hasKey) {
                    alert('🔒 Tu llave está BLOQUEADA por el administrador.\n\nNo puedes editar hasta que el admin desbloquee tu llave.');
                    return;
                }
                // Luego verificar si tiene contraseña y está desbloqueada
                if (userHasEditPassword && !editUnlocked) {
                    alert('🔒 Edición bloqueada.\n\nDesbloquea tu llave con tu contraseña en la sección de Clientes.');
                    return;
                }
            }
            
            const c = clientes.find(cl => cl.id === id);
            if (!c) return alert('Cliente no encontrado');
            
            // Llenar el modal con los datos del cliente (usando campos correctos del modal)
            document.getElementById('clienteNombre').value = c.nombre || '';
            document.getElementById('clienteTelefono').value = c.telefono || '';
            document.getElementById('clienteUbicacion').value = c.ubicacion || '';
            document.getElementById('clienteLat').value = c.lat || '';
            document.getElementById('clienteLng').value = c.lng || '';
            document.getElementById('clienteTipo').value = c.tipoCliente || 'nuevo';
            document.getElementById('clienteNegocio').value = c.tipoNegocio || '';
            document.getElementById('clienteNombreNegocio').value = c.nombreNegocio || '';
            document.getElementById('clienteNotas').value = c.notas || '';
            document.getElementById('clienteMonto').value = c.montoTotal || '';
            document.getElementById('clienteParcelas').value = c.numeroParcelas || '';
            document.getElementById('clienteComision').value = c.comisionPorcentaje || 20;
            document.getElementById('clienteMicroseguro').value = c.microseguro || 0;
            
            // Mostrar coordenadas si existen
            if (c.lat && c.lng) {
                document.getElementById('coordsInfo').style.display = 'block';
            }
            
            // Calcular y mostrar totales
            calcularTotal();
            
            // Guardar ID para actualizar en lugar de crear
            window.clienteEditandoId = id;
            document.getElementById('btnCrearCliente').innerHTML = '<i class="fas fa-save me-2"></i>Guardar Cambios';
            
            // Cambiar título del modal
            document.querySelector('#clienteModal .modal-title').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Cliente';
            
            // Abrir modal
            const modal = new bootstrap.Modal(document.getElementById('clienteModal'));
            modal.show();
        }
        
        // ========== ELIMINAR Y RESTABLECER CLIENTES ==========
        let clientesEliminados = [];
        
        async function eliminarCliente(id) {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            // Verificar llave de edición para trabajadores
            if (currentUser && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                // Primero verificar si el admin habilitó la llave
                const hasKey = await checkEditKey();
                if (!hasKey) {
                    alert('🔒 Tu llave está BLOQUEADA por el administrador.\n\nNo puedes eliminar hasta que el admin desbloquee tu llave.');
                    return;
                }
                // Luego verificar si tiene contraseña y está desbloqueada
                if (userHasEditPassword && !editUnlocked) {
                    alert('🔒 Edición bloqueada.\n\nDesbloquea tu llave con tu contraseña en la sección de Clientes.');
                    return;
                }
            }
            
            const c = clientes.find(cl => cl.id === id);
            if (!c) return;
            
            if (!confirm(`¿Eliminar al cliente "${c.nombre}"?\n\nEl cliente será movido a la papelera y podrás restablecerlo desde Mi Historial.`)) return;
            
            try {
                // Guardar en colección de eliminados
                const clienteEliminado = { ...c, fechaEliminacion: getCurrentDate().toISOString(), creadoPor: currentUser.id };
                await fetch(API_URL + '/api/clientes-eliminados', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clienteEliminado)
                });
                
                // Eliminar de clientes activos
                await fetch(API_URL + '/api/clientes/' + id, { method: 'DELETE' });
                
                // Actualizar lista local
                clientes = clientes.filter(cl => cl.id !== id);
                renderClientes();
                updateStats();
                cargarClientesEliminados();
                showToast('✅ Cliente eliminado. Puedes restablecerlo desde Mi Historial.', 3000);
            } catch (e) {
                alert('Error al eliminar: ' + e.message);
            }
        }
        
        async function cargarClientesEliminados() {
            try {
                const res = await fetch(API_URL + '/api/clientes-eliminados?userId=' + currentUser.id);
                clientesEliminados = await res.json();
                if (clientesEliminados.error) clientesEliminados = [];
                renderClientesEliminados();
            } catch (e) {
                clientesEliminados = [];
                renderClientesEliminados();
            }
        }
        
        function renderClientesEliminados() {
            const container = document.getElementById('clientesEliminados');
            if (!container) return;
            
            // Filtrar por cartera actual
            let eliminadosCartera = clientesEliminados;
            if (carteraActual !== null && carteras.length > 0) {
                eliminadosCartera = clientesEliminados.filter(c => c.carteraId === carteraActual);
            }
            
            // Aplicar filtro de búsqueda
            const busqueda = (document.getElementById('buscarEliminado')?.value || '').toLowerCase();
            const filtrados = eliminadosCartera.filter(c => 
                !busqueda || (c.nombre && c.nombre.toLowerCase().includes(busqueda))
            );
            
            if (!filtrados || filtrados.length === 0) {
                container.innerHTML = `<p class="text-secondary text-center py-3">${busqueda ? 'No se encontraron clientes con ese nombre' : t('noClientesEliminados')}</p>`;
                return;
            }
            
            container.innerHTML = filtrados.map(c => {
                const fechaElim = c.fechaEliminacion ? new Date(c.fechaEliminacion).toLocaleDateString('es-BR') : 'Desconocida';
                const fechaCreacion = c.fechaCreacion ? new Date(c.fechaCreacion).toLocaleDateString('es-BR') : 'Desconocida';
                const restante = ((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2);
                return `
                <div class="card-dark mb-2" style="border-left: 3px solid var(--accent-red);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div style="flex: 1;">
                            <strong style="color: var(--accent-red);"><i class="fas fa-user-times me-2"></i>${c.nombre}</strong>
                            <div class="row mt-2" style="font-size: 0.85rem;">
                                <div class="col-6">
                                    <small class="text-secondary"><i class="fas fa-phone me-1"></i>${c.telefono || 'Sin teléfono'}</small><br>
                                    <small class="text-secondary"><i class="fas fa-map-marker-alt me-1"></i>${c.ubicacion || 'Sin ubicación'}</small><br>
                                    <small class="text-secondary"><i class="fas fa-store me-1"></i>${c.tipoNegocio || 'Sin negocio'}</small>
                                </div>
                                <div class="col-6">
                                    <small class="text-secondary"><i class="fas fa-money-bill me-1"></i>Prestado: <span style="color: var(--accent-cyan);">R$ ${(c.montoTotal || 0).toFixed(2)}</span></small><br>
                                    <small class="text-secondary"><i class="fas fa-check me-1"></i>Cobrado: <span style="color: var(--accent-green);">R$ ${(c.montoPagado || 0).toFixed(2)}</span></small><br>
                                    <small class="text-secondary"><i class="fas fa-times me-1"></i>Restante: <span style="color: var(--accent-red);">R$ ${restante}</span></small>
                                </div>
                            </div>
                            <div class="mt-2" style="font-size: 0.8rem;">
                                <small class="text-secondary"><i class="fas fa-calendar-plus me-1"></i>Creado: ${fechaCreacion}</small>
                                <small class="text-secondary ms-3"><i class="fas fa-trash me-1"></i>Eliminado: ${fechaElim}</small>
                                <small class="text-secondary ms-3"><i class="fas fa-percentage me-1"></i>Comisión: ${c.comisionPorcentaje || 20}%</small>
                            </div>
                        </div>
                        <button class="btn btn-sm" style="background: var(--accent-green); color: #fff;" onclick="restablecerCliente('${c._id || c.id}')" title="Restablecer cliente">
                            <i class="fas fa-undo me-1"></i>Restablecer
                        </button>
                    </div>
                </div>`;
            }).join('');
        }
        
        function filtrarClientesEliminados() {
            renderClientesEliminados();
        }
        
        let clienteRestableciendo = null;
        
        function restablecerCliente(id) {
            console.log('Restableciendo cliente con ID:', id);
            console.log('Clientes eliminados:', clientesEliminados);
            const c = clientesEliminados.find(cl => cl.id === id || cl._id === id);
            if (!c) {
                console.log('Cliente no encontrado');
                alert('Error: Cliente no encontrado');
                return;
            }
            
            console.log('Cliente encontrado:', c);
            clienteRestableciendo = c;
            
            // Abrir modal de nuevo cliente con datos prellenados
            document.getElementById('clienteNombre').value = c.nombre || '';
            document.getElementById('clienteTelefono').value = c.telefono || '';
            document.getElementById('clienteUbicacion').value = c.ubicacion || '';
            document.getElementById('clienteLat').value = c.lat || '';
            document.getElementById('clienteLng').value = c.lng || '';
            document.getElementById('coordsInfo').style.display = (c.lat && c.lng) ? 'block' : 'none';
            document.getElementById('clienteTipo').value = c.tipoCliente || 'nuevo';
            document.getElementById('clienteNegocio').value = c.tipoNegocio || '';
            document.getElementById('clienteNegocioOtro').value = c.negocioOtro || '';
            document.getElementById('clienteNombreNegocio').value = c.nombreNegocio || '';
            document.getElementById('clienteNotas').value = c.notas || '';
            document.getElementById('clienteMonto').value = c.montoTotal || '';
            document.getElementById('clienteParcelas').value = c.numeroParcelas || '';
            document.getElementById('clienteComision').value = c.comisionPorcentaje || '20';
            
            // Calcular valores
            calcularTotal();
            
            // Cambiar texto del botón a "Restablecer Cliente"
            document.getElementById('btnCrearCliente').textContent = 'Restablecer Cliente';
            
            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }
        
        let clienteRenovandoId = null;
        
        function renovarCliente(id) {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            const c = clientes.find(cl => cl.id === id);
            if (!c) return;
            
            // Guardar ID del cliente que se está renovando
            clienteRenovandoId = id;
            
            // Abrir modal de nuevo cliente con datos prellenados
            document.getElementById('clienteNombre').value = c.nombre;
            document.getElementById('clienteTelefono').value = c.telefono || '';
            document.getElementById('clienteUbicacion').value = c.ubicacion || '';
            document.getElementById('clienteLat').value = c.lat || '';
            document.getElementById('clienteLng').value = c.lng || '';
            document.getElementById('coordsInfo').style.display = (c.lat && c.lng) ? 'block' : 'none';
            document.getElementById('clienteTipo').value = 'bueno'; // Al renovar, es buen cliente
            document.getElementById('clienteNegocio').value = c.tipoNegocio || '';
            document.getElementById('clienteNegocioOtro').value = c.negocioOtro || '';
            document.getElementById('clienteNombreNegocio').value = c.nombreNegocio || '';
            document.getElementById('clienteNotas').value = c.notas || '';
            document.getElementById('clienteMonto').value = '';
            document.getElementById('clienteParcelas').value = '';
            document.getElementById('clienteComision').value = c.comisionPorcentaje || '20';
            
            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }

        // ========== GASTOS ==========
        function openGastoModal() {
            // Verificar si hay caja inicial del día
            if (!verificarCajaInicialDelDia()) {
                return;
            }
            
            document.getElementById('gastoDescripcion').value = '';
            document.getElementById('gastoValor').value = '';
            document.getElementById('gastoFecha').value = getFechaLocal();
            document.getElementById('gastoCategoria').value = '';
            gastoEnProceso = false; // Resetear protección doble clic
            new bootstrap.Modal(document.getElementById('gastoModal')).show();
        }

        function setGastoHoy() {
            document.getElementById('gastoFechaFiltro').value = getFechaLocal();
            renderGastos();
        }

        let gastoEnProceso = false; // Prevenir doble clic
        
        async function guardarGasto() {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            if (gastoEnProceso) return; // Prevenir doble clic
            
            const descripcion = document.getElementById('gastoDescripcion').value;
            const valor = parseFloat(document.getElementById('gastoValor').value);
            const fecha = document.getElementById('gastoFecha').value;
            const categoria = document.getElementById('gastoCategoria').value;
            
            if (!descripcion || !valor || !fecha) {
                return alert('Completa todos los campos');
            }
            
            gastoEnProceso = true; // Bloquear más clics
            
            const userId = currentUser.id || currentUser._id;
            
            const gasto = {
                descripcion,
                valor,
                fecha,
                categoria,
                creadoPor: userId,
                timestamp: getCurrentDate().toISOString(),
                carteraId: carteraActual || null
            };
            
            try {
                const res = await fetch(API_URL + '/api/gastos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(gasto)
                });
                const data = await res.json();
                if (data.success) {
                    gasto.id = data.id;
                    gastos.push(gasto);
                    bootstrap.Modal.getInstance(document.getElementById('gastoModal')).hide();
                    renderGastos();
                    updateStats();
                    calcularCajaDelDia(); // Actualizar caja después de gasto
                    mostrarMensajeExito('✅ Gasto guardado');
                } else {
                    gastoEnProceso = false; // Permitir reintentar
                    alert('Error al guardar gasto');
                }
            } catch (e) {
                gastoEnProceso = false; // Permitir reintentar
                alert('Error al guardar gasto');
            }
        }

        async function eliminarGasto(id) {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            if (!confirm('¿Eliminar este gasto?')) return;
            try {
                await fetch(API_URL + '/api/gastos/' + id, { method: 'DELETE' });
                gastos = gastos.filter(g => g.id !== id);
                renderGastos();
            } catch (e) {
                alert('Error al eliminar');
            }
        }

        function renderGastos() {
            try {
                const fechaFiltro = document.getElementById('gastoFechaFiltro')?.value || '';
                const hoy = getCurrentDateString();
                
                // Obtener gastos filtrados por cartera
                const gastosCartera = getGastosFiltrados() || [];
                
                // Calcular totales (asegurar que valor sea número)
                const gastosHoy = gastosCartera.filter(g => g.fecha === hoy).reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                const inicioSemana = getCurrentDate();
                inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
                const gastosSemana = gastosCartera.filter(g => new Date(g.fecha) >= inicioSemana).reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                const inicioMes = getCurrentDate();
                inicioMes.setDate(1);
                const gastosMes = gastosCartera.filter(g => new Date(g.fecha) >= inicioMes).reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                // Actualizar elementos con verificación
                const elHoy = document.getElementById('gastoHoy');
                const elSemana = document.getElementById('gastoSemana');
                const elMes = document.getElementById('gastoMes');
                
                if (elHoy) elHoy.textContent = 'R$ ' + gastosHoy.toFixed(2);
                if (elSemana) elSemana.textContent = 'R$ ' + gastosSemana.toFixed(2);
                if (elMes) elMes.textContent = 'R$ ' + gastosMes.toFixed(2);
                
                // Filtrar por fecha seleccionada
                const gastosFiltrados = fechaFiltro ? gastosCartera.filter(g => g.fecha === fechaFiltro) : [];
                const totalDia = gastosFiltrados.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                const container = document.getElementById('gastosLista');
                if (!container) return;
                
                if (gastosFiltrados.length === 0) {
                    container.innerHTML = `<p class="text-center text-secondary py-4">${t('sinGastosFecha')}</p>`;
                    return;
                }
                
                const categoriaIcons = {
                    servicios: '💡', comida: '🍔', transporte: '🚗', salud: '💊',
                    entretenimiento: '🎬', ropa: '👕', educacion: '📚', hogar: '🏠', otro: '📦'
                };
                
                container.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom" style="border-color: var(--border-color) !important;">
                        <strong>${t('totalDia')}:</strong>
                        <span style="color: var(--accent-red); font-size: 1.3rem;">R$ ${totalDia.toFixed(2)}</span>
                    </div>
                    ${gastosFiltrados.map(g => `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <span style="font-size: 1.2rem;">${categoriaIcons[g.categoria] || '📦'}</span>
                                <strong class="ms-2">${g.descripcion || 'Sin descripción'}</strong>
                                <br><small class="text-secondary">${g.categoria || 'otro'}</small>
                            </div>
                            <div class="d-flex align-items-center gap-3">
                                <span style="color: var(--accent-red);">R$ ${(parseFloat(g.valor) || 0).toFixed(2)}</span>
                                <button class="btn btn-sm" style="background: var(--accent-red); color: white;" onclick="eliminarGasto('${g.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('')}
                `;
            } catch (e) {
                console.error('Error en renderGastos:', e);
            }
        }

        // ========== MICROSEGUROS ==========
        function renderMicroseguros() {
            const hoy = getCurrentDateString();
            const fechaInicio = document.getElementById('microseguroFechaInicio').value;
            const fechaFin = document.getElementById('microseguroFechaFin').value;
            const busqueda = (document.getElementById('microseguroBusqueda').value || '').toLowerCase().trim();
            
            // Filtrar clientes por cartera actual que tienen microseguro (excluir renovados)
            const clientesCartera = getClientesFiltrados().filter(c => !c.renovado);
            const clientesConMicroseguro = clientesCartera.filter(c => c.microseguro && c.microseguro > 0);
            
            // Calcular totales por período
            const ahora = getCurrentDate();
            
            // Hoy
            const microseguroHoy = clientesConMicroseguro
                .filter(c => c.fechaCreacion && c.fechaCreacion.split('T')[0] === hoy)
                .reduce((s, c) => s + (c.microseguro || 0), 0);
            
            // Últimos 7 días
            const hace7Dias = new Date(ahora);
            hace7Dias.setDate(hace7Dias.getDate() - 7);
            const microseguroSemana = clientesConMicroseguro
                .filter(c => c.fechaCreacion && new Date(c.fechaCreacion) >= hace7Dias)
                .reduce((s, c) => s + (c.microseguro || 0), 0);
            
            // Este mes
            const inicioMes = new Date(ahora.getFullYear(), ahora.getMonth(), 1);
            const microseguroMes = clientesConMicroseguro
                .filter(c => c.fechaCreacion && new Date(c.fechaCreacion) >= inicioMes)
                .reduce((s, c) => s + (c.microseguro || 0), 0);
            
            // Este año
            const inicioAnio = new Date(ahora.getFullYear(), 0, 1);
            const microseguroAnio = clientesConMicroseguro
                .filter(c => c.fechaCreacion && new Date(c.fechaCreacion) >= inicioAnio)
                .reduce((s, c) => s + (c.microseguro || 0), 0);
            
            // Actualizar estadísticas
            document.getElementById('microseguroHoy').textContent = 'R$ ' + microseguroHoy.toFixed(2);
            document.getElementById('microseguroSemana').textContent = 'R$ ' + microseguroSemana.toFixed(2);
            document.getElementById('microseguroMes').textContent = 'R$ ' + microseguroMes.toFixed(2);
            document.getElementById('microseguroAnio').textContent = 'R$ ' + microseguroAnio.toFixed(2);
            
            // Filtrar por búsqueda de nombre o teléfono
            let clientesFiltrados = clientesConMicroseguro;
            if (busqueda) {
                clientesFiltrados = clientesFiltrados.filter(c => 
                    (c.nombre || '').toLowerCase().includes(busqueda) ||
                    (c.telefono || '').startsWith(busqueda) ||
                    (c.telefono || '').replace(/\D/g, '').startsWith(busqueda.replace(/\D/g, ''))
                );
            }
            
            // Filtrar por rango de fechas si está seleccionado
            if (fechaInicio && fechaFin) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    if (!c.fechaCreacion) return false;
                    const fecha = c.fechaCreacion.split('T')[0];
                    return fecha >= fechaInicio && fecha <= fechaFin;
                });
            } else if (fechaInicio) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    if (!c.fechaCreacion) return false;
                    return c.fechaCreacion.split('T')[0] >= fechaInicio;
                });
            } else if (fechaFin) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    if (!c.fechaCreacion) return false;
                    return c.fechaCreacion.split('T')[0] <= fechaFin;
                });
            }
            
            // Ordenar por fecha más reciente
            clientesFiltrados.sort((a, b) => new Date(b.fechaCreacion) - new Date(a.fechaCreacion));
            
            const container = document.getElementById('microsegurosLista');
            
            if (clientesFiltrados.length === 0) {
                container.innerHTML = '<tr><td colspan="4" class="text-center text-secondary py-4">No hay microseguros registrados</td></tr>';
                return;
            }
            
            container.innerHTML = clientesFiltrados.map(c => {
                const fecha = c.fechaCreacion ? new Date(c.fechaCreacion).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) : 'N/A';
                return `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div style="width: 35px; height: 35px; background: var(--accent-purple); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-user" style="color: white; font-size: 0.8rem;"></i>
                                </div>
                                <div>
                                    <strong>${c.nombre}</strong>
                                    <br><small class="text-secondary">${c.telefono || 'Sin teléfono'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${fecha}</td>
                        <td style="color: var(--accent-purple); font-weight: 600;">R$ ${(c.microseguro || 0).toFixed(2)}</td>
                        <td>R$ ${(c.montoTotal || 0).toFixed(2)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function setMicroseguroHoy() {
            const hoy = getFechaLocal();
            document.getElementById('microseguroFechaInicio').value = hoy;
            document.getElementById('microseguroFechaFin').value = hoy;
            renderMicroseguros();
        }
        
        function resetMicroseguroFiltro() {
            document.getElementById('microseguroFechaInicio').value = '';
            document.getElementById('microseguroFechaFin').value = '';
            document.getElementById('microseguroBusqueda').value = '';
            renderMicroseguros();
        }

        // ========== MAPA ==========
        let map = null;
        let markers = [];
        let miUbicacion = null;
        let miMarcador = null;

        function initMapa() {
            // Excluir clientes renovados
            const clientesCartera = getClientesFiltrados().filter(c => !c.renovado);
            const clientesConUbi = clientesCartera.filter(c => c.lat && c.lng);
            const clientesSinUbi = clientesCartera.filter(c => !c.lat || !c.lng);
            
            document.getElementById('clientesConUbicacion').textContent = clientesConUbi.length;
            document.getElementById('clientesSinUbicacion').textContent = clientesSinUbi.length;
            
            // Inicializar mapa si no existe
            if (!map) {
                map = L.map('mapContainer').setView([4.6097, -74.0817], 12); // Bogotá por defecto
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(map);
            }
            
            // Limpiar marcadores anteriores
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Agregar marcadores de clientes
            clientesConUbi.forEach(c => {
                const tipoColors = { nuevo: '#00d4ff', bueno: '#2ecc71', regular: '#e6a700', malo: '#ff4757' };
                const color = tipoColors[c.tipoCliente] || '#00d4ff';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-user" style="color: white; font-size: 12px;"></i></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const marker = L.marker([c.lat, c.lng], { icon }).addTo(map);
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 1.1rem;">${c.nombre}</strong><br>
                        <small>${c.ubicacion || 'Sin dirección'}</small><hr style="margin: 8px 0;">
                        <div><i class="fas fa-phone"></i> ${c.telefono || 'N/A'}</div>
                        <div><i class="fas fa-money-bill"></i> Restante: R$ ${restante.toFixed(2)}</div>
                        <div style="margin-top: 10px;">
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank" class="btn btn-sm btn-primary-custom" style="width: 100%;">
                                <i class="fas fa-directions"></i> Cómo llegar
                            </a>
                        </div>
                    </div>
                `);
                markers.push(marker);
            });
            
            // Centrar mapa si hay clientes
            if (clientesConUbi.length > 0) {
                const bounds = L.latLngBounds(clientesConUbi.map(c => [c.lat, c.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Renderizar lista
            renderListaClientesMapa(clientesConUbi);
            
            // Forzar redimensionamiento del mapa
            setTimeout(() => map.invalidateSize(), 100);
        }

        function renderListaClientesMapa(clientesConUbi) {
            const container = document.getElementById('listaClientesMapa');
            if (clientesConUbi.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center">No hay clientes con ubicación guardada</p>';
                return;
            }
            
            container.innerHTML = clientesConUbi.map(c => {
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                return `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <strong>${c.nombre}</strong>
                        <br><small class="text-secondary"><i class="fas fa-map-marker-alt"></i> ${c.ubicacion || 'Sin dirección'}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm" style="background: var(--bg-hover);" onclick="centrarEnCliente('${c.id}')">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank" class="btn btn-sm btn-primary-custom">
                            <i class="fas fa-directions"></i>
                        </a>
                    </div>
                </div>`;
            }).join('');
        }

        function centrarEnCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (cliente && cliente.lat && cliente.lng) {
                map.setView([cliente.lat, cliente.lng], 16);
                // Abrir popup del marcador
                const marker = markers.find((m, i) => {
                    const clientesConUbi = clientes.filter(c => c.lat && c.lng);
                    return clientesConUbi[i] && clientesConUbi[i].id === clienteId;
                });
                if (marker) marker.openPopup();
            }
        }

        function obtenerMiUbicacion() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalización');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    miUbicacion = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    
                    // Mostrar en mapa
                    if (miMarcador) map.removeLayer(miMarcador);
                    
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: #00d4ff; width: 20px; height: 20px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 15px rgba(0,212,255,0.8);"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    miMarcador = L.marker([miUbicacion.lat, miUbicacion.lng], { icon }).addTo(map);
                    miMarcador.bindPopup('<strong>Tu ubicación</strong>').openPopup();
                    
                    map.setView([miUbicacion.lat, miUbicacion.lng], 14);
                    document.getElementById('miUbicacionCard').style.display = 'block';
                },
                (err) => {
                    alert('No se pudo obtener tu ubicación. Asegúrate de dar permiso.');
                },
                { enableHighAccuracy: true }
            );
        }

        function obtenerUbicacionCliente() {
            const direccion = document.getElementById('clienteUbicacion').value;
            if (!direccion || direccion.trim() === '') {
                alert('Escribe una dirección primero');
                return;
            }
            
            // Buscar coordenadas de la dirección usando Nominatim (OpenStreetMap)
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(direccion)}&format=json&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        
                        document.getElementById('clienteLat').value = lat;
                        document.getElementById('clienteLng').value = lng;
                        document.getElementById('coordsInfo').style.display = 'block';
                        
                        // Mostrar mini mapa en un modal
                        mostrarMapaPreview(lat, lng, direccion);
                    } else {
                        alert('No se encontró la dirección. Intenta ser más específico (ej: "Calle 10 #5-20, Bogotá, Colombia")');
                    }
                })
                .catch(() => {
                    alert('Error al buscar la dirección. Intenta de nuevo.');
                });
        }

        let previewMap = null;
        function mostrarMapaPreview(lat, lng, direccion) {
            // Crear modal si no existe
            let modal = document.getElementById('mapaPreviewModal');
            if (!modal) {
                const modalHtml = `
                <div class="modal fade modal-dark" id="mapaPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>Ubicación encontrada</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p id="direccionEncontrada" class="text-secondary mb-3"></p>
                                <div id="mapaPreviewContainer" style="height: 350px; border-radius: 10px; overflow: hidden;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-success-custom" data-bs-dismiss="modal">
                                    <i class="fas fa-check me-2"></i>Confirmar ubicación
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('mapaPreviewModal');
            }
            
            document.getElementById('direccionEncontrada').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${direccion}`;
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Inicializar mapa después de que el modal esté visible
            modal.addEventListener('shown.bs.modal', function initPreviewMap() {
                if (previewMap) {
                    previewMap.remove();
                }
                
                previewMap = L.map('mapaPreviewContainer').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(previewMap);
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #00d4ff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 15px rgba(0,212,255,0.5);"><i class="fas fa-map-marker-alt" style="color: white; font-size: 18px;"></i></div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                L.marker([lat, lng], { icon }).addTo(previewMap)
                    .bindPopup(`<strong>${direccion}</strong>`)
                    .openPopup();
                
                modal.removeEventListener('shown.bs.modal', initPreviewMap);
            }, { once: true });
        }

        // PWA Install
        let deferredPrompt = null;
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            // Mostrar botones de instalar
            document.getElementById('installBanner').style.display = 'block';
            document.getElementById('installBtn').style.display = 'inline-block';
        });
        
        function installApp() {
            if (!deferredPrompt) {
                // Si no hay prompt, dar instrucciones manuales
                alert('Para instalar FinanGest:\n\n📱 En celular: Toca los 3 puntos del menú y selecciona "Instalar app" o "Añadir a pantalla de inicio"\n\n💻 En PC: Busca el icono de instalar (⊕) en la barra de direcciones');
                return;
            }
            
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('App instalada');
                    document.getElementById('installBanner').style.display = 'none';
                    document.getElementById('installBtn').style.display = 'none';
                }
                deferredPrompt = null;
            });
        }
        
        window.addEventListener('appinstalled', () => {
            document.getElementById('installBanner').style.display = 'none';
            document.getElementById('installBtn').style.display = 'none';
            deferredPrompt = null;
        });

        // Sistema de sesión: usar sessionStorage para que se cierre al cerrar navegador
        const SESSION_KEY = 'finangest_user';

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar idioma en pantalla de Auth
            initIdiomaAuth();
            
            // Si viene con ?logout en la URL, borrar sesión
            if (window.location.search.includes('logout')) {
                sessionStorage.removeItem(SESSION_KEY);
                window.history.replaceState({}, '', window.location.pathname);
                document.body.classList.add('loaded');
                return;
            }
            
            // FORZAR LIMPIEZA COMPLETA Y MOSTRAR SOLO LOGIN
            sessionStorage.clear();
            localStorage.clear();
            currentUser = null;
            
            // FORZAR mostrar solo pantalla de login
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
            document.body.classList.add('loaded');
            
            // NO EJECUTAR AUTO-LOGIN BAJO NINGUNA CIRCUNSTANCIA
            return;
            
            // CÓDIGO DESHABILITADO PERMANENTEMENTE
            const saved = sessionStorage.getItem(SESSION_KEY);
            // DESHABILITAR AUTO-LOGIN TEMPORALMENTE
            if (false && saved) {
                currentUser = JSON.parse(saved);
                showMainApp();
            }
            // Mostrar página después de verificar sesión
            document.body.classList.add('loaded');
            
            // Limpiar Service Worker viejo y forzar actualización
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => reg.unregister());
                });
                // Registrar nuevo Service Worker
                navigator.serviceWorker.register('/sw.js', { updateViaCache: 'none' })
                    .then(reg => {
                        reg.update();
                        console.log('Service Worker actualizado');
                    })
                    .catch(err => console.log('Error SW:', err));
            }
            
            // Limpiar caché viejo
            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }
            
            // Listener para resetear variables cuando se cierra el modal de cliente
            const clienteModal = document.getElementById('clienteModal');
            if (clienteModal) {
                clienteModal.addEventListener('hidden.bs.modal', () => {
                    clienteRestableciendo = null;
                    clienteRenovandoId = null;
                    window.clienteEditandoId = null;
                    document.getElementById('btnCrearCliente').innerHTML = '<i class="fas fa-plus me-2"></i>Crear Cliente';
                    document.querySelector('#clienteModal .modal-title').innerHTML = '<i class="fas fa-user-plus me-2"></i>Nuevo Cliente';
                    document.getElementById('coordsInfo').style.display = 'none';
                });
            }
        });

        // ============ FUNCIONES ADMIN EDITAR/ELIMINAR ============
        
        // Editar cliente desde admin
        async function adminEditarCliente(clienteId) {
            // Verificar llave de edición individual del trabajador
            if (currentUser && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                if (userHasEditPassword && !editUnlocked) {
                    alert('🔒 Edición bloqueada.\n\nDesbloquea tu llave de edición en la sección de Clientes para poder editar.');
                    return;
                }
            }
            
            const cliente = verTodoClientes.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            // Crear modal de edición
            let modal = document.getElementById('adminEditClienteModal');
            if (modal) modal.remove();
            
            const modalHtml = `
            <div class="modal fade modal-dark" id="adminEditClienteModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2" style="color: var(--accent-cyan);"></i>Editar Cliente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">👤 Nombre del Cliente</label>
                                    <input type="text" class="form-control form-control-dark" id="adminEditNombre" value="${cliente.nombre || ''}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">📱 Teléfono</label>
                                    <input type="tel" class="form-control form-control-dark" id="adminEditTelefono" value="${cliente.telefono || ''}">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">⭐ Tipo de Cliente</label>
                                    <select class="form-control form-control-dark" id="adminEditTipo">
                                        <option value="nuevo" ${cliente.tipoCliente === 'nuevo' ? 'selected' : ''}>🆕 Nuevo</option>
                                        <option value="bueno" ${cliente.tipoCliente === 'bueno' ? 'selected' : ''}>✅ Buen Cliente</option>
                                        <option value="regular" ${cliente.tipoCliente === 'regular' ? 'selected' : ''}>⚠️ Regular</option>
                                        <option value="malo" ${cliente.tipoCliente === 'malo' ? 'selected' : ''}>❌ Mala Paga</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">🏪 Tipo de Negocio</label>
                                    <select class="form-control form-control-dark" id="adminEditTipoNegocio">
                                        <option value="" ${!cliente.tipoNegocio ? 'selected' : ''}>-- Seleccionar --</option>
                                        <option value="tienda" ${cliente.tipoNegocio === 'tienda' ? 'selected' : ''}>🏪 Tienda</option>
                                        <option value="restaurante" ${cliente.tipoNegocio === 'restaurante' ? 'selected' : ''}>🍽️ Restaurante</option>
                                        <option value="taxista" ${cliente.tipoNegocio === 'taxista' ? 'selected' : ''}>🚕 Taxista</option>
                                        <option value="vendedor" ${cliente.tipoNegocio === 'vendedor' ? 'selected' : ''}>🛒 Vendedor Ambulante</option>
                                        <option value="peluqueria" ${cliente.tipoNegocio === 'peluqueria' ? 'selected' : ''}>💇 Peluquería/Barbería</option>
                                        <option value="taller" ${cliente.tipoNegocio === 'taller' ? 'selected' : ''}>🔧 Taller Mecánico</option>
                                        <option value="farmacia" ${cliente.tipoNegocio === 'farmacia' ? 'selected' : ''}>💊 Farmacia</option>
                                        <option value="panaderia" ${cliente.tipoNegocio === 'panaderia' ? 'selected' : ''}>🥖 Panadería</option>
                                        <option value="carniceria" ${cliente.tipoNegocio === 'carniceria' ? 'selected' : ''}>🥩 Carnicería</option>
                                        <option value="ferreteria" ${cliente.tipoNegocio === 'ferreteria' ? 'selected' : ''}>🔨 Ferretería</option>
                                        <option value="ropa" ${cliente.tipoNegocio === 'ropa' ? 'selected' : ''}>👕 Tienda de Ropa</option>
                                        <option value="celulares" ${cliente.tipoNegocio === 'celulares' ? 'selected' : ''}>📱 Celulares/Tecnología</option>
                                        <option value="otro" ${cliente.tipoNegocio === 'otro' ? 'selected' : ''}>📦 Otro</option>
                                    </select>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">💰 Monto Prestado (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditMonto" value="${cliente.montoTotal || 0}" step="0.01">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">� Dinero Csobrado (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditMontoCobrado" value="${cliente.montoPagado || 0}" step="0.01">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">📋 Total a Pagar (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditTotalPagar" value="${cliente.totalAPagar || 0}" step="0.01">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">�️ Parcielas a Pagar</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditTotalParcelas" value="${cliente.numeroParcelas || 0}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">✔️ Parcelas Pagas</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditParcelasPagas" value="${cliente.parcelasPagas || 0}">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">🛡️ Microseguro (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditMicroseguro" value="${cliente.microseguro || 0}" step="0.01">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">� Conmisión (%)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditComision" value="${cliente.comisionPorcentaje || 20}" step="1">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">📝 Notas sobre el cliente</label>
                                <textarea class="form-control form-control-dark" id="adminEditNotas" rows="2" placeholder="Información adicional...">${cliente.notas || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">📍 Ubicación / Dirección</label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-dark" id="adminEditUbicacion" value="${cliente.ubicacion || ''}" placeholder="Dirección del cliente">
                                    <button class="btn btn-primary-custom" type="button" onclick="obtenerUbicacionAdmin()" title="Buscar ubicación">
                                        <i class="fas fa-crosshairs"></i>
                                    </button>
                                    ${cliente.lat && cliente.lng ? '<button class="btn btn-success-custom" type="button" onclick="verMapaAdmin(' + cliente.lat + ', ' + cliente.lng + ')" title="Ver en mapa"><i class="fas fa-map-marker-alt"></i></button>' : ''}
                                </div>
                                <input type="hidden" id="adminEditLat" value="${cliente.lat || ''}">
                                <input type="hidden" id="adminEditLng" value="${cliente.lng || ''}">
                                <input type="hidden" id="adminEditCreadoPor" value="${cliente.creadoPor || cliente.userId || verTodoUserId || ''}">
                                <small id="adminCoordsInfo" class="text-secondary" style="display: ${cliente.lat && cliente.lng ? 'block' : 'none'};">
                                    <i class="fas fa-check-circle text-success"></i> Coordenadas guardadas
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary-custom" onclick="guardarAdminEditCliente('${clienteId}')">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const bsModal = new bootstrap.Modal(document.getElementById('adminEditClienteModal'));
            bsModal.show();
        }
        
        function obtenerUbicacionAdmin() {
            const direccion = document.getElementById('adminEditUbicacion').value;
            if (!direccion || direccion.trim() === '') {
                alert('Escribe una dirección primero');
                return;
            }
            
            const btn = event.target.closest('button');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
            
            // Buscar coordenadas de la dirección usando Nominatim (OpenStreetMap)
            fetch('https://nominatim.openstreetmap.org/search?q=' + encodeURIComponent(direccion) + '&format=json&limit=1')
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        
                        // Mostrar mapa para confirmar
                        mostrarMapaPreviewAdmin(lat, lng, direccion);
                    } else {
                        alert('No se encontró la dirección. Intenta ser más específico (ej: "Rua 10, Goiânia, Brasil")');
                    }
                })
                .catch(function() {
                    btn.innerHTML = originalHtml;
                    btn.disabled = false;
                    alert('Error al buscar la dirección. Intenta de nuevo.');
                });
        }
        
        let previewMapAdmin = null;
        function mostrarMapaPreviewAdmin(lat, lng, direccion) {
            // Crear modal si no existe
            let modal = document.getElementById('mapaPreviewAdminModal');
            if (modal) modal.remove();
            
            const modalHtml = '<div class="modal fade modal-dark" id="mapaPreviewAdminModal" tabindex="-1">' +
                '<div class="modal-dialog modal-lg">' +
                    '<div class="modal-content">' +
                        '<div class="modal-header">' +
                            '<h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>Ubicación encontrada</h5>' +
                            '<button type="button" class="btn-close" data-bs-dismiss="modal"></button>' +
                        '</div>' +
                        '<div class="modal-body">' +
                            '<p id="direccionEncontradaAdmin" class="text-secondary mb-3"><i class="fas fa-check-circle text-success me-2"></i>' + direccion + '</p>' +
                            '<div id="mapaPreviewContainerAdmin" style="height: 350px; border-radius: 10px; overflow: hidden;"></div>' +
                        '</div>' +
                        '<div class="modal-footer">' +
                            '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>' +
                            '<button type="button" class="btn btn-success-custom" onclick="confirmarUbicacionAdmin(' + lat + ', ' + lng + ')">' +
                                '<i class="fas fa-check me-2"></i>Confirmar ubicación' +
                            '</button>' +
                        '</div>' +
                    '</div>' +
                '</div>' +
            '</div>';
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            modal = document.getElementById('mapaPreviewAdminModal');
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Inicializar mapa después de que el modal esté visible
            modal.addEventListener('shown.bs.modal', function initPreviewMapAdmin() {
                if (previewMapAdmin) {
                    previewMapAdmin.remove();
                }
                
                previewMapAdmin = L.map('mapaPreviewContainerAdmin').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(previewMapAdmin);
                
                var icon = L.divIcon({
                    className: 'custom-marker',
                    html: '<div style="background: #00d4ff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 15px rgba(0,212,255,0.5);"><i class="fas fa-map-marker-alt" style="color: white; font-size: 18px;"></i></div>',
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                L.marker([lat, lng], { icon: icon }).addTo(previewMapAdmin)
                    .bindPopup('<strong>' + direccion + '</strong>')
                    .openPopup();
                
                modal.removeEventListener('shown.bs.modal', initPreviewMapAdmin);
            }, { once: true });
        }
        
        function confirmarUbicacionAdmin(lat, lng) {
            document.getElementById('adminEditLat').value = lat;
            document.getElementById('adminEditLng').value = lng;
            document.getElementById('adminCoordsInfo').style.display = 'block';
            
            // Cerrar modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('mapaPreviewAdminModal'));
            if (modal) modal.hide();
        }
        
        function verMapaAdmin(lat, lng) {
            window.open('https://www.google.com/maps?q=' + lat + ',' + lng, '_blank');
        }
        
        async function guardarAdminEditCliente(clienteId) {
            // Obtener creadoPor original del campo oculto
            const creadoPorOriginal = document.getElementById('adminEditCreadoPor').value;
            
            const updates = {
                nombre: document.getElementById('adminEditNombre').value,
                telefono: document.getElementById('adminEditTelefono').value,
                tipoCliente: document.getElementById('adminEditTipo').value,
                montoTotal: parseFloat(document.getElementById('adminEditMonto').value) || 0,
                totalAPagar: parseFloat(document.getElementById('adminEditTotalPagar').value) || 0,
                comisionPorcentaje: parseFloat(document.getElementById('adminEditComision').value) || 20,
                parcelasPagas: parseInt(document.getElementById('adminEditParcelasPagas').value) || 0,
                numeroParcelas: parseInt(document.getElementById('adminEditTotalParcelas').value) || 0,
                microseguro: parseFloat(document.getElementById('adminEditMicroseguro').value) || 0,
                montoPagado: parseFloat(document.getElementById('adminEditMontoCobrado').value) || 0,
                tipoNegocio: document.getElementById('adminEditTipoNegocio').value,
                ubicacion: document.getElementById('adminEditUbicacion').value,
                notas: document.getElementById('adminEditNotas').value,
                lat: document.getElementById('adminEditLat').value || null,
                lng: document.getElementById('adminEditLng').value || null,
                creadoPor: creadoPorOriginal // Enviar el creadoPor original
            };
            
            // Calcular valor por parcela
            if (updates.numeroParcelas > 0) {
                updates.valorParcela = updates.totalAPagar / updates.numeroParcelas;
            } else {
                updates.valorParcela = 0;
            }
            
            // Calcular estado automáticamente
            if (updates.montoPagado >= updates.totalAPagar && updates.totalAPagar > 0) {
                updates.estado = 'pagado';
                updates.parcelasPagas = updates.numeroParcelas;
            } else if (updates.montoPagado > 0) {
                updates.estado = 'parcial';
            } else {
                updates.estado = 'pendiente';
            }
            
            try {
                const res = await fetch(API_URL + '/api/clientes/' + clienteId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Cliente actualizado correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('adminEditClienteModal')).hide();
                    // Recargar datos
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function adminEliminarCliente(clienteId) {
            // Verificar llave de edición para trabajadores
            if (currentUser && currentUser.role !== 'admin' && !currentUser.isAdmin) {
                const hasKey = await checkEditKey();
                if (!hasKey) {
                    alert('🔒 No tienes permiso para eliminar.\n\nTu llave de edición está DESACTIVADA.\nContacta al administrador para activarla.');
                    return;
                }
                if (userHasEditPassword && !editUnlocked) {
                    alert('🔒 Edición bloqueada.\n\nDesbloquea tu llave de edición en la sección de Clientes para poder eliminar.');
                    return;
                }
            }
            
            const cliente = verTodoClientes.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            if (!confirm(`⚠️ ¿Eliminar al cliente "${cliente.nombre}"?\n\nEsta acción no se puede deshacer.`)) return;
            if (!confirm('⚠️ ÚLTIMA CONFIRMACIÓN\n\n¿Estás seguro de eliminar este cliente?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/clientes/' + clienteId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Cliente eliminado');
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // Editar gasto desde admin
        function adminEditarGasto(gastoId) {
            const gasto = verTodoGastos.find(g => g.id === gastoId);
            if (!gasto) return alert('Gasto no encontrado');
            
            let modal = document.getElementById('adminEditGastoModal');
            if (modal) modal.remove();
            
            const fechaValue = gasto.fecha ? gasto.fecha.split('T')[0] : '';
            
            const modalHtml = `
            <div class="modal fade modal-dark" id="adminEditGastoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2" style="color: var(--accent-cyan);"></i>Editar Gasto</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Descripción</label>
                                <input type="text" class="form-control form-control-dark" id="adminEditGastoDesc" value="${gasto.descripcion || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Categoría</label>
                                <select class="form-control form-control-dark" id="adminEditGastoCat">
                                    <option value="transporte" ${gasto.categoria === 'transporte' ? 'selected' : ''}>🚗 Transporte</option>
                                    <option value="alimentacion" ${gasto.categoria === 'alimentacion' ? 'selected' : ''}>🍔 Alimentación</option>
                                    <option value="comunicacion" ${gasto.categoria === 'comunicacion' ? 'selected' : ''}>📱 Comunicación</option>
                                    <option value="oficina" ${gasto.categoria === 'oficina' ? 'selected' : ''}>📎 Oficina</option>
                                    <option value="otros" ${gasto.categoria === 'otros' ? 'selected' : ''}>📦 Otros</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor (R$)</label>
                                <input type="number" class="form-control form-control-dark" id="adminEditGastoValor" value="${gasto.valor || 0}" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control form-control-dark" id="adminEditGastoFecha" value="${fechaValue}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success-custom" onclick="guardarAdminEditGasto('${gastoId}')">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const bsModal = new bootstrap.Modal(document.getElementById('adminEditGastoModal'));
            bsModal.show();
        }
        
        async function guardarAdminEditGasto(gastoId) {
            const updates = {
                descripcion: document.getElementById('adminEditGastoDesc').value,
                categoria: document.getElementById('adminEditGastoCat').value,
                valor: parseFloat(document.getElementById('adminEditGastoValor').value) || 0,
                fecha: document.getElementById('adminEditGastoFecha').value
            };
            
            try {
                const res = await fetch(API_URL + '/api/admin/gasto/' + gastoId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Gasto actualizado correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('adminEditGastoModal')).hide();
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        async function adminEliminarGasto(gastoId) {
            const gasto = verTodoGastos.find(g => g.id === gastoId);
            if (!gasto) return alert('Gasto no encontrado');
            
            if (!confirm(`⚠️ ¿Eliminar el gasto "${gasto.descripcion}"?\n\nEsta acción no se puede deshacer.`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/gasto/' + gastoId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('✅ Gasto eliminado');
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        // ============ FIN FUNCIONES ADMIN EDITAR/ELIMINAR ============
        
        // ============ SISTEMA DE CARTERAS ============
        
        // Cargar carteras del usuario
        async function cargarCarteras() {
            if (!currentUser) return;
            try {
                const res = await fetch(API_URL + '/api/carteras/' + currentUser.id);
                const data = await res.json();
                if (data.success) {
                    carteras = data.carteras || [];
                    
                    // Verificar carteras expiradas (por fecha individual)
                    const ahora = getCurrentDate();
                    const carterasExpiradas = carteras.filter(c => {
                        if (c.fechaExpiracion) {
                            return new Date(c.fechaExpiracion) < ahora;
                        }
                        return false;
                    });
                    
                    // Marcar carteras expiradas como pendientes de pago
                    carteras.forEach(c => {
                        if (c.fechaExpiracion && new Date(c.fechaExpiracion) < ahora) {
                            c.expirada = true;
                        }
                    });
                    
                    renderCarterasDropdown();
                    
                    // Restaurar cartera si estaba desbloqueada en esta sesión
                    const savedCartera = localStorage.getItem('finangest_cartera_' + currentUser.id);
                    const carteraDesbloqueada = localStorage.getItem('finangest_cartera_unlocked_' + currentUser.id);
                    const carteraGuardada = carteras.find(c => c.id === savedCartera);
                    
                    // Restaurar si:
                    // 1. La cartera existe Y no tiene contraseña Y no está expirada, O
                    // 2. La cartera existe Y fue desbloqueada en esta sesión Y no está expirada
                    if (carteraGuardada && !carteraGuardada.expirada && (!carteraGuardada.password || carteraDesbloqueada === savedCartera)) {
                        carteraActual = savedCartera;
                    } else {
                        // No seleccionar ninguna - mostrar pantalla de cartera bloqueada
                        carteraActual = null;
                        localStorage.removeItem('finangest_cartera_' + currentUser.id);
                        localStorage.removeItem('finangest_cartera_unlocked_' + currentUser.id);
                    }
                    actualizarBotonCartera();
                    
                    // Si hay carteras expiradas, mostrar modal de renovación
                    if (carterasExpiradas.length > 0 && !window.modalRenovacionMostrado) {
                        window.modalRenovacionMostrado = true;
                        setTimeout(() => {
                            mostrarModalRenovarCarteras(carterasExpiradas);
                        }, 1000);
                    }
                } else {
                    carteras = [];
                    carteraActual = null;
                }
            } catch (e) {
                console.error('Error cargando carteras:', e);
                carteras = [];
                carteraActual = null;
            }
        }
        
        // Variable para filtro de carteras
        let filtroCarteras = '';
        
        // Renderizar dropdown de carteras
        function renderCarterasDropdown() {
            const lista = document.getElementById('carterasList');
            if (!lista) return;
            
            let html = '';
            
            // Agregar buscador siempre (útil para buscar rápido)
            html += `
                <div style="padding: 10px 15px; border-bottom: 1px solid var(--border-color);">
                    <div style="position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); font-size: 0.8rem;"></i>
                        <input type="text" id="buscarCarteraInput" placeholder="Buscar cartera..." 
                               value="${filtroCarteras}"
                               oninput="filtrarCarteras(this.value)"
                               onclick="event.stopPropagation()"
                               style="width: 100%; padding: 8px 10px 8px 32px; background: var(--bg-dark); border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); font-size: 0.85rem;">
                    </div>
                </div>
            `;
            
            // Filtrar carteras
            const carterasFiltradas = carteras.filter(c => 
                c.nombre.toLowerCase().includes(filtroCarteras.toLowerCase())
            );
            
            if (carterasFiltradas.length === 0 && filtroCarteras) {
                html += `<div style="padding: 15px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-search" style="font-size: 1.2rem; margin-bottom: 8px; display: block;"></i>
                    No se encontraron carteras
                </div>`;
            } else if (carteras.length === 0) {
                html += `<div style="padding: 15px; text-align: center; color: var(--text-secondary);">
                    <i class="fas fa-folder-open" style="font-size: 1.5rem; margin-bottom: 10px; display: block;"></i>
                    No tienes carteras.<br>Crea una para empezar.
                </div>`;
            } else {
                carterasFiltradas.forEach(c => {
                    const isActive = c.id === carteraActual;
                    const tienePassword = c.password ? '<i class="fas fa-lock" style="color: var(--accent-yellow); font-size: 0.65rem; margin-left: 5px;" title="Protegida"></i>' : '';
                    const estaExpirada = c.expirada || (c.fechaExpiracion && new Date(c.fechaExpiracion) < getCurrentDate());
                    
                    // Calcular días restantes
                    let diasInfo = '';
                    if (c.fechaExpiracion) {
                        const hoy = getCurrentDate();
                        const expira = new Date(c.fechaExpiracion);
                        const diffTime = expira - hoy;
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        
                        if (estaExpirada) {
                            diasInfo = '<span style="background: var(--accent-red); color: white; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">EXPIRADA</span>';
                        } else if (diffDays <= 5) {
                            diasInfo = `<span style="background: var(--accent-yellow); color: #000; font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; margin-left: 5px;">${diffDays}d</span>`;
                        } else {
                            diasInfo = `<span style="color: var(--text-secondary); font-size: 0.65rem; margin-left: 5px;">${diffDays}d</span>`;
                        }
                    }
                    
                    const opacidad = estaExpirada ? 'opacity: 0.6;' : '';
                    const onclickAction = estaExpirada 
                        ? `mostrarModalRenovarCarteraUnica('${c.id}')`
                        : `seleccionarCartera('${c.id}')`;
                    html += `
                        <div onclick="${onclickAction}" style="padding: 12px 15px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: all 0.2s; ${isActive ? 'background: var(--bg-hover);' : ''} ${opacidad}" 
                             onmouseover="this.style.background='var(--bg-hover)'" 
                             onmouseout="this.style.background='${isActive ? 'var(--bg-hover)' : 'transparent'}'">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#00d4ff'};"></div>
                            <span style="flex: 1; color: var(--text-primary); font-size: 0.9rem;">${c.nombre}${tienePassword}${diasInfo}</span>
                            ${isActive ? '<i class="fas fa-check" style="color: var(--accent-green); font-size: 0.8rem;"></i>' : ''}
                            <i class="fas fa-cog" style="color: var(--text-secondary); font-size: 0.75rem;" onclick="event.stopPropagation(); editarCartera('${c.id}')"></i>
                        </div>
                    `;
                });
            }
            
            lista.innerHTML = html;
        }
        
        // Filtrar carteras por nombre
        function filtrarCarteras(valor) {
            filtroCarteras = valor;
            renderCarterasDropdown();
            // Mantener el foco en el input
            setTimeout(() => {
                const input = document.getElementById('buscarCarteraInput');
                if (input) {
                    input.focus();
                    input.setSelectionRange(input.value.length, input.value.length);
                }
            }, 10);
        }
        
        // Toggle dropdown de carteras
        function toggleCarteraDropdown() {
            const dropdown = document.getElementById('carteraDropdown');
            if (dropdown) {
                const isOpening = dropdown.style.display === 'none';
                dropdown.style.display = isOpening ? 'block' : 'none';
                // Limpiar filtro al cerrar
                if (!isOpening) {
                    filtroCarteras = '';
                }
            }
        }
        
        // Cerrar dropdown al hacer click fuera
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('carteraDropdown');
            const btn = document.getElementById('carteraBtn');
            if (dropdown && btn && !btn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.style.display = 'none';
                filtroCarteras = ''; // Limpiar filtro
            }
        });
        
        // Variables para contraseña de cartera
        let carteraPasswordPendiente = null;
        let carteraRecuperacionCodigo = null;
        // NO guardamos carteras desbloqueadas - siempre pide contraseña al cambiar
        
        // Seleccionar cartera (con verificación de contraseña)
        function seleccionarCartera(carteraId) {
            const cartera = carteras.find(c => c.id === carteraId);
            if (!cartera) return;
            
            // Si es la misma cartera actual pero NO tiene contraseña, pedir crear una
            if (carteraId === carteraActual) {
                if (!cartera.password) {
                    // Pedir crear contraseña para la cartera actual
                    carteraPasswordPendiente = carteraId;
                    document.getElementById('carteraCrearPasswordNombre').textContent = cartera.nombre;
                    document.getElementById('carteraNuevaPassword').value = '';
                    document.getElementById('carteraConfirmarPassword').value = '';
                    toggleCarteraDropdown();
                    new bootstrap.Modal(document.getElementById('carteraCrearPasswordModal')).show();
                    setTimeout(() => document.getElementById('carteraNuevaPassword').focus(), 300);
                } else {
                    // Ya tiene contraseña, solo cerrar dropdown
                    toggleCarteraDropdown();
                }
                return;
            }
            
            // Si la cartera tiene contraseña, pedirla
            if (cartera.password) {
                carteraPasswordPendiente = carteraId;
                document.getElementById('carteraPasswordNombre').textContent = cartera.nombre;
                document.getElementById('carteraPasswordInput').value = '';
                toggleCarteraDropdown();
                new bootstrap.Modal(document.getElementById('carteraPasswordModal')).show();
                setTimeout(() => document.getElementById('carteraPasswordInput').focus(), 300);
                return;
            }
            
            // Si no tiene contraseña, pedir crear una
            carteraPasswordPendiente = carteraId;
            document.getElementById('carteraCrearPasswordNombre').textContent = cartera.nombre;
            document.getElementById('carteraNuevaPassword').value = '';
            document.getElementById('carteraConfirmarPassword').value = '';
            toggleCarteraDropdown();
            new bootstrap.Modal(document.getElementById('carteraCrearPasswordModal')).show();
            setTimeout(() => document.getElementById('carteraNuevaPassword').focus(), 300);
        }
        
        // Acceder a la cartera (después de verificar contraseña)
        function accederCartera(carteraId) {
            carteraActual = carteraId;
            if (currentUser) {
                localStorage.setItem('finangest_cartera_' + currentUser.id, carteraId || '');
                // Guardar que esta cartera fue desbloqueada en esta sesión
                localStorage.setItem('finangest_cartera_unlocked_' + currentUser.id, carteraId || '');
            }
            actualizarBotonCartera();
            toggleCarteraDropdown();
            renderCarterasDropdown();
            // IMPORTANTE: Actualizar el menú para mostrar todas las opciones
            actualizarMenuSegunCarteras();
            // Cargar caja inicial de esta cartera
            cargarCajaInicial();
            // Actualizar TODAS las vistas con los datos filtrados por cartera
            updateStats();
            renderClientes();
            renderGastos();
            if (typeof renderChart === 'function') renderChart();
            if (typeof renderCobros === 'function') renderCobros();
            if (typeof renderMicroseguros === 'function') renderMicroseguros();
            if (typeof renderEstadisticas === 'function') renderEstadisticas();
            if (typeof renderClientesEliminados === 'function') renderClientesEliminados();
            if (typeof renderHistorial === 'function') renderHistorial();
            if (typeof initMapa === 'function' && document.getElementById('mapa')?.classList.contains('active')) initMapa();
        }
        
        // Toggle visibilidad de contraseña
        function toggleCarteraPasswordVisibility(inputId, btn) {
            const input = document.getElementById(inputId);
            if (input.type === 'password') {
                input.type = 'text';
                btn.innerHTML = '<i class="fas fa-eye-slash"></i>';
            } else {
                input.type = 'password';
                btn.innerHTML = '<i class="fas fa-eye"></i>';
            }
        }
        
        // Verificar contraseña de cartera
        async function verificarCarteraPassword() {
            const password = document.getElementById('carteraPasswordInput').value;
            if (!password) {
                alert('Ingresa la contraseña');
                return;
            }
            
            const cartera = carteras.find(c => c.id === carteraPasswordPendiente);
            if (!cartera) return;
            
            console.log('Verificando contraseña para cartera:', cartera.nombre);
            console.log('Password guardado en cartera:', cartera.password);
            console.log('Password ingresado:', password);
            
            // Verificar contraseña (simple comparación - en producción usar hash)
            if (password === cartera.password) {
                bootstrap.Modal.getInstance(document.getElementById('carteraPasswordModal')).hide();
                showToast('✅ ¡Bienvenido a ' + cartera.nombre + '!', 2500);
                accederCartera(carteraPasswordPendiente);
                carteraPasswordPendiente = null;
            } else {
                alert('❌ Contraseña incorrecta');
                document.getElementById('carteraPasswordInput').value = '';
                document.getElementById('carteraPasswordInput').focus();
            }
        }
        
        // Crear contraseña para cartera
        async function crearCarteraPassword() {
            const password = document.getElementById('carteraNuevaPassword').value;
            const confirmar = document.getElementById('carteraConfirmarPassword').value;
            
            if (!password || password.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            
            if (password !== confirmar) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            const cartera = carteras.find(c => c.id === carteraPasswordPendiente);
            if (!cartera) return;
            
            try {
                // Guardar contraseña en la cartera (solo enviar password)
                console.log('Guardando contraseña para cartera:', carteraPasswordPendiente);
                const res = await fetch(API_URL + '/api/carteras/' + carteraPasswordPendiente, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });
                
                const data = await res.json();
                console.log('Respuesta guardar contraseña:', data);
                if (data.success) {
                    cartera.password = password;
                    bootstrap.Modal.getInstance(document.getElementById('carteraCrearPasswordModal')).hide();
                    // NO acceder automáticamente - mostrar pantalla de cartera bloqueada
                    carteraActual = null;
                    carteraPasswordPendiente = null;
                    mostrarPantallaCarteraBloqueada();
                    alert('✅ Contraseña creada. Ahora haz click en la cartera e ingresa tu contraseña para acceder.');
                } else {
                    alert('Error al guardar contraseña');
                }
            } catch (e) {
                console.error('Error guardando contraseña:', e);
                alert('Error de conexión');
            }
        }
        
        // Mostrar pantalla de cartera bloqueada (tiene carteras pero ninguna desbloqueada)
        function mostrarPantallaCarteraBloqueada() {
            const menu = document.getElementById('navMenu');
            const sidebar = document.getElementById('sidebar');
            const carteraBtn = document.getElementById('carteraBtn');
            
            // Mostrar sidebar pero con menú limitado
            if (sidebar) sidebar.style.display = 'block';
            if (carteraBtn) carteraBtn.style.display = 'flex';
            
            // Restaurar margen
            const mainContent = document.querySelector('.main-content');
            if (mainContent) mainContent.style.marginLeft = '';
            
            // Actualizar botón de cartera
            document.getElementById('carteraActualNombre').textContent = 'Seleccionar Cartera';
            
            // Menú limitado (solo Configuración)
            if (menu) {
                menu.innerHTML = `
                    <div class="nav-item" onclick="showSection('miConfig')"><i class="fas fa-cog"></i><span>Configuración</span></div>
                `;
            }
            
            // Mostrar sección de cartera bloqueada
            showSection('carteraBloqueada');
            renderCarterasDropdown();
        }
        
        // Olvidó contraseña de cartera
        function olvidoCarteraPassword() {
            bootstrap.Modal.getInstance(document.getElementById('carteraPasswordModal')).hide();
            const cartera = carteras.find(c => c.id === carteraPasswordPendiente);
            if (!cartera) return;
            
            document.getElementById('carteraRecuperarNombre').textContent = cartera.nombre;
            document.getElementById('carteraRecuperarPaso1').style.display = 'block';
            document.getElementById('carteraRecuperarPaso2').style.display = 'none';
            document.getElementById('btnConfirmarRecuperacionCartera').style.display = 'none';
            
            new bootstrap.Modal(document.getElementById('carteraRecuperarPasswordModal')).show();
        }
        
        // Enviar código de recuperación
        async function enviarCodigoRecuperacionCartera() {
            if (!currentUser || !currentUser.email) {
                alert('No tienes un email configurado. Contacta al administrador.');
                return;
            }
            
            try {
                // Generar código de 6 dígitos
                carteraRecuperacionCodigo = Math.floor(100000 + Math.random() * 900000).toString();
                
                const cartera = carteras.find(c => c.id === carteraPasswordPendiente);
                
                // Enviar email al email principal del usuario
                const res = await fetch(API_URL + '/api/send-recovery-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        code: carteraRecuperacionCodigo,
                        tipo: 'cartera',
                        carteraNombre: cartera?.nombre || 'Cartera'
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    alert('✅ Código enviado a ' + currentUser.email);
                    document.getElementById('carteraRecuperarPaso1').style.display = 'none';
                    document.getElementById('carteraRecuperarPaso2').style.display = 'block';
                    document.getElementById('btnConfirmarRecuperacionCartera').style.display = 'block';
                    document.getElementById('carteraCodigoRecuperacion').value = '';
                    document.getElementById('carteraNuevaPasswordRecuperar').value = '';
                    document.getElementById('carteraConfirmarPasswordRecuperar').value = '';
                    setTimeout(() => document.getElementById('carteraCodigoRecuperacion').focus(), 100);
                } else {
                    alert('Error al enviar código: ' + (data.error || 'Intenta de nuevo'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // Confirmar recuperación de contraseña de cartera
        async function confirmarRecuperacionCartera() {
            const codigo = document.getElementById('carteraCodigoRecuperacion').value;
            const nuevaPassword = document.getElementById('carteraNuevaPasswordRecuperar').value;
            const confirmarPassword = document.getElementById('carteraConfirmarPasswordRecuperar').value;
            
            if (codigo !== carteraRecuperacionCodigo) {
                alert('❌ Código incorrecto');
                return;
            }
            
            if (!nuevaPassword || nuevaPassword.length < 4) {
                alert('La contraseña debe tener al menos 4 caracteres');
                return;
            }
            
            if (nuevaPassword !== confirmarPassword) {
                alert('Las contraseñas no coinciden');
                return;
            }
            
            const cartera = carteras.find(c => c.id === carteraPasswordPendiente);
            if (!cartera) return;
            
            try {
                const res = await fetch(API_URL + '/api/carteras/' + carteraPasswordPendiente, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ...cartera, password: nuevaPassword })
                });
                
                const data = await res.json();
                if (data.success) {
                    cartera.password = nuevaPassword;
                    bootstrap.Modal.getInstance(document.getElementById('carteraRecuperarPasswordModal')).hide();
                    accederCartera(carteraPasswordPendiente);
                    carteraPasswordPendiente = null;
                    carteraRecuperacionCodigo = null;
                    alert('✅ Contraseña cambiada correctamente');
                } else {
                    alert('Error al cambiar contraseña');
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // Cancelar recuperación
        function cancelarRecuperacionCartera() {
            bootstrap.Modal.getInstance(document.getElementById('carteraRecuperarPasswordModal')).hide();
            carteraRecuperacionCodigo = null;
            // Volver al modal de contraseña
            new bootstrap.Modal(document.getElementById('carteraPasswordModal')).show();
        }
        
        // Actualizar texto del botón de cartera
        function actualizarBotonCartera() {
            const nombreSpan = document.getElementById('carteraActualNombre');
            const btn = document.getElementById('carteraBtn');
            if (!nombreSpan) return;
            
            // Mostrar/ocultar contenido según si hay cartera
            const sinCarteraMsg = document.getElementById('sinCarteraMsg');
            const clientesContent = document.getElementById('clientesContent');
            
            if (carteraActual === null || carteras.length === 0) {
                nombreSpan.textContent = 'Sin Cartera';
                if (btn) btn.querySelector('i.fa-wallet').style.color = 'var(--text-secondary)';
                // Mostrar mensaje de sin cartera, ocultar contenido
                if (sinCarteraMsg) sinCarteraMsg.style.display = 'block';
                if (clientesContent) clientesContent.style.display = 'none';
            } else {
                const cartera = carteras.find(c => c.id === carteraActual);
                if (cartera) {
                    nombreSpan.textContent = cartera.nombre;
                    if (btn) btn.querySelector('i.fa-wallet').style.color = cartera.color || 'var(--accent-cyan)';
                } else {
                    nombreSpan.textContent = 'Sin Cartera';
                    if (btn) btn.querySelector('i.fa-wallet').style.color = 'var(--text-secondary)';
                }
                // Ocultar mensaje, mostrar contenido
                if (sinCarteraMsg) sinCarteraMsg.style.display = 'none';
                if (clientesContent) clientesContent.style.display = 'block';
            }
        }
        
        // Función para abrir modal de nueva cartera desde el mensaje
        function abrirModalNuevaCartera() {
            mostrarModalNuevaCartera();
        }
        
        let carteraEnProceso = false; // Prevenir doble clic
        
        // Mostrar modal para nueva cartera
        function mostrarModalNuevaCartera() {
            editandoCarteraId = null;
            carteraEnProceso = false; // Resetear protección doble clic
            document.getElementById('carteraModalTitle').textContent = 'Nueva Cartera';
            document.getElementById('carteraNombre').value = '';
            document.getElementById('carteraDescripcion').value = '';
            document.getElementById('carteraColorSeleccionado').value = '#00d4ff';
            
            // Ocultar botón eliminar al crear nueva
            const btnEliminar = document.getElementById('btnEliminarCarteraModal');
            if (btnEliminar) btnEliminar.style.display = 'none';
            
            // Reset color buttons
            document.querySelectorAll('.cartera-color-btn').forEach(btn => {
                btn.style.border = '3px solid transparent';
            });
            document.querySelector('.cartera-color-btn[data-color="#00d4ff"]').style.border = '3px solid white';
            
            toggleCarteraDropdown();
            const modal = new bootstrap.Modal(document.getElementById('carteraModal'));
            modal.show();
        }
        
        // Seleccionar color de cartera
        function seleccionarColorCartera(btn, color) {
            document.querySelectorAll('.cartera-color-btn').forEach(b => {
                b.style.border = '3px solid transparent';
            });
            btn.style.border = '3px solid white';
            document.getElementById('carteraColorSeleccionado').value = color;
        }
        
        // Variables para pago de cartera nueva
        let carteraNuevaPendiente = null;
        let pagoCarteraInterval = null;
        
        // Guardar cartera (nueva o editar)
        async function guardarCartera() {
            // NO verificar horario si el usuario está creando carteras que ya pagó
            const carterasActuales = carteras.length;
            const carterasPagadas = currentUser.carterasPagadas || 1;
            const esCarteraPagada = carterasActuales < carterasPagadas;
            
            // Solo verificar horario si NO es una cartera ya pagada
            if (!esCarteraPagada && !puedeRealizarAccion()) {
                return;
            }
            
            if (carteraEnProceso) return; // Prevenir doble clic
            
            const nombre = document.getElementById('carteraNombre').value.trim();
            const descripcion = document.getElementById('carteraDescripcion').value.trim();
            const color = document.getElementById('carteraColorSeleccionado').value;
            
            if (!nombre) {
                alert('Por favor ingresa un nombre para la cartera');
                return;
            }
            
            carteraEnProceso = true; // Bloquear más clics
            
            // Mostrar estado de carga inmediatamente
            const btn = document.getElementById('btnGuardarCartera');
            const btnTextoOriginal = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
            btn.disabled = true;
            
            try {
                let res;
                if (editandoCarteraId) {
                    // Editar cartera existente
                    res = await fetch(API_URL + '/api/carteras/' + editandoCarteraId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nombre, descripcion, color })
                    });
                    
                    const data = await res.json();
                    if (data.success) {
                        bootstrap.Modal.getInstance(document.getElementById('carteraModal')).hide();
                        await cargarCarteras();
                        actualizarMenuSegunCarteras();
                        btn.innerHTML = btnTextoOriginal;
                        btn.disabled = false;
                    } else {
                        carteraEnProceso = false;
                        btn.innerHTML = btnTextoOriginal;
                        btn.disabled = false;
                        alert('Error: ' + (data.error || 'No se pudo guardar'));
                    }
                } else {
                    // Crear nueva cartera
                    const carterasActuales = carteras.length;
                    const carterasPagadas = currentUser.carterasPagadas || 1;
                    
                    console.log('🔵 Creando cartera:', { currentUser, carterasActuales, carterasPagadas });
                    
                    // Si tiene carteras disponibles (pagadas pero no creadas), crear sin pago
                    if (carterasActuales < carterasPagadas) {
                        // Crear cartera sin pago (ya pagó por ella)
                        res = await fetch(API_URL + '/api/carteras', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id || currentUser._id,
                                nombre,
                                descripcion,
                                color,
                                esPrincipal: carterasActuales === 0,
                                pendientePago: false
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('carteraModal')).hide();
                            await cargarCarteras();
                            actualizarMenuSegunCarteras();
                            if (data.id) {
                                seleccionarCartera(data.id);
                            }
                            updateStats();
                            renderClientes();
                            renderChart();
                            btn.innerHTML = btnTextoOriginal;
                            btn.disabled = false;
                            showToast(`✅ Cartera "${nombre}" creada (${carterasActuales + 1}/${carterasPagadas} usadas)`, 3000);
                        } else {
                            carteraEnProceso = false;
                            btn.innerHTML = btnTextoOriginal;
                            btn.disabled = false;
                            alert('Error: ' + (data.error || 'No se pudo guardar'));
                        }
                    } else {
                        // Cartera adicional - requiere pago
                        // Primero crear la cartera como pendiente de pago
                        res = await fetch(API_URL + '/api/carteras', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                userId: currentUser.id,
                                nombre,
                                descripcion,
                                color,
                                esPrincipal: false,
                                pendientePago: true
                            })
                        });
                        
                        const data = await res.json();
                        if (data.success) {
                            bootstrap.Modal.getInstance(document.getElementById('carteraModal')).hide();
                            btn.innerHTML = btnTextoOriginal;
                            btn.disabled = false;
                            // Guardar datos de la cartera pendiente
                            carteraNuevaPendiente = {
                                id: data.id,
                                nombre,
                                color
                            };
                            // Mostrar modal de pago para esta cartera
                            mostrarModalPagoCarteraNueva(data.id, nombre);
                        } else {
                            carteraEnProceso = false;
                            btn.innerHTML = btnTextoOriginal;
                            btn.disabled = false;
                            alert('Error: ' + (data.error || 'No se pudo guardar'));
                        }
                    }
                }
            } catch (e) {
                carteraEnProceso = false;
                btn.innerHTML = btnTextoOriginal;
                btn.disabled = false;
                alert('Error de conexión');
            }
        }
        
        // Mostrar modal de pago para cartera nueva
        async function mostrarModalPagoCarteraNueva(carteraId, nombreCartera) {
            document.getElementById('nombreCarteraPago').textContent = nombreCartera;
            document.getElementById('modalPagoCarteraNueva').style.display = 'flex';
            
            // Generar PIX
            try {
                const res = await fetch(API_URL + '/api/crear-pago-cartera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.id,
                        carteraId: carteraId,
                        nombre: currentUser.nombre,
                        email: currentUser.email
                    })
                });
                
                const data = await res.json();
                if (data.success) {
                    // Mostrar QR
                    document.getElementById('qrCarteraNueva').innerHTML = `<img src="data:image/png;base64,${data.qrCodeBase64}" style="width: 200px; height: 200px;">`;
                    document.getElementById('pixCodigoCartera').value = data.qrCode;
                    
                    // Iniciar verificación automática
                    if (pagoCarteraInterval) clearInterval(pagoCarteraInterval);
                    pagoCarteraInterval = setInterval(() => verificarPagoCarteraNueva(data.paymentId, carteraId), 5000);
                } else {
                    document.getElementById('qrCarteraNueva').innerHTML = `<p style="color: var(--accent-red);">Error: ${data.error}</p>`;
                }
            } catch (e) {
                document.getElementById('qrCarteraNueva').innerHTML = `<p style="color: var(--accent-red);">Error de conexión</p>`;
            }
        }
        
        // Verificar pago de cartera nueva
        async function verificarPagoCarteraNueva(paymentId, carteraId) {
            try {
                const res = await fetch(API_URL + '/api/verificar-pago-cartera', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ paymentId, carteraId, userId: currentUser.id })
                });
                
                const data = await res.json();
                if (data.paid) {
                    if (pagoCarteraInterval) clearInterval(pagoCarteraInterval);
                    cerrarModalPagoCartera();
                    showToast('✅ ¡Cartera activada! Expira en 30 días.', 4000);
                    await cargarCarteras();
                    actualizarMenuSegunCarteras();
                    if (carteraNuevaPendiente && carteraNuevaPendiente.id) {
                        seleccionarCartera(carteraNuevaPendiente.id);
                    }
                    carteraNuevaPendiente = null;
                    carteraEnProceso = false;
                }
            } catch (e) {
                console.error('Error verificando pago:', e);
            }
        }
        
        // Copiar código PIX de cartera
        function copiarPixCartera() {
            const codigo = document.getElementById('pixCodigoCartera').value;
            navigator.clipboard.writeText(codigo).then(() => {
                showToast('📋 Código PIX copiado', 2000);
            });
        }
        
        // Cerrar modal de pago de cartera
        function cerrarModalPagoCartera() {
            document.getElementById('modalPagoCarteraNueva').style.display = 'none';
            if (pagoCarteraInterval) clearInterval(pagoCarteraInterval);
            carteraEnProceso = false;
        }
        
        // Cancelar pago de cartera nueva (eliminar la cartera pendiente)
        async function cancelarPagoCarteraNueva() {
            if (carteraNuevaPendiente && carteraNuevaPendiente.id) {
                try {
                    // Eliminar la cartera pendiente
                    await fetch(API_URL + '/api/carteras/' + carteraNuevaPendiente.id, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.id })
                    });
                } catch (e) {
                    console.error('Error eliminando cartera pendiente:', e);
                }
            }
            cerrarModalPagoCartera();
            carteraNuevaPendiente = null;
            showToast('Cartera cancelada', 2000);
        }
        
        // Editar cartera
        function editarCartera(carteraId) {
            const cartera = carteras.find(c => c.id === carteraId);
            if (!cartera) return;
            
            editandoCarteraId = carteraId;
            document.getElementById('carteraModalTitle').textContent = 'Editar Cartera';
            document.getElementById('carteraNombre').value = cartera.nombre;
            document.getElementById('carteraDescripcion').value = cartera.descripcion || '';
            document.getElementById('carteraColorSeleccionado').value = cartera.color || '#00d4ff';
            
            // Mostrar botón eliminar SOLO si hay una cartera desbloqueada (estamos dentro de una cartera)
            const btnEliminar = document.getElementById('btnEliminarCarteraModal');
            if (btnEliminar) {
                // Solo mostrar eliminar si ya estamos dentro de una cartera
                btnEliminar.style.display = carteraActual ? 'block' : 'none';
            }
            
            // Seleccionar color
            document.querySelectorAll('.cartera-color-btn').forEach(btn => {
                btn.style.border = btn.dataset.color === cartera.color ? '3px solid white' : '3px solid transparent';
            });
            
            toggleCarteraDropdown();
            const modal = new bootstrap.Modal(document.getElementById('carteraModal'));
            modal.show();
        }
        
        // Variable para carteras eliminadas
        let carterasEliminadas = [];
        let carteraAEliminar = null;
        
        // Mostrar modal de eliminar cartera
        function mostrarEliminarCartera() {
            if (!editandoCarteraId) return;
            const cartera = carteras.find(c => c.id === editandoCarteraId);
            if (!cartera) return;
            
            carteraAEliminar = editandoCarteraId;
            document.getElementById('eliminarCarteraNombre').textContent = cartera.nombre;
            document.getElementById('eliminarCarteraPassword').value = '';
            document.getElementById('eliminarCarteraConfirmacion').value = '';
            
            // Cerrar modal de editar
            bootstrap.Modal.getInstance(document.getElementById('carteraModal')).hide();
            
            // Abrir modal de eliminar
            setTimeout(() => {
                new bootstrap.Modal(document.getElementById('eliminarCarteraModal')).show();
            }, 300);
        }
        
        // Confirmar eliminación de cartera
        async function confirmarEliminarCartera() {
            const cartera = carteras.find(c => c.id === carteraAEliminar);
            if (!cartera) return;
            
            const password = document.getElementById('eliminarCarteraPassword').value;
            const confirmacion = document.getElementById('eliminarCarteraConfirmacion').value;
            
            // Verificar contraseña (solo si la cartera tiene contraseña)
            if (cartera.password && password !== cartera.password) {
                alert('Contraseña incorrecta');
                return;
            }
            
            // Verificar confirmación
            if (confirmacion.toUpperCase() !== 'ELIMINAR') {
                alert('Debes escribir "ELIMINAR" para confirmar');
                return;
            }
            
            try {
                // Mover a carteras eliminadas (soft delete)
                console.log('Eliminando cartera:', carteraAEliminar);
                const res = await fetch(API_URL + '/api/carteras/' + carteraAEliminar + '/eliminar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
                const data = await res.json();
                console.log('Respuesta eliminar:', data);
                
                if (data.success) {
                    // Cerrar modal primero
                    try {
                        bootstrap.Modal.getInstance(document.getElementById('eliminarCarteraModal'))?.hide();
                    } catch(e) {}
                    
                    // Limpiar estado de cartera actual
                    const carteraEliminadaId = carteraAEliminar;
                    carteraAEliminar = null;
                    
                    // Limpiar cartera actual si era la eliminada
                    if (carteraActual === carteraEliminadaId) {
                        carteraActual = null;
                        localStorage.removeItem('finangest_cartera_' + currentUser.id);
                        localStorage.removeItem('finangest_cartera_unlocked_' + currentUser.id);
                    }
                    
                    // Recargar carteras
                    try {
                        await cargarCarteras();
                    } catch(e) { console.error('Error cargando carteras:', e); }
                    
                    try {
                        await cargarCarterasEliminadas();
                    } catch(e) { console.error('Error cargando carteras eliminadas:', e); }
                    
                    console.log('Carteras después de eliminar:', carteras.length);
                    
                    // Redirigir según si hay más carteras
                    if (carteras.length === 0) {
                        // No hay más carteras - ir a crear primera cartera
                        actualizarMenuSegunCarteras();
                        showSection('sinCarteraInicio');
                        showToast('Cartera eliminada. Crea una nueva para continuar.', 3000);
                    } else {
                        // Hay otras carteras - ir a seleccionar cartera
                        carteraActual = null;
                        actualizarMenuSegunCarteras();
                        showSection('carteraBloqueada');
                        try { renderCarterasDropdown(); } catch(e) {}
                        showToast('Cartera eliminada. Selecciona otra para continuar.', 3000);
                    }
                } else {
                    // Cerrar modal aunque haya error
                    try {
                        bootstrap.Modal.getInstance(document.getElementById('eliminarCarteraModal'))?.hide();
                    } catch(e) {}
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                    carteraAEliminar = null;
                }
            } catch (e) {
                console.error('Error eliminando cartera:', e);
                // Cerrar modal aunque haya error
                try {
                    bootstrap.Modal.getInstance(document.getElementById('eliminarCarteraModal'))?.hide();
                } catch(e2) {}
                alert('Error de conexión: ' + e.message);
                carteraAEliminar = null;
            }
        }
        
        // Cargar carteras eliminadas
        async function cargarCarterasEliminadas() {
            try {
                console.log('Cargando carteras eliminadas para userId:', currentUser.id);
                const res = await fetch(API_URL + '/api/carteras-eliminadas?userId=' + currentUser.id);
                const data = await res.json();
                console.log('Carteras eliminadas recibidas:', data);
                carterasEliminadas = data.error ? [] : data;
                renderCarterasEliminadas();
                renderCarterasEliminadasHist();
            } catch (e) {
                console.error('Error cargando carteras eliminadas:', e);
                carterasEliminadas = [];
                renderCarterasEliminadas();
                renderCarterasEliminadasHist();
            }
        }
        
        // Renderizar carteras eliminadas
        function renderCarterasEliminadas() {
            const container = document.getElementById('carterasEliminadas');
            if (!container) return;
            
            const filtro = document.getElementById('buscarCarteraEliminada')?.value?.toLowerCase() || '';
            // Solo mostrar carteras que tengan al menos 1 cliente o 1 gasto
            const filtradas = carterasEliminadas.filter(c => 
                c.nombre.toLowerCase().includes(filtro) &&
                ((c.clientesBackup?.length || 0) > 0 || (c.gastosBackup?.length || 0) > 0)
            );
            
            if (filtradas.length === 0) {
                container.innerHTML = `<p class="text-center text-secondary py-3">No hay carteras eliminadas</p>`;
                return;
            }
            
            let html = '<div class="list-group">';
            filtradas.forEach(c => {
                const fecha = c.fechaEliminacion ? new Date(c.fechaEliminacion).toLocaleDateString() : 'N/A';
                const numClientes = c.clientesBackup?.length || 0;
                const numGastos = c.gastosBackup?.length || 0;
                const infoExtra = `${numClientes} clientes, ${numGastos} gastos`;
                
                html += `
                    <div class="list-group-item" style="background: var(--bg-hover); border-color: var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#666'};"></div>
                            <div>
                                <strong style="color: var(--text-primary);">${c.nombre}</strong>
                                <small class="d-block text-secondary">Eliminada: ${fecha} • ${infoExtra}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm" style="background: var(--accent-green); color: #fff;" onclick="restablecerCartera('${c.id}')" ${!editKeyActive ? 'disabled title="Activa la llave de edición"' : ''}>
                            <i class="fas fa-undo me-1"></i>Restablecer
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Filtrar carteras eliminadas
        function filtrarCarterasEliminadas() {
            renderCarterasEliminadas();
        }
        
        // Renderizar carteras eliminadas en sección Historial
        function renderCarterasEliminadasHist() {
            const container = document.getElementById('carterasEliminadasHist');
            if (!container) return;
            
            console.log('renderCarterasEliminadasHist - total:', carterasEliminadas.length);
            
            const filtro = document.getElementById('buscarCarteraEliminadaHist')?.value?.toLowerCase() || '';
            // Solo mostrar carteras que tengan al menos 1 cliente o 1 gasto
            const filtradas = carterasEliminadas.filter(c => 
                c.nombre.toLowerCase().includes(filtro) &&
                ((c.clientesBackup?.length || 0) > 0 || (c.gastosBackup?.length || 0) > 0)
            );
            
            console.log('Carteras filtradas:', filtradas.length);
            
            if (filtradas.length === 0) {
                container.innerHTML = `<p class="text-center text-secondary py-3">No hay carteras eliminadas</p>`;
                return;
            }
            
            let html = '<div class="list-group">';
            filtradas.forEach(c => {
                const fecha = c.fechaEliminacion ? new Date(c.fechaEliminacion).toLocaleDateString() : 'N/A';
                const numClientes = c.clientesBackup?.length || 0;
                const numGastos = c.gastosBackup?.length || 0;
                const infoExtra = `${numClientes} clientes, ${numGastos} gastos`;
                
                html += `
                    <div class="list-group-item" style="background: var(--bg-hover); border-color: var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background: ${c.color || '#666'};"></div>
                            <div>
                                <strong style="color: var(--text-primary);">${c.nombre}</strong>
                                <small class="d-block text-secondary">Eliminada: ${fecha} • ${infoExtra}</small>
                            </div>
                        </div>
                        <button class="btn btn-sm" style="background: var(--accent-green); color: #fff;" onclick="restablecerCartera('${c.id}')">
                            <i class="fas fa-undo me-1"></i>Restablecer
                        </button>
                    </div>
                `;
            });
            html += '</div>';
            container.innerHTML = html;
        }
        
        // Filtrar carteras eliminadas en historial
        function filtrarCarterasEliminadasHist() {
            renderCarterasEliminadasHist();
        }
        
        // Restablecer cartera
        async function restablecerCartera(carteraId) {
            const cartera = carterasEliminadas.find(c => c.id === carteraId);
            if (!cartera) return;
            
            if (!confirm(`¿Restablecer la cartera "${cartera.nombre}"?\n\nSe recuperarán ${cartera.clientesBackup?.length || 0} clientes y ${cartera.gastosBackup?.length || 0} gastos.`)) {
                return;
            }
            
            try {
                const res = await fetch(API_URL + '/api/carteras/' + carteraId + '/restablecer', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id })
                });
                const data = await res.json();
                
                if (data.success) {
                    // Recargar todo
                    await cargarCarteras();
                    await cargarCarterasEliminadas();
                    
                    // Recargar clientes y gastos
                    try {
                        const resClientes = await fetch(API_URL + '/api/clientes?userId=' + currentUser.id);
                        const dataClientes = await resClientes.json();
                        clientes = dataClientes.error ? [] : dataClientes;
                    } catch(e) {}
                    
                    try {
                        const resGastos = await fetch(API_URL + '/api/gastos?userId=' + currentUser.id);
                        const dataGastos = await resGastos.json();
                        gastos = dataGastos.error ? [] : dataGastos;
                    } catch(e) {}
                    
                    renderCarterasDropdown();
                    showToast('✅ Cartera "' + cartera.nombre + '" restablecida', 2500);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restablecer'));
                }
            } catch (e) {
                alert('Error de conexión');
            }
        }
        
        // Eliminar cartera (función legacy - ahora usa el modal)
        async function eliminarCartera(carteraId) {
            // Verificar si el sistema está cerrado (12 AM - 6 AM)
            if (!puedeRealizarAccion()) {
                return;
            }
            
            const cartera = carteras.find(c => c.id === carteraId);
            if (!cartera) return;
            
            // Usar el nuevo sistema con modal
            editandoCarteraId = carteraId;
            mostrarEliminarCartera();
        }
        
        // Obtener cartera actual para filtrar
        function getCarteraFiltro() {
            return carteraActual;
        }
        
        // ============ FIN SISTEMA DE CARTERAS ============
    </script>
    
    <!-- Modal de Suscripción/Error -->
    <div id="modalSuscripcion" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 20px; padding: 40px; max-width: 450px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div id="modalSuscripcionIcono" style="width: 80px; height: 80px; background: linear-gradient(135deg, #ff6b6b, #ee5a5a); border-radius: 50%; margin: 0 auto 25px; display: flex; align-items: center; justify-content: center;">
                <i class="fas fa-clock fa-2x" style="color: white;"></i>
            </div>
            <h3 style="color: #fff; margin-bottom: 15px;" id="modalSuscripcionTitulo">Error</h3>
            <p style="color: var(--text-secondary); margin-bottom: 30px; line-height: 1.6;" id="modalSuscripcionMensaje">
                Mensaje de error
            </p>
            <!-- Botón para renovar suscripción (solo cuando needsPayment) -->
            <button id="btnRenovarSuscripcion" onclick="cerrarModalSuscripcion()" style="display: none; width: 100%; padding: 16px; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; border-radius: 12px; color: #000; font-size: 1.1rem; font-weight: 600; cursor: pointer; margin-bottom: 10px;">
                <i class="fas fa-credit-card me-2"></i>Renovar Suscripción
            </button>
            <!-- Botón cerrar para errores normales -->
            <button id="btnCerrarModal" onclick="cerrarModalError()" style="display: none; width: 100%; padding: 16px; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 12px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer;">
                <i class="fas fa-times me-2"></i>Entendido
            </button>
        </div>
    </div>
    
    <!-- Modal de Renovación de Carteras -->
    <div id="modalRenovarCarteras" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="width: 70px; height: 70px; background: linear-gradient(135deg, #f39c12, #e67e22); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-wallet fa-2x" style="color: white;"></i>
                </div>
                <h3 style="color: #fff; margin-bottom: 10px;">Renovar Suscripción</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Selecciona las carteras que deseas renovar</p>
            </div>
            
            <!-- Lista de carteras con checkboxes -->
            <div id="listaCarterasRenovar" style="max-height: 250px; overflow-y: auto; margin-bottom: 20px;">
                <!-- Se llena dinámicamente -->
            </div>
            
            <!-- Botón seleccionar todas -->
            <button onclick="seleccionarTodasCarteras()" style="width: 100%; padding: 12px; background: var(--bg-hover); border: 1px solid var(--accent-cyan); border-radius: 8px; color: var(--accent-cyan); font-weight: 600; cursor: pointer; margin-bottom: 15px;">
                <i class="fas fa-check-double me-2"></i>Seleccionar Todas
            </button>
            
            <!-- Total a pagar -->
            <div style="background: var(--bg-hover); border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 20px;">
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Total a Pagar</p>
                <h2 id="totalRenovacion" style="color: var(--accent-green); font-size: 2rem; margin: 0;">R$ 0,00</h2>
                <small id="detalleRenovacion" style="color: var(--text-secondary);">0 carteras × R$ 51,41</small>
            </div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 10px;">
                <button onclick="cerrarModalRenovacion()" style="flex: 1; padding: 14px; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 10px; color: #fff; font-weight: 600; cursor: pointer;">
                    Cancelar
                </button>
                <button onclick="confirmarRenovacion()" id="btnConfirmarRenovacion" style="flex: 2; padding: 14px; background: linear-gradient(135deg, #00d4ff, #0099cc); border: none; border-radius: 10px; color: #000; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-credit-card me-2"></i>Pagar con PIX
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Pago para Cartera Nueva -->
    <div id="modalPagoCarteraNueva" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10001; justify-content: center; align-items: center;">
        <div style="background: var(--bg-card); border-radius: 20px; padding: 30px; max-width: 450px; width: 90%; border: 1px solid var(--border-color); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <div style="text-align: center; margin-bottom: 20px;">
                <div style="width: 60px; height: 60px; background: linear-gradient(135deg, #00d4ff, #0099cc); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-folder-plus fa-xl" style="color: white;"></i>
                </div>
                <h3 style="color: #fff; margin-bottom: 8px;">Nueva Cartera</h3>
                <p style="color: var(--text-secondary); font-size: 0.9rem;">Paga para activar: <strong id="nombreCarteraPago" style="color: var(--accent-cyan);"></strong></p>
            </div>
            
            <!-- Precio -->
            <div style="background: var(--bg-hover); border-radius: 12px; padding: 15px; text-align: center; margin-bottom: 20px;">
                <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 5px;">Precio por cartera</p>
                <h2 style="color: var(--accent-green); font-size: 2rem; margin: 0;">R$ 51,41</h2>
                <small style="color: var(--text-secondary);">Válido por 30 días</small>
            </div>
            
            <!-- QR Code -->
            <div id="qrCarteraNueva" style="text-align: center; margin-bottom: 15px; min-height: 200px; display: flex; align-items: center; justify-content: center;">
                <div class="spinner-border text-info" role="status">
                    <span class="visually-hidden">Generando PIX...</span>
                </div>
            </div>
            
            <!-- Código PIX -->
            <div style="margin-bottom: 20px;">
                <label style="color: var(--text-secondary); font-size: 0.85rem; display: block; margin-bottom: 5px;">Código PIX Copia y Pega:</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="pixCodigoCartera" readonly style="flex: 1; padding: 10px; background: var(--bg-hover); border: 1px solid var(--border-color); border-radius: 8px; color: #fff; font-size: 0.8rem;">
                    <button onclick="copiarPixCartera()" style="padding: 10px 15px; background: var(--accent-cyan); border: none; border-radius: 8px; color: #000; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <!-- Info -->
            <div style="background: rgba(0,212,255,0.1); border: 1px solid var(--accent-cyan); border-radius: 8px; padding: 12px; margin-bottom: 20px;">
                <p style="color: var(--accent-cyan); font-size: 0.85rem; margin: 0; text-align: center;">
                    <i class="fas fa-info-circle me-2"></i>El pago se verifica automáticamente
                </p>
            </div>
            
            <!-- Botones -->
            <div style="display: flex; gap: 10px;">
                <button onclick="cancelarPagoCarteraNueva()" style="flex: 1; padding: 14px; background: var(--bg-hover); border: 1px solid var(--accent-red); border-radius: 10px; color: var(--accent-red); font-weight: 600; cursor: pointer;">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
            </div>
        </div>
    </div>
</body>
</html>
 
