<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinanGestPay - Gesti√≥n Financiera Profesional</title>
    <!-- PWA Meta Tags -->
    <meta name="description" content="FinanGest - Gesti√≥n financiera personal. Organiza tus cuentas, controla pagos y gastos.">
    <meta name="theme-color" content="#00d4ff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FinanGest">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/icon-192.svg">
    <link rel="icon" type="image/svg+xml" href="/icons/icon-192.svg">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a2e;
            --bg-hover: #16213e;
            --accent-cyan: #00d4ff;
            --accent-green: #2ecc71;
            --accent-yellow: #e6a700;
            --accent-red: #ff4757;
            --accent-purple: #a855f7;
            --text-primary: #ffffff;
            --text-secondary: #8892b0;
            --border-color: #2d2d44;
        }
        * { box-sizing: border-box; }
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Segoe UI', system-ui, sans-serif;
            min-height: 100vh;
            margin: 0;
        }
        .sidebar {
            position: fixed;
            left: 0; top: 0;
            width: 260px; height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transition: transform 0.3s;
        }
        .sidebar.hidden { transform: translateX(-100%); }
        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--accent-cyan); }
        .logo span { color: var(--text-secondary); font-weight: 400; font-size: 0.9rem; }
        .nav-menu { padding: 20px 0; }
        .nav-item {
            display: flex; align-items: center; padding: 12px 25px;
            color: var(--text-secondary); text-decoration: none;
            transition: all 0.2s; cursor: pointer; border-left: 3px solid transparent;
        }
        .nav-item:hover, .nav-item.active {
            background: var(--bg-hover); color: var(--accent-cyan);
            border-left-color: var(--accent-cyan);
        }
        .nav-item i { width: 24px; margin-right: 12px; }
        .main-content {
            margin-left: 260px; padding: 30px;
            min-height: 100vh; transition: margin 0.3s;
        }
        .main-content.expanded { margin-left: 0; }
        .topbar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }
        .page-title { font-size: 1.5rem; font-weight: 600; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: var(--accent-cyan); display: flex;
            align-items: center; justify-content: center; font-weight: 600;
        }
        .card-dark {
            background: var(--bg-card); border-radius: 16px;
            border: 1px solid var(--border-color); padding: 24px;
        }
        .stat-card {
            background: var(--bg-card); border-radius: 16px;
            padding: 24px; border: 1px solid var(--border-color);
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0;
            width: 4px; height: 100%; background: var(--accent-cyan);
        }
        .stat-card.green::before { background: var(--accent-green); }
        .stat-card.yellow::before { background: var(--accent-yellow); }
        .stat-card.red::before { background: var(--accent-red); }
        .stat-card.purple::before { background: var(--accent-purple); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 5px; }
        .stat-label { color: var(--text-secondary); font-size: 0.9rem; }
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
            border: none; padding: 12px 28px; border-radius: 8px;
            color: #000; font-weight: 600; transition: all 0.3s;
        }
        .btn-primary-custom:hover {
            transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,212,255,0.3);
            color: #000;
        }
        .btn-success-custom {
            background: linear-gradient(135deg, var(--accent-green), #00cc6a);
            border: none; padding: 10px 20px; border-radius: 8px;
            color: #000; font-weight: 600;
        }
        .table-dark-custom { background: transparent; color: var(--text-primary); }
        .table-dark-custom th {
            background: var(--bg-hover); border-color: var(--border-color);
            color: var(--text-secondary); font-weight: 500; padding: 14px;
        }
        .table-dark-custom td {
            border-color: var(--border-color); padding: 14px;
            vertical-align: middle;
        }
        .table-dark-custom tbody tr:hover { background: var(--bg-hover); }
        .badge-status {
            padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 500;
        }
        .badge-active { background: rgba(0,255,136,0.15); color: var(--accent-green); }
        .badge-finished { background: rgba(0,212,255,0.15); color: var(--accent-cyan); }
        .badge-late { background: rgba(255,71,87,0.15); color: var(--accent-red); }
        .form-control-dark {
            background: var(--bg-hover); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 12px 16px; border-radius: 8px;
        }
        .form-control-dark:focus {
            background: var(--bg-hover); border-color: var(--accent-cyan);
            color: var(--text-primary); box-shadow: 0 0 0 3px rgba(0,212,255,0.1);
        }
        .form-control-dark::placeholder { color: var(--text-secondary); }
        .section { display: none; }
        .section.active { display: block; }
        .progress-custom {
            height: 8px; background: var(--bg-hover); border-radius: 4px; overflow: hidden;
        }
        .progress-custom .bar {
            height: 100%; background: linear-gradient(90deg, var(--accent-cyan), var(--accent-green));
            border-radius: 4px; transition: width 0.5s;
        }
        .chart-container { position: relative; height: 300px; }
        .modal-dark .modal-content {
            background: var(--bg-card); border: 1px solid var(--border-color);
            border-radius: 16px;
        }
        .modal-dark .modal-header {
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-hover); border-radius: 16px 16px 0 0;
        }
        .modal-dark .modal-footer { border-top: 1px solid var(--border-color); }
        .modal-dark .btn-close { filter: invert(1); }
        /* Auth Screen */
        .auth-container {
            min-height: 100vh; display: flex; align-items: center;
            justify-content: center; background: var(--bg-primary);
        }
        .auth-card {
            background: var(--bg-card); border-radius: 20px;
            border: 1px solid var(--border-color); width: 100%;
            max-width: 420px; overflow: hidden;
        }
        .auth-header {
            background: linear-gradient(135deg, var(--bg-hover), var(--bg-secondary));
            padding: 40px; text-align: center;
        }
        .auth-header .logo { font-size: 2.2rem; }
        .auth-body { padding: 40px; }
        .auth-tabs {
            display: flex; margin-bottom: 30px;
            background: var(--bg-hover); border-radius: 10px; padding: 5px;
        }
        .auth-tab {
            flex: 1; padding: 12px; text-align: center; border-radius: 8px;
            cursor: pointer; transition: all 0.3s; color: var(--text-secondary);
        }
        .auth-tab.active {
            background: var(--accent-cyan); color: #000; font-weight: 600;
        }
        .verification-input {
            display: flex; gap: 10px; justify-content: center; margin: 20px 0;
        }
        .verification-input input {
            width: 50px; height: 60px; text-align: center; font-size: 1.5rem;
            background: var(--bg-hover); border: 2px solid var(--border-color);
            border-radius: 10px; color: var(--text-primary);
        }
        .verification-input input:focus {
            border-color: var(--accent-cyan); outline: none;
        }
        .client-card {
            background: var(--bg-card); border-radius: 12px;
            border: 1px solid var(--border-color); padding: 20px;
            margin-bottom: 15px; transition: all 0.3s;
        }
        .client-card:hover {
            border-color: var(--accent-cyan);
            box-shadow: 0 4px 20px rgba(0,212,255,0.1);
        }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.show { transform: translateX(0); }
            .main-content { margin-left: 0; }
        }
        /* Animaciones para login */
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px rgba(0,212,255,0.3); }
            50% { box-shadow: 0 0 40px rgba(0,212,255,0.6); }
        }
        .auth-icon-float {
            animation: float 3s ease-in-out infinite;
        }
        .auth-card {
            animation: pulse-glow 4s ease-in-out infinite;
        }
        .feature-item {
            display: flex; align-items: center; gap: 10px;
            padding: 8px 0; color: var(--text-secondary);
        }
        .feature-item i {
            color: var(--accent-cyan); width: 20px;
        }
        /* Tema Claro */
        body.light-theme {
            --bg-primary: #f2f4f6;
            --bg-secondary: #f2f4f6;
            --bg-card: #f2f4f6;
            --bg-hover: #e0e3e7;
            --text-primary: #1a1a2e;
            --text-secondary: #5a6270;
            --border-color: #d1d9e6;
        }
        body.light-theme .sidebar {
            background: #f2f4f6;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        body.light-theme .table-dark-custom th {
            background: #e0e3e7;
        }
        body.light-theme .form-control-dark {
            background: #eaecef;
            border-color: #d1d9e6;
            color: #1a1a2e;
        }
        body.light-theme .form-control-dark:focus {
            background: #f2f4f6;
        }
        body.light-theme .modal-dark .modal-content {
            background: #f2f4f6;
        }
        body.light-theme .modal-dark .modal-header {
            background: #eaecef;
        }
        /* Mapa */
        #mapContainer {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        .leaflet-popup-content-wrapper {
            background: var(--bg-card);
            color: var(--text-primary);
            border-radius: 10px;
        }
        .leaflet-popup-tip {
            background: var(--bg-card);
        }
        body.light-theme .leaflet-popup-content-wrapper {
            background: #f2f4f6;
            color: #1a1a2e;
        }
        body.light-theme .leaflet-popup-tip {
            background: #f2f4f6;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container">
        <div class="auth-card" style="max-width: 480px;">
            <div class="auth-header" style="padding: 50px 40px;">
                <div class="auth-icon-float" style="margin-bottom: 20px;">
                    <i class="fas fa-chart-line fa-3x" style="color: var(--accent-cyan);"></i>
                </div>
                <div class="logo" style="font-size: 2.5rem;">FinanGest</div>
                <span style="color: var(--text-secondary); font-size: 1.1rem;">Software de Gesti√≥n Financiera</span>
                <p style="color: var(--text-secondary); margin-top: 15px; font-size: 0.9rem;">
                    Gestiona tus pr√©stamos de forma inteligente y profesional
                </p>
                <div style="margin-top: 20px; text-align: left; max-width: 280px; margin-left: auto; margin-right: auto;">
                    <div class="feature-item"><i class="fas fa-check-circle"></i> Control total de clientes</div>
                    <div class="feature-item"><i class="fas fa-check-circle"></i> Seguimiento de pagos</div>
                    <div class="feature-item"><i class="fas fa-check-circle"></i> Reportes en tiempo real</div>
                </div>
            </div>
            <div class="auth-body">
                <div class="auth-tabs">
                    <div class="auth-tab active" onclick="showAuthTab('login')">Iniciar Sesi√≥n</div>
                    <div class="auth-tab" onclick="showAuthTab('register')">Registrarse</div>
                </div>
                <!-- Login Form -->
                <div id="loginForm">
                    <div class="mb-3">
                        <label class="form-label text-secondary">Usuario o Email</label>
                        <input type="text" class="form-control form-control-dark" id="loginEmail" placeholder="tu@email.com" autocomplete="off">
                    </div>
                    <div class="mb-4">
                        <label class="form-label text-secondary">Contrase√±a</label>
                        <input type="password" class="form-control form-control-dark" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password">
                    </div>
                    <button class="btn btn-primary-custom w-100" onclick="handleLogin()">
                        <i class="fas fa-sign-in-alt me-2"></i>Ingresar
                    </button>
                    <div class="text-center mt-3">
                        <a href="#" onclick="alert('Contacta a soporte para recuperar tu contrase√±a')" style="color: var(--accent-cyan); text-decoration: none; font-size: 0.9rem;">
                            <i class="fas fa-key me-1"></i>¬øOlvidaste tu contrase√±a?
                        </a>
                    </div>
                    <!-- Soporte Section -->
                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                        <p style="color: var(--text-secondary); font-size: 0.85rem; text-align: center; margin-bottom: 15px;">
                            <i class="fas fa-headset me-1"></i>¬øNecesitas ayuda? Cont√°ctanos
                        </p>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <a href="mailto:fzuluaga548@gmail.com" style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); text-decoration: none; padding: 10px; background: var(--bg-hover); border-radius: 8px; transition: all 0.3s;">
                                <i class="fas fa-envelope" style="color: var(--accent-cyan); width: 20px;"></i>
                                <span style="font-size: 0.9rem;">fzuluaga548@gmail.com</span>
                            </a>
                            <a href="tel:+79998555813" style="display: flex; align-items: center; gap: 10px; color: var(--text-secondary); text-decoration: none; padding: 10px; background: var(--bg-hover); border-radius: 8px; transition: all 0.3s;">
                                <i class="fas fa-phone" style="color: var(--accent-green); width: 20px;"></i>
                                <span style="font-size: 0.9rem;">+7 999 855 5813</span>
                            </a>
                            <div style="text-align: center; margin-top: 10px;">
                                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 10px;">
                                    <i class="fab fa-whatsapp me-1" style="color: #25D366;"></i>WhatsApp
                                </p>
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://wa.me/79998555813&bgcolor=1a1a2e&color=00d4ff" 
                                     alt="WhatsApp QR" style="border-radius: 10px; border: 2px solid var(--border-color);">
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Register Form -->
                <div id="registerForm" style="display: none;">
                    <div id="registerStep1">
                        <div class="mb-3">
                            <label class="form-label text-secondary">Nombre Completo</label>
                            <input type="text" class="form-control form-control-dark" id="regNombre" placeholder="Tu nombre">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Email</label>
                            <input type="email" class="form-control form-control-dark" id="regEmail" placeholder="tu@email.com">
                        </div>
                        <div class="mb-3">
                            <label class="form-label text-secondary">Contrase√±a</label>
                            <input type="password" class="form-control form-control-dark" id="regPassword" placeholder="M√≠nimo 6 caracteres">
                        </div>
                        <div class="mb-4">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="acceptTerms" style="background: var(--bg-hover); border-color: var(--border-color);">
                                <label class="form-check-label text-secondary" for="acceptTerms" style="font-size: 0.85rem;">
                                    Acepto los <a href="politicas.html#terminos" target="_blank" style="color: var(--accent-cyan);">T√©rminos de Uso</a> 
                                    y la <a href="politicas.html" target="_blank" style="color: var(--accent-cyan);">Pol√≠tica de Privacidad</a>
                                </label>
                            </div>
                        </div>
                        <button class="btn btn-primary-custom w-100" onclick="sendVerificationCode()" id="btnSendCode">
                            <i class="fas fa-paper-plane me-2"></i>Enviar C√≥digo de Verificaci√≥n
                        </button>
                    </div>
                    <div id="registerStep2" style="display: none;">
                        <div class="text-center mb-4">
                            <i class="fas fa-envelope-open-text fa-3x mb-3" style="color: var(--accent-cyan);"></i>
                            <h5>Verifica tu Email</h5>
                            <p class="text-secondary">Enviamos un c√≥digo a <span id="emailSent" style="color: var(--accent-cyan);"></span></p>
                        </div>
                        <div class="mb-4">
                            <label class="form-label text-secondary">C√≥digo de Verificaci√≥n</label>
                            <input type="text" class="form-control form-control-dark text-center" id="verificationCode" 
                                   placeholder="000000" maxlength="6" style="font-size: 1.5rem; letter-spacing: 8px;">
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="verifyCode()">
                            <i class="fas fa-check me-2"></i>Verificar y Crear Cuenta
                        </button>
                        <button class="btn btn-link w-100 mt-2" style="color: var(--text-secondary);" onclick="resendCode()">
                            ¬øNo recibiste el c√≥digo? Reenviar
                        </button>
                    </div>
                    <!-- Paso 3: Pago PIX -->
                    <div id="registerStep3" style="display: none;">
                        <div class="text-center mb-4">
                            <i class="fas fa-check-circle fa-3x mb-3" style="color: var(--accent-green);"></i>
                            <h5 style="color: var(--accent-green);">¬°Cuenta Creada!</h5>
                            <p class="text-secondary">√öltimo paso: Activa tu suscripci√≥n</p>
                        </div>
                        <div style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 5px;">Plan Mensual</p>
                            <h2 style="color: var(--accent-green); font-size: 2.5rem; margin: 0;">R$ 99,00</h2>
                            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 5px;">Acceso completo a FinanGest</p>
                        </div>
                        <div id="pixQrContainer" style="background: var(--bg-hover); border-radius: 12px; padding: 20px; text-align: center; margin-bottom: 20px;">
                            <div id="pixLoading">
                                <i class="fas fa-spinner fa-spin fa-2x mb-3" style="color: var(--accent-cyan);"></i>
                                <p class="text-secondary">Generando c√≥digo PIX...</p>
                            </div>
                            <div id="pixQrCode" style="display: none;">
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                                    <i class="fas fa-qrcode me-2"></i>Escanea con tu app de banco
                                </p>
                                <img id="pixQrImage" src="" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 200px;">
                                <div style="margin-top: 15px; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                                    <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">PIX Copia e Cola</p>
                                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                        <input type="text" id="pixCopyPaste" readonly style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--accent-cyan); padding: 8px; border-radius: 5px; font-size: 0.7rem; width: 180px; text-overflow: ellipsis;">
                                        <button onclick="copyPixCode()" style="background: var(--accent-cyan); border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                            <i class="fas fa-copy"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-success-custom w-100" onclick="verificarPago()" id="btnVerificarPago">
                            <i class="fas fa-sync-alt me-2"></i>Ya pagu√© - Verificar
                        </button>
                        <p style="color: var(--text-secondary); font-size: 0.8rem; text-align: center; margin-top: 15px;">
                            <i class="fas fa-clock me-1"></i>El pago se verifica autom√°ticamente
                        </p>
                    </div>
                </div>
            </div>
            <div style="text-align: center; padding: 20px; border-top: 1px solid var(--border-color);">
                <a href="politicas.html" target="_blank" style="color: var(--text-secondary); font-size: 0.8rem; text-decoration: none;">
                    <i class="fas fa-shield-alt me-1"></i>Pol√≠tica de Privacidad
                </a>
                <span style="color: var(--text-secondary); margin: 0 10px;">|</span>
                <a href="politicas.html#terminos" target="_blank" style="color: var(--text-secondary); font-size: 0.8rem; text-decoration: none;">
                    <i class="fas fa-file-contract me-1"></i>T√©rminos de Uso
                </a>
                <p style="color: var(--text-secondary); font-size: 0.7rem; margin-top: 10px;">
                    ¬© 2026 FinanGest Software. Todos los derechos reservados.
                </p>
            </div>
        </div>
    </div>
    <!-- Main App -->
    <div id="mainApp" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo">FinanGest<br><span>Software</span></div>
            </div>
            <div class="nav-menu" id="navMenu">
                <!-- Se llena din√°micamente -->
            </div>
            <div style="position: absolute; bottom: 20px; left: 20px; right: 20px;">
                <div class="nav-item" onclick="toggleTheme()" style="border-radius: 8px;">
                    <i class="fas fa-adjust" id="themeIcon"></i><span id="themeText">Tema Claro</span>
                </div>
                <div class="nav-item" onclick="logout()" style="border-radius: 8px; margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                    <i class="fas fa-sign-out-alt"></i>Cerrar Sesi√≥n
                </div>
            </div>
        </nav>
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <div class="topbar">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-link d-md-none" onclick="toggleSidebar()" style="color: var(--text-primary);">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                <div class="user-info">
                    <span id="userName" class="d-none d-md-block"></span>
                    <div class="user-avatar" id="userAvatar">U</div>
                </div>
            </div>
            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="row g-4 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="statClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i>Clientes Activos</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="statPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i>Total Prestado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="statCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i>Total Cobrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red">
                            <div class="stat-value" id="statPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i>Pendiente</div>
                        </div>
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="card-dark">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="mb-0"><i class="fas fa-chart-area me-2" style="color: var(--accent-cyan);"></i>Resumen</h5>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="date" id="chartFechaInicio" class="form-control form-control-dark" style="width: auto;" onchange="renderChart()">
                                    <span class="text-secondary">a</span>
                                    <input type="date" id="chartFechaFin" class="form-control form-control-dark" style="width: auto;" onchange="renderChart()">
                                    <button class="btn btn-sm btn-outline-secondary" onclick="resetChartDates()" title="Restaurar fechas"><i class="fas fa-undo"></i></button>
                                </div>
                            </div>
                            <div class="chart-container"><canvas id="mainChart"></canvas></div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card-dark h-100">
                            <h5 class="mb-4"><i class="fas fa-tasks me-2" style="color: var(--accent-green);"></i>Cobros de Hoy</h5>
                            <div id="cobrosHoyPreview"><!-- Se llena din√°micamente --></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Clientes Section -->
            <div id="clientes" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-users me-2" style="color: var(--accent-cyan);"></i>Gesti√≥n de Clientes</h5>
                    <button class="btn btn-primary-custom" onclick="openNewClientModal()">
                        <i class="fas fa-plus me-2"></i>Nuevo Cliente
                    </button>
                </div>
                
                <!-- Filtros de clientes -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i>Tipo de Cliente</label>
                            <select class="form-control form-control-dark" id="clientesFiltroTipo" onchange="renderClientes()">
                                <option value="">Todos</option>
                                <option value="nuevo">üÜï Nuevo</option>
                                <option value="bueno">‚úÖ Buen Cliente</option>
                                <option value="regular">‚ö†Ô∏è Regular</option>
                                <option value="malo">‚ùå Mala Paga</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i>Estado</label>
                            <select class="form-control form-control-dark" id="clientesFiltroEstado" onchange="renderClientes()">
                                <option value="">Todos</option>
                                <option value="ativo">Activos</option>
                                <option value="finalizado">Finalizados</option>
                                <option value="atrasado">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-search me-2"></i>Buscar</label>
                            <input type="text" class="form-control form-control-dark" id="clientesBuscar" placeholder="Nombre o tel√©fono..." oninput="renderClientes()">
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo -->
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('nuevo')">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="clientesNuevos">0</div>
                            <small class="text-secondary">üÜï Nuevos</small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('bueno')">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="clientesBuenos">0</div>
                            <small class="text-secondary">‚úÖ Buenos</small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('regular')">
                            <div style="color: var(--accent-yellow); font-size: 1.5rem; font-weight: bold;" id="clientesRegulares">0</div>
                            <small class="text-secondary">‚ö†Ô∏è Regulares</small>
                        </div>
                        <div class="col-3" style="cursor: pointer;" onclick="filtrarClientesPorTipo('malo')">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="clientesMalos">0</div>
                            <small class="text-secondary">‚ùå Mala Paga</small>
                        </div>
                    </div>
                </div>
                
                <div class="card-dark">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Tel√©fono</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Restante</th>
                                    <th>Parcelas</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientesTable"><!-- Se llena din√°micamente --></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Estad√≠sticas Section -->
            <div id="estadisticas" class="section">
                <h5 class="mb-4"><i class="fas fa-chart-bar me-2" style="color: var(--accent-purple);"></i>Mis Estad√≠sticas</h5>
                
                <!-- Filtros de fecha -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-eye me-2"></i>Ver por</label>
                            <select class="form-control form-control-dark" id="estVista" onchange="renderEstadisticas()">
                                <option value="dia">D√≠a espec√≠fico</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes" selected>Este mes</option>
                                <option value="anio">Este a√±o</option>
                                <option value="todo">Todo el tiempo</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i>Fecha</label>
                            <input type="date" class="form-control form-control-dark" id="estFecha" onchange="renderEstadisticas()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>Mes</label>
                            <select class="form-control form-control-dark" id="estMes" onchange="renderEstadisticas()">
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>A√±o</label>
                            <select class="form-control form-control-dark" id="estAnio" onchange="renderEstadisticas()"></select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen principal -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="estClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i>Clientes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="estPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i>Prestado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="estCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i>Cobrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red">
                            <div class="stat-value" id="estPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i>Pendiente</div>
                        </div>
                    </div>
                </div>
                
                <!-- M√°s estad√≠sticas -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2" style="color: var(--accent-green);"></i>Pagos Recibidos</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estPagosCount">0</div>
                                    <small class="text-secondary">Cantidad</small>
                                </div>
                                <div class="col-6">
                                    <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estPagosTotal">R$ 0</div>
                                    <small class="text-secondary">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-wallet me-2" style="color: var(--accent-red);"></i>Gastos</h6>
                            <div class="row text-center">
                                <div class="col-6">
                                    <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estGastosCount">0</div>
                                    <small class="text-secondary">Cantidad</small>
                                </div>
                                <div class="col-6">
                                    <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estGastosTotal">R$ 0</div>
                                    <small class="text-secondary">Total</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <h6 class="mb-3"><i class="fas fa-balance-scale me-2" style="color: var(--accent-cyan);"></i>Balance</h6>
                            <div class="text-center">
                                <div style="font-size: 2rem; font-weight: bold;" id="estBalance">R$ 0</div>
                                <small class="text-secondary">Cobrado - Gastos</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Por tipo de cliente -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i>Por Tipo de Cliente</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="estNuevos">0</div>
                            <small class="text-secondary">üÜï Nuevos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="estBuenos">0</div>
                            <small class="text-secondary">‚úÖ Buenos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="estRegulares">0</div>
                            <small class="text-secondary">‚ö†Ô∏è Regulares</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="estMalos">0</div>
                            <small class="text-secondary">‚ùå Mala Paga</small>
                        </div>
                    </div>
                </div>
                
                <!-- Por estado -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-tasks me-2" style="color: var(--accent-cyan);"></i>Por Estado</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="estActivos">0</div>
                            <small class="text-secondary">Activos</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="estFinalizados">0</div>
                            <small class="text-secondary">Finalizados</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="estAtrasados">0</div>
                            <small class="text-secondary">Atrasados</small>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de actividad reciente -->
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i>Actividad del Per√≠odo</h6>
                    <div id="estActividad" style="max-height: 300px; overflow-y: auto;">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
            <!-- Cobros Section -->
            <div id="cobros" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-calendar-day me-2" style="color: var(--accent-yellow);"></i>Cobros del D√≠a</h5>
                    <div class="d-flex gap-2 align-items-center">
                        <button class="btn btn-primary-custom btn-sm" onclick="setFechaHoy()">
                            <i class="fas fa-calendar-check me-1"></i>Hoy
                        </button>
                        <input type="date" class="form-control form-control-dark" id="fechaCobros" style="width: auto;" onchange="renderCobros()">
                    </div>
                </div>
                <div id="cobrosResumen" class="row g-3 mb-4">
                    <!-- Resumen de cobros -->
                </div>
                <div class="card-dark">
                    <div id="cobrosLista"><!-- Se llena din√°micamente --></div>
                </div>
            </div>
            <!-- Gastos Section -->
            <div id="gastos" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-wallet me-2" style="color: var(--accent-yellow);"></i>Gastos Personales</h5>
                    <button class="btn btn-primary-custom" onclick="openGastoModal()">
                        <i class="fas fa-plus me-2"></i>Nuevo Gasto
                    </button>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card red">
                            <div class="stat-value" id="gastoHoy">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-day me-2"></i>Gastos de Hoy</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="gastoSemana">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-week me-2"></i>Esta Semana</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card purple">
                            <div class="stat-value" id="gastoMes">R$ 0.00</div>
                            <div class="stat-label"><i class="fas fa-calendar-alt me-2"></i>Este Mes</div>
                        </div>
                    </div>
                </div>
                <div class="card-dark mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6 class="mb-0"><i class="fas fa-filter me-2"></i>Filtrar por fecha</h6>
                        <div class="d-flex gap-2">
                            <input type="date" class="form-control form-control-dark" id="gastoFechaFiltro" style="width: auto;" onchange="renderGastos()">
                            <button class="btn btn-sm btn-primary-custom" onclick="setGastoHoy()">Hoy</button>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <div id="gastosLista"><!-- Se llena din√°micamente --></div>
                </div>
            </div>
            <!-- Historial Section (Trabajadores) -->
            <div id="historial" class="section">
                <h5 class="mb-4"><i class="fas fa-history me-2" style="color: var(--accent-purple);"></i>Mi Historial Completo</h5>
                
                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-alt me-2"></i>A√±o</label>
                            <select class="form-control form-control-dark" id="historialAnio" onchange="renderHistorial()">
                                <!-- Se llena din√°micamente -->
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i>Mes</label>
                            <select class="form-control form-control-dark" id="historialMes" onchange="renderHistorial()">
                                <option value="">Todos los meses</option>
                                <option value="0">Enero</option>
                                <option value="1">Febrero</option>
                                <option value="2">Marzo</option>
                                <option value="3">Abril</option>
                                <option value="4">Mayo</option>
                                <option value="5">Junio</option>
                                <option value="6">Julio</option>
                                <option value="7">Agosto</option>
                                <option value="8">Septiembre</option>
                                <option value="9">Octubre</option>
                                <option value="10">Noviembre</option>
                                <option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar-day me-2"></i>D√≠a espec√≠fico</label>
                            <input type="date" class="form-control form-control-dark" id="historialDia" onchange="renderHistorial()">
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i>Estado</label>
                            <select class="form-control form-control-dark" id="historialEstado" onchange="renderHistorial()">
                                <option value="">Todos</option>
                                <option value="ativo">Activos</option>
                                <option value="finalizado">Finalizados</option>
                                <option value="atrasado">Atrasados</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i>Tipo de Cliente</label>
                            <select class="form-control form-control-dark" id="historialTipo" onchange="renderHistorial()">
                                <option value="">Todos</option>
                                <option value="nuevo">üÜï Nuevo</option>
                                <option value="bueno">‚úÖ Buen Cliente</option>
                                <option value="regular">‚ö†Ô∏è Regular</option>
                                <option value="malo">‚ùå Mala Paga</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo de cliente -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i>Por Tipo de Cliente</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="histNuevos">0</div>
                            <small class="text-secondary">üÜï Nuevos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="histBuenos">0</div>
                            <small class="text-secondary">‚úÖ Buenos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="histRegulares">0</div>
                            <small class="text-secondary">‚ö†Ô∏è Regulares</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="histMalos">0</div>
                            <small class="text-secondary">‚ùå Mala Paga</small>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card">
                            <div class="stat-value" id="histTotalClientes">0</div>
                            <div class="stat-label"><i class="fas fa-users me-2"></i>Total Clientes</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green">
                            <div class="stat-value" id="histTotalPrestado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-hand-holding-usd me-2"></i>Total Prestado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="histTotalCobrado">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-coins me-2"></i>Total Cobrado</div>
                        </div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red">
                            <div class="stat-value" id="histTotalPendiente">R$ 0</div>
                            <div class="stat-label"><i class="fas fa-clock me-2"></i>Pendiente</div>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por estado -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-chart-pie me-2" style="color: var(--accent-cyan);"></i>Resumen por Estado</h6>
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="histActivos">0</div>
                            <small class="text-secondary">Activos</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="histFinalizados">0</div>
                            <small class="text-secondary">Finalizados</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="histAtrasados">0</div>
                            <small class="text-secondary">Atrasados</small>
                        </div>
                    </div>
                </div>
                
                <!-- Lista de clientes -->
                <div class="card-dark">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i>Registro de Clientes</h6>
                        <button class="btn btn-sm btn-primary-custom" onclick="limpiarFiltrosHistorial()">
                            <i class="fas fa-redo me-1"></i>Limpiar Filtros
                        </button>
                    </div>
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Tel√©fono</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Pendiente</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="historialTable"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Historial de pagos recibidos -->
                <div class="card-dark mt-4">
                    <h6 class="mb-3"><i class="fas fa-money-bill-wave me-2" style="color: var(--accent-green);"></i>√öltimos Pagos Recibidos</h6>
                    <div id="historialPagos"><!-- Se llena din√°micamente --></div>
                </div>
            </div>
            <!-- Mapa Section -->
            <div id="mapa" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-map-marked-alt me-2" style="color: var(--accent-purple);"></i>Mapa de Clientes</h5>
                    <button class="btn btn-primary-custom" onclick="obtenerMiUbicacion()">
                        <i class="fas fa-crosshairs me-2"></i>Mi Ubicaci√≥n
                    </button>
                </div>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="stat-card purple">
                            <div class="stat-value" id="clientesConUbicacion">0</div>
                            <div class="stat-label"><i class="fas fa-map-pin me-2"></i>Con ubicaci√≥n</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-value" id="clientesSinUbicacion">0</div>
                            <div class="stat-label"><i class="fas fa-question-circle me-2"></i>Sin ubicaci√≥n</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card green" id="miUbicacionCard" style="display: none;">
                            <div class="stat-value"><i class="fas fa-check-circle"></i></div>
                            <div class="stat-label">Ubicaci√≥n activa</div>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <div id="mapContainer"></div>
                </div>
                <div class="card-dark mt-3">
                    <h6 class="mb-3"><i class="fas fa-list me-2" style="color: var(--accent-cyan);"></i>Clientes con ubicaci√≥n</h6>
                    <div id="listaClientesMapa"><!-- Se llena din√°micamente --></div>
                </div>
            </div>
            <!-- Admin: Usuarios Section -->
            <div id="adminUsuarios" class="section">
                <h5 class="mb-4"><i class="fas fa-users-cog me-2" style="color: var(--accent-yellow);"></i>Usuarios Registrados</h5>
                <div class="row g-4 mb-4">
                    <div class="col-md-3">
                        <div class="stat-card purple">
                            <div class="stat-value" id="adminTotalUsers">0</div>
                            <div class="stat-label">Total Usuarios</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card" style="border-left: 4px solid #ff6b35;">
                            <div class="stat-value" id="adminPendientes" style="color: #ff6b35;">0</div>
                            <div class="stat-label">Pendientes Activar</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card green">
                            <div class="stat-value" id="adminTotalClients">0</div>
                            <div class="stat-label">Total Clientes</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card yellow">
                            <div class="stat-value" id="adminTotalPrestado">R$ 0</div>
                            <div class="stat-label">Total Prestado</div>
                        </div>
                    </div>
                </div>
                
                <!-- Secci√≥n de Pendientes -->
                <div id="pendientesSection" class="card-dark mb-4" style="border-left: 4px solid #ff6b35; display: none;">
                    <h6 class="mb-3" style="color: #ff6b35;">
                        <i class="fas fa-exclamation-circle me-2"></i>Usuarios Pendientes de Activaci√≥n
                        <span class="badge" style="background: #ff6b35; color: #fff; margin-left: 10px;" id="pendientesBadge">0</span>
                    </h6>
                    <p class="text-secondary mb-3" style="font-size: 0.85rem;">
                        Estos usuarios se registraron y est√°n esperando que verifiques su pago para activarlos.
                    </p>
                    <div id="pendientesList"><!-- Se llena din√°micamente --></div>
                </div>
                
                <div id="usuariosList"><!-- Se llena din√°micamente --></div>
            </div>
            <!-- Admin: Backups Section -->
            <div id="adminBackups" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-database me-2" style="color: var(--accent-green);"></i>Backups del Sistema</h5>
                    <button class="btn btn-success-custom" onclick="crearBackupManual()">
                        <i class="fas fa-plus me-2"></i>Crear Backup Ahora
                    </button>
                </div>
                <div class="card-dark mb-3">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas fa-shield-alt fa-2x" style="color: var(--accent-green);"></i>
                        <div>
                            <strong>Sistema de Backups Autom√°ticos</strong>
                            <p class="text-secondary mb-0" style="font-size: 0.85rem;">
                                Los datos se guardan autom√°ticamente cada hora. Se mantienen los √∫ltimos 30 backups.
                            </p>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-history me-2"></i>Backups Disponibles</h6>
                    <div id="backupsList"><!-- Se llena din√°micamente --></div>
                </div>
            </div>
            <!-- Admin: Calendario de Clientes -->
            <div id="adminCalendario" class="section">
                <h5 class="mb-4"><i class="fas fa-calendar-alt me-2" style="color: var(--accent-purple);"></i>Calendario de Clientes</h5>
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-user-tie me-2"></i>Filtrar por Trabajador</label>
                            <select class="form-control form-control-dark" id="calendarioTrabajador" onchange="renderCalendarioClientes()">
                                <option value="">Todos los trabajadores</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i>Seleccionar Fecha</label>
                            <input type="date" class="form-control form-control-dark" id="calendarioFecha" onchange="renderCalendarioClientes()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-filter me-2"></i>Ver</label>
                            <select class="form-control form-control-dark" id="calendarioVista" onchange="renderCalendarioClientes()">
                                <option value="dia">Este d√≠a</option>
                                <option value="semana">Esta semana</option>
                                <option value="mes" selected>Este mes</option>
                                <option value="todos">Todos</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.8rem; font-weight: bold;" id="calTotalClientes">0</div>
                            <small class="text-secondary">Clientes</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.8rem; font-weight: bold;" id="calTotalPrestado">R$ 0</div>
                            <small class="text-secondary">Prestado</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-yellow); font-size: 1.8rem; font-weight: bold;" id="calTotalCobrado">R$ 0</div>
                            <small class="text-secondary">Cobrado</small>
                        </div>
                    </div>
                </div>
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-list me-2"></i>Clientes Registrados</h6>
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Fecha Registro</th>
                                    <th>Cliente</th>
                                    <th>Trabajador</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="calendarioClientesTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Admin: Historial de Trabajador -->
            <div id="adminHistorial" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-history me-2" style="color: var(--accent-purple);"></i>Historial de: <span id="adminHistNombre">Trabajador</span></h5>
                    <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </button>
                </div>
                
                <!-- Filtros -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">A√±o</label>
                            <select class="form-control form-control-dark" id="adminHistAnio" onchange="renderAdminHistorialTrabajador()"></select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Mes</label>
                            <select class="form-control form-control-dark" id="adminHistMes" onchange="renderAdminHistorialTrabajador()">
                                <option value="">Todos</option>
                                <option value="0">Enero</option><option value="1">Febrero</option><option value="2">Marzo</option>
                                <option value="3">Abril</option><option value="4">Mayo</option><option value="5">Junio</option>
                                <option value="6">Julio</option><option value="7">Agosto</option><option value="8">Septiembre</option>
                                <option value="9">Octubre</option><option value="10">Noviembre</option><option value="11">Diciembre</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">D√≠a</label>
                            <input type="date" class="form-control form-control-dark" id="adminHistDia" onchange="renderAdminHistorialTrabajador()">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card-dark">
                            <label class="form-label">Estado</label>
                            <select class="form-control form-control-dark" id="adminHistEstado" onchange="renderAdminHistorialTrabajador()">
                                <option value="">Todos</option>
                                <option value="ativo">Activos</option>
                                <option value="finalizado">Finalizados</option>
                                <option value="atrasado">Atrasados</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <div class="card-dark">
                            <label class="form-label"><i class="fas fa-star me-2"></i>Tipo de Cliente</label>
                            <select class="form-control form-control-dark" id="adminHistTipo" onchange="renderAdminHistorialTrabajador()">
                                <option value="">Todos</option>
                                <option value="nuevo">üÜï Nuevo</option>
                                <option value="bueno">‚úÖ Buen Cliente</option>
                                <option value="regular">‚ö†Ô∏è Regular</option>
                                <option value="malo">‚ùå Mala Paga</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen por tipo -->
                <div class="card-dark mb-4">
                    <h6 class="mb-3"><i class="fas fa-star me-2" style="color: var(--accent-yellow);"></i>Por Tipo de Cliente</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div style="color: var(--accent-cyan); font-size: 1.3rem; font-weight: bold;" id="adminHistNuevos">0</div>
                            <small class="text-secondary">üÜï Nuevos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-green); font-size: 1.3rem; font-weight: bold;" id="adminHistBuenos">0</div>
                            <small class="text-secondary">‚úÖ Buenos</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-yellow); font-size: 1.3rem; font-weight: bold;" id="adminHistRegulares">0</div>
                            <small class="text-secondary">‚ö†Ô∏è Regulares</small>
                        </div>
                        <div class="col-3">
                            <div style="color: var(--accent-red); font-size: 1.3rem; font-weight: bold;" id="adminHistMalos">0</div>
                            <small class="text-secondary">‚ùå Mala Paga</small>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen -->
                <div class="row g-3 mb-4">
                    <div class="col-md-3 col-6">
                        <div class="stat-card"><div class="stat-value" id="adminHistTotal">0</div><div class="stat-label">Clientes</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card green"><div class="stat-value" id="adminHistPrestado">R$ 0</div><div class="stat-label">Prestado</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card yellow"><div class="stat-value" id="adminHistCobrado">R$ 0</div><div class="stat-label">Cobrado</div></div>
                    </div>
                    <div class="col-md-3 col-6">
                        <div class="stat-card red"><div class="stat-value" id="adminHistPendiente">R$ 0</div><div class="stat-label">Pendiente</div></div>
                    </div>
                </div>
                
                <!-- Tabla -->
                <div class="card-dark">
                    <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                        <table class="table table-dark-custom table-hover" style="cursor: pointer;">
                            <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 1;">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Tel√©fono</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Pendiente</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="adminHistTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!-- Admin: Backups de Trabajador -->
            <div id="adminBackupsTrabajador" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-database me-2" style="color: var(--accent-yellow);"></i>Backups: <span id="backupTrabajadorNombre">Trabajador</span></h5>
                    <div class="d-flex gap-2">
                        <button class="btn btn-success-custom" onclick="crearBackupTrabajador()">
                            <i class="fas fa-plus me-2"></i>Crear Backup Ahora
                        </button>
                        <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                            <i class="fas fa-arrow-left me-2"></i>Volver
                        </button>
                    </div>
                </div>
                
                <div class="card-dark mb-4">
                    <div class="row text-center">
                        <div class="col-4">
                            <div style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold;" id="btClientes">0</div>
                            <small class="text-secondary">Clientes</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;" id="btPrestado">R$ 0</div>
                            <small class="text-secondary">Prestado</small>
                        </div>
                        <div class="col-4">
                            <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;" id="btGastos">R$ 0</div>
                            <small class="text-secondary">Gastos</small>
                        </div>
                    </div>
                </div>
                
                <div class="card-dark">
                    <h6 class="mb-3"><i class="fas fa-history me-2" style="color: var(--accent-yellow);"></i>Backups Disponibles</h6>
                    <div id="backupsTrabajadorList" style="max-height: 400px; overflow-y: auto;">
                        <!-- Se llena din√°micamente -->
                    </div>
                </div>
            </div>
            <!-- Admin: Ver Todo de Trabajador -->
            <div id="adminVerTodo" class="section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5><i class="fas fa-eye me-2" style="color: var(--accent-purple);"></i>Control Total: <span id="verTodoNombre">Trabajador</span></h5>
                    <button class="btn btn-secondary" onclick="showSection('adminUsuarios')">
                        <i class="fas fa-arrow-left me-2"></i>Volver
                    </button>
                </div>
                
                <!-- Info del trabajador -->
                <div class="card-dark mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Email</p>
                            <p id="verTodoEmail" style="color: var(--accent-cyan);">-</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Fecha de Registro</p>
                            <p id="verTodoFechaReg">-</p>
                        </div>
                        <div class="col-md-4">
                            <p class="text-secondary mb-1">Estado</p>
                            <p id="verTodoEstado">-</p>
                        </div>
                    </div>
                </div>
                
                <!-- Resumen general -->
                <div class="row g-3 mb-4">
                    <div class="col-md-2 col-4">
                        <div class="stat-card"><div class="stat-value" id="vtTotalClientes">0</div><div class="stat-label">Clientes</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card green"><div class="stat-value" id="vtPrestado">R$ 0</div><div class="stat-label">Prestado</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card yellow"><div class="stat-value" id="vtCobrado">R$ 0</div><div class="stat-label">Cobrado</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card red"><div class="stat-value" id="vtPendiente">R$ 0</div><div class="stat-label">Pendiente</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card purple"><div class="stat-value" id="vtGastos">R$ 0</div><div class="stat-label">Gastos</div></div>
                    </div>
                    <div class="col-md-2 col-4">
                        <div class="stat-card"><div class="stat-value" id="vtPagosRecibidos">0</div><div class="stat-label">Pagos</div></div>
                    </div>
                </div>
                
                <!-- Tabs -->
                <div class="card-dark mb-4">
                    <div class="d-flex gap-2 flex-wrap align-items-center">
                        <button class="btn btn-primary-custom" onclick="mostrarTabVerTodo('clientes')" id="vtTabClientes">
                            <i class="fas fa-users me-1"></i>Clientes
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('gastos')" id="vtTabGastos">
                            <i class="fas fa-wallet me-1"></i>Gastos
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('pagos')" id="vtTabPagos">
                            <i class="fas fa-money-bill me-1"></i>Pagos Recibidos
                        </button>
                        <button class="btn btn-secondary" onclick="mostrarTabVerTodo('actividad')" id="vtTabActividad">
                            <i class="fas fa-clock me-1"></i>Actividad
                        </button>
                        <div class="ms-auto" style="min-width: 250px;">
                            <div class="input-group">
                                <span class="input-group-text" style="background: var(--bg-hover); border-color: var(--border-color); color: var(--accent-cyan);">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control form-control-dark" id="vtBuscador" placeholder="Buscar por nombre..." oninput="filtrarVerTodo()">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Contenido de tabs -->
                <div id="vtContenido">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
            <!-- Admin: Todos los Clientes -->
            <div id="adminClientes" class="section">
                <h5 class="mb-4"><i class="fas fa-database me-2" style="color: var(--accent-cyan);"></i>Todos los Clientes</h5>
                <div class="card-dark">
                    <div class="table-responsive">
                        <table class="table table-dark-custom">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Usuario</th>
                                    <th>Prestado</th>
                                    <th>Cobrado</th>
                                    <th>Restante</th>
                                    <th>Estado</th>
                                </tr>
                            </thead>
                            <tbody id="adminClientesTable"><!-- Se llena din√°micamente --></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- Modal Nuevo Cliente -->
    <div class="modal fade modal-dark" id="clienteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Nuevo Cliente</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre del Cliente</label>
                            <input type="text" class="form-control form-control-dark" id="clienteNombre">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Tel√©fono</label>
                            <input type="tel" class="form-control form-control-dark" id="clienteTelefono">
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-map-marker-alt me-1"></i>Ubicaci√≥n / Direcci√≥n</label>
                            <div class="input-group">
                                <input type="text" class="form-control form-control-dark" id="clienteUbicacion" placeholder="Direcci√≥n del cliente">
                                <button class="btn btn-primary-custom" type="button" onclick="obtenerUbicacionCliente()" title="Usar ubicaci√≥n actual">
                                    <i class="fas fa-crosshairs"></i>
                                </button>
                            </div>
                            <input type="hidden" id="clienteLat">
                            <input type="hidden" id="clienteLng">
                            <small id="coordsInfo" class="text-secondary" style="display: none;">
                                <i class="fas fa-check-circle text-success"></i> Coordenadas guardadas
                            </small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-star me-1"></i>Tipo de Cliente</label>
                            <select class="form-control form-control-dark" id="clienteTipo">
                                <option value="nuevo">üÜï Nuevo</option>
                                <option value="bueno">‚úÖ Buen Cliente</option>
                                <option value="regular">‚ö†Ô∏è Regular</option>
                                <option value="malo">‚ùå Mala Paga</option>
                            </select>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-store me-1"></i>Tipo de Negocio</label>
                            <select class="form-control form-control-dark" id="clienteNegocio" onchange="toggleOtroNegocio()">
                                <option value="">-- Seleccionar --</option>
                                <option value="tienda">üè™ Tienda</option>
                                <option value="restaurante">üçΩÔ∏è Restaurante</option>
                                <option value="taxista">üöï Taxista</option>
                                <option value="vendedor">üõí Vendedor Ambulante</option>
                                <option value="peluqueria">üíá Peluquer√≠a/Barber√≠a</option>
                                <option value="taller">üîß Taller Mec√°nico</option>
                                <option value="farmacia">üíä Farmacia</option>
                                <option value="panaderia">ü•ñ Panader√≠a</option>
                                <option value="carniceria">ü•© Carnicer√≠a</option>
                                <option value="ferreteria">üî® Ferreter√≠a</option>
                                <option value="ropa">üëï Tienda de Ropa</option>
                                <option value="celulares">üì± Celulares/Tecnolog√≠a</option>
                                <option value="otro">üì¶ Otro</option>
                            </select>
                            <input type="text" class="form-control form-control-dark mt-2" id="clienteNegocioOtro" placeholder="Escribe el tipo de negocio..." style="display: none;">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label"><i class="fas fa-building me-1"></i>Nombre del Negocio (opcional)</label>
                            <input type="text" class="form-control form-control-dark" id="clienteNombreNegocio" placeholder="Ej: Tienda Don Jos√©">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label"><i class="fas fa-sticky-note me-1"></i>Notas sobre el cliente (opcional)</label>
                        <textarea class="form-control form-control-dark" id="clienteNotas" rows="2" placeholder="Informaci√≥n adicional..."></textarea>
                    </div>
                    <hr style="border-color: var(--border-color);">
                    <div class="row">
                        <div class="col-4 mb-3">
                            <label class="form-label">Valor Prestado (R$)</label>
                            <input type="number" class="form-control form-control-dark" id="clienteMonto" oninput="calcularTotal()">
                        </div>
                        <div class="col-4 mb-3">
                            <label class="form-label">Parcelas</label>
                            <input type="number" class="form-control form-control-dark" id="clienteParcelas" oninput="calcularTotal()">
                        </div>
                        <div class="col-4 mb-3">
                            <label class="form-label">Comisi√≥n %</label>
                            <select class="form-control form-control-dark" id="clienteComision" onchange="calcularTotal()">
                                <option value="10">10%</option>
                                <option value="20" selected>20%</option>
                                <option value="30">30%</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-dark" style="background: var(--bg-hover);">
                        <div class="row text-center">
                            <div class="col-4">
                                <small class="text-secondary">Comisi√≥n (<span id="comisionLabel">20</span>%)</small>
                                <div id="calcComision" style="color: var(--accent-yellow);">R$ 0</div>
                            </div>
                            <div class="col-4">
                                <small class="text-secondary">Total a Pagar</small>
                                <div id="calcTotal" style="color: var(--accent-green);">R$ 0</div>
                            </div>
                            <div class="col-4">
                                <small class="text-secondary">Por Parcela</small>
                                <div id="calcParcela" style="color: var(--accent-cyan);">R$ 0</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="crearCliente()">Crear Cliente</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Pago -->
    <div class="modal fade modal-dark" id="pagoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-money-bill-wave me-2"></i>Registrar Pago</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="pagoClienteInfo" class="card-dark mb-3" style="background: var(--bg-hover);"></div>
                    <div class="mb-3">
                        <label class="form-label">Valor del Pago (R$)</label>
                        <input type="number" class="form-control form-control-dark" id="pagoValor">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control form-control-dark" id="pagoFecha">
                    </div>
                    <button type="button" class="btn w-100 mb-2" style="background: var(--accent-purple); color: #fff;" onclick="pagarTodo()">
                        <i class="fas fa-check-double me-2"></i>Pagar Todo (Saldar Deuda)
                    </button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="confirmarPago()">Confirmar Pago</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal Gasto -->
    <div class="modal fade modal-dark" id="gastoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-wallet me-2"></i>Nuevo Gasto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Descripci√≥n del Gasto</label>
                        <input type="text" class="form-control form-control-dark" id="gastoDescripcion" placeholder="Ej: Pago de luz, Almuerzo...">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label">Valor (R$)</label>
                            <input type="number" class="form-control form-control-dark" id="gastoValor" placeholder="0.00" step="0.01">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label">Fecha</label>
                            <input type="date" class="form-control form-control-dark" id="gastoFecha">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Categor√≠a</label>
                        <input type="text" class="form-control form-control-dark" id="gastoCategoria" placeholder="Ej: Comida, Transporte, Servicios...">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-custom" onclick="guardarGasto()">
                        <i class="fas fa-save me-2"></i>Guardar Gasto
                    </button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Detectar API_URL autom√°ticamente
        const API_URL = (() => {
            const host = window.location.hostname;
            const protocol = window.location.protocol;
            
            // En desarrollo local
            if (host === 'localhost' || host === '127.0.0.1') {
                return 'http://localhost:3000';
            }
            
            // En producci√≥n (Vercel, Netlify, etc)
            if (host.includes('vercel.app') || host.includes('netlify.app') || host.includes('pages.dev')) {
                // Intenta usar el backend de Vercel
                return 'https://finangest-backend.vercel.app';
            }
            
            // Si se sirve desde dominio personalizado, usa mismo dominio
            return `${protocol}//${host}`;
        })();
        
        let currentUser = null;
        let clientes = [];
        let gastos = [];
        let allUsers = [];
        let mainChart = null;

        // Auth Functions
        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('registerForm').style.display = tab === 'register' ? 'block' : 'none';
            document.getElementById('registerStep1').style.display = 'block';
            document.getElementById('registerStep2').style.display = 'none';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            if (!email || !password) return alert('Completa todos los campos');
            try {
                const res = await fetch(API_URL + '/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                const data = await res.json();
                if (data.success) {
                    currentUser = data.user;
                    localStorage.setItem('finangest_user', JSON.stringify(currentUser));
                    showMainApp();
                } else if (data.needsPayment) {
                    // Usuario necesita pagar - mostrar pantalla de pago
                    alert('Tu cuenta est√° pendiente de pago. Te redirigimos al pago.');
                    pendingUser = { id: data.userId, nombre: data.nombre, email: data.email };
                    showAuthTab('register');
                    document.getElementById('registerStep1').style.display = 'none';
                    document.getElementById('registerStep2').style.display = 'none';
                    document.getElementById('registerStep3').style.display = 'block';
                    generarPagoPix(data.userId, data.nombre, data.email);
                } else {
                    alert(data.error || 'Error al iniciar sesi√≥n');
                }
            } catch (e) {
                alert('Error de conexi√≥n con el servidor');
            }
        }

        async function sendVerificationCode() {
            const nombre = document.getElementById('regNombre').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;
            if (!nombre || !email || !password) return alert('Completa todos los campos');
            if (password.length < 6) return alert('La contrase√±a debe tener al menos 6 caracteres');
            if (!acceptTerms) return alert('Debes aceptar los T√©rminos de Uso y la Pol√≠tica de Privacidad');
            const btn = document.getElementById('btnSendCode');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            try {
                const res = await fetch(API_URL + '/api/send-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, nombre })
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('registerStep1').style.display = 'none';
                    document.getElementById('registerStep2').style.display = 'block';
                    document.getElementById('emailSent').textContent = email;
                } else {
                    alert(data.error || 'Error al enviar c√≥digo');
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Enviar C√≥digo de Verificaci√≥n';
        }

        async function verifyCode() {
            const email = document.getElementById('regEmail').value;
            const code = document.getElementById('verificationCode').value;
            const password = document.getElementById('regPassword').value;
            const nombre = document.getElementById('regNombre').value;
            if (!code || code.length !== 6) return alert('Ingresa el c√≥digo de 6 d√≠gitos');
            try {
                const res = await fetch(API_URL + '/api/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, code, password })
                });
                const data = await res.json();
                if (data.success) {
                    // Guardar usuario temporalmente
                    pendingUser = data.user;
                    // Mostrar pantalla de pago
                    document.getElementById('registerStep2').style.display = 'none';
                    document.getElementById('registerStep3').style.display = 'block';
                    // Generar PIX
                    generarPagoPix(data.user.id, nombre, email);
                } else {
                    alert(data.error || 'C√≥digo incorrecto');
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        let pendingUser = null;
        let pendingPaymentId = null;

        async function generarPagoPix(userId, nombre, email) {
            const pixContainer = document.getElementById('pixQrCode');
            const pixLoading = document.getElementById('pixLoading');
            
            try {
                const res = await fetch(API_URL + '/api/crear-pago-pix', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId, nombre, email })
                });
                const data = await res.json();
                
                pixLoading.style.display = 'none';
                pixContainer.style.display = 'block';
                
                if (data.success && data.qrCode && !data.manual) {
                    // PIX Autom√°tico con QR Code de Asaas
                    pendingPaymentId = data.paymentId;
                    pixContainer.innerHTML = `
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 15px;">
                            <i class="fas fa-qrcode me-2"></i>Escanea con tu app de banco
                        </p>
                        <img src="data:image/png;base64,${data.qrCode}" alt="PIX QR Code" style="border-radius: 12px; border: 3px solid var(--accent-cyan); max-width: 200px;">
                        <div style="margin-top: 15px; padding: 15px; background: var(--bg-card); border-radius: 8px;">
                            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">PIX Copia e Cola</p>
                            <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                <input type="text" id="pixCopyPaste" value="${data.qrCodeText}" readonly style="background: var(--bg-hover); border: 1px solid var(--border-color); color: var(--accent-cyan); padding: 8px; border-radius: 5px; font-size: 0.7rem; width: 180px; text-overflow: ellipsis;">
                                <button onclick="copyPixCode()" style="background: var(--accent-cyan); border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    iniciarVerificacionAutomatica();
                } else {
                    // PIX Manual - mostrar llave PIX directa
                    pendingPaymentId = null;
                    const userEmail = email || '';
                    pixContainer.innerHTML = `
                        <div style="text-align: center;">
                            <p style="color: var(--accent-cyan); font-size: 1rem; margin-bottom: 15px;">
                                <i class="fas fa-key me-2"></i>Chave PIX
                            </p>
                            <div style="background: var(--bg-card); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                                <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">Telefone</p>
                                <p style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold; margin: 0; letter-spacing: 2px;">86992035517</p>
                            </div>
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">
                                <i class="fas fa-user me-1"></i>FinanGestPay
                            </p>
                            <p style="color: var(--accent-green); font-size: 1.2rem; font-weight: bold;">
                                R$ 99,00
                            </p>
                            <button onclick="copyPixKey('86992035517')" class="btn btn-primary-custom mt-3">
                                <i class="fas fa-copy me-2"></i>Copiar Chave PIX
                            </button>
                            <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 15px;">
                                <i class="fas fa-info-circle me-1"></i>Ap√≥s pagar, envie o comprovante por WhatsApp
                            </p>
                            <a href="https://wa.me/79998555813?text=Ol√°! Acabei de pagar R$ 99,00 para FinanGest. Meu email: ${userEmail}" 
                               target="_blank" class="btn btn-success-custom mt-2" style="background: #25D366;">
                                <i class="fab fa-whatsapp me-2"></i>Enviar Comprovante
                            </a>
                        </div>
                    `;
                }
            } catch (e) {
                // Error de conexi√≥n - mostrar PIX manual
                pixLoading.style.display = 'none';
                pixContainer.style.display = 'block';
                pendingPaymentId = null;
                pixContainer.innerHTML = `
                    <div style="text-align: center;">
                        <p style="color: var(--accent-cyan); font-size: 1rem; margin-bottom: 15px;">
                            <i class="fas fa-key me-2"></i>Chave PIX
                        </p>
                        <div style="background: var(--bg-card); border: 2px solid var(--accent-cyan); border-radius: 12px; padding: 20px; margin-bottom: 15px;">
                            <p style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 5px;">Telefone</p>
                            <p style="color: var(--accent-cyan); font-size: 1.5rem; font-weight: bold; margin: 0; letter-spacing: 2px;">86992035517</p>
                        </div>
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">
                            <i class="fas fa-user me-1"></i>FinanGestPay
                        </p>
                        <p style="color: var(--accent-green); font-size: 1.2rem; font-weight: bold;">
                            R$ 99,00
                        </p>
                        <button onclick="copyPixKey('86992035517')" class="btn btn-primary-custom mt-3">
                            <i class="fas fa-copy me-2"></i>Copiar Chave PIX
                        </button>
                        <p style="color: var(--text-secondary); font-size: 0.75rem; margin-top: 15px;">
                            <i class="fas fa-info-circle me-1"></i>Ap√≥s pagar, envie o comprovante por WhatsApp
                        </p>
                        <a href="https://wa.me/79998555813?text=Ol√°! Acabei de pagar R$ 99,00 para FinanGest. Meu email: ${email}" 
                           target="_blank" class="btn btn-success-custom mt-2" style="background: #25D366;">
                            <i class="fab fa-whatsapp me-2"></i>Enviar Comprovante
                        </a>
                    </div>
                `;
            }
        }

        function copyPixKey(key) {
            navigator.clipboard.writeText(key);
            alert('¬°Chave PIX copiada!');
        }

        function copyPixCode() {
            const pixCode = document.getElementById('pixCopyPaste').value;
            navigator.clipboard.writeText(pixCode);
            alert('¬°C√≥digo PIX copiado!');
        }

        let verificacionInterval = null;

        function iniciarVerificacionAutomatica() {
            if (verificacionInterval) clearInterval(verificacionInterval);
            verificacionInterval = setInterval(async () => {
                if (pendingPaymentId) {
                    const pagado = await verificarPagoSilencioso();
                    if (pagado) {
                        clearInterval(verificacionInterval);
                    }
                }
            }, 5000); // Cada 5 segundos
        }

        async function verificarPagoSilencioso() {
            try {
                const res = await fetch(API_URL + '/api/verificar-pago/' + pendingPaymentId);
                const data = await res.json();
                if (data.status === 'PAID') {
                    alert('üéâ ¬°Pago confirmado! Bienvenido a FinanGest');
                    currentUser = pendingUser;
                    localStorage.setItem('finangest_user', JSON.stringify(currentUser));
                    showMainApp();
                    return true;
                }
            } catch (e) {}
            return false;
        }

        async function verificarPago() {
            const btn = document.getElementById('btnVerificarPago');
            
            // Si es PIX manual, no hay verificaci√≥n autom√°tica
            if (!pendingPaymentId) {
                alert('Para PIX manual, env√≠a el comprobante por WhatsApp y espera la activaci√≥n.');
                return;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
            btn.disabled = true;
            
            try {
                const res = await fetch(API_URL + '/api/verificar-pago/' + pendingPaymentId);
                const data = await res.json();
                if (data.status === 'PAID') {
                    alert('üéâ ¬°Pago confirmado! Bienvenido a FinanGest');
                    currentUser = pendingUser;
                    localStorage.setItem('finangest_user', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    alert('Pago a√∫n no detectado. Espera unos segundos despu√©s de pagar.');
                }
            } catch (e) {
                alert('Error verificando pago');
            }
            
            btn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Ya pagu√© - Verificar';
            btn.disabled = false;
        }

        function resendCode() {
            document.getElementById('registerStep1').style.display = 'block';
            document.getElementById('registerStep2').style.display = 'none';
            document.getElementById('registerStep3').style.display = 'none';
            if (verificacionInterval) clearInterval(verificacionInterval);
        }
        function showMainApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('userName').textContent = currentUser.nombre;
            document.getElementById('userAvatar').textContent = currentUser.nombre.charAt(0).toUpperCase();
            loadTheme();
            buildNavMenu();
            loadData();
        }

        function buildNavMenu() {
            const menu = document.getElementById('navMenu');
            const isAdmin = currentUser.isAdmin;
            if (isAdmin) {
                menu.innerHTML = `
                    <div class="nav-item active" onclick="showSection('adminUsuarios')"><i class="fas fa-users"></i>Usuarios</div>
                    <div class="nav-item" onclick="showSection('adminCalendario')"><i class="fas fa-calendar-alt"></i>Calendario</div>
                    <div class="nav-item" onclick="showSection('adminBackups')"><i class="fas fa-database"></i>Backups</div>
                `;
            } else {
                menu.innerHTML = `
                    <div class="nav-item active" onclick="showSection('dashboard')"><i class="fas fa-chart-pie"></i>Dashboard</div>
                    <div class="nav-item" onclick="showSection('estadisticas')"><i class="fas fa-chart-bar"></i>Estad√≠sticas</div>
                    <div class="nav-item" onclick="showSection('clientes')"><i class="fas fa-users"></i>Clientes</div>
                    <div class="nav-item" onclick="showSection('cobros')"><i class="fas fa-calendar-check"></i>Cobros del D√≠a</div>
                    <div class="nav-item" onclick="showSection('gastos')"><i class="fas fa-wallet"></i>Gastos</div>
                    <div class="nav-item" onclick="showSection('mapa')"><i class="fas fa-map-marked-alt"></i>Mapa</div>
                    <div class="nav-item" onclick="showSection('historial')"><i class="fas fa-history"></i>Mi Historial</div>
                `;
            }
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (event && event.target && event.target.closest('.nav-item')) {
                event.target.closest('.nav-item').classList.add('active');
            }
            
            // Cargar backups si es la secci√≥n de backups
            if (id === 'adminBackups') {
                cargarBackups();
            }
            
            const titles = {
                dashboard: 'Dashboard', clientes: 'Clientes', estadisticas: 'Mis Estad√≠sticas', cobros: 'Cobros del D√≠a',
                gastos: 'Gastos Personales', historial: 'Mi Historial', mapa: 'Mapa de Clientes', adminUsuarios: 'Usuarios Registrados',
                adminCalendario: 'Calendario de Clientes', adminHistorial: 'Historial de Trabajador', 
                adminVerTodo: 'Control Total - Trabajador', adminBackups: 'Backups del Sistema'
            };
            document.getElementById('pageTitle').textContent = titles[id] || 'Dashboard';
            if (id === 'cobros') {
                document.getElementById('fechaCobros').value = new Date().toISOString().split('T')[0];
                renderCobros();
            }
            if (id === 'gastos') {
                document.getElementById('gastoFechaFiltro').value = new Date().toISOString().split('T')[0];
                renderGastos();
            }
            if (id === 'historial') {
                initHistorial();
                renderHistorial();
            }
            if (id === 'mapa') initMapa();
            if (id === 'adminUsuarios') renderAdminUsuarios();
            if (id === 'adminCalendario') {
                document.getElementById('calendarioFecha').value = new Date().toISOString().split('T')[0];
                renderCalendarioClientes();
            }
            if (id === 'adminHistorial') renderAdminHistorialTrabajador();
            if (id === 'adminClientes') renderAdminClientes();
            if (id === 'estadisticas') {
                initEstadisticas();
                renderEstadisticas();
            }
            if (id === 'adminVerTodo') renderVerTodo();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('show');
        }

        function logout() {
            localStorage.removeItem('finangest_user');
            currentUser = null;
            clientes = [];
            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Tema claro/oscuro
        let isDarkTheme = true;
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            document.body.classList.toggle('light-theme', !isDarkTheme);
            document.getElementById('themeIcon').className = isDarkTheme ? 'fas fa-sun' : 'fas fa-moon';
            document.getElementById('themeText').textContent = isDarkTheme ? 'Tema Claro' : 'Tema Oscuro';
            localStorage.setItem('finangest_theme', isDarkTheme ? 'dark' : 'light');
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('finangest_theme');
            if (savedTheme === 'light') {
                isDarkTheme = false;
                document.body.classList.add('light-theme');
                document.getElementById('themeIcon').className = 'fas fa-moon';
                document.getElementById('themeText').textContent = 'Tema Oscuro';
            }
        }

        // Soporte
        function openSupport() {
            const supportNumber = '573000000000'; // Cambia este n√∫mero
            const message = encodeURIComponent('Hola, necesito ayuda con FinanGestPay');
            window.open(`https://wa.me/${supportNumber}?text=${message}`, '_blank');
        }

        async function loadData() {
            try {
                const res = await fetch(API_URL + '/api/clientes?userId=' + currentUser.id);
                clientes = await res.json();
                
                // Cargar gastos
                const gastosRes = await fetch(API_URL + '/api/gastos?userId=' + currentUser.id);
                gastos = await gastosRes.json();
                
                if (currentUser.isAdmin) {
                    const usersRes = await fetch(API_URL + '/api/users');
                    allUsers = await usersRes.json();
                    showSection('adminUsuarios');
                } else {
                    updateStats();
                    renderClientes();
                    renderChart();
                }
            } catch (e) {
                console.error('Error loading data:', e);
            }
        }

        function updateStats() {
            const activos = clientes.filter(c => c.estado === 'ativo');
            const totalPrestado = clientes.reduce((s, c) => s + (c.montoTotal || 0), 0);
            const totalCobrado = clientes.reduce((s, c) => s + (c.montoPagado || 0), 0);
            const totalPendiente = clientes.reduce((s, c) => s + ((c.totalAPagar || 0) - (c.montoPagado || 0)), 0);
            document.getElementById('statClientes').textContent = activos.length;
            document.getElementById('statPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('statCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('statPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            renderCobrosPreview();
        }
        
        function resetChartDates() {
            document.getElementById('chartFechaInicio').value = '';
            document.getElementById('chartFechaFin').value = '';
            renderChart();
        }
        
        function renderChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            if (mainChart) mainChart.destroy();
            
            const labels = [];
            const datosCobrado = [];
            const datosPrestado = [];
            
            const inputInicio = document.getElementById('chartFechaInicio');
            const inputFin = document.getElementById('chartFechaFin');
            
            let fechaInicio, fechaFin;
            
            if (inputInicio.value && inputFin.value) {
                fechaInicio = new Date(inputInicio.value + 'T00:00:00');
                fechaFin = new Date(inputFin.value + 'T23:59:59');
                
                // Validar que fecha inicio sea menor que fecha fin
                if (fechaInicio > fechaFin) {
                    const temp = fechaInicio;
                    fechaInicio = fechaFin;
                    fechaFin = temp;
                    inputInicio.value = fechaInicio.toISOString().split('T')[0];
                    inputFin.value = fechaFin.toISOString().split('T')[0];
                }
            } else {
                // Por defecto: desde 1 de enero del a√±o actual hasta hoy
                const hoy = new Date();
                fechaFin = new Date(hoy.getFullYear(), hoy.getMonth(), hoy.getDate(), 23, 59, 59);
                fechaInicio = new Date(hoy.getFullYear(), 0, 1, 0, 0, 0); // 1 de enero
                
                inputInicio.value = fechaInicio.toISOString().split('T')[0];
                inputFin.value = fechaFin.toISOString().split('T')[0];
            }
            
            // Generar d√≠as entre las fechas
            let current = new Date(fechaInicio);
            while (current <= fechaFin) {
                const dia = current.getDate();
                const mes = current.getMonth();
                const anio = current.getFullYear();
                const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                labels.push(dia + ' ' + meses[mes]);
                
                let cobradoDia = 0;
                let prestadoDia = 0;
                
                clientes.forEach(c => {
                    const fechaCliente = new Date(c.fechaInicio || c.fechaRegistro || c.fechaCreacion);
                    if (fechaCliente.getDate() === dia && fechaCliente.getMonth() === mes && fechaCliente.getFullYear() === anio) {
                        prestadoDia += parseFloat(c.montoTotal) || 0;
                    }
                    if (c.pagos) {
                        c.pagos.forEach(p => {
                            const fechaPago = new Date(p.fecha);
                            if (fechaPago.getDate() === dia && fechaPago.getMonth() === mes && fechaPago.getFullYear() === anio) {
                                cobradoDia += parseFloat(p.valor) || 0;
                            }
                        });
                    }
                    if (c.historialPagos) {
                        c.historialPagos.forEach(p => {
                            const fechaPago = new Date(p.fecha);
                            if (fechaPago.getDate() === dia && fechaPago.getMonth() === mes && fechaPago.getFullYear() === anio) {
                                cobradoDia += parseFloat(p.monto) || 0;
                            }
                        });
                    }
                });
                
                datosCobrado.push(cobradoDia);
                datosPrestado.push(prestadoDia);
                
                current.setDate(current.getDate() + 1);
            }
            
            // Crear gradientes para un look m√°s profesional
            const gradientCobrado = ctx.createLinearGradient(0, 0, 0, 300);
            gradientCobrado.addColorStop(0, 'rgba(0,212,255,0.4)');
            gradientCobrado.addColorStop(1, 'rgba(0,212,255,0.02)');
            
            const gradientPrestado = ctx.createLinearGradient(0, 0, 0, 300);
            gradientPrestado.addColorStop(0, 'rgba(46,204,113,0.4)');
            gradientPrestado.addColorStop(1, 'rgba(46,204,113,0.02)');
            
            mainChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Cobrado',
                        data: datosCobrado,
                        borderColor: '#00d4ff',
                        backgroundColor: gradientCobrado,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#00d4ff',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        cubicInterpolationMode: 'monotone'
                    }, {
                        label: 'Prestado',
                        data: datosPrestado,
                        borderColor: '#2ecc71',
                        backgroundColor: gradientPrestado,
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#2ecc71',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        cubicInterpolationMode: 'monotone'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: { 
                        legend: { 
                            labels: { 
                                color: '#8892b0',
                                usePointStyle: true,
                                padding: 20
                            } 
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26,26,46,0.9)',
                            titleColor: '#fff',
                            bodyColor: '#8892b0',
                            borderColor: '#2d2d44',
                            borderWidth: 1,
                            cornerRadius: 8,
                            padding: 12
                        }
                    },
                    scales: {
                        x: { 
                            grid: { color: 'rgba(45,45,68,0.5)', drawBorder: false }, 
                            ticks: { color: '#8892b0', maxRotation: 45, font: { size: 10 } } 
                        },
                        y: { 
                            grid: { color: 'rgba(45,45,68,0.5)', drawBorder: false }, 
                            ticks: { 
                                color: '#8892b0',
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            },
                            beginAtZero: true
                        }
                    },
                    elements: {
                        line: {
                            capBezierPoints: true
                        }
                    }
                }
            });
        }

        function renderCobrosPreview() {
            const container = document.getElementById('cobrosHoyPreview');
            const activos = clientes.filter(c => c.estado === 'ativo').slice(0, 4);
            if (activos.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center">No hay cobros pendientes</p>';
                return;
            }
            container.innerHTML = activos.map(c => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <div>${c.nombre}</div>
                        <small class="text-secondary">${c.parcelasPagas || 0}/${c.numeroParcelas} parcelas</small>
                    </div>
                    <div class="text-end">
                        <div style="color: var(--accent-cyan);">R$ ${(c.valorParcela || 0).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }

        function filtrarClientesPorTipo(tipo) {
            document.getElementById('clientesFiltroTipo').value = tipo;
            renderClientes();
        }

        function renderClientes() {
            const tbody = document.getElementById('clientesTable');
            
            // Obtener filtros
            const filtroTipo = document.getElementById('clientesFiltroTipo')?.value || '';
            const filtroEstado = document.getElementById('clientesFiltroEstado')?.value || '';
            const buscar = (document.getElementById('clientesBuscar')?.value || '').toLowerCase();
            
            // Contar por tipo (de todos los clientes)
            const nuevos = clientes.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = clientes.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = clientes.filter(c => c.tipoCliente === 'regular').length;
            const malos = clientes.filter(c => c.tipoCliente === 'malo').length;
            
            if (document.getElementById('clientesNuevos')) {
                document.getElementById('clientesNuevos').textContent = nuevos;
                document.getElementById('clientesBuenos').textContent = buenos;
                document.getElementById('clientesRegulares').textContent = regulares;
                document.getElementById('clientesMalos').textContent = malos;
            }
            
            // Filtrar clientes (ocultar los que ya fueron renovados)
            let clientesFiltrados = clientes.filter(c => !c.renovado);
            
            if (filtroTipo) {
                clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === filtroTipo);
            }
            
            if (filtroEstado) {
                clientesFiltrados = clientesFiltrados.filter(c => c.estado === filtroEstado);
            }
            
            if (buscar) {
                clientesFiltrados = clientesFiltrados.filter(c => 
                    c.nombre.toLowerCase().includes(buscar) || 
                    (c.telefono && c.telefono.includes(buscar))
                );
            }
            
            // Ordenar: primero por renovaciones (m√°s renovaciones arriba), luego por fecha
            clientesFiltrados.sort((a, b) => {
                const renovA = a.renovaciones || 0;
                const renovB = b.renovaciones || 0;
                if (renovB !== renovA) return renovB - renovA;
                const fechaA = new Date(a.fechaCreacion || a.fechaInicio || 0);
                const fechaB = new Date(b.fechaCreacion || b.fechaInicio || 0);
                return fechaB - fechaA;
            });
            
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
                return;
            }
            
            const tipoLabels = { nuevo: 'üÜï', bueno: '‚úÖ', regular: '‚ö†Ô∏è', malo: '‚ùå' };
            tbody.innerHTML = clientesFiltrados.map(c => {
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                const statusClass = c.estado === 'ativo' ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                const tipoIcon = tipoLabels[c.tipoCliente] || 'üÜï';
                const renovaciones = c.renovaciones || 0;
                return `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td><strong>${c.nombre}</strong>${renovaciones > 0 ? `<br><small style="color: var(--accent-purple);">üîÑ ${renovaciones}x renovado</small>` : ''}</td>
                    <td style="font-size: 1.2rem;">${tipoIcon}</td>
                    <td>${c.telefono || '-'}</td>
                    <td>R$ ${(c.montoTotal || 0).toFixed(2)}</td>
                    <td style="color: var(--accent-green);">R$ ${(c.montoPagado || 0).toFixed(2)}</td>
                    <td style="color: var(--accent-red);">R$ ${restante.toFixed(2)}</td>
                    <td>${c.parcelasPagas || 0}/${c.numeroParcelas}</td>
                    <td><span class="badge-status badge-${statusClass}">${c.estado}</span></td>
                    <td>
                        ${c.estado === 'finalizado' && !c.renovado ? `
                        <button class="btn btn-sm me-1" style="background: var(--accent-purple); color: #fff;" onclick="renovarCliente('${c.id}')" title="Renovar pr√©stamo">
                            <i class="fas fa-redo"></i>
                        </button>
                        ` : c.estado !== 'finalizado' ? `
                        <button class="btn btn-sm btn-success-custom me-1" onclick="abrirPago('${c.id}')" title="Registrar pago">
                            <i class="fas fa-dollar-sign"></i>
                        </button>
                        ` : ''}
                        <button class="btn btn-sm" style="background: var(--bg-hover); color: var(--text-secondary);" onclick="verDetalles('${c.id}')" title="Ver detalles">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>`;
            }).join('');
        }
        function setFechaHoy() {
            document.getElementById('fechaCobros').value = new Date().toISOString().split('T')[0];
            renderCobros();
        }

        function renderCobros() {
            const container = document.getElementById('cobrosLista');
            const resumenContainer = document.getElementById('cobrosResumen');
            const fechaSeleccionada = document.getElementById('fechaCobros').value;
            
            // Filtrar clientes activos
            const activos = clientes.filter(c => c.estado === 'ativo');
            
            // Filtrar pagos realizados en la fecha seleccionada
            const pagosDelDia = [];
            clientes.forEach(c => {
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        // Comparar solo la parte de fecha (YYYY-MM-DD)
                        const fechaPago = (p.fecha || '').split('T')[0];
                        if (fechaPago === fechaSeleccionada) {
                            // Extraer hora si existe
                            let hora = '';
                            if (p.fecha && p.fecha.includes('T')) {
                                const fechaObj = new Date(p.fecha);
                                hora = fechaObj.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                            }
                            pagosDelDia.push({
                                cliente: c.nombre,
                                telefono: c.telefono,
                                valor: p.valor,
                                hora: hora,
                                clienteId: c.id
                            });
                        }
                    });
                }
            });
            
            // Calcular totales del d√≠a
            const totalCobradoHoy = pagosDelDia.reduce((s, p) => s + p.valor, 0);
            const totalPendienteHoy = activos.reduce((s, c) => s + (c.valorParcela || 0), 0);
            
            // Mostrar resumen
            resumenContainer.innerHTML = `
                <div class="col-md-4">
                    <div class="stat-card green">
                        <div class="stat-value">R$ ${totalCobradoHoy.toFixed(2)}</div>
                        <div class="stat-label"><i class="fas fa-check-circle me-2"></i>Cobrado este d√≠a</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card yellow">
                        <div class="stat-value">${pagosDelDia.length}</div>
                        <div class="stat-label"><i class="fas fa-receipt me-2"></i>Pagos registrados</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="stat-card">
                        <div class="stat-value">${activos.length}</div>
                        <div class="stat-label"><i class="fas fa-users me-2"></i>Clientes pendientes</div>
                    </div>
                </div>
            `;
            
            // Mostrar pagos del d√≠a si hay
            let html = '';
            
            if (pagosDelDia.length > 0) {
                html += `<h6 class="mb-3" style="color: var(--accent-green);"><i class="fas fa-check-circle me-2"></i>Pagos del ${fechaSeleccionada}</h6>`;
                html += pagosDelDia.map(p => `
                    <div class="client-card" style="border-left: 3px solid var(--accent-green);">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>${p.cliente}</strong><br>
                                <small class="text-secondary">${p.telefono || 'Sin tel√©fono'}</small>
                            </div>
                            <div class="col-md-4">
                                <small class="text-secondary">Pago realizado${p.hora ? ' a las ' + p.hora : ''}</small><br>
                                <span style="color: var(--accent-green); font-size: 1.2rem;">R$ ${p.valor.toFixed(2)}</span>
                            </div>
                            <div class="col-md-4 text-end">
                                <span class="badge-status badge-active"><i class="fas fa-check me-1"></i>Pagado</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Mostrar clientes pendientes
            if (activos.length > 0) {
                html += `<h6 class="mb-3 mt-4" style="color: var(--accent-yellow);"><i class="fas fa-clock me-2"></i>Pendientes de cobro</h6>`;
                html += activos.map(c => `
                    <div class="client-card">
                        <div class="row align-items-center">
                            <div class="col-md-3">
                                <strong>${c.nombre}</strong><br>
                                <small class="text-secondary">${c.telefono || 'Sin tel√©fono'}</small>
                            </div>
                            <div class="col-md-2">
                                <small class="text-secondary">Parcela</small><br>
                                <span style="color: var(--accent-cyan);">R$ ${(c.valorParcela || 0).toFixed(2)}</span>
                            </div>
                            <div class="col-md-2">
                                <small class="text-secondary">Restante</small><br>
                                <span style="color: var(--accent-red);">R$ ${((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2)}</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-secondary">Progreso</small>
                                <div class="progress-custom mt-1">
                                    <div class="bar" style="width: ${((c.montoPagado || 0) / (c.totalAPagar || 1)) * 100}%"></div>
                                </div>
                                <small class="text-secondary">${c.parcelasPagas || 0}/${c.numeroParcelas} parcelas</small>
                            </div>
                            <div class="col-md-2 text-end">
                                <button class="btn btn-success-custom" onclick="abrirPago('${c.id}')">
                                    <i class="fas fa-money-bill me-1"></i>Cobrar
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            if (html === '') {
                html = '<p class="text-center text-secondary py-4">No hay cobros ni pagos para esta fecha</p>';
            }
            
            container.innerHTML = html;
        }

        // Admin Functions
        async function renderAdminUsuarios() {
            try {
                const usersRes = await fetch(API_URL + '/api/users');
                allUsers = await usersRes.json();
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                adminAllClients = allClients;
                
                // Separar usuarios activos y pendientes
                const usuariosPendientes = allUsers.filter(u => !u.pagado && !u.activo);
                const usuariosActivos = allUsers.filter(u => u.pagado || u.activo);
                
                document.getElementById('adminTotalUsers').textContent = allUsers.length;
                document.getElementById('adminPendientes').textContent = usuariosPendientes.length;
                document.getElementById('adminTotalClients').textContent = allClients.length;
                const totalPrestado = allClients.reduce((s, c) => s + (c.montoTotal || 0), 0);
                document.getElementById('adminTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                
                // Mostrar secci√≥n de pendientes si hay
                const pendientesSection = document.getElementById('pendientesSection');
                const pendientesList = document.getElementById('pendientesList');
                const pendientesBadge = document.getElementById('pendientesBadge');
                
                if (usuariosPendientes.length > 0) {
                    pendientesSection.style.display = 'block';
                    pendientesBadge.textContent = usuariosPendientes.length;
                    pendientesList.innerHTML = usuariosPendientes.map(u => {
                        const fechaReg = u.fechaRegistro ? new Date(u.fechaRegistro).toLocaleString('es-BR') : 'Desconocida';
                        return `
                        <div class="d-flex justify-content-between align-items-center py-3 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <strong style="color: #ff6b35;">
                                    <i class="fas fa-user-clock me-2"></i>${u.nombre}
                                </strong>
                                <br><small class="text-secondary"><i class="fas fa-envelope me-1"></i>${u.email}</small>
                                <br><small class="text-secondary"><i class="fas fa-clock me-1"></i>Registrado: ${fechaReg}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-success-custom" onclick="activarUsuario('${u.id}')">
                                    <i class="fas fa-check me-1"></i>Activar
                                </button>
                                <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="rechazarUsuario('${u.id}')">
                                    <i class="fas fa-times me-1"></i>Rechazar
                                </button>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    pendientesSection.style.display = 'none';
                }
                
                // Mostrar usuarios activos
                const container = document.getElementById('usuariosList');
                if (usuariosActivos.length === 0) {
                    container.innerHTML = '<div class="card-dark text-center py-4"><p class="text-secondary">No hay usuarios activos</p></div>';
                    return;
                }
                container.innerHTML = usuariosActivos.map(u => {
                    const userClients = allClients.filter(c => c.creadoPor === u.id);
                    const userPrestado = userClients.reduce((s, c) => s + (c.montoTotal || 0), 0);
                    const userCobrado = userClients.reduce((s, c) => s + (c.montoPagado || 0), 0);
                    const bloqueado = u.bloqueado || false;
                    return `
                    <div class="card-dark mb-3" style="${bloqueado ? 'opacity: 0.6; border-left: 3px solid var(--accent-red);' : ''}">
                        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                            <div style="cursor: pointer;" onclick="toggleUserClients('${u.id}')">
                                <strong>
                                    <i class="fas fa-user me-2" style="color: ${bloqueado ? 'var(--accent-red)' : 'var(--accent-cyan)'};"></i>
                                    ${u.nombre}
                                    ${bloqueado ? '<span class="badge-status badge-late ms-2">BLOQUEADO</span>' : ''}
                                </strong>
                                <br><small class="text-secondary">${u.email}</small>
                                <br><span class="badge-status badge-active mt-1">${userClients.length} clientes</span>
                                <span style="color: var(--accent-green); margin-left: 10px;">R$ ${userPrestado.toFixed(2)}</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm" style="background: var(--accent-purple); color: #fff;"
                                        onclick="event.stopPropagation(); verTodoTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-eye me-1"></i>Ver Todo
                                </button>
                                <button class="btn btn-sm btn-primary-custom" 
                                        onclick="event.stopPropagation(); verHistorialTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-history me-1"></i>Historial
                                </button>
                                <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;"
                                        onclick="event.stopPropagation(); verBackupsTrabajador('${u.id}', '${u.nombre}')">
                                    <i class="fas fa-database me-1"></i>Backups
                                </button>
                                <button class="btn btn-sm" 
                                        style="background: ${bloqueado ? 'var(--accent-red)' : 'var(--accent-green)'}; color: #fff;"
                                        onclick="event.stopPropagation(); toggleBlockUser('${u.id}')"
                                        title="${bloqueado ? 'Clic para desbloquear' : 'Clic para bloquear'}">
                                    <i class="fas fa-${bloqueado ? 'lock' : 'lock-open'}"></i>
                                    ${bloqueado ? 'Bloqueado' : 'Activo'}
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="toggleUserClients('${u.id}')">
                                    <i class="fas fa-chevron-down" id="icon-${u.id}"></i>
                                </button>
                            </div>
                        </div>
                        <div id="clients-${u.id}" style="display: none; margin-top: 15px; padding-top: 15px; border-top: 1px solid var(--border-color);">
                            ${userClients.length === 0 ? '<p class="text-secondary mb-0">Sin clientes</p>' : 
                            userClients.map(c => `
                                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                                    <div>
                                        <strong>${c.nombre}</strong>
                                        <br><small class="text-secondary">R$ ${(c.montoTotal || 0).toFixed(2)} prestado</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary-custom" onclick="event.stopPropagation(); verClienteAdmin('${c.id}', '${u.id}')">
                                        <i class="fas fa-eye me-1"></i>VER
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                }).join('');
            } catch (e) { console.error(e); }
        }
        
        async function activarUsuario(userId) {
            if (!confirm('¬øActivar este usuario? Podr√° acceder a la aplicaci√≥n.')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId + '/activate', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Usuario activado correctamente');
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo activar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        
        async function rechazarUsuario(userId) {
            if (!confirm('¬øRechazar y eliminar este usuario?')) return;
            if (!confirm('‚ö†Ô∏è Esta acci√≥n eliminar√° al usuario permanentemente. ¬øContinuar?')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('Usuario eliminado');
                    renderAdminUsuarios();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        // Variable para guardar clientes del admin
        let adminAllClients = [];

        // ========== CALENDARIO ADMIN ==========
        async function renderCalendarioClientes() {
            try {
                // Cargar usuarios y clientes
                const usersRes = await fetch(API_URL + '/api/users');
                const users = await usersRes.json();
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                
                // Llenar select de trabajadores
                const selectTrabajador = document.getElementById('calendarioTrabajador');
                const currentValue = selectTrabajador.value;
                selectTrabajador.innerHTML = '<option value="">Todos los trabajadores</option>' + 
                    users.map(u => `<option value="${u.id}" ${currentValue === u.id ? 'selected' : ''}>${u.nombre}</option>`).join('');
                
                // Obtener filtros
                const trabajadorId = document.getElementById('calendarioTrabajador').value;
                const fechaSeleccionada = document.getElementById('calendarioFecha').value || new Date().toISOString().split('T')[0];
                const vista = document.getElementById('calendarioVista').value;
                
                // Filtrar clientes
                let clientesFiltrados = allClients;
                
                // Filtrar por trabajador
                if (trabajadorId) {
                    clientesFiltrados = clientesFiltrados.filter(c => c.creadoPor === trabajadorId);
                }
                
                // Filtrar por fecha
                const fechaBase = new Date(fechaSeleccionada);
                if (vista !== 'todos') {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fechaCliente = new Date(c.fechaInicio || c.fechaRegistro || c.id.split('-')[1]);
                        if (vista === 'dia') {
                            return fechaCliente.toDateString() === fechaBase.toDateString();
                        } else if (vista === 'semana') {
                            const inicioSemana = new Date(fechaBase);
                            inicioSemana.setDate(fechaBase.getDate() - fechaBase.getDay());
                            const finSemana = new Date(inicioSemana);
                            finSemana.setDate(inicioSemana.getDate() + 6);
                            return fechaCliente >= inicioSemana && fechaCliente <= finSemana;
                        } else if (vista === 'mes') {
                            return fechaCliente.getMonth() === fechaBase.getMonth() && 
                                   fechaCliente.getFullYear() === fechaBase.getFullYear();
                        }
                        return true;
                    });
                }
                
                // Ordenar por fecha (m√°s reciente primero)
                clientesFiltrados.sort((a, b) => {
                    const fechaA = new Date(a.fechaInicio || a.fechaRegistro || 0);
                    const fechaB = new Date(b.fechaInicio || b.fechaRegistro || 0);
                    return fechaB - fechaA;
                });
                
                // Calcular totales
                const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                
                document.getElementById('calTotalClientes').textContent = clientesFiltrados.length;
                document.getElementById('calTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('calTotalCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                
                // Renderizar tabla
                const tbody = document.getElementById('calendarioClientesTable');
                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-4">No hay clientes para esta fecha</td></tr>';
                    return;
                }
                
                tbody.innerHTML = clientesFiltrados.map(c => {
                    const fechaRegistro = c.fechaInicio || c.fechaRegistro;
                    const fechaFormateada = fechaRegistro ? new Date(fechaRegistro).toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    }) : 'Sin fecha';
                    
                    const trabajador = users.find(u => u.id === c.creadoPor);
                    const nombreTrabajador = trabajador ? trabajador.nombre : 'Desconocido';
                    
                    const prestado = parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0;
                    const cobrado = parseFloat(c.montoPagado) || 0;
                    
                    const statusClass = c.estado === 'ativo' ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                    const statusText = c.estado === 'ativo' ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                    
                    return `
                    <tr>
                        <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                        <td><strong>${c.nombre}</strong><br><small class="text-secondary">${c.telefono || ''}</small></td>
                        <td><i class="fas fa-user-tie me-2" style="color: var(--accent-cyan);"></i>${nombreTrabajador}</td>
                        <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                        <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                        <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                    </tr>`;
                }).join('');
                
            } catch (e) { 
                console.error('Error en calendario:', e); 
            }
        }
        // ========== FIN CALENDARIO ADMIN ==========

        // ========== HISTORIAL TRABAJADOR (PARA TRABAJADORES) ==========
        function initHistorial() {
            const selectAnio = document.getElementById('historialAnio');
            const anioActual = new Date().getFullYear();
            let opciones = '<option value="">Todos los a√±os</option>';
            for (let a = anioActual; a >= anioActual - 5; a--) {
                opciones += `<option value="${a}">${a}</option>`;
            }
            selectAnio.innerHTML = opciones;
        }

        function limpiarFiltrosHistorial() {
            document.getElementById('historialAnio').value = '';
            document.getElementById('historialMes').value = '';
            document.getElementById('historialDia').value = '';
            document.getElementById('historialEstado').value = '';
            document.getElementById('historialTipo').value = '';
            renderHistorial();
        }

        function renderHistorial() {
            const anio = document.getElementById('historialAnio').value;
            const mes = document.getElementById('historialMes').value;
            const dia = document.getElementById('historialDia').value;
            const estado = document.getElementById('historialEstado').value;
            const tipo = document.getElementById('historialTipo').value;
            
            // Filtrar clientes del usuario actual
            let clientesFiltrados = [...clientes];
            
            // Filtrar por a√±o
            if (anio) {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.getFullYear() === parseInt(anio);
                });
            }
            
            // Filtrar por mes
            if (mes !== '') {
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.getMonth() === parseInt(mes);
                });
            }
            
            // Filtrar por d√≠a espec√≠fico
            if (dia) {
                const fechaDia = new Date(dia);
                clientesFiltrados = clientesFiltrados.filter(c => {
                    const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                    return fecha.toDateString() === fechaDia.toDateString();
                });
            }
            
            // Filtrar por estado
            if (estado) {
                clientesFiltrados = clientesFiltrados.filter(c => c.estado === estado);
            }
            
            // Filtrar por tipo de cliente
            if (tipo) {
                clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === tipo);
            }
            
            // Ordenar por fecha (m√°s reciente primero)
            clientesFiltrados.sort((a, b) => {
                const fechaA = new Date(a.fechaInicio || a.fechaRegistro || 0);
                const fechaB = new Date(b.fechaInicio || b.fechaRegistro || 0);
                return fechaB - fechaA;
            });
            
            // Calcular totales
            const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0), 0);
            const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
            const totalPendiente = totalPrestado - totalCobrado;
            
            const activos = clientesFiltrados.filter(c => c.estado === 'ativo').length;
            const finalizados = clientesFiltrados.filter(c => c.estado === 'finalizado').length;
            const atrasados = clientesFiltrados.filter(c => c.estado === 'atrasado').length;
            
            // Contar por tipo (de todos los clientes, no solo filtrados)
            const nuevos = clientes.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = clientes.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = clientes.filter(c => c.tipoCliente === 'regular').length;
            const malos = clientes.filter(c => c.tipoCliente === 'malo').length;
            
            document.getElementById('histTotalClientes').textContent = clientesFiltrados.length;
            document.getElementById('histTotalPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('histTotalCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('histTotalPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            document.getElementById('histActivos').textContent = activos;
            document.getElementById('histFinalizados').textContent = finalizados;
            document.getElementById('histAtrasados').textContent = atrasados;
            document.getElementById('histNuevos').textContent = nuevos;
            document.getElementById('histBuenos').textContent = buenos;
            document.getElementById('histRegulares').textContent = regulares;
            document.getElementById('histMalos').textContent = malos;
            
            // Renderizar tabla
            const tbody = document.getElementById('historialTable');
            if (clientesFiltrados.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
            } else {
                const tipoLabels = { nuevo: 'üÜï', bueno: '‚úÖ', regular: '‚ö†Ô∏è', malo: '‚ùå' };
                tbody.innerHTML = clientesFiltrados.map(c => {
                    const fecha = c.fechaInicio || c.fechaRegistro;
                    const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', {
                        day: '2-digit', month: '2-digit', year: 'numeric'
                    }) : 'Sin fecha';
                    
                    const prestado = parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0;
                    const cobrado = parseFloat(c.montoPagado) || 0;
                    const pendiente = prestado - cobrado;
                    
                    const statusClass = c.estado === 'ativo' ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                    const statusText = c.estado === 'ativo' ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                    const tipoIcon = tipoLabels[c.tipoCliente] || 'üÜï';
                    
                    return `
                    <tr style="border-bottom: 1px solid var(--border-color);">
                        <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                        <td><strong>${c.nombre}</strong></td>
                        <td style="font-size: 1.2rem;">${tipoIcon}</td>
                        <td>${c.telefono || '-'}</td>
                        <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                        <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                        <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                        <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                    </tr>`;
                }).join('');
            }
            
            // Renderizar √∫ltimos pagos
            renderHistorialPagos(clientesFiltrados);
        }

        function renderHistorialPagos(clientesFiltrados) {
            const container = document.getElementById('historialPagos');
            let todosPagos = [];
            
            clientesFiltrados.forEach(c => {
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.monto,
                            fecha: p.fecha,
                            parcela: p.parcela
                        });
                    });
                }
            });
            
            // Ordenar por fecha m√°s reciente
            todosPagos.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
            
            // Mostrar √∫ltimos 20
            todosPagos = todosPagos.slice(0, 20);
            
            if (todosPagos.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center py-3">No hay pagos registrados</p>';
                return;
            }
            
            container.innerHTML = todosPagos.map(p => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <strong>${p.cliente}</strong>
                        <br><small class="text-secondary">${new Date(p.fecha).toLocaleDateString('es-ES')} - Parcela ${p.parcela || '?'}</small>
                    </div>
                    <span style="color: var(--accent-green); font-weight: bold;">+ R$ ${parseFloat(p.monto).toFixed(2)}</span>
                </div>
            `).join('');
        }
        // ========== FIN HISTORIAL TRABAJADOR ==========

        // ========== HISTORIAL ADMIN (VER TRABAJADOR ESPEC√çFICO) ==========
        let adminHistorialUserId = null;

        function verHistorialTrabajador(userId, nombre) {
            adminHistorialUserId = userId;
            document.getElementById('adminHistNombre').textContent = nombre;
            
            // Inicializar a√±os
            const selectAnio = document.getElementById('adminHistAnio');
            const anioActual = new Date().getFullYear();
            let opciones = '<option value="">Todos</option>';
            for (let a = anioActual; a >= anioActual - 5; a--) {
                opciones += `<option value="${a}">${a}</option>`;
            }
            selectAnio.innerHTML = opciones;
            
            // Limpiar filtros
            document.getElementById('adminHistMes').value = '';
            document.getElementById('adminHistDia').value = '';
            document.getElementById('adminHistEstado').value = '';
            
            showSection('adminHistorial');
        }

        async function renderAdminHistorialTrabajador() {
            if (!adminHistorialUserId) return;
            
            try {
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                
                // Filtrar por trabajador (todos los clientes de este trabajador)
                const clientesTrabajador = allClients.filter(c => c.creadoPor === adminHistorialUserId);
                let clientesFiltrados = [...clientesTrabajador];
                
                // Aplicar filtros
                const anio = document.getElementById('adminHistAnio').value;
                const mes = document.getElementById('adminHistMes').value;
                const dia = document.getElementById('adminHistDia').value;
                const estado = document.getElementById('adminHistEstado').value;
                const tipo = document.getElementById('adminHistTipo').value;
                
                if (anio) {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.getFullYear() === parseInt(anio);
                    });
                }
                
                if (mes !== '') {
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.getMonth() === parseInt(mes);
                    });
                }
                
                if (dia) {
                    const fechaDia = new Date(dia);
                    clientesFiltrados = clientesFiltrados.filter(c => {
                        const fecha = new Date(c.fechaInicio || c.fechaRegistro || 0);
                        return fecha.toDateString() === fechaDia.toDateString();
                    });
                }
                
                if (estado) {
                    clientesFiltrados = clientesFiltrados.filter(c => c.estado === estado);
                }
                
                if (tipo) {
                    clientesFiltrados = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === tipo);
                }
                
                // Ordenar por fecha (m√°s reciente primero)
                clientesFiltrados.sort((a, b) => {
                    const fechaA = new Date(a.fechaInicio || a.fechaRegistro || 0);
                    const fechaB = new Date(b.fechaInicio || b.fechaRegistro || 0);
                    return fechaB - fechaA;
                });
                
                // Calcular totales
                const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                const totalPendiente = totalPrestado - totalCobrado;
                
                // Contar por tipo (de todos los clientes del trabajador)
                const nuevos = clientesTrabajador.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
                const buenos = clientesTrabajador.filter(c => c.tipoCliente === 'bueno').length;
                const regulares = clientesTrabajador.filter(c => c.tipoCliente === 'regular').length;
                const malos = clientesTrabajador.filter(c => c.tipoCliente === 'malo').length;
                
                document.getElementById('adminHistTotal').textContent = clientesFiltrados.length;
                document.getElementById('adminHistPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('adminHistCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                document.getElementById('adminHistPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
                document.getElementById('adminHistNuevos').textContent = nuevos;
                document.getElementById('adminHistBuenos').textContent = buenos;
                document.getElementById('adminHistRegulares').textContent = regulares;
                document.getElementById('adminHistMalos').textContent = malos;
                
                // Renderizar tabla
                const tbody = document.getElementById('adminHistTable');
                const tipoLabels = { nuevo: 'üÜï', bueno: '‚úÖ', regular: '‚ö†Ô∏è', malo: '‚ùå' };
                
                if (clientesFiltrados.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" class="text-center text-secondary py-4">No hay clientes para estos filtros</td></tr>';
                } else {
                    tbody.innerHTML = clientesFiltrados.map(c => {
                        const fecha = c.fechaInicio || c.fechaRegistro;
                        const fechaFormateada = fecha ? new Date(fecha).toLocaleDateString('es-ES', {
                            day: '2-digit', month: '2-digit', year: 'numeric'
                        }) : 'Sin fecha';
                        
                        const prestado = parseFloat(c.montoPrestado) || parseFloat(c.montoTotal) || 0;
                        const cobrado = parseFloat(c.montoPagado) || 0;
                        const pendiente = prestado - cobrado;
                        
                        const statusClass = c.estado === 'ativo' ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                        const statusText = c.estado === 'ativo' ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                        const tipoIcon = tipoLabels[c.tipoCliente] || 'üÜï';
                        
                        return `
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td><i class="fas fa-calendar me-2" style="color: var(--accent-purple);"></i>${fechaFormateada}</td>
                            <td><strong>${c.nombre}</strong></td>
                            <td style="font-size: 1.2rem;">${tipoIcon}</td>
                            <td>${c.telefono || '-'}</td>
                            <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                            <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                            <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                            <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                        </tr>`;
                    }).join('');
                }
            } catch (e) {
                console.error('Error en historial admin:', e);
            }
        }
        // ========== FIN HISTORIAL ADMIN ==========

        // ========== ESTAD√çSTICAS TRABAJADOR ==========
        function initEstadisticas() {
            const hoy = new Date();
            document.getElementById('estFecha').value = hoy.toISOString().split('T')[0];
            document.getElementById('estMes').value = hoy.getMonth();
            
            const selectAnio = document.getElementById('estAnio');
            const anioActual = hoy.getFullYear();
            let opciones = '';
            for (let a = anioActual; a >= anioActual - 5; a--) {
                opciones += `<option value="${a}" ${a === anioActual ? 'selected' : ''}>${a}</option>`;
            }
            selectAnio.innerHTML = opciones;
        }

        function renderEstadisticas() {
            const vista = document.getElementById('estVista').value;
            const fecha = document.getElementById('estFecha').value;
            const mes = parseInt(document.getElementById('estMes').value);
            const anio = parseInt(document.getElementById('estAnio').value);
            
            const hoy = new Date();
            let fechaInicio, fechaFin;
            
            if (vista === 'dia') {
                const fechaSel = fecha ? new Date(fecha + 'T00:00:00') : hoy;
                fechaInicio = new Date(fechaSel);
                fechaInicio.setHours(0, 0, 0, 0);
                fechaFin = new Date(fechaSel);
                fechaFin.setHours(23, 59, 59, 999);
            } else if (vista === 'semana') {
                const inicioSemana = new Date(hoy);
                inicioSemana.setDate(hoy.getDate() - hoy.getDay());
                inicioSemana.setHours(0, 0, 0, 0);
                fechaInicio = inicioSemana;
                fechaFin = new Date(inicioSemana);
                fechaFin.setDate(fechaFin.getDate() + 6);
                fechaFin.setHours(23, 59, 59, 999);
            } else if (vista === 'mes') {
                fechaInicio = new Date(anio, mes, 1);
                fechaFin = new Date(anio, mes + 1, 0, 23, 59, 59, 999);
            } else if (vista === 'anio') {
                fechaInicio = new Date(anio, 0, 1);
                fechaFin = new Date(anio, 11, 31, 23, 59, 59, 999);
            } else {
                fechaInicio = new Date(2000, 0, 1);
                fechaFin = new Date(2100, 11, 31);
            }
            
            const clientesFiltrados = clientes.filter(c => {
                const fechaCliente = new Date(c.fechaCreacion || c.fechaInicio || c.fechaRegistro || 0);
                return fechaCliente >= fechaInicio && fechaCliente <= fechaFin;
            });
            
            const totalClientes = clientesFiltrados.length;
            const totalPrestado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
            const totalCobrado = clientesFiltrados.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
            const totalPendiente = clientesFiltrados.reduce((s, c) => {
                const total = parseFloat(c.totalAPagar) || 0;
                const pagado = parseFloat(c.montoPagado) || 0;
                return s + (total - pagado);
            }, 0);
            
            let pagosCount = 0;
            let pagosTotal = 0;
            clientes.forEach(c => {
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        const fechaPago = new Date(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            pagosCount++;
                            pagosTotal += parseFloat(p.valor) || 0;
                        }
                    });
                }
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        const fechaPago = new Date(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            pagosCount++;
                            pagosTotal += parseFloat(p.monto) || 0;
                        }
                    });
                }
            });
            
            const gastosFiltrados = gastos.filter(g => {
                const fechaGasto = new Date(g.fecha);
                return fechaGasto >= fechaInicio && fechaGasto <= fechaFin;
            });
            const gastosCount = gastosFiltrados.length;
            const gastosTotal = gastosFiltrados.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
            
            const balance = pagosTotal - gastosTotal;
            
            const nuevos = clientesFiltrados.filter(c => (c.tipoCliente || 'nuevo') === 'nuevo').length;
            const buenos = clientesFiltrados.filter(c => c.tipoCliente === 'bueno').length;
            const regulares = clientesFiltrados.filter(c => c.tipoCliente === 'regular').length;
            const malos = clientesFiltrados.filter(c => c.tipoCliente === 'malo').length;
            
            const activos = clientesFiltrados.filter(c => c.estado === 'ativo').length;
            const finalizados = clientesFiltrados.filter(c => c.estado === 'finalizado').length;
            const atrasados = clientesFiltrados.filter(c => c.estado === 'atrasado').length;
            
            document.getElementById('estClientes').textContent = totalClientes;
            document.getElementById('estPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
            document.getElementById('estCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
            document.getElementById('estPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
            
            document.getElementById('estPagosCount').textContent = pagosCount;
            document.getElementById('estPagosTotal').textContent = 'R$ ' + pagosTotal.toFixed(2);
            document.getElementById('estGastosCount').textContent = gastosCount;
            document.getElementById('estGastosTotal').textContent = 'R$ ' + gastosTotal.toFixed(2);
            
            const balanceEl = document.getElementById('estBalance');
            balanceEl.textContent = 'R$ ' + balance.toFixed(2);
            balanceEl.style.color = balance >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            
            document.getElementById('estNuevos').textContent = nuevos;
            document.getElementById('estBuenos').textContent = buenos;
            document.getElementById('estRegulares').textContent = regulares;
            document.getElementById('estMalos').textContent = malos;
            
            document.getElementById('estActivos').textContent = activos;
            document.getElementById('estFinalizados').textContent = finalizados;
            document.getElementById('estAtrasados').textContent = atrasados;
            
            renderEstadisticasActividad(fechaInicio, fechaFin, clientesFiltrados, gastosFiltrados);
        }

        function renderEstadisticasActividad(fechaInicio, fechaFin, clientesFiltrados, gastosFiltrados) {
            const container = document.getElementById('estActividad');
            let actividades = [];
            
            // Solo pagos, sin nuevos clientes
            clientes.forEach(c => {
                if (c.pagos) {
                    c.pagos.forEach(p => {
                        const fechaPago = new Date(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            actividades.push({
                                tipo: 'pago',
                                fecha: fechaPago,
                                texto: `Pago de ${c.nombre}`,
                                monto: p.valor,
                                icono: 'fa-money-bill-wave',
                                color: 'var(--accent-green)'
                            });
                        }
                    });
                }
                if (c.historialPagos) {
                    c.historialPagos.forEach(p => {
                        const fechaPago = new Date(p.fecha);
                        if (fechaPago >= fechaInicio && fechaPago <= fechaFin) {
                            actividades.push({
                                tipo: 'pago',
                                fecha: fechaPago,
                                texto: `Pago de ${c.nombre} (Parcela ${p.parcela || '?'})`,
                                monto: p.monto,
                                icono: 'fa-money-bill-wave',
                                color: 'var(--accent-green)'
                            });
                        }
                    });
                }
            });
            
            gastosFiltrados.forEach(g => {
                actividades.push({
                    tipo: 'gasto',
                    fecha: new Date(g.fecha),
                    texto: `Gasto: ${g.descripcion}`,
                    monto: g.valor,
                    icono: 'fa-wallet',
                    color: 'var(--accent-red)'
                });
            });
            
            actividades.sort((a, b) => b.fecha - a.fecha);
            actividades = actividades.slice(0, 50);
            
            if (actividades.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center py-3">No hay actividad en este per√≠odo</p>';
                return;
            }
            
            container.innerHTML = actividades.map(a => {
                const fechaStr = a.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const horaStr = a.fecha.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const signo = a.tipo === 'gasto' ? '-' : '+';
                return `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div class="d-flex align-items-center gap-3">
                        <i class="fas ${a.icono}" style="color: ${a.color}; width: 20px;"></i>
                        <div>
                            <span>${a.texto}</span>
                            <br><small class="text-secondary">${fechaStr} - ${horaStr}</small>
                        </div>
                    </div>
                    <span style="color: ${a.color}; font-weight: bold;">${signo} R$ ${parseFloat(a.monto).toFixed(2)}</span>
                </div>`;
            }).join('');
        }
        // ========== FIN ESTAD√çSTICAS TRABAJADOR ==========

        // ========== VER TODO TRABAJADOR (ADMIN) ==========
        let verTodoUserId = null;
        let verTodoUserData = null;
        let verTodoClientes = [];
        let verTodoGastos = [];
        let verTodoTabActual = 'clientes';

        async function verTodoTrabajador(userId, nombre) {
            verTodoUserId = userId;
            verTodoUserData = allUsers.find(u => u.id === userId);
            
            document.getElementById('verTodoNombre').textContent = nombre;
            document.getElementById('verTodoEmail').textContent = verTodoUserData?.email || '-';
            document.getElementById('verTodoFechaReg').textContent = verTodoUserData?.fechaRegistro ? 
                new Date(verTodoUserData.fechaRegistro).toLocaleDateString('es-ES') : '-';
            document.getElementById('verTodoEstado').innerHTML = verTodoUserData?.activo !== false ? 
                '<span class="badge-status badge-active">Activo</span>' : 
                '<span class="badge-status badge-late">Bloqueado</span>';
            
            try {
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                verTodoClientes = allClients.filter(c => c.creadoPor === userId);
                
                const gastosRes = await fetch(API_URL + '/api/gastos/' + userId);
                verTodoGastos = await gastosRes.json();
                
                const totalClientes = verTodoClientes.length;
                const totalPrestado = verTodoClientes.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalCobrado = verTodoClientes.reduce((s, c) => s + (parseFloat(c.montoPagado) || 0), 0);
                const totalPendiente = verTodoClientes.reduce((s, c) => {
                    const total = parseFloat(c.totalAPagar) || 0;
                    const pagado = parseFloat(c.montoPagado) || 0;
                    return s + (total - pagado);
                }, 0);
                const totalGastos = verTodoGastos.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                let totalPagos = 0;
                verTodoClientes.forEach(c => {
                    if (c.pagos) totalPagos += c.pagos.length;
                    if (c.historialPagos) totalPagos += c.historialPagos.length;
                });
                
                document.getElementById('vtTotalClientes').textContent = totalClientes;
                document.getElementById('vtPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('vtCobrado').textContent = 'R$ ' + totalCobrado.toFixed(2);
                document.getElementById('vtPendiente').textContent = 'R$ ' + totalPendiente.toFixed(2);
                document.getElementById('vtGastos').textContent = 'R$ ' + totalGastos.toFixed(2);
                document.getElementById('vtPagosRecibidos').textContent = totalPagos;
                
                showSection('adminVerTodo');
                verTodoTabActual = 'clientes';
                mostrarTabVerTodo('clientes');
                
            } catch (e) {
                console.error('Error cargando datos:', e);
                alert('Error al cargar datos del trabajador');
            }
        }

        function mostrarTabVerTodo(tab) {
            verTodoTabActual = tab;
            
            ['clientes', 'gastos', 'pagos', 'actividad'].forEach(t => {
                const btn = document.getElementById('vtTab' + t.charAt(0).toUpperCase() + t.slice(1));
                if (btn) {
                    btn.className = t === tab ? 'btn btn-primary-custom' : 'btn btn-secondary';
                }
            });
            
            const container = document.getElementById('vtContenido');
            
            if (tab === 'clientes') {
                renderVerTodoClientes(container);
            } else if (tab === 'gastos') {
                renderVerTodoGastos(container);
            } else if (tab === 'pagos') {
                renderVerTodoPagos(container);
            } else if (tab === 'actividad') {
                renderVerTodoActividad(container);
            }
        }

        function filtrarVerTodo() {
            mostrarTabVerTodo(verTodoTabActual);
        }

        function renderVerTodo() {
            if (verTodoUserId) {
                mostrarTabVerTodo(verTodoTabActual);
            }
        }

        function renderVerTodoClientes(container) {
            const tipoLabels = { nuevo: 'üÜï', bueno: '‚úÖ', regular: '‚ö†Ô∏è', malo: '‚ùå' };
            const busqueda = (document.getElementById('vtBuscador')?.value || '').toLowerCase().trim();
            
            let clientesFiltrados = verTodoClientes;
            if (busqueda) {
                clientesFiltrados = verTodoClientes.filter(c => 
                    (c.nombre || '').toLowerCase().includes(busqueda) ||
                    (c.telefono || '').toLowerCase().startsWith(busqueda)
                );
            }
            
            if (clientesFiltrados.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${busqueda ? 'No se encontraron resultados para "' + busqueda + '"' : 'No hay clientes'}</p></div>`;
                return;
            }
            
            const clientesOrdenados = [...clientesFiltrados].sort((a, b) => {
                return new Date(b.fechaCreacion || 0) - new Date(a.fechaCreacion || 0);
            });
            
            container.innerHTML = `
            <div class="card-dark">
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-dark-custom mb-0">
                        <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 10;">
                            <tr>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Tipo</th>
                                <th>Tel√©fono</th>
                                <th>Prestado</th>
                                <th>Cobrado</th>
                                <th>Pendiente</th>
                                <th>Estado</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${clientesOrdenados.map(c => {
                                const fecha = c.fechaCreacion || c.fechaInicio;
                                const fechaStr = fecha ? new Date(fecha).toLocaleDateString('es-ES') : '-';
                                const prestado = parseFloat(c.montoTotal) || 0;
                                const cobrado = parseFloat(c.montoPagado) || 0;
                                const pendiente = (parseFloat(c.totalAPagar) || 0) - cobrado;
                                const statusClass = c.estado === 'ativo' ? 'active' : c.estado === 'finalizado' ? 'finished' : 'late';
                                const statusText = c.estado === 'ativo' ? 'Activo' : c.estado === 'finalizado' ? 'Finalizado' : 'Atrasado';
                                
                                return `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td>${fechaStr}</td>
                                    <td><strong>${c.nombre}</strong></td>
                                    <td style="font-size: 1.2rem;">${tipoLabels[c.tipoCliente] || 'üÜï'}</td>
                                    <td>${c.telefono || '-'}</td>
                                    <td style="color: var(--accent-green);">R$ ${prestado.toFixed(2)}</td>
                                    <td style="color: var(--accent-yellow);">R$ ${cobrado.toFixed(2)}</td>
                                    <td style="color: var(--accent-red);">R$ ${pendiente.toFixed(2)}</td>
                                    <td><span class="badge-status badge-${statusClass}">${statusText}</span></td>
                                    <td>
                                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000; margin-right: 5px;" onclick="adminEditarCliente('${c.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="adminEliminarCliente('${c.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderVerTodoGastos(container) {
            const busqueda = (document.getElementById('vtBuscador')?.value || '').toLowerCase().trim();
            
            let gastosFiltrados = verTodoGastos;
            if (busqueda) {
                gastosFiltrados = verTodoGastos.filter(g => 
                    (g.descripcion || '').toLowerCase().includes(busqueda) ||
                    (g.categoria || '').toLowerCase().includes(busqueda)
                );
            }
            
            if (gastosFiltrados.length === 0) {
                container.innerHTML = `<div class="card-dark"><p class="text-secondary text-center py-4">${busqueda ? 'No se encontraron resultados para "' + busqueda + '"' : 'No hay gastos registrados'}</p></div>`;
                return;
            }
            
            const gastosOrdenados = [...gastosFiltrados].sort((a, b) => {
                return new Date(b.fecha || 0) - new Date(a.fecha || 0);
            });
            
            const totalGastos = gastosOrdenados.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
            
            container.innerHTML = `
            <div class="card-dark mb-3">
                <div class="row text-center">
                    <div class="col-6">
                        <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;">${gastosOrdenados.length}</div>
                        <small class="text-secondary">Total Gastos</small>
                    </div>
                    <div class="col-6">
                        <div style="color: var(--accent-red); font-size: 1.5rem; font-weight: bold;">R$ ${totalGastos.toFixed(2)}</div>
                        <small class="text-secondary">Valor Total</small>
                    </div>
                </div>
            </div>
            <div class="card-dark">
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-dark-custom mb-0">
                        <thead style="position: sticky; top: 0; background: var(--bg-hover); z-index: 10;">
                            <tr>
                                <th>Fecha</th>
                                <th>Descripci√≥n</th>
                                <th>Categor√≠a</th>
                                <th>Valor</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${gastosOrdenados.map(g => {
                                const fechaStr = g.fecha ? new Date(g.fecha).toLocaleDateString('es-ES') : '-';
                                return `
                                <tr style="border-bottom: 1px solid var(--border-color);">
                                    <td>${fechaStr}</td>
                                    <td>${g.descripcion || '-'}</td>
                                    <td>${g.categoria || '-'}</td>
                                    <td style="color: var(--accent-red); font-weight: bold;">R$ ${(parseFloat(g.valor) || 0).toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-sm" style="background: var(--accent-cyan); color: #000; margin-right: 5px;" onclick="adminEditarGasto('${g.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="adminEliminarGasto('${g.id}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }

        function renderVerTodoPagos(container) {
            let todosPagos = [];
            
            verTodoClientes.forEach(c => {
                if (c.pagos && c.pagos.length > 0) {
                    c.pagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.valor,
                            fecha: p.fecha
                        });
                    });
                }
                if (c.historialPagos && c.historialPagos.length > 0) {
                    c.historialPagos.forEach(p => {
                        todosPagos.push({
                            cliente: c.nombre,
                            monto: p.monto,
                            fecha: p.fecha,
                            parcela: p.parcela
                        });
                    });
                }
            });
            
            todosPagos.sort((a, b) => new Date(b.fecha || 0) - new Date(a.fecha || 0));
            
            if (todosPagos.length === 0) {
                container.innerHTML = '<div class="card-dark"><p class="text-secondary text-center py-4">No hay pagos registrados</p></div>';
                return;
            }
            
            const totalPagos = todosPagos.reduce((s, p) => s + (parseFloat(p.monto) || 0), 0);
            
            container.innerHTML = `
            <div class="card-dark mb-3">
                <div class="row text-center">
                    <div class="col-6">
                        <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;">${todosPagos.length}</div>
                        <small class="text-secondary">Total Pagos</small>
                    </div>
                    <div class="col-6">
                        <div style="color: var(--accent-green); font-size: 1.5rem; font-weight: bold;">R$ ${totalPagos.toFixed(2)}</div>
                        <small class="text-secondary">Valor Total</small>
                    </div>
                </div>
            </div>
            <div class="card-dark">
                <div style="max-height: 400px; overflow-y: auto;">
                    ${todosPagos.map(p => {
                        const fechaStr = p.fecha ? new Date(p.fecha).toLocaleDateString('es-ES') : '-';
                        return `
                        <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                            <div>
                                <strong>${p.cliente}</strong>
                                <br><small class="text-secondary">${fechaStr}${p.parcela ? ' - Parcela ' + p.parcela : ''}</small>
                            </div>
                            <span style="color: var(--accent-green); font-weight: bold;">+ R$ ${(parseFloat(p.monto) || 0).toFixed(2)}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }

        function renderVerTodoActividad(container) {
            let actividades = [];
            
            verTodoClientes.forEach(c => {
                actividades.push({
                    tipo: 'cliente',
                    fecha: new Date(c.fechaCreacion || c.fechaInicio || 0),
                    texto: `Nuevo cliente: ${c.nombre}`,
                    detalle: `Pr√©stamo: R$ ${(c.montoTotal || 0).toFixed(2)}`,
                    icono: 'fa-user-plus',
                    color: 'var(--accent-cyan)'
                });
            });
            
            verTodoClientes.forEach(c => {
                if (c.pagos) {
                    c.pagos.forEach(p => {
                        actividades.push({
                            tipo: 'pago',
                            fecha: new Date(p.fecha || 0),
                            texto: `Pago recibido de ${c.nombre}`,
                            detalle: `R$ ${(parseFloat(p.valor) || 0).toFixed(2)}`,
                            icono: 'fa-money-bill-wave',
                            color: 'var(--accent-green)'
                        });
                    });
                }
                if (c.historialPagos) {
                    c.historialPagos.forEach(p => {
                        actividades.push({
                            tipo: 'pago',
                            fecha: new Date(p.fecha || 0),
                            texto: `Pago de ${c.nombre} (Parcela ${p.parcela || '?'})`,
                            detalle: `R$ ${(parseFloat(p.monto) || 0).toFixed(2)}`,
                            icono: 'fa-money-bill-wave',
                            color: 'var(--accent-green)'
                        });
                    });
                }
            });
            
            verTodoGastos.forEach(g => {
                actividades.push({
                    tipo: 'gasto',
                    fecha: new Date(g.fecha || 0),
                    texto: `Gasto: ${g.descripcion || 'Sin descripci√≥n'}`,
                    detalle: `R$ ${(parseFloat(g.valor) || 0).toFixed(2)}`,
                    icono: 'fa-wallet',
                    color: 'var(--accent-red)'
                });
            });
            
            actividades.sort((a, b) => b.fecha - a.fecha);
            
            if (actividades.length === 0) {
                container.innerHTML = '<div class="card-dark"><p class="text-secondary text-center py-4">No hay actividad registrada</p></div>';
                return;
            }
            
            container.innerHTML = `
            <div class="card-dark">
                <div style="max-height: 500px; overflow-y: auto;">
                    ${actividades.map(a => {
                        const fechaStr = a.fecha.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
                        return `
                        <div class="d-flex align-items-center gap-3 py-3 border-bottom" style="border-color: var(--border-color) !important;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: ${a.color}20; display: flex; align-items: center; justify-content: center;">
                                <i class="fas ${a.icono}" style="color: ${a.color};"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${a.texto}</strong>
                                <br><small class="text-secondary">${fechaStr}</small>
                            </div>
                            <span style="color: ${a.color}; font-weight: bold;">${a.detalle}</span>
                        </div>`;
                    }).join('')}
                </div>
            </div>`;
        }
        // ========== FIN VER TODO TRABAJADOR ==========

        // ========== BACKUPS POR TRABAJADOR ==========
        let backupTrabajadorId = null;
        let backupTrabajadorNombre = null;

        async function verBackupsTrabajador(userId, nombre) {
            backupTrabajadorId = userId;
            backupTrabajadorNombre = nombre;
            document.getElementById('backupTrabajadorNombre').textContent = nombre;
            
            // Cargar datos del trabajador
            try {
                const clientsRes = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await clientsRes.json();
                const userClients = allClients.filter(c => c.creadoPor === userId);
                
                const gastosRes = await fetch(API_URL + '/api/gastos/' + userId);
                const userGastos = await gastosRes.json();
                
                const totalPrestado = userClients.reduce((s, c) => s + (parseFloat(c.montoTotal) || 0), 0);
                const totalGastos = userGastos.reduce((s, g) => s + (parseFloat(g.valor) || 0), 0);
                
                document.getElementById('btClientes').textContent = userClients.length;
                document.getElementById('btPrestado').textContent = 'R$ ' + totalPrestado.toFixed(2);
                document.getElementById('btGastos').textContent = 'R$ ' + totalGastos.toFixed(2);
                
                // Cargar backups del trabajador
                await cargarBackupsTrabajador();
                
                showSection('adminBackupsTrabajador');
            } catch (e) {
                console.error('Error:', e);
                alert('Error al cargar datos');
            }
        }

        async function cargarBackupsTrabajador() {
            try {
                const res = await fetch(API_URL + '/api/admin/backups-trabajador/' + backupTrabajadorId);
                const backups = await res.json();
                const container = document.getElementById('backupsTrabajadorList');
                
                if (backups.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center py-3">No hay backups para este trabajador. Crea uno ahora.</p>';
                    return;
                }
                
                container.innerHTML = backups.map((b, i) => {
                    const fecha = new Date(b.fecha).toLocaleString('es-BR');
                    return `
                    <div class="d-flex justify-content-between align-items-center py-2 ${i > 0 ? 'border-top' : ''}" style="border-color: var(--border-color) !important;">
                        <div>
                            <strong><i class="fas fa-file-archive me-2" style="color: var(--accent-yellow);"></i>${b.nombre}</strong>
                            <br><small class="text-secondary">${fecha} - ${b.clientes} clientes, ${b.gastos} gastos</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;" onclick="restaurarBackupTrabajador('${b.id}')" title="Restaurar">
                                <i class="fas fa-undo"></i> Restaurar
                            </button>
                            <button class="btn btn-sm" style="background: var(--accent-red); color: #fff;" onclick="eliminarBackupTrabajador('${b.id}')" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('Error cargando backups:', e);
            }
        }

        async function crearBackupTrabajador() {
            if (!backupTrabajadorId) return;
            try {
                const res = await fetch(API_URL + '/api/admin/backup-trabajador/' + backupTrabajadorId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Backup creado correctamente');
                    cargarBackupsTrabajador();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo crear'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        async function restaurarBackupTrabajador(backupId) {
            if (!confirm('‚ö†Ô∏è ¬øRESTAURAR este backup?\n\nEsto reemplazar√° TODOS los datos de ' + backupTrabajadorNombre + ' con los del backup.\n\nLos datos de otros trabajadores NO se afectar√°n.\n\n¬øContinuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore-trabajador/' + backupId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Backup restaurado correctamente para ' + backupTrabajadorNombre);
                    verBackupsTrabajador(backupTrabajadorId, backupTrabajadorNombre);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        async function eliminarBackupTrabajador(backupId) {
            if (!confirm('¬øEliminar este backup?')) return;
            try {
                const res = await fetch(API_URL + '/api/admin/delete-backup-trabajador/' + backupId, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) {
                    alert('Backup eliminado');
                    cargarBackupsTrabajador();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        // ========== FIN BACKUPS POR TRABAJADOR ==========

        function verClienteAdmin(clienteId, userId) {
            const cliente = adminAllClients.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            const tipoLabels = { nuevo: 'üÜï Nuevo', bueno: '‚úÖ Buen Cliente', regular: '‚ö†Ô∏è Regular', malo: '‚ùå Mala Paga' };
            const tipoLabel = tipoLabels[cliente.tipoCliente] || 'üÜï Nuevo';
            const restante = (cliente.totalAPagar || 0) - (cliente.montoPagado || 0);
            
            const info = `
üìã DATOS DEL CLIENTE

üë§ Nombre: ${cliente.nombre}
üìû Tel√©fono: ${cliente.telefono || 'No registrado'}
üìç Ubicaci√≥n: ${cliente.ubicacion || 'No registrada'}
‚≠ê Tipo: ${tipoLabel}
üìù Notas: ${cliente.notas || 'Sin notas'}

üí∞ INFORMACI√ìN FINANCIERA

üíµ Prestado: R$ ${(cliente.montoTotal || 0).toFixed(2)}
üìä Comisi√≥n: ${cliente.comisionPorcentaje || 20}%
üí≥ Total a Pagar: R$ ${(cliente.totalAPagar || 0).toFixed(2)}
‚úÖ Cobrado: R$ ${(cliente.montoPagado || 0).toFixed(2)}
‚ùå Restante: R$ ${restante.toFixed(2)}
üìÖ Parcelas: ${cliente.parcelasPagas || 0}/${cliente.numeroParcelas}
üîÑ Estado: ${cliente.estado}
            `.trim();
            
            alert(info);
        }

        async function toggleBlockUser(userId) {
            if (!confirm('¬øEst√°s seguro de cambiar el estado de este usuario?')) return;
            try {
                const res = await fetch(API_URL + '/api/users/' + userId + '/toggle-block', {
                    method: 'POST'
                });
                const data = await res.json();
                if (data.success) {
                    alert(data.message);
                    renderAdminUsuarios();
                } else {
                    alert(data.error || 'Error al cambiar estado');
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        function toggleUserClients(userId) {
            const div = document.getElementById('clients-' + userId);
            const icon = document.getElementById('icon-' + userId);
            if (div.style.display === 'none') {
                div.style.display = 'block';
                icon.className = 'fas fa-chevron-up ms-2';
            } else {
                div.style.display = 'none';
                icon.className = 'fas fa-chevron-down ms-2';
            }
        }

        // ============ FUNCIONES DE BACKUP ============
        async function cargarBackups() {
            try {
                const res = await fetch(API_URL + '/api/admin/backups');
                const backups = await res.json();
                const container = document.getElementById('backupsList');
                
                if (backups.length === 0) {
                    container.innerHTML = '<p class="text-secondary text-center py-3">No hay backups disponibles</p>';
                    return;
                }
                
                container.innerHTML = backups.map((b, i) => {
                    const fecha = b.fecha ? new Date(b.fecha).toLocaleString('es-BR') : 'Fecha desconocida';
                    return `
                    <div class="d-flex justify-content-between align-items-center py-2 ${i > 0 ? 'border-top' : ''}" style="border-color: var(--border-color) !important;">
                        <div>
                            <strong><i class="fas fa-file-archive me-2" style="color: var(--accent-cyan);"></i>${b.usuario || 'Usuario'}</strong>
                            <br><small class="text-secondary">${fecha} - ${b.tama√±o || ''}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm" style="background: var(--accent-yellow); color: #000;" onclick="restaurarBackupGeneral('${b.id}')" title="Restaurar">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            } catch (e) {
                console.error('Error cargando backups:', e);
            }
        }

        async function crearBackupManual() {
            if (!confirm('¬øCrear un backup ahora?')) return;
            try {
                const res = await fetch(API_URL + '/api/admin/backup', { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ ' + data.archivo);
                    cargarBackups();
                } else {
                    alert('Error creando backup');
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        async function restaurarBackupGeneral(backupId) {
            if (!confirm('‚ö†Ô∏è ¬øRESTAURAR este backup?\n\nEsto reemplazar√° los datos del trabajador con los del backup.\n\n¬øEst√°s seguro?')) return;
            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n¬øContinuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore/' + backupId, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Backup restaurado correctamente');
                    cargarBackups();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }

        function descargarBackup(filename) {
            window.open(API_URL + '/api/admin/backup/' + filename, '_blank');
        }

        async function restaurarBackup(filename) {
            if (!confirm('‚ö†Ô∏è ¬øRESTAURAR este backup?\n\nEsto reemplazar√° TODOS los datos actuales con los del backup.\n\n¬øEst√°s seguro?')) return;
            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\nSe perder√°n todos los cambios desde que se cre√≥ este backup.\n\n¬øContinuar?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/restore/' + filename, { method: 'POST' });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Backup restaurado correctamente');
                    location.reload();
                } else {
                    alert('Error: ' + (data.error || 'No se pudo restaurar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        // ============ FIN FUNCIONES DE BACKUP ============

        async function renderAdminClientes() {
            try {
                const res = await fetch(API_URL + '/api/clientes?userId=admin');
                const allClients = await res.json();
                const tbody = document.getElementById('adminClientesTable');
                if (allClients.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary py-4">No hay clientes</td></tr>';
                    return;
                }
                tbody.innerHTML = allClients.map(c => {
                    const user = allUsers.find(u => u.id === c.creadoPor) || { nombre: 'Desconocido' };
                    return `
                    <tr>
                        <td><strong>${c.nombre}</strong></td>
                        <td>${user.nombre}</td>
                        <td>R$ ${(c.montoTotal || 0).toFixed(2)}</td>
                        <td style="color: var(--accent-green);">R$ ${(c.montoPagado || 0).toFixed(2)}</td>
                        <td style="color: var(--accent-red);">R$ ${((c.totalAPagar || 0) - (c.montoPagado || 0)).toFixed(2)}</td>
                        <td><span class="badge-status badge-${c.estado === 'ativo' ? 'active' : 'finished'}">${c.estado}</span></td>
                    </tr>`;
                }).join('');
            } catch (e) { console.error(e); }
        }

        // Client Functions
        function openNewClientModal() {
            document.getElementById('clienteNombre').value = '';
            document.getElementById('clienteTelefono').value = '';
            document.getElementById('clienteUbicacion').value = '';
            document.getElementById('clienteLat').value = '';
            document.getElementById('clienteLng').value = '';
            document.getElementById('coordsInfo').style.display = 'none';
            document.getElementById('clienteTipo').value = 'nuevo';
            document.getElementById('clienteNegocio').value = '';
            document.getElementById('clienteNegocioOtro').value = '';
            document.getElementById('clienteNegocioOtro').style.display = 'none';
            document.getElementById('clienteNombreNegocio').value = '';
            document.getElementById('clienteNotas').value = '';
            document.getElementById('clienteMonto').value = '';
            document.getElementById('clienteParcelas').value = '';
            document.getElementById('clienteComision').value = '20';
            calcularTotal();
            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }

        function toggleOtroNegocio() {
            const select = document.getElementById('clienteNegocio');
            const input = document.getElementById('clienteNegocioOtro');
            if (select.value === 'otro') {
                input.style.display = 'block';
                input.focus();
            } else {
                input.style.display = 'none';
                input.value = '';
            }
        }

        function calcularTotal() {
            const monto = parseFloat(document.getElementById('clienteMonto').value) || 0;
            const parcelas = parseInt(document.getElementById('clienteParcelas').value) || 1;
            const porcentaje = parseInt(document.getElementById('clienteComision').value) || 20;
            const comision = monto * (porcentaje / 100);
            const total = monto + comision;
            const porParcela = total / parcelas;
            document.getElementById('comisionLabel').textContent = porcentaje;
            document.getElementById('calcComision').textContent = 'R$ ' + comision.toFixed(2);
            document.getElementById('calcTotal').textContent = 'R$ ' + total.toFixed(2);
            document.getElementById('calcParcela').textContent = 'R$ ' + porParcela.toFixed(2);
        }

        async function crearCliente() {
            const nombre = document.getElementById('clienteNombre').value;
            const telefono = document.getElementById('clienteTelefono').value;
            const ubicacion = document.getElementById('clienteUbicacion').value;
            const lat = document.getElementById('clienteLat').value;
            const lng = document.getElementById('clienteLng').value;
            const tipoCliente = document.getElementById('clienteTipo').value;
            let tipoNegocio = document.getElementById('clienteNegocio').value;
            const negocioOtro = document.getElementById('clienteNegocioOtro').value;
            if (tipoNegocio === 'otro' && negocioOtro) {
                tipoNegocio = negocioOtro;
            }
            const nombreNegocio = document.getElementById('clienteNombreNegocio').value;
            const notas = document.getElementById('clienteNotas').value;
            const monto = parseFloat(document.getElementById('clienteMonto').value);
            const parcelas = parseInt(document.getElementById('clienteParcelas').value);
            const porcentaje = parseInt(document.getElementById('clienteComision').value) || 20;
            if (!nombre || !monto || !parcelas) return alert('Completa los campos requeridos');
            const comision = monto * (porcentaje / 100);
            const total = monto + comision;
            
            // Contar renovaciones previas de este cliente (por tel√©fono)
            let renovacionesPrevias = 0;
            if (telefono) {
                clientes.forEach(c => {
                    if (c.telefono === telefono && (c.renovado || c.estado === 'finalizado')) {
                        renovacionesPrevias++;
                    }
                });
            }
            
            const cliente = {
                id: Date.now().toString(),
                nombre, telefono, ubicacion, tipoCliente, tipoNegocio, nombreNegocio, notas,
                lat: lat ? parseFloat(lat) : null,
                lng: lng ? parseFloat(lng) : null,
                montoTotal: monto,
                numeroParcelas: parcelas,
                comisionPorcentaje: porcentaje,
                comisionTotal: comision,
                totalAPagar: total,
                valorParcela: total / parcelas,
                estado: 'ativo',
                fechaCreacion: new Date().toISOString(),
                montoPagado: 0,
                parcelasPagas: 0,
                pagos: [],
                renovaciones: renovacionesPrevias,
                creadoPor: currentUser.id,
                creadoPorNombre: currentUser.nombre
            };
            
            // Si es una renovaci√≥n, marcar el cliente original como renovado
            if (clienteRenovandoId) {
                const clienteOriginal = clientes.find(c => c.id === clienteRenovandoId);
                if (clienteOriginal) {
                    clienteOriginal.renovado = true;
                    // Actualizar en servidor
                    await fetch(API_URL + '/api/clientes/' + clienteRenovandoId, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clienteOriginal)
                    });
                }
                clienteRenovandoId = null;
            }
            
            try {
                await fetch(API_URL + '/api/clientes', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, cliente })
                });
                clientes.push(cliente);
                bootstrap.Modal.getInstance(document.getElementById('clienteModal')).hide();
                updateStats();
                renderClientes();
                alert('Cliente creado exitosamente');
            } catch (e) { alert('Error al crear cliente'); }
        }

        let clienteParaPago = null;
        function abrirPago(id) {
            clienteParaPago = clientes.find(c => c.id === id);
            if (!clienteParaPago) return;
            document.getElementById('pagoClienteInfo').innerHTML = `
                <strong>${clienteParaPago.nombre}</strong><br>
                <small class="text-secondary">Restante: R$ ${((clienteParaPago.totalAPagar || 0) - (clienteParaPago.montoPagado || 0)).toFixed(2)}</small>
            `;
            document.getElementById('pagoValor').value = clienteParaPago.valorParcela.toFixed(2);
            document.getElementById('pagoFecha').value = new Date().toISOString().split('T')[0];
            new bootstrap.Modal(document.getElementById('pagoModal')).show();
        }

        async function confirmarPago() {
            if (!clienteParaPago) return;
            const valor = parseFloat(document.getElementById('pagoValor').value);
            if (!valor || valor <= 0) return alert('Ingresa un valor v√°lido');
            clienteParaPago.montoPagado = (clienteParaPago.montoPagado || 0) + valor;
            clienteParaPago.parcelasPagas = Math.floor(clienteParaPago.montoPagado / (clienteParaPago.valorParcela || 1));
            if (clienteParaPago.montoPagado >= (clienteParaPago.totalAPagar || 0)) {
                clienteParaPago.estado = 'finalizado';
                clienteParaPago.parcelasPagas = clienteParaPago.numeroParcelas;
            }
            // Asegurar que pagos existe
            if (!clienteParaPago.pagos) clienteParaPago.pagos = [];
            // Guardar fecha y hora completa
            const fechaSeleccionada = document.getElementById('pagoFecha').value;
            const horaActual = new Date().toTimeString().slice(0, 8);
            const fechaHoraCompleta = new Date(fechaSeleccionada + 'T' + horaActual).toISOString();
            clienteParaPago.pagos.push({ valor, fecha: fechaHoraCompleta });
            try {
                const res = await fetch(API_URL + '/api/clientes/' + clienteParaPago.id, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(clienteParaPago)
                });
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'Error');
                bootstrap.Modal.getInstance(document.getElementById('pagoModal')).hide();
                updateStats();
                renderClientes();
                renderCobros();
                alert('‚úÖ Pago registrado');
            } catch (e) { 
                console.error('Error pago:', e);
                alert('Error al registrar pago: ' + e.message); 
            }
        }
        
        async function pagarTodo() {
            if (!clienteParaPago) return;
            const restante = (clienteParaPago.totalAPagar || 0) - (clienteParaPago.montoPagado || 0);
            if (restante <= 0) {
                alert('Este cliente ya no tiene deuda pendiente');
                return;
            }
            if (!confirm(`¬øConfirmar pago total de R$ ${restante.toFixed(2)}?\n\nEsto saldar√° toda la deuda de ${clienteParaPago.nombre}.`)) return;
            
            document.getElementById('pagoValor').value = restante.toFixed(2);
            await confirmarPago();
        }

        function verDetalles(id) {
            const c = clientes.find(cl => cl.id === id);
            if (!c) return;
            alert(`${c.nombre}\nTel√©fono: ${c.telefono || 'N/A'}\nPrestado: R$ ${c.montoTotal}\nTotal: R$ ${c.totalAPagar}\nPagado: R$ ${c.montoPagado}\nParcelas: ${c.parcelasPagas}/${c.numeroParcelas}`);
        }
        
        let clienteRenovandoId = null;
        
        function renovarCliente(id) {
            const c = clientes.find(cl => cl.id === id);
            if (!c) return;
            
            // Guardar ID del cliente que se est√° renovando
            clienteRenovandoId = id;
            
            // Abrir modal de nuevo cliente con datos prellenados
            document.getElementById('clienteNombre').value = c.nombre;
            document.getElementById('clienteTelefono').value = c.telefono || '';
            document.getElementById('clienteUbicacion').value = c.ubicacion || '';
            document.getElementById('clienteLat').value = c.lat || '';
            document.getElementById('clienteLng').value = c.lng || '';
            document.getElementById('coordsInfo').style.display = (c.lat && c.lng) ? 'block' : 'none';
            document.getElementById('clienteTipo').value = 'bueno'; // Al renovar, es buen cliente
            document.getElementById('clienteNegocio').value = c.tipoNegocio || '';
            document.getElementById('clienteNegocioOtro').value = c.negocioOtro || '';
            document.getElementById('clienteNombreNegocio').value = c.nombreNegocio || '';
            document.getElementById('clienteNotas').value = c.notas || '';
            document.getElementById('clienteMonto').value = '';
            document.getElementById('clienteParcelas').value = '';
            document.getElementById('clienteComision').value = c.comisionPorcentaje || '20';
            
            new bootstrap.Modal(document.getElementById('clienteModal')).show();
        }

        // ========== GASTOS ==========
        function openGastoModal() {
            document.getElementById('gastoDescripcion').value = '';
            document.getElementById('gastoValor').value = '';
            document.getElementById('gastoFecha').value = new Date().toISOString().split('T')[0];
            document.getElementById('gastoCategoria').value = '';
            new bootstrap.Modal(document.getElementById('gastoModal')).show();
        }

        function setGastoHoy() {
            document.getElementById('gastoFechaFiltro').value = new Date().toISOString().split('T')[0];
            renderGastos();
        }

        async function guardarGasto() {
            const descripcion = document.getElementById('gastoDescripcion').value;
            const valor = parseFloat(document.getElementById('gastoValor').value);
            const fecha = document.getElementById('gastoFecha').value;
            const categoria = document.getElementById('gastoCategoria').value;
            
            if (!descripcion || !valor || !fecha) {
                return alert('Completa todos los campos');
            }
            
            const gasto = {
                id: Date.now().toString(),
                descripcion,
                valor,
                fecha,
                categoria,
                creadoPor: currentUser.id,
                timestamp: new Date().toISOString()
            };
            
            try {
                await fetch(API_URL + '/api/gastos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUser.id, gasto })
                });
                gastos.push(gasto);
                bootstrap.Modal.getInstance(document.getElementById('gastoModal')).hide();
                renderGastos();
                alert('Gasto guardado');
            } catch (e) {
                alert('Error al guardar gasto');
            }
        }

        async function eliminarGasto(id) {
            if (!confirm('¬øEliminar este gasto?')) return;
            try {
                await fetch(API_URL + '/api/gastos/' + id, { method: 'DELETE' });
                gastos = gastos.filter(g => g.id !== id);
                renderGastos();
            } catch (e) {
                alert('Error al eliminar');
            }
        }

        function renderGastos() {
            const fechaFiltro = document.getElementById('gastoFechaFiltro').value;
            const hoy = new Date().toISOString().split('T')[0];
            
            // Calcular totales
            const gastosHoy = gastos.filter(g => g.fecha === hoy).reduce((s, g) => s + g.valor, 0);
            
            const inicioSemana = new Date();
            inicioSemana.setDate(inicioSemana.getDate() - inicioSemana.getDay());
            const gastosSemana = gastos.filter(g => new Date(g.fecha) >= inicioSemana).reduce((s, g) => s + g.valor, 0);
            
            const inicioMes = new Date();
            inicioMes.setDate(1);
            const gastosMes = gastos.filter(g => new Date(g.fecha) >= inicioMes).reduce((s, g) => s + g.valor, 0);
            
            document.getElementById('gastoHoy').textContent = 'R$ ' + gastosHoy.toFixed(2);
            document.getElementById('gastoSemana').textContent = 'R$ ' + gastosSemana.toFixed(2);
            document.getElementById('gastoMes').textContent = 'R$ ' + gastosMes.toFixed(2);
            
            // Filtrar por fecha seleccionada
            const gastosFiltrados = gastos.filter(g => g.fecha === fechaFiltro);
            const totalDia = gastosFiltrados.reduce((s, g) => s + g.valor, 0);
            
            const container = document.getElementById('gastosLista');
            
            if (gastosFiltrados.length === 0) {
                container.innerHTML = '<p class="text-center text-secondary py-4">No hay gastos para esta fecha</p>';
                return;
            }
            
            const categoriaIcons = {
                servicios: 'üí°', comida: 'üçî', transporte: 'üöó', salud: 'üíä',
                entretenimiento: 'üé¨', ropa: 'üëï', educacion: 'üìö', hogar: 'üè†', otro: 'üì¶'
            };
            
            container.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <strong>Total del d√≠a:</strong>
                    <span style="color: var(--accent-red); font-size: 1.3rem;">R$ ${totalDia.toFixed(2)}</span>
                </div>
                ${gastosFiltrados.map(g => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                        <div>
                            <span style="font-size: 1.2rem;">${categoriaIcons[g.categoria] || 'üì¶'}</span>
                            <strong class="ms-2">${g.descripcion}</strong>
                            <br><small class="text-secondary">${g.categoria}</small>
                        </div>
                        <div class="d-flex align-items-center gap-3">
                            <span style="color: var(--accent-red);">R$ ${g.valor.toFixed(2)}</span>
                            <button class="btn btn-sm" style="background: var(--accent-red); color: white;" onclick="eliminarGasto('${g.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        // ========== MAPA ==========
        let map = null;
        let markers = [];
        let miUbicacion = null;
        let miMarcador = null;

        function initMapa() {
            const clientesConUbi = clientes.filter(c => c.lat && c.lng);
            const clientesSinUbi = clientes.filter(c => !c.lat || !c.lng);
            
            document.getElementById('clientesConUbicacion').textContent = clientesConUbi.length;
            document.getElementById('clientesSinUbicacion').textContent = clientesSinUbi.length;
            
            // Inicializar mapa si no existe
            if (!map) {
                map = L.map('mapContainer').setView([4.6097, -74.0817], 12); // Bogot√° por defecto
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);
            }
            
            // Limpiar marcadores anteriores
            markers.forEach(m => map.removeLayer(m));
            markers = [];
            
            // Agregar marcadores de clientes
            clientesConUbi.forEach(c => {
                const tipoColors = { nuevo: '#00d4ff', bueno: '#2ecc71', regular: '#e6a700', malo: '#ff4757' };
                const color = tipoColors[c.tipoCliente] || '#00d4ff';
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${color}; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"><i class="fas fa-user" style="color: white; font-size: 12px;"></i></div>`,
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });
                
                const marker = L.marker([c.lat, c.lng], { icon }).addTo(map);
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                
                marker.bindPopup(`
                    <div style="min-width: 200px;">
                        <strong style="font-size: 1.1rem;">${c.nombre}</strong><br>
                        <small>${c.ubicacion || 'Sin direcci√≥n'}</small><hr style="margin: 8px 0;">
                        <div><i class="fas fa-phone"></i> ${c.telefono || 'N/A'}</div>
                        <div><i class="fas fa-money-bill"></i> Restante: R$ ${restante.toFixed(2)}</div>
                        <div style="margin-top: 10px;">
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank" class="btn btn-sm btn-primary-custom" style="width: 100%;">
                                <i class="fas fa-directions"></i> C√≥mo llegar
                            </a>
                        </div>
                    </div>
                `);
                markers.push(marker);
            });
            
            // Centrar mapa si hay clientes
            if (clientesConUbi.length > 0) {
                const bounds = L.latLngBounds(clientesConUbi.map(c => [c.lat, c.lng]));
                map.fitBounds(bounds, { padding: [50, 50] });
            }
            
            // Renderizar lista
            renderListaClientesMapa(clientesConUbi);
            
            // Forzar redimensionamiento del mapa
            setTimeout(() => map.invalidateSize(), 100);
        }

        function renderListaClientesMapa(clientesConUbi) {
            const container = document.getElementById('listaClientesMapa');
            if (clientesConUbi.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center">No hay clientes con ubicaci√≥n guardada</p>';
                return;
            }
            
            container.innerHTML = clientesConUbi.map(c => {
                const restante = (c.totalAPagar || 0) - (c.montoPagado || 0);
                return `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div>
                        <strong>${c.nombre}</strong>
                        <br><small class="text-secondary"><i class="fas fa-map-marker-alt"></i> ${c.ubicacion || 'Sin direcci√≥n'}</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm" style="background: var(--bg-hover);" onclick="centrarEnCliente('${c.id}')">
                            <i class="fas fa-crosshairs"></i>
                        </button>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${c.lat},${c.lng}" target="_blank" class="btn btn-sm btn-primary-custom">
                            <i class="fas fa-directions"></i>
                        </a>
                    </div>
                </div>`;
            }).join('');
        }

        function centrarEnCliente(clienteId) {
            const cliente = clientes.find(c => c.id === clienteId);
            if (cliente && cliente.lat && cliente.lng) {
                map.setView([cliente.lat, cliente.lng], 16);
                // Abrir popup del marcador
                const marker = markers.find((m, i) => {
                    const clientesConUbi = clientes.filter(c => c.lat && c.lng);
                    return clientesConUbi[i] && clientesConUbi[i].id === clienteId;
                });
                if (marker) marker.openPopup();
            }
        }

        function obtenerMiUbicacion() {
            if (!navigator.geolocation) {
                alert('Tu navegador no soporta geolocalizaci√≥n');
                return;
            }
            
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    miUbicacion = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                    
                    // Mostrar en mapa
                    if (miMarcador) map.removeLayer(miMarcador);
                    
                    const icon = L.divIcon({
                        className: 'custom-marker',
                        html: `<div style="background: #00d4ff; width: 20px; height: 20px; border-radius: 50%; border: 4px solid white; box-shadow: 0 0 15px rgba(0,212,255,0.8);"></div>`,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    });
                    
                    miMarcador = L.marker([miUbicacion.lat, miUbicacion.lng], { icon }).addTo(map);
                    miMarcador.bindPopup('<strong>Tu ubicaci√≥n</strong>').openPopup();
                    
                    map.setView([miUbicacion.lat, miUbicacion.lng], 14);
                    document.getElementById('miUbicacionCard').style.display = 'block';
                },
                (err) => {
                    alert('No se pudo obtener tu ubicaci√≥n. Aseg√∫rate de dar permiso.');
                },
                { enableHighAccuracy: true }
            );
        }

        function obtenerUbicacionCliente() {
            const direccion = document.getElementById('clienteUbicacion').value;
            if (!direccion || direccion.trim() === '') {
                alert('Escribe una direcci√≥n primero');
                return;
            }
            
            // Buscar coordenadas de la direcci√≥n usando Nominatim (OpenStreetMap)
            fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(direccion)}&format=json&limit=1`)
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lng = parseFloat(data[0].lon);
                        
                        document.getElementById('clienteLat').value = lat;
                        document.getElementById('clienteLng').value = lng;
                        document.getElementById('coordsInfo').style.display = 'block';
                        
                        // Mostrar mini mapa en un modal
                        mostrarMapaPreview(lat, lng, direccion);
                    } else {
                        alert('No se encontr√≥ la direcci√≥n. Intenta ser m√°s espec√≠fico (ej: "Calle 10 #5-20, Bogot√°, Colombia")');
                    }
                })
                .catch(() => {
                    alert('Error al buscar la direcci√≥n. Intenta de nuevo.');
                });
        }

        let previewMap = null;
        function mostrarMapaPreview(lat, lng, direccion) {
            // Crear modal si no existe
            let modal = document.getElementById('mapaPreviewModal');
            if (!modal) {
                const modalHtml = `
                <div class="modal fade modal-dark" id="mapaPreviewModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title"><i class="fas fa-map-marker-alt me-2"></i>Ubicaci√≥n encontrada</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p id="direccionEncontrada" class="text-secondary mb-3"></p>
                                <div id="mapaPreviewContainer" style="height: 350px; border-radius: 10px; overflow: hidden;"></div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                <button type="button" class="btn btn-success-custom" data-bs-dismiss="modal">
                                    <i class="fas fa-check me-2"></i>Confirmar ubicaci√≥n
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                modal = document.getElementById('mapaPreviewModal');
            }
            
            document.getElementById('direccionEncontrada').innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${direccion}`;
            
            // Mostrar modal
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Inicializar mapa despu√©s de que el modal est√© visible
            modal.addEventListener('shown.bs.modal', function initPreviewMap() {
                if (previewMap) {
                    previewMap.remove();
                }
                
                previewMap = L.map('mapaPreviewContainer').setView([lat, lng], 16);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(previewMap);
                
                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: #00d4ff; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 4px solid white; box-shadow: 0 2px 15px rgba(0,212,255,0.5);"><i class="fas fa-map-marker-alt" style="color: white; font-size: 18px;"></i></div>`,
                    iconSize: [40, 40],
                    iconAnchor: [20, 20]
                });
                
                L.marker([lat, lng], { icon }).addTo(previewMap)
                    .bindPopup(`<strong>${direccion}</strong>`)
                    .openPopup();
                
                modal.removeEventListener('shown.bs.modal', initPreviewMap);
            }, { once: true });
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            // Si viene con ?logout en la URL, borrar sesi√≥n
            if (window.location.search.includes('logout')) {
                localStorage.removeItem('finangest_user');
                window.history.replaceState({}, '', window.location.pathname);
                return;
            }
            const saved = localStorage.getItem('finangest_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                showMainApp();
            }
            
            // Registrar Service Worker para PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('Service Worker registrado'))
                    .catch(err => console.log('Error SW:', err));
            }
        });

        // ============ FUNCIONES ADMIN EDITAR/ELIMINAR ============
        
        // Editar cliente desde admin
        function adminEditarCliente(clienteId) {
            const cliente = verTodoClientes.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            // Crear modal de edici√≥n
            let modal = document.getElementById('adminEditClienteModal');
            if (modal) modal.remove();
            
            const modalHtml = `
            <div class="modal fade modal-dark" id="adminEditClienteModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2" style="color: var(--accent-cyan);"></i>Editar Cliente</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nombre</label>
                                    <input type="text" class="form-control form-control-dark" id="adminEditNombre" value="${cliente.nombre || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tel√©fono</label>
                                    <input type="text" class="form-control form-control-dark" id="adminEditTelefono" value="${cliente.telefono || ''}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Tipo de Cliente</label>
                                    <select class="form-control form-control-dark" id="adminEditTipo">
                                        <option value="nuevo" ${cliente.tipoCliente === 'nuevo' ? 'selected' : ''}>üÜï Nuevo</option>
                                        <option value="bueno" ${cliente.tipoCliente === 'bueno' ? 'selected' : ''}>‚úÖ Buen Cliente</option>
                                        <option value="regular" ${cliente.tipoCliente === 'regular' ? 'selected' : ''}>‚ö†Ô∏è Regular</option>
                                        <option value="malo" ${cliente.tipoCliente === 'malo' ? 'selected' : ''}>‚ùå Mala Paga</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Estado</label>
                                    <select class="form-control form-control-dark" id="adminEditEstado">
                                        <option value="ativo" ${cliente.estado === 'ativo' ? 'selected' : ''}>Activo</option>
                                        <option value="finalizado" ${cliente.estado === 'finalizado' ? 'selected' : ''}>Finalizado</option>
                                        <option value="atrasado" ${cliente.estado === 'atrasado' ? 'selected' : ''}>Atrasado</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Monto Prestado (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditMonto" value="${cliente.montoTotal || 0}" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Monto Cobrado (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditCobrado" value="${cliente.montoPagado || 0}" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total a Pagar (R$)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditTotalPagar" value="${cliente.totalAPagar || 0}" step="0.01">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Comisi√≥n (%)</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditComision" value="${cliente.comisionPorcentaje || 20}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Parcelas Pagas</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditParcelasPagas" value="${cliente.parcelasPagas || 0}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Total Parcelas</label>
                                    <input type="number" class="form-control form-control-dark" id="adminEditTotalParcelas" value="${cliente.numeroParcelas || 0}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Ubicaci√≥n</label>
                                    <input type="text" class="form-control form-control-dark" id="adminEditUbicacion" value="${cliente.ubicacion || ''}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Notas</label>
                                    <textarea class="form-control form-control-dark" id="adminEditNotas" rows="2">${cliente.notas || ''}</textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success-custom" onclick="guardarAdminEditCliente('${clienteId}')">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const bsModal = new bootstrap.Modal(document.getElementById('adminEditClienteModal'));
            bsModal.show();
        }
        
        async function guardarAdminEditCliente(clienteId) {
            const updates = {
                nombre: document.getElementById('adminEditNombre').value,
                telefono: document.getElementById('adminEditTelefono').value,
                tipoCliente: document.getElementById('adminEditTipo').value,
                estado: document.getElementById('adminEditEstado').value,
                montoTotal: parseFloat(document.getElementById('adminEditMonto').value) || 0,
                montoPagado: parseFloat(document.getElementById('adminEditCobrado').value) || 0,
                totalAPagar: parseFloat(document.getElementById('adminEditTotalPagar').value) || 0,
                comisionPorcentaje: parseFloat(document.getElementById('adminEditComision').value) || 20,
                parcelasPagas: parseInt(document.getElementById('adminEditParcelasPagas').value) || 0,
                numeroParcelas: parseInt(document.getElementById('adminEditTotalParcelas').value) || 0,
                ubicacion: document.getElementById('adminEditUbicacion').value,
                notas: document.getElementById('adminEditNotas').value
            };
            
            try {
                const res = await fetch(API_URL + '/api/admin/cliente/' + clienteId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Cliente actualizado correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('adminEditClienteModal')).hide();
                    // Recargar datos
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        
        async function adminEliminarCliente(clienteId) {
            const cliente = verTodoClientes.find(c => c.id === clienteId);
            if (!cliente) return alert('Cliente no encontrado');
            
            if (!confirm(`‚ö†Ô∏è ¬øEliminar al cliente "${cliente.nombre}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;
            if (!confirm('‚ö†Ô∏è √öLTIMA CONFIRMACI√ìN\n\n¬øEst√°s seguro de eliminar este cliente?')) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/cliente/' + clienteId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Cliente eliminado');
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        
        // Editar gasto desde admin
        function adminEditarGasto(gastoId) {
            const gasto = verTodoGastos.find(g => g.id === gastoId);
            if (!gasto) return alert('Gasto no encontrado');
            
            let modal = document.getElementById('adminEditGastoModal');
            if (modal) modal.remove();
            
            const fechaValue = gasto.fecha ? gasto.fecha.split('T')[0] : '';
            
            const modalHtml = `
            <div class="modal fade modal-dark" id="adminEditGastoModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-edit me-2" style="color: var(--accent-cyan);"></i>Editar Gasto</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Descripci√≥n</label>
                                <input type="text" class="form-control form-control-dark" id="adminEditGastoDesc" value="${gasto.descripcion || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Categor√≠a</label>
                                <select class="form-control form-control-dark" id="adminEditGastoCat">
                                    <option value="transporte" ${gasto.categoria === 'transporte' ? 'selected' : ''}>üöó Transporte</option>
                                    <option value="alimentacion" ${gasto.categoria === 'alimentacion' ? 'selected' : ''}>üçî Alimentaci√≥n</option>
                                    <option value="comunicacion" ${gasto.categoria === 'comunicacion' ? 'selected' : ''}>üì± Comunicaci√≥n</option>
                                    <option value="oficina" ${gasto.categoria === 'oficina' ? 'selected' : ''}>üìé Oficina</option>
                                    <option value="otros" ${gasto.categoria === 'otros' ? 'selected' : ''}>üì¶ Otros</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor (R$)</label>
                                <input type="number" class="form-control form-control-dark" id="adminEditGastoValor" value="${gasto.valor || 0}" step="0.01">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Fecha</label>
                                <input type="date" class="form-control form-control-dark" id="adminEditGastoFecha" value="${fechaValue}">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success-custom" onclick="guardarAdminEditGasto('${gastoId}')">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            const bsModal = new bootstrap.Modal(document.getElementById('adminEditGastoModal'));
            bsModal.show();
        }
        
        async function guardarAdminEditGasto(gastoId) {
            const updates = {
                descripcion: document.getElementById('adminEditGastoDesc').value,
                categoria: document.getElementById('adminEditGastoCat').value,
                valor: parseFloat(document.getElementById('adminEditGastoValor').value) || 0,
                fecha: document.getElementById('adminEditGastoFecha').value
            };
            
            try {
                const res = await fetch(API_URL + '/api/admin/gasto/' + gastoId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Gasto actualizado correctamente');
                    bootstrap.Modal.getInstance(document.getElementById('adminEditGastoModal')).hide();
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo actualizar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        
        async function adminEliminarGasto(gastoId) {
            const gasto = verTodoGastos.find(g => g.id === gastoId);
            if (!gasto) return alert('Gasto no encontrado');
            
            if (!confirm(`‚ö†Ô∏è ¬øEliminar el gasto "${gasto.descripcion}"?\n\nEsta acci√≥n no se puede deshacer.`)) return;
            
            try {
                const res = await fetch(API_URL + '/api/admin/gasto/' + gastoId, {
                    method: 'DELETE'
                });
                const data = await res.json();
                
                if (data.success) {
                    alert('‚úÖ Gasto eliminado');
                    await verTodoTrabajador(verTodoUserId);
                } else {
                    alert('Error: ' + (data.error || 'No se pudo eliminar'));
                }
            } catch (e) {
                alert('Error de conexi√≥n');
            }
        }
        // ============ FIN FUNCIONES ADMIN EDITAR/ELIMINAR ============

        // ============ PWA Y SERVICE WORKER ============
        
        // Registrar Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registrado:', registration.scope);
                        
                        // Escuchar actualizaciones
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    console.log('üì¶ Nueva versi√≥n disponible');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.warn('‚ö†Ô∏è Error registrando Service Worker:', error);
                    });
            });
        }

        // Variables para PWA install
        let deferredPrompt;
        const installButton = document.getElementById('installButton');

        // Capturar evento de instalaci√≥n
        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('üì± Aplicaci√≥n lista para instalar');
            e.preventDefault();
            deferredPrompt = e;
            if (installButton) {
                installButton.style.display = 'block';
            }
        });

        // Manejar clic en bot√≥n de instalaci√≥n
        if (installButton) {
            installButton.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`Usuario respondi√≥: ${outcome}`);
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                }
            });
        }

        // Escuchar instalaci√≥n exitosa
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ Aplicaci√≥n instalada exitosamente');
            deferredPrompt = null;
            if (installButton) {
                installButton.style.display = 'none';
            }
        });

        // ============ FIN PWA ============
    </script>
</body>
</html>
